(function(){"use strict";var t={1522:function(t,r,n){var i=n(6848),o=function(){var e=this,t=e._self._c;return t("div",{attrs:{id:"app"}},[t("router-view")],1)},a=[],s=function(){var e=this,t=e._self._c;return t("div",{staticClass:"avatar"},[t("el-container",[t("el-aside",{attrs:{width:"200px",height:"840px"}},[t("el-row",[e._e(),e.isShowCreateRecorderButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.createRecoder()}}},[e._v(" 创建录音器 ")]):e._e(),e.isShowSetSDKEvenetButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.setSDKEvenet()}}},[e._v(" 设置SDK监听事件 ")]):e._e(),e.isShowSetPlayerEvenetButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.setPlayerEvenet()}}},[e._v(" 设置播放器监听事件 ")]):e._e(),e.isShowSetApiInfoButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){e.SetApiInfodialog=!0}}},[e._v(" SetApiInfo ")]):e._e(),e.isShowSetGlobalParamsButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){e.SetGlobalParamsdialog=!0}}},[e._v(" SetGlobalParams ")]):e._e(),e.isShowStartButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.start()}}},[e._v(" 开始面试 ")]):e._e(),t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.pop()}}},[e._v(" 查看我的面试分析报告 ")]),e.isShowNlpRadio?t("div",[t("el-radio",{attrs:{label:!0},model:{value:e.nlp,callback:function(t){e.nlp=t},expression:"nlp"}},[e._v("开启语义理解")]),t("el-radio",{attrs:{label:!1},model:{value:e.nlp,callback:function(t){e.nlp=t},expression:"nlp"}},[e._v("关闭语义理解")])],1):e._e(),e._e(),e._e(),e._e(),e._e(),e.isShowInterruptButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.interrupt()}}},[e._v(" 打断 ")]):e._e(),e._e(),e.isShowStartRecordButton&&!e.recorderbutton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.startRecord()}}},[e._v(" 开启录音 ")]):e._e(),e.isShowStopRecordButton&&e.recorderbutton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.stopRecord()}}},[e._v(" 关闭录音 ")]):e._e(),e.isShowStopButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.stop()}}},[e._v(" 关闭连接 ")]):e._e(),e.isShowDestroyButton?t("el-button",{staticStyle:{margin:"0px"},attrs:{type:"primary"},on:{click:function(t){return e.destroy()}}},[e._v(" 销毁SDK ")]):e._e(),t("el-button",{class:{"is-recording":e.isRecording},attrs:{type:"primary"},on:{click:e.toggleRecording}},[e._v(" "+e._s(e.isRecording?"再次点击停止回答":"点击开始回答")+" ")])],1),e.transcriptionResult?t("div",{staticClass:"transcription"},[t("h4",[e._v("转写结果：")]),t("p",[e._v(e._s(e.transcriptionResult))])]):e._e()],1),t("el-main",{staticClass:"htmleaf-content",staticStyle:{padding:"0px"}},[t("div",{staticClass:"weather rain",attrs:{id:"wrapper"}}),t("span",[e._v("透明度")]),t("input",{attrs:{type:"range",id:"opacityRange",min:"0",max:"1",step:"0.1",value:"1"}})]),t("el-dialog",{attrs:{title:"初始化SDK",visible:e.SetApiInfodialog},on:{"update:visible":function(t){e.SetApiInfodialog=t}}},[t("el-form",{attrs:{model:e.form}},[t("span",[e._v("此处参数均去交互平台-接口服务中获取")]),t("el-form-item",{attrs:{label:"Appid","label-width":e.formLabelWidth}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"off"},model:{value:e.form.appid,callback:function(t){e.$set(e.form,"appid",t)},expression:"form.appid"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"ApiKey","label-width":e.formLabelWidth}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"off"},model:{value:e.form.apikey,callback:function(t){e.$set(e.form,"apikey",t)},expression:"form.apikey"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"ApiSecret","label-width":e.formLabelWidth}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"off"},model:{value:e.form.apisecret,callback:function(t){e.$set(e.form,"apisecret",t)},expression:"form.apisecret"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"SceneId","label-width":e.formLabelWidth}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"off"},model:{value:e.form.sceneid,callback:function(t){e.$set(e.form,"sceneid",t)},expression:"form.sceneid"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"ServerUrl","label-width":e.formLabelWidth}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"off"},model:{value:e.form.serverurl,callback:function(t){e.$set(e.form,"serverurl",t)},expression:"form.serverurl"}}),t("span",[e._v("必填")])],1)],1),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.SetApiInfodialog=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){e.SetApiInfodialog=!1,e.SetApiInfo2()}}},[e._v("确 定")])],1)],1),t("el-dialog",{attrs:{title:"设置全局变量",visible:e.SetGlobalParamsdialog},on:{"update:visible":function(t){e.SetGlobalParamsdialog=t}}},[t("div",{staticStyle:{"text-align":"center"}},[t("h3",[e._v("打断模式全局设置")])]),t("el-form",{attrs:{model:e.setglobalparamsform,"label-width":e.formLabelWidth}},[t("el-form-item",{attrs:{label:"视频协议"}},[t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"支持webrtc/xrtc/rtmp(控制台打印视频流地址)",placement:"right-start"}},[t("i",{staticClass:"el-icon-question"})]),t("el-select",{attrs:{placeholder:"请选择视频流协议"},model:{value:e.setglobalparamsform.stream.protocol,callback:function(t){e.$set(e.setglobalparamsform.stream,"protocol",t)},expression:"setglobalparamsform.stream.protocol"}},[t("el-option",{attrs:{label:"xrtc",value:"xrtc"}}),t("el-option",{attrs:{label:"webrtc",value:"webrtc"}}),t("el-option",{attrs:{label:"rtmp",value:"rtmp"}})],1),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"透明背景"}},[t("el-tooltip",{staticClass:"item",attrs:{effect:"dark",content:"仅支持xrtc协议",placement:"right-start"}},[t("i",{staticClass:"el-icon-question"})]),t("el-switch",{model:{value:e.setglobalparamsform.stream.alpha,callback:function(t){e.$set(e.setglobalparamsform.stream,"alpha",t)},expression:"setglobalparamsform.stream.alpha"}})],1),t("el-form-item",{attrs:{label:"全局交互模式"}},[t("el-radio-group",{model:{value:e.setglobalparamsform.avatar_dispatch.interactive_mode,callback:function(t){e.$set(e.setglobalparamsform.avatar_dispatch,"interactive_mode",t)},expression:"setglobalparamsform.avatar_dispatch.interactive_mode"}},[t("el-radio",{attrs:{label:0}},[e._v("追加模式（信息依次播报）")]),t("el-radio",{attrs:{label:1}},[e._v("打断模式（直接播报最新）")])],1)],1),t("el-form-item",{attrs:{label:"形象ID"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on",placeholder:"到交互平台-接口服务-形象列表中获取id"},model:{value:e.setglobalparamsform.avatar.avatar_id,callback:function(t){e.$set(e.setglobalparamsform.avatar,"avatar_id",t)},expression:"setglobalparamsform.avatar.avatar_id"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"分辨率高"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on"},model:{value:e.setglobalparamsform.avatar.height,callback:function(t){e.$set(e.setglobalparamsform.avatar,"height",t)},expression:"setglobalparamsform.avatar.height"}})],1),t("el-form-item",{attrs:{label:"分辨率宽"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on"},model:{value:e.setglobalparamsform.avatar.width,callback:function(t){e.$set(e.setglobalparamsform.avatar,"width",t)},expression:"setglobalparamsform.avatar.width"}})],1),t("el-form-item",{attrs:{label:"音频采样率"}},[t("el-radio-group",{model:{value:e.setglobalparamsform.avatar.audio_format,callback:function(t){e.$set(e.setglobalparamsform.avatar,"audio_format",t)},expression:"setglobalparamsform.avatar.audio_format"}},[t("el-radio",{attrs:{label:1}},[e._v("16K(传1)")]),t("el-radio",{attrs:{label:2}},[e._v("24K(传2，大部分情况默认24K即可)")])],1)],1),null!=e.setglobalparamsform.avatar.mask_region?t("el-form-item",{attrs:{label:"形象裁剪"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on",placeholder:"对形象进行裁剪[从左到右,从上到下,从右到左,从下到上]"},model:{value:e.setglobalparamsform.avatar.mask_region,callback:function(t){e.$set(e.setglobalparamsform.avatar,"mask_region",t)},expression:"setglobalparamsform.avatar.mask_region"}})],1):e._e(),t("el-form-item",{attrs:{label:"发音人"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on",placeholder:"到交互平台-接口服务-声音列表中获取id"},model:{value:e.setglobalparamsform.tts.vcn,callback:function(t){e.$set(e.setglobalparamsform.tts,"vcn",t)},expression:"setglobalparamsform.tts.vcn"}}),t("span",[e._v("必填")])],1),t("el-form-item",{attrs:{label:"情感"}},[t("el-input",{staticClass:"widthclass",attrs:{autocomplete:"on",placeholder:"到交互平台-接口服务-声音列表中获取id"},model:{value:e.setglobalparamsform.tts.emotion,callback:function(t){e.$set(e.setglobalparamsform.tts,"emotion",e._n(t))},expression:"setglobalparamsform.tts.emotion"}})],1),t("el-form-item",{attrs:{label:"是否开启字幕"}},[t("el-radio-group",{model:{value:e.setglobalparamsform.subtitle.subtitle,callback:function(t){e.$set(e.setglobalparamsform.subtitle,"subtitle",t)},expression:"setglobalparamsform.subtitle.subtitle"}},[t("el-radio",{attrs:{label:1}},[e._v("开启")]),t("el-radio",{attrs:{label:0}},[e._v("关闭")])],1)],1),t("el-form-item",{attrs:{label:"字体颜色"}},[t("el-color-picker",{model:{value:e.setglobalparamsform.subtitle.font_color,callback:function(t){e.$set(e.setglobalparamsform.subtitle,"font_color",t)},expression:"setglobalparamsform.subtitle.font_color"}})],1),t("el-form-item",{attrs:{label:"是否开启背景图"}},[t("el-radio-group",{model:{value:e.setglobalparamsform.enable,callback:function(t){e.$set(e.setglobalparamsform,"enable",t)},expression:"setglobalparamsform.enable"}},[t("el-radio",{attrs:{label:!0}},[e._v("开启")]),t("el-radio",{attrs:{label:!1}},[e._v("关闭")])],1)],1),t("el-form-item",{attrs:{label:"背景图片"}},[t("el-radio-group",{model:{value:e.setglobalparamsform.background.type,callback:function(t){e.$set(e.setglobalparamsform.background,"type",t)},expression:"setglobalparamsform.background.type"}},[t("el-radio",{attrs:{label:"url"}},[e._v("URL")]),t("el-radio",{attrs:{label:"res_key"}},[e._v("res_key(到交互平台-素材管理中获取)")])],1)],1),t("el-form-item",{attrs:{label:"背景数据"}},[t("el-input",{attrs:{autocomplete:"on"},model:{value:e.setglobalparamsform.background.data,callback:function(t){e.$set(e.setglobalparamsform.background,"data",t)},expression:"setglobalparamsform.background.data"}})],1)],1),t("el-form",{attrs:{model:e.form}}),t("div",{staticClass:"dialog-footer",attrs:{slot:"footer"},slot:"footer"},[t("el-button",{on:{click:function(t){e.SetGlobalParamsdialog=!1}}},[e._v("取 消")]),t("el-button",{attrs:{type:"primary"},on:{click:function(t){e.SetGlobalParamsdialog=!1,e.SetGlobalParams()}}},[e._v("确 定")])],1)],1)],1)],1)},c=[],u=(n(4114),n(8111),n(7588),n(2002)),d=n(4373);document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("wrapper"),t=document.getElementById("opacityRange");t.addEventListener("input",(function(){e.style.opacity=this.value}))}));let l=null,h=null;var p,f,m,v,g,y={name:"avatarComponent",data(){return{isShowInitButton:!1,isShowCreateRecorderButton:!1,isShowSetSDKEvenetButton:!1,isShowSetPlayerEvenetButton:!1,isShowSetApiInfoButton:!1,isShowSetGlobalParamsButton:!1,isShowStartButton:!0,isShowWriteTextButton:!0,isShowInterruptButton:!1,isShowWriteCmdButton:!1,isShowStartRecordButton:!1,isShowStopRecordButton:!1,isShowStopButton:!1,isShowDestroyButton:!1,isShowNlpRadio:!1,isShowTextarea:!0,isShowVcInput:!1,isShowEmotionInput:!1,isShowActionInput:!1,recorderbutton:!1,SetApiInfodialog:!1,SetGlobalParamsdialog:!1,isShowInitButton:!0,isRecording:!1,mediaRecorder:null,audioChunks:[],transcriptionResult:null,avatarPlatform2:null,form:{appid:"7d2ebf7e",apikey:"f7c54ee54ab86f4dbe65d78a7770121c",apisecret:"ZjNhMjRhZmJmMTU0ZGFhN2Q4NTZlNjA1",sceneid:"184186341888757760",serverurl:"wss://avatar.cn-huadong-1.xf-yun.com/v1/interact"},setglobalparamsform:{stream:{protocol:"xrtc",fps:25,bitrate:1e6,alpha:!1},avatar:{avatar_id:"110117005",width:1080,height:1920,mask_region:"[0,0,1080,1920]",scale:1,move_h:0,move_v:0,audio_format:1},tts:{vcn:"x4_lingxiaoying_assist",speed:50,pitch:50,volume:100,emotion:13},avatar_dispatch:{interactive_mode:1},subtitle:{subtitle:1,font_color:"#FFFFFF",font_name:"Sanji.Suxian.Simple",position_x:100,position_y:0,font_size:10,width:100,height:100},enable:!1,background:{type:"res_key",data:"22SLM2teIw+aqR6Xsm2JbH6Ng310kDam2NiCY/RQ9n6dw47gMO+7gGUJfWWfkqD3IxsU/HMK1uJTTxxF2llcKSM4dlSdBy0Piag/DndHocqs32kTOwXUw6lkyggYQBXF0uwTv9jVFm1ZjZgSehV3kpx5RTvizZ9MqEI8lotCRvokC9HLI0pGfKtSmlKgCKL+OUoc9QI5HW3wLtYbLersumd4UCKEPk/uWAdKEh4ntSJiW2km8waGFsg/VSNFj5vaDK3LC4PxfsRvi1a2veZW7JUs/VOleE9wwgTH+A/oqPPcyksBY7aQ4TxYjvS9Qj9LtXkvOwttQMgPGwoxlqBEBhR/xLUwmecHkHzgjACFtxE="}},formLabelWidth:"120px",textarea:"",vc:"",recorderbutton:!1,nlp:!1,emotion:0,action:"A_RH_hello_O",volume:100}},mounted(){this.initRecorder()},methods:{toQuestion(){this.$router.push("/question")},initRecorder(){navigator.mediaDevices&&navigator.mediaDevices.getUserMedia||console.error("浏览器不支持录音功能")},toggleRecording(){this.isRecording?this.stopRecording():this.startRecording()},startRecording(){this.isRecording=!0,this.audioChunks=[],this.transcriptionResult=null,navigator.mediaDevices.getUserMedia({audio:!0}).then((e=>{this.mediaRecorder=new MediaRecorder(e),this.mediaRecorder.ondataavailable=e=>{this.audioChunks.push(e.data)},this.mediaRecorder.onstop=()=>{const t=new Blob(this.audioChunks,{type:"audio/wav"});this.sendToTranscribe(t),e.getTracks().forEach((e=>e.stop()))},this.mediaRecorder.start()})).catch((e=>{console.error("录音失败:",e),this.isRecording=!1}))},stopRecording(){this.isRecording=!1,this.mediaRecorder?.stop(),this.mediaRecorder=null},async sendToTranscribe(e){const t=new FormData,r=new File([e],"recording.wav",{type:"audio/wav"});t.append("file",r);try{const e=await d.A.post("http://117.72.49.76:3389/api/transcribe",t,{headers:{"Content-Type":"multipart/form-data"}});if("success"===e.data.status){this.transcriptionResult=e.data.text;let t=parseInt(localStorage.getItem("transcribeCount")||"0");t++,1===t?(localStorage.setItem("firstResult",this.transcriptionResult),console.log("第一次转写成功，"+localStorage.getItem("firstResult"))):2===t&&(localStorage.setItem("secondResult",this.transcriptionResult),console.log("第二次转写成功，"+localStorage.getItem("secondResult"))),localStorage.setItem("transcribeCount",t.toString()),console.log(`第${t}次转写成功`)}else console.error("转写失败:",e.data.error),this.transcriptionResult="转写失败，请重试"}catch(n){console.error("网络错误:",n),this.transcriptionResult="网络请求失败"}},initSDK(){l=new u.A,null!=l&&this.open2("实例化SDK成功")},createRecoder(){null!=l?(h=l.createRecorder(),this.open2("创建录音器成功")):alert("请实例化SDK实例")},setSDKEvenet(){null!=l?(l.on(u.S.connected,(function(e){console.log("SDKEvent.connect:initResp:",e)})).on(u.S.stream_start,(function(){console.log("stream_start")})).on(u.S.disconnected,(function(t){console.log("SDKEvent.disconnected:",t),t&&(console.error("ws link disconnected because of Error"),console.error(e.code,e.message,e.name,e.stack))})).on(u.S.nlp,(function(e){console.log("语义理解内容nlp:",e)})).on(u.S.frame_start,(function(e){console.log("推流开始（可以看作一段文本开始播报时间点）frame_start:",e)})).on(u.S.frame_stop,(function(e){console.log("推流结束（可以看作一段文本结束播报时间点）frame_stop:",e)})).on(u.S.error,(function(e){console.log("错误信息error:",e)})).on(u.S.connected,(function(){console.log("connected")})).on(u.S.asr,(function(e){console.log("语音识别数据asr:",e)})).on(u.S.tts_duration,(function(e){console.log("语音合成用时tts：",e)})).on(u.S.subtitle_info,(function(e){console.log("subtitleData：",e)})).on(u.S.action_start,(function(e){console.log("动作推流开始（可以看作动作开始时间节点）action_start:",e)})).on(u.S.action_stop,(function(e){console.log("动作推流结束（可以看作动作结束时间点）action_stop：",e)})),this.open2("监听SDK事件成功")):alert("请先实例化SDK")},setPlayerEvenet(){if(null!=l){const e=l.createPlayer();e.on(u.P.play,(function(){console.log("paly")})).on(u.P.playing,(function(){console.log("playing")})).on(u.P.waiting,(function(){console.log("waiting")})).on(u.P.stop,(function(){console.log("stop")})).on(u.P.playNotAllowed,(function(){console.log("playNotAllowed：触发了游览器限制自动播放策略，播放前必须与游览器产生交互（例如点击页面或者dom组件），触发该事件后调用avatarPlatform2.player.resume()方法来接触限制"),e.resume()})),this.open2("监听播放器事件成功")}else alert("请先实例化SDK")},SetApiInfo2(){if(null==l)alert("请先实例化SDK");else{console.log("设置setApiInfo");const e={appId:this.form.appid,apiKey:this.form.apikey,apiSecret:this.form.apisecret,serverUrl:this.form.serverurl,sceneId:this.form.sceneid};console.log("初始化SDK信息：",e),l.setApiInfo(e),this.open2("初始化SDK成功")}},SetGlobalParams(){if(null!=l){let e=Object.assign({},this.setglobalparamsform);console.log("this.setglobalparamsform.stream.alpha",this.setglobalparamsform.stream.alpha),0==this.setglobalparamsform.enable&&(delete e.background,delete e.enable),console.log("this.setglobalparamsform",this.setglobalparamsform),1==this.setglobalparamsform.stream.alpha?(console.log("设置alpha=1"),e.stream.alpha=1):(console.log("设置alpha=0"),e.stream.alpha=0),console.log("设置的全局变量为：",e),l.setGlobalParams(e),this.open2("设置全局变量成功")}else alert("请先实例化SDK")},async start(){if(console.log("1"),this.initSDK(),console.log("2"),this.createRecoder(),this.setSDKEvenet(),this.setPlayerEvenet(),this.SetApiInfo2(),this.SetGlobalParams(),null!=l)try{await l.start({wrapper:document.querySelector("#wrapper")}),console.log("SDK启动成功，3秒后发送问候语"),setTimeout((()=>{this.writeText()}),1e4)}catch(e){console.error("SDK启动失败:",e),alert("SDK启动失败，请检查配置")}else alert("请先实例化SDK")},writeText(){if(null!=l){let e="你好，面试者，10秒钟后我会开始面试，一共两道题目，每道题目间隔10秒";this.sendTextToAvatar(e),setTimeout((()=>{e="第一道题目",localStorage.setItem("firstQuestion",e),this.sendTextToAvatar(e)}),1e4),setTimeout((()=>{e="第二道题目",localStorage.setItem("secondQuestion",e),this.sendTextToAvatar(e)}),2e4)}else alert("请先实例化SDK")},sendTextToAvatar(e){if(e){const t={nlp:this.nlp,tts:{volume:100,...this.vc?{vcn:this.vc,emotion:this.emotion}:{}}};l.writeText(e,t)}else alert("内容不许为空")},writeCmd(){l.writeCmd("action",this.action)},interrupt(){null!=l?l.interrupt():alert("请先实例化SDK")},startRecord(){null!=l?(l.recorder.startRecord(0,(()=>{console.warn("STOPED RECORDER")}),{nlp:!0,avatar_dispatch:{interactive_mode:0}}),this.recorderbutton=!0):alert("请先实例化SDK")},stopRecord(){null!=l?(l.recorder.stopRecord(),this.recorderbutton=!1):alert("请先实例化SDK")},stop(){null!=l?l.stop():alert("请先实例化SDK")},destroy(){null!=l?(l.destroy(),l=null):alert("请先实例化SDK")},open2(e){this.$message({message:e,type:"success"})}},beforeDestroy(){l&&l.stop()}},b=y,S=n(1656),E=(0,S.A)(b,s,c,!1,null,"46152413",null),C=E.exports,T={name:"App",components:{avatarComponent:C}},w=T,_=(0,S.A)(w,o,a,!1,null,null,null),k=_.exports,R=n(6178),I=function(){var e=this,t=e._self._c;return t("div",[t("div",{staticClass:"wrapperPlayer"}),t("button",{on:{click:function(t){return e.play()}}},[e._v("播放")])])},O=[];n(6573),n(8100),n(7936),n(1148),n(2489),n(116),n(1701),n(8237),n(3579),n(9479),n(7642),n(8004),n(3853),n(5876),n(2475),n(5024),n(1698),n(7467),n(4732),n(9577),n(4979),n(4603),n(7566),n(8721);function P(e,t,r){return t=V(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return B(e)}(e,A()?Reflect.construct(t,r||[],V(e).constructor):t.apply(e,r))}function A(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(A=function(){return!!e})()}function x(){x=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof g?t:g,a=Object.create(o.prototype),s=new P(n||[]);return i(a,"_invoke",{value:k(e,r,s)}),a}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var h="suspendedStart",p="suspendedYield",f="executing",m="completed",v={};function g(){}function y(){}function b(){}var S={};u(S,a,(function(){return this}));var E=Object.getPrototypeOf,C=E&&E(E(A([])));C&&C!==r&&n.call(C,a)&&(S=C);var T=b.prototype=g.prototype=Object.create(S);function w(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function r(i,o,a,s){var c=l(e[i],e,o);if("throw"!==c.type){var u=c.arg,d=u.value;return d&&"object"==typeof d&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,a,s)}),(function(e){r("throw",e,a,s)})):t.resolve(d).then((function(e){u.value=e,a(u)}),(function(e){return r("throw",e,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,i){r(e,n,t,i)}))}return o=o?o.then(i,i):i()}})}function k(t,r,n){var i=h;return function(o,a){if(i===f)throw new Error("Generator is already running");if(i===m){if("throw"===o)throw a;return{value:e,done:!0}}for(n.method=o,n.arg=a;;){var s=n.delegate;if(s){var c=R(s,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===h)throw i=m,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=f;var u=l(t,r,n);if("normal"===u.type){if(i=n.done?m:p,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(i=m,n.method="throw",n.arg=u.arg)}}}function R(t,r){var n=r.method,i=t.iterator[n];if(i===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,R(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var o=l(i,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,v;var a=o.arg;return a?a.done?(r[t.resultName]=a.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,v):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function A(t){if(t||""===t){var r=t[a];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,o=function r(){for(;++i<t.length;)if(n.call(t,i))return r.value=t[i],r.done=!1,r;return r.value=e,r.done=!0,r};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return y.prototype=b,i(T,"constructor",{value:b,configurable:!0}),i(b,"constructor",{value:y,configurable:!0}),y.displayName=u(b,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,u(e,c,"GeneratorFunction")),e.prototype=Object.create(T),e},t.awrap=function(e){return{__await:e}},w(_.prototype),u(_.prototype,s,(function(){return this})),t.AsyncIterator=_,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new _(d(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},w(T),u(T,c,"Generator"),u(T,a,(function(){return this})),u(T,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=A,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function i(n,i){return s.type="throw",s.arg=t,r.next=n,i&&(r.method="next",r.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,v):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),O(r),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;O(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:A(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),v}},t}function L(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function M(e){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},M(e)}function D(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function U(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,L(n.key),n)}}function N(e,t,r){return t&&U(e.prototype,t),r&&U(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function j(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&F(e,t)}function V(e){return V=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},V(e)}function F(e,t){return F=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},F(e,t)}function W(e){var t="function"==typeof Map?new Map:void 0;return W=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(A){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return function(e,t,r){if(A())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&F(i,r.prototype),i}(e,arguments,V(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),F(r,e)},W(e)}function B(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function G(){return G="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=V(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},G.apply(this,arguments)}function H(e,t,r,n){return new(r||(r=Promise))((function(i,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))}function z(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}function K(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r}"function"==typeof SuppressedError&&SuppressedError;var J,q,Y,$=0,X=function(){function e(t){var r,n=this;D(this,e),p.set(this,$),f.set(this,{}),m.set(this,[]),v.set(this,(function(e,t,r){if("function"!=typeof t)throw TypeError("listener must be a function");-1===z(n,m,"f").indexOf(e)&&z(n,m,"f").push(e),z(n,f,"f")[e]=z(n,f,"f")[e]||[],z(n,f,"f")[e].push({once:r||!1,fn:t})})),g.set(this,(function(e,t){var r=z(n,f,"f")[e],i=[];null==r||r.forEach((function(e,r){e.fn.apply(null,t),e.once&&i.unshift(r)})),null==i||i.forEach((function(e){r.splice(e,1)}))})),K(this,p,null!==(r=null==t?void 0:t.emitDelay)&&void 0!==r?r:$,"f")}return N(e,[{key:"on",value:function(e,t){return z(this,v,"f").call(this,e,t,!1),this}},{key:"once",value:function(e,t){return z(this,v,"f").call(this,e,t,!0),this}},{key:"off",value:function(e,t){var r=z(this,m,"f").indexOf(e);if(e&&-1!==r)if(t){var n=[],i=z(this,f,"f")[e];null==i||i.forEach((function(e,r){e.fn===t&&n.unshift(r)})),null==n||n.forEach((function(e){i.splice(e,1)})),i.length||(z(this,m,"f").splice(r,1),delete z(this,f,"f")[e])}else delete z(this,f,"f")[e],z(this,m,"f").splice(r,1);return this}},{key:"removeAllListeners",value:function(){return K(this,f,{},"f"),K(this,m,[],"f"),this}},{key:"emit",value:function(e){for(var t=this,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];z(this,p,"f")?setTimeout((function(){z(t,g,"f").call(t,e,n)}),z(this,p,"f")):z(this,g,"f").call(this,e,n)}},{key:"emitSync",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];z(this,g,"f").call(this,e,r)}},{key:"destroy",value:function(){K(this,f,{},"f"),K(this,m,[],"f")}}]),e}();p=new WeakMap,f=new WeakMap,m=new WeakMap,v=new WeakMap,g=new WeakMap,function(e){e.connected="connected",e.disconnected="disconnected",e.frameBegin="frameBegin",e.frameEnd="frameEnd",e.duration="duration",e.nlp="nlp",e.asr="asr",e.error="error"}(J||(J={})),function(e){e.play="play",e.waiting="waiting",e.playing="playing",e.stop="stop",e.playNotAllowed="not-allowed",e.error="error"}(q||(q={})),function(e){e.InvalidParam="InvalidParam",e.InvalidResponse="InvalidResponse",e.ContextError="ContextError",e.NetworkError="NetworkError",e.ConnectError="ConnectError",e.InvalidConnect="InvalidConnect",e.MediaError="MediaError",e.UserMediaError="UserMediaError"}(Y||(Y={}));var Q=function(){function e(t,r,n,i,o){var a;return D(this,e),(a=P(this,e,[t])).name=n,a.code=r,a.aside=o||"",a.sid=i||"",a}return j(e,W(Error)),N(e)}(),Z=function(){var e={resolve:function(){},reject:function(){}};return{promise:new Promise((function(t,r){e.resolve=t,e.reject=r})),controller:e}},ee={code:"700003",message:"无效的流数据"},te={code:"700002",message:"播放不允许"},re={code:"700005",message:"当前设备不支持 H.264"},ne={code:"700009",message:"播放失败"};
/*!
 * xrtc.js v5.2024.2.1_00_hotfix2
 * (c) 2020-2024 
 * Released under the MIT License in iflytek.
 */function ie(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function ae(e,t){if(e){if("string"==typeof e)return oe(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?oe(e,t):void 0}}function se(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,i=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(n=(a=s.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==s.return||s.return()}finally{if(i)throw o}}return r}}(e,t)||ae(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ce(e,t,r,n,i,o,a){try{var s=e[o](a),c=s.value}catch(e){return void r(e)}s.done?t(c):Promise.resolve(c).then(n,i)}function ue(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var o=e.apply(t,r);function a(e){ce(o,n,i,a,s,"next",e)}function s(e){ce(o,n,i,a,s,"throw",e)}a(void 0)}))}}function de(e){return function(e){if(Array.isArray(e))return oe(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||ae(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function le(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function he(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function pe(e,t,r){return t&&he(e.prototype,t),r&&he(e,r),e}function fe(e){var t={exports:{}};return e(t,t.exports),t.exports}var me,ve,ge,ye,be=fe((function(e){var t=function(e){var t,r=Object.prototype,n=r.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",s=i.toStringTag||"@@toStringTag";function c(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,r){return e[t]=r}}function u(e,t,r,n){var i=Object.create((t&&t.prototype instanceof v?t:v).prototype),o=new I(n||[]);return i._invoke=function(e,t,r){var n=l;return function(i,o){if(n===p)throw new Error("Generator is already running");if(n===f){if("throw"===i)throw o;return P()}for(r.method=i,r.arg=o;;){var a=r.delegate;if(a){var s=_(a,r);if(s){if(s===m)continue;return s}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===l)throw n=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var c=d(e,t,r);if("normal"===c.type){if(n=r.done?f:h,c.arg===m)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(n=f,r.method="throw",r.arg=c.arg)}}}(e,r,o),i}function d(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=u;var l="suspendedStart",h="suspendedYield",p="executing",f="completed",m={};function v(){}function g(){}function y(){}var b={};b[o]=function(){return this};var S=Object.getPrototypeOf,E=S&&S(S(O([])));E&&E!==r&&n.call(E,o)&&(b=E);var C=y.prototype=v.prototype=Object.create(b);function T(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function r(i,o,a,s){var c=d(e[i],e,o);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&n.call(l,"__await")?t.resolve(l.__await).then((function(e){r("next",e,a,s)}),(function(e){r("throw",e,a,s)})):t.resolve(l).then((function(e){u.value=e,a(u)}),(function(e){return r("throw",e,a,s)}))}s(c.arg)}var i;this._invoke=function(e,n){function o(){return new t((function(t,i){r(e,n,t,i)}))}return i=i?i.then(o,o):o()}}function _(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,_(e,r),"throw"===r.method))return m;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return m}var i=d(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,m;var o=i.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,m):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,m)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function I(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function O(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return a.next=a}}return{next:P}}function P(){return{value:t,done:!0}}return g.prototype=C.constructor=y,y.constructor=g,g.displayName=c(y,s,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===g||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,y):(e.__proto__=y,c(e,s,"GeneratorFunction")),e.prototype=Object.create(C),e},e.awrap=function(e){return{__await:e}},T(w.prototype),w.prototype[a]=function(){return this},e.AsyncIterator=w,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var a=new w(u(t,r,n,i),o);return e.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},T(C),c(C,s,"Generator"),C[o]=function(){return this},C.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=O,I.prototype={constructor:I,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return s.type="throw",s.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,m):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:O(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),m}},e}(e.exports);try{regeneratorRuntime=t}catch(e){Function("r","regeneratorRuntime = r")(t)}})),Se=function(){function e(t){le(this,e),this.events={},this.logger=t}return pe(e,[{key:"on",value:function(e,t){var r=this.events[e]||[];return r.push(t),this.events[e]=r,this}},{key:"once",value:function(e,t){var r=this;this.on(e,(function n(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];t.apply(null,o),r.off(e,n)}))}},{key:"off",value:function(e,t){if("*"===e)return this.events={},this;var r=this.events[e];return this.events[e]=r&&r.filter((function(e){return e!==t})),this}},{key:"emit",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];"network-quality"!==e&&"audio-volume"!==e&&"mic-volume"!==e&&this.logger&&this.logger.info("Emit event name:",e);var i=this.events[e];return i&&i.forEach((function(e){return e.apply(null,r)})),this}}]),e}(),Ee=new Map;Ee.set("anchor",{publish:{audio:!0,video:!0},subscribe:{audio:!0,video:!0},control:!0}),Ee.set("audience",{publish:{audio:!1,video:!1},subscribe:{audio:!0,video:!0},control:!1}),function(e){e[e.New=0]="New",e[e.Joining=1]="Joining",e[e.Joined=2]="Joined",e[e.Leaving=3]="Leaving",e[e.Leaved=4]="Leaved"}(me||(me={})),function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Unpublished=3]="Unpublished"}(ve||(ve={})),function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribed=3]="Unsubscribed"}(ge||(ge={})),function(e){e[e.Invalid=0]="Invalid",e[e.AudioOnly=1]="AudioOnly",e[e.VideoOnly=2]="VideoOnly",e[e.AudioVideo=3]="AudioVideo"}(ye||(ye={}));var Ce="auxiliary",Te="error";function we(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function _e(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?we(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):we(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var ke=_e(_e(_e(_e(_e(_e({},{INVALID_PARAMETER:4096,INVALID_OPERATION:4097,NOT_SUPPORTED:4098}),{JOIN_ROOM_FAILED:16388,CREATE_OFFER_FAILED:16389,LEAVE_ROOM_FAILED:16390,PUBLISH_STREAM_FAILED:16391,UNPUBLISH_STREAM_FAILED:16392,SUBSCRIBE_FAILED:16393,UNSUBSCRIBE_FAILED:16400,SWITCH_ROLE_ERROR:16401,INVALID_TRANSPORT_STATA:16402,LOCAL_AUDIO_STATA_ERROR:16403,LOCAL_VIDEO_STATA_ERROR:16404,REMOTE_AUDIO_STATA_ERROR:16405,REMOTE_VIDEO_STATA_ERROR:16406,LOCAL_SWITCH_SIMULCAST:16407,REMOTE_SWITCH_SIMULCAST:16408,SUBSCRIPTION_TIMEOUT:16450,UNKNOWN:"0xFFFF"}),{INIT_STREAM_FAILED:12289,PLAY_STREAM_ERROR:12290,SET_AUDIO_OUTPUT_FAILED:12291,SET_VIDEO_PROFILE_ERROR:12292,SET_SCREEN_SHARE_FAILED:12293,SWITCH_DEVICE_FAILED:12294,ADD_TRACK_FAILED:12295,REMOVE_TRACK_FAILED:12296,REPLACE_TRACK_FAILED:12297,PLAY_NOT_ALLOWED:16451,DEVICE_AUTO_RECOVER_FAILED:16452,CANDIDATE_COLLECT_FAILED:16453,RTCPEERCONNECTION_SATE_FAILED:16480}),{DEVICE_NOT_FOUND:256,H264_NOT_SUPPORTED:257,CAMERAS_NOT_FOUND:258,MICROPHONES_NOT_FOUND:259,SPEAKERS_NOT_FOUND:260,OS_NOT_SUPPORTED:261,WEBRTC_NOT_SUPPORTED:262,BROWSER_NOT_SUPPORTED:263}),{SIGNAL_CHANNEL_SETUP_FAILED:20481,SIGNAL_CHANNEL_RECONNECTION_FAILED:20482,SERVER_TIMEOUT:20483}),{SERVER_UNKNOWN_ERROR:-10011,AUTHORIZATION_FAILED:-10013,GET_SERVER_NODE_FAILED:-10015,REQUEST_TIMEOUT:-10020});function Re(e,t){return(Re=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Ie(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Re(e,t)}function Oe(e){return(Oe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Pe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function Ae(e,t){return!t||"object"!==Oe(t)&&"function"!=typeof t?Pe(e):t}function xe(e){return(xe=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Le(e,t,r){return(Le=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,r){var n=[null];n.push.apply(n,t);var i=new(Function.bind.apply(e,n));return r&&Re(i,r.prototype),i}).apply(null,arguments)}function Me(e){var t="function"==typeof Map?new Map:void 0;return(Me=function(e){if(null===e||-1===Function.toString.call(e).indexOf("[native code]"))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return Le(e,arguments,xe(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),Re(r,e)})(e)}var De,Ue=function(){Ie(t,Me(Error));var e=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=xe(e);if(t){var i=xe(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Ae(this,r)}}(t);function t(r){var n;le(this,t),(n=e.call(this)).code=r.code,r.name&&(n.name=r.name);var i=r.message instanceof Error?r.message.message:r.message;return n.message=i,n}return pe(t,[{key:"getCode",value:function(){return this.code}}]),t}(),Ne=function(){function e(){var t=this;le(this,e),this.context=new(window.AudioContext||window.webkitAudioContext),this.instant=0,this.slow=0,this.clip=0,this.script=this.context.createScriptProcessor(2048,1,1),this.script.onaudioprocess=function(e){var r,n=e.inputBuffer.getChannelData(0),i=0,o=0;for(r=0;r<n.length;++r)i+=n[r]*n[r],Math.abs(n[r])>.99&&(o+=1);t.instant=Math.sqrt(i/n.length),t.slow=.95*t.slow+.05*t.instant,t.clip=o/n.length}}return pe(e,[{key:"connectToSource",value:function(e){try{var t=new MediaStream;t.addTrack(e),this.mic=this.context.createMediaStreamSource(t),this.mic.connect(this.script),this.script.connect(this.context.destination)}catch(e){console.error("soundMeter connectoToSource error: "+e)}}},{key:"stop",value:function(){this.mic.disconnect(),this.script.disconnect()}},{key:"resume",value:function(){this.context&&this.context.resume()}},{key:"getVolume",value:function(){return this.instant.toFixed(2)}}]),e}(),je=function(){function e(t){le(this,e),this.stream=t.stream,this.userId=t.stream.userId,this.log=t.stream.logger,this.track=t.track,this.div=t.div,this.muted=t.muted,this.outputDeviceId=t.deviceId,this.volume=t.volume,this.element=null,this.state="NONE",this.pausedRetryCount=5,this._emitter=new Se,this.handleEleEventPlaying=this.eleEventPlaying.bind(this),this.handleEleEventEnded=this.eleEventEnded.bind(this),this.handleEleEventPause=this.eleEventPause.bind(this),this.handleTrackEventEnded=this.trackEventEnded.bind(this),this.handleTrackEventMute=this.trackEventMute.bind(this),this.handleTrackEventUnmute=this.trackEventUnmute.bind(this)}var t;return pe(e,[{key:"play",value:(t=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){var n=new MediaStream;n.addTrack(t.track);var i=document.createElement("audio");i.srcObject=n,i.muted=t.muted,i.setAttribute("id","audio_".concat(t.stream.getId(),"_").concat(Date.now())),i.setAttribute("autoplay","autoplay"),i.setAttribute("playsinline","playsinline"),t.div.appendChild(i),t.outputDeviceId&&"function"==typeof(null==i?void 0:i.setSinkId)&&i.setSinkId(t.outputDeviceId),t.element=i,t.setVolume(t.volume),t.handleEvents(),i.addEventListener("canplay",(function(){t.element.play().then((function(){e()})).catch((function(e){r(e)}))}))})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"handleEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.addEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.addEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.addEventListener("pause",this.handleEleEventPause),this.trackHandleEvents()}},{key:"trackHandleEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.addEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.addEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.addEventListener("unmute",this.handleTrackEventUnmute)}},{key:"trackRemoveEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.removeEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.removeEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.removeEventListener("unmute",this.handleTrackEventUnmute)}},{key:"removeEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.removeEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.removeEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.removeEventListener("pause",this.handleEleEventPause),this.trackRemoveEvents()}},{key:"setSinkId",value:function(e){var t;this.outputDeviceId!==e&&(this.outputDeviceId=e,"function"==typeof(null===(t=this.element)||void 0===t?void 0:t.setSinkId)&&this.element.setSinkId(e))}},{key:"setVolume",value:function(e){this.log.info("stream - audioElement setVolume to : ".concat(e.toString())),this.element.volume=e}},{key:"getAudioLevel",value:function(){return this.soundMeter||(this.soundMeter=new Ne,this.soundMeter.connectToSource(this.track)),this.soundMeter.getVolume()}},{key:"stop",value:function(){this.removeEvents(),this.div.removeChild(this.element),this.element.srcObject=null,this.element=null,this.soundMeter&&(this.soundMeter.stop(),this.soundMeter=null)}},{key:"resume",value:function(){var e;return null===(e=this.element)||void 0===e?void 0:e.play()}},{key:"getAudioElement",value:function(){return this.element}},{key:"setAudioTrack",value:function(e){this.trackRemoveEvents();var t=new MediaStream;t.addTrack(e),this.track=e,this.trackHandleEvents(),this.soundMeter=null,this.log.info("setAudioTrack",e),this.element&&(this.element.srcObject=t,this.element.play())}},{key:"eleEventPlaying",value:function(){this.log.info("stream ".concat(this.userId," - audio player is starting playing")),this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"playing"})}},{key:"eleEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - audio player is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended"}))}},{key:"eleEventPause",value:function(){if(this.log.info("stream ".concat(this.userId," - audio player is paused")),this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"pause"}),this.div&&document.getElementById(this.div.id)){var e=(window.navigator&&window.navigator.userAgent||"").match(/Chrome\/(\d+)/),t=e&&e[1]?Number(e[1]):null;this.pausedRetryCount>0&&"number"==typeof t&&t<70&&(this.resume(),this.pausedRetryCount--)}else this.log.warn("audio container is not in DOM")}},{key:"trackEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - audio player track is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended",type:"track"}))}},{key:"trackEventMute",value:function(){this.log.info("stream ".concat(this.userId," - audio track is muted")),"PAUSED"!==this.state&&(this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"mute",type:"track"}))}},{key:"trackEventUnmute",value:function(){this.log.info("stream ".concat(this.userId," - audio track is unmuted")),"PAUSED"===this.state&&(this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"unmute",type:"track"}))}}]),e}(),Ve=(De=function(e,t){for(var r=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=null,i=0;i<r.length;++i){try{n=e.getContext(r[i],t)}catch(e){}if(n)break}return n},function(e,t,r){r=r||function(e){var t=document.getElementsByTagName("body")[0];if(t){var r=window.WebGLRenderingContext?'It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org">Click here for more information.</a>':'This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>';e&&(r+="<br/><br/>Status: "+e),t.innerHTML=function(e){return'<div style="margin: auto; width:500px;z-index:10000;margin-top:20em;text-align:center;"> '.concat(e," </div>")}(r)}},e.addEventListener&&e.addEventListener("webglcontextcreationerror",(function(e){r(e.statusMessage)}),!1);var n=De(e,t);return n||r(""),n});function Fe(e,t,r){var n=e.createShader(t);return null==n?null:(e.shaderSource(n,r),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:(e.getShaderInfoLog(n),e.deleteShader(n),null))}window.requestAnimationFrame||(window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e,t){window.setTimeout(e,1e3/60)}),window.cancelAnimationFrame||(window.cancelAnimationFrame=window.cancelRequestAnimationFrame||window.webkitCancelAnimationFrame||window.webkitCancelRequestAnimationFrame||window.mozCancelAnimationFrame||window.mozCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.msCancelRequestAnimationFrame||window.oCancelAnimationFrame||window.oCancelRequestAnimationFrame||window.clearTimeout);var We=function(){function e(t,r){le(this,e),this.div=t.div,this.video=t.video,this.virtualBackgroundMix=t.virtualBackgroundMix||null,this.textures=[],this.canCopyVideo=!1,this.canCopyBackground=!1,this.log=r,this.track=t.track,this.initVirtualBackground(t.virtualBackground),this.isEleLisenter=t.isEleLisenter}return pe(e,[{key:"play",value:function(){var e=this;if(this.initCanvas(),this.gl=Ve(this.canvas,{preserveDrawingBuffer:!0,alpha:!0,antialias:!0})||null,this.gl){var t=this.initXShaderSource();if(function(e,t,r){var n=function(e,t,r){var n=Fe(e,e.VERTEX_SHADER,t),i=Fe(e,e.FRAGMENT_SHADER,r);if(!n||!i)return null;var o=e.createProgram();return o?(e.attachShader(o,n),e.attachShader(o,i),e.linkProgram(o),e.getProgramParameter(o,e.LINK_STATUS)?o:(e.getProgramInfoLog(o),e.deleteProgram(o),e.deleteShader(i),e.deleteShader(n),null)):null}(e,t,r);return!!n&&(e.useProgram(n),e.program=n,!0)}(this.gl,t.VSHADER,t.FSHADER))if(this.initVertexBuffers(this.gl)<0)this.log.warn("Failed to initialize shaders");else{var r=[];this.video?(this.setupVideo(this.video,"canCopyVideo"),r.push(this.video),this.virtualBackground&&this.virtualBackgroundMix&&r.push(this.virtualBackground),r.forEach((function(t,r){var n=e.initTextures(e.gl,r);n?e.textures.push(n):e.log.warn("Failed to initialize texture")})),this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.render()):this.log.warn("Failed to get video")}else this.log.warn("Failed to initialize shaders")}else this.log.warn("Failed to get the rendering context for webgl")}},{key:"stop",value:function(){this.canCopyVideo=!1,this.canCopyBackground=!1,this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.virtualBackground=null,this.virtualBackgroundMix=!1,this.isEleLisenter&&this.observer.unobserve(this.div),this.canvas.remove(),delete this.canvas,delete this.gl}},{key:"unmute",value:function(){this.render()}},{key:"mute",value:function(){this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=null,this.gl.clearColor(0,0,0,0),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.canvas.style.backgroundImage=""}},{key:"render",value:function(){var e,t,r=this,n=Date.now();!function i(){var o=r.track.getSettings();r.frameRate=o.frameRate||15;var a=1e3/r.frameRate;r.rafId&&cancelAnimationFrame(r.rafId),r.rafId=requestAnimationFrame(i),e=Date.now(),(t=e-n)>a&&(n=e-t/a,r.canCopyVideo&&(r.updateTexture(r.gl,r.textures[0],r.video),r.setCanvasBgImage(),r.canUpdateBackground()&&r.updateTexture(r.gl,r.textures[1],r.virtualBackground)),r.gl.clear(r.gl.COLOR_BUFFER_BIT),r.gl.viewport(0,0,r.canvas.width,r.canvas.height),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4))}()}},{key:"initVirtualBackground",value:function(e){if(e){if("IMG"===e.nodeName){var t=new Image;t.src=e.src,this.virtualBackground=t}else if("VIDEO"===e.nodeName){var r=document.createElement("video");r.playsInline=!0,r.muted=!0,r.loop=!0,r.src=e.src,r.play(),this.virtualBackground=r,this.setupVideo(this.video,"canCopyBackground")}}else this.virtualBackground=null}},{key:"initCanvas",value:function(){this.canvas=document.createElement("canvas"),this.canvas?(this.canvas.width=this.div.clientWidth,this.canvas.height=this.div.clientHeight,this.canvas.style.objectFit=this.video.style.objectFit,this.canvas.style.width="100%",this.canvas.style.height="100%",this.isEleLisenter&&this.addDivListener(),this.div.appendChild(this.canvas)):this.log.warn("Failed to retrieve the <canvas> element")}},{key:"resize",value:function(){var e=this.canvas.width,t=this.div.clientHeight,r=this.div.clientWidth;t!==this.canvas.height&&(this.canvas.height=t),r!==e&&(this.canvas.width=r)}},{key:"addDivListener",value:function(){this.observer=new ResizeObserver(this.resize.bind(this)),this.observer.observe(this.div)}},{key:"setCanvasBgImage",value:function(){this.canvas.style.backgroundImage||this.virtualBackground&&!this.virtualBackgroundMix&&(this.canvas.style.backgroundImage="url(".concat(this.virtualBackground.src,")"),this.canvas.style.backgroundRepeat="no-repeat",this.canvas.style.backgroundSize="cover")}},{key:"setupVideo",value:function(e,t){var r=this,n=!1,i=!1;e.addEventListener("playing",(function(){n=!0,o()}),!0),e.addEventListener("timeupdate",(function(){i=!0,o()}),!0);var o=function(){n&&i&&(r[t]=!0)}}},{key:"canUpdateBackground",value:function(){return!(!this.virtualBackground||!this.virtualBackgroundMix)&&("IMG"===this.virtualBackground.nodeName?this.virtualBackground.complete:this.canCopyBackground)}},{key:"initVertexBuffers",value:function(e){var t=new Float32Array([-1,1,0,1,-1,-1,0,0,1,1,1,1,1,-1,1,0]),r=t.BYTES_PER_ELEMENT,n=e.createBuffer();if(!n)return this.log.warn("Failed to create vertex buffer"),-1;e.bindBuffer(e.ARRAY_BUFFER,n),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW);var i=e.getAttribLocation(e.program,"a_Position");if(i<0)return this.log.warn("Failed to get the storage location of a_Position"),-1;e.vertexAttribPointer(i,2,e.FLOAT,!1,4*r,0),e.enableVertexAttribArray(i);var o=e.getAttribLocation(e.program,"a_TexCoord");return o<0?(this.log.warn("Failed to get the storage location of a_TexCoord"),-1):(e.vertexAttribPointer(o,2,e.FLOAT,!1,4*r,2*r),e.enableVertexAttribArray(o),4)}},{key:"initTextures",value:function(e,t){var r,n,i=e.createTexture();if(!i)return this.log.warn("Failed to create the texture object"),null;if(0===t){if(!(r=e.getUniformLocation(e.program,"u_Sampler0")))return this.log.warn("Failed to get the storage location of u_Sampler"),null}else if(!(n=e.getUniformLocation(e.program,"u_Sampler1")))return this.log.warn("Failed to get the storage location of u_Sampler"),null;return e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,1),e.activeTexture(0===t?e.TEXTURE0:e.TEXTURE1),e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),0===t?e.uniform1i(r,0):e.uniform1i(n,1),i}},{key:"updateTexture",value:function(e,t,r){var n=e.RGBA,i=e.RGBA,o=e.UNSIGNED_BYTE;e.bindTexture(e.TEXTURE_2D,t),e.texImage2D(e.TEXTURE_2D,0,n,i,o,r)}},{key:"initXShaderSource",value:function(){return{VSHADER:"attribute vec4 a_Position;\nattribute vec2 a_TexCoord;\nvarying vec2 v_TexCoord;\nvoid main() {\ngl_Position = a_Position;\nv_TexCoord = a_TexCoord;\n}\n",FSHADER:this.virtualBackground&&this.virtualBackgroundMix?"precision mediump float;\nuniform sampler2D u_Sampler0;\nuniform sampler2D u_Sampler1;\nvarying vec2 v_TexCoord;\nvoid main() {\nvec2 true_pixel_coord = vec2(v_TexCoord.x, (0.5 + (v_TexCoord.y / 2.))); \nvec2 mask_pexel_coord = vec2(v_TexCoord.x, v_TexCoord.y / 2.); \nfloat alpha = texture2D(u_Sampler0, mask_pexel_coord).r; \nvec3 rgb = texture2D(u_Sampler0, true_pixel_coord).rgb*alpha;\nvec4 videoColor = vec4(rgb, alpha);\nvec4 imgColor = vec4(texture2D(u_Sampler1, v_TexCoord).rgb*(1.0-alpha),1.0-alpha);\ngl_FragColor = imgColor + videoColor;\n}\n":"precision mediump float;\nuniform sampler2D u_Sampler0;\nvarying vec2 v_TexCoord;\nvoid main() {\nvec2 true_pixel_coord = vec2(v_TexCoord.x, (0.5 + (v_TexCoord.y / 2.))); \nvec2 mask_pexel_coord = vec2(v_TexCoord.x, v_TexCoord.y / 2.); \nfloat alpha = texture2D(u_Sampler0, mask_pexel_coord).r; \nvec3 rgb = texture2D(u_Sampler0, true_pixel_coord).rgb*alpha;\nvec4 videoColor = vec4(rgb, alpha);\ngl_FragColor = videoColor;\n}\n"}}}]),e}(),Be=function(){function e(t){le(this,e),this.stream=t.stream,this.userId=t.stream.userId,this.log=t.stream.logger,this.track=t.track,this.div=t.div,this.muted=t.muted,this.objectFit=t.objectFit,this.mirror=t.mirror,this.element=null,this.state="NONE",this.pausedRetryCount=5,this.isEleLisenter=t.isEleLisenter,this._emitter=new Se,this.handleEleEventPlaying=this.eleEventPlaying.bind(this),this.handleEleEventEnded=this.eleEventEnded.bind(this),this.handleEleEventPause=this.eleEventPause.bind(this),this.handleTrackEventEnded=this.trackEventEnded.bind(this),this.handleTrackEventMute=this.trackEventMute.bind(this),this.handleTrackEventUnmute=this.trackEventUnmute.bind(this),this.isAlphaChannels=t.isAlphaChannels||!1,this.virtualBackground=t.virtualBackground,this.virtualBackgroundMix=t.virtualBackgroundMix,this.initializeElement(),this.isAlphaChannels&&this.startTexturesPlayer()}var t;return pe(e,[{key:"initializeElement",value:function(){var e=new MediaStream;e.addTrack(this.track);var t=document.createElement("video");t.srcObject=e,t.muted=!0;var r="width: 100%; height: 100%; object-fit: ".concat(this.objectFit,";");this.mirror&&(r+="transform: rotateY(180deg);"),t.setAttribute("id","video_".concat(this.stream.getId(),"_").concat(Date.now())),t.setAttribute("style",r),t.setAttribute("autoplay","autoplay"),t.setAttribute("playsinline","playsinline"),this.div.style.lineHeight="0",this.div.appendChild(t),this.element=t,this.handleEvents()}},{key:"play",value:(t=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){t.element.play().then((function(){t.element.pause(),e()})).catch((function(e){r(e)}))})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"handleEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.addEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.addEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.addEventListener("pause",this.handleEleEventPause),this.trackHandleEvents()}},{key:"trackHandleEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.addEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.addEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.addEventListener("unmute",this.handleTrackEventUnmute)}},{key:"trackRemoveEvents",value:function(){var e,t,r;null===(e=this.track)||void 0===e||e.removeEventListener("ended",this.handleTrackEventEnded),null===(t=this.track)||void 0===t||t.removeEventListener("mute",this.handleTrackEventMute),null===(r=this.track)||void 0===r||r.removeEventListener("unmute",this.handleTrackEventUnmute)}},{key:"removeEvents",value:function(){var e,t,r;null===(e=this.element)||void 0===e||e.removeEventListener("playing",this.handleEleEventPlaying),null===(t=this.element)||void 0===t||t.removeEventListener("ended",this.handleEleEventEnded),null===(r=this.element)||void 0===r||r.removeEventListener("pause",this.handleEleEventPause),this.trackRemoveEvents()}},{key:"stop",value:function(){this.removeEvents(),this.div.removeChild(this.element),this.element.srcObject=null,this.element=null,this.isAlphaChannels&&this.texturesPlayer.stop(),this.isAlphaChannels=!1}},{key:"resume",value:function(){var e;return null===(e=this.element)||void 0===e?void 0:e.play()}},{key:"getVideoFrame",value:function(){var e,t,r=document.createElement("canvas");r.width=null===(e=this.element)||void 0===e?void 0:e.videoWidth,r.height=null===(t=this.element)||void 0===t?void 0:t.videoHeight;var n=null;return this.isAlphaChannels?(n=this.texturesPlayer.canvas,r.height=r.height/2,r.getContext("2d").drawImage(n,0,0,n.width,n.height,0,0,r.width,r.height)):(n=this.element,r.getContext("2d").drawImage(n,0,0)),r.toDataURL("image/png")}},{key:"getVideoElement",value:function(){return this.element}},{key:"setVideoTrack",value:function(e){this.trackRemoveEvents();var t=new MediaStream;t.addTrack(e),this.track=e,this.trackHandleEvents(),this.log.info("setVideoTrack",e),this.element&&(this.element.srcObject=t,this.element.play())}},{key:"unmute",value:function(){this.isAlphaChannels&&this.texturesPlayer.unmute()}},{key:"mute",value:function(){this.isAlphaChannels&&this.texturesPlayer.mute()}},{key:"startTexturesPlayer",value:function(){this.element.style.position="absolute",this.element.style.width="0",this.element.style.height="0",this.element.style.zIndex="-1",this.texturesPlayer=new We({div:this.div,video:this.element,track:this.track,virtualBackground:this.virtualBackground,virtualBackgroundMix:this.virtualBackgroundMix,isEleLisenter:this.isEleLisenter},this.log),this.texturesPlayer.play()}},{key:"resize",value:function(){this.texturesPlayer.resize()}},{key:"eleEventPlaying",value:function(){this.log.info("stream ".concat(this.userId," - video player is starting playing")),this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"playing"})}},{key:"eleEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - video player is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended"}))}},{key:"eleEventPause",value:function(){this.log.info("stream ".concat(this.userId," - video player is paused")),this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"pause"}),this.div&&document.getElementById(this.div.id)?this.pausedRetryCount>0&&(this.log.info("auto resume when video paused"),this.resume(),this.pausedRetryCount--):this.log.warn("video container is not in DOM")}},{key:"trackEventEnded",value:function(){this.log.info("stream ".concat(this.userId," - video player track is ended")),"STOPPED"!==this.state&&(this.state="STOPPED",this._emitter.emit("player-state-changed",{state:this.state,reason:"ended",type:"track"}))}},{key:"trackEventMute",value:function(){this.log.info("stream ".concat(this.userId," - video track is muted")),"PAUSED"!==this.state&&(this.state="PAUSED",this._emitter.emit("player-state-changed",{state:this.state,reason:"mute",type:"track"}))}},{key:"trackEventUnmute",value:function(){this.log.info("stream ".concat(this.userId," - video track is unmuted")),"PAUSED"===this.state&&(this.state="PLAYING",this._emitter.emit("player-state-changed",{state:this.state,reason:"unmute",type:"track"}))}}]),e}();function Ge(){var e=navigator.userAgent,t=navigator.connection,r=e.match(/NetType\/\w+/)?e.match(/NetType\/\w+/)[0]:"";"3gnet"===(r=r.toLowerCase().replace("nettype/",""))&&(r="3g");var n=t&&t.type&&t.type.toLowerCase(),i=t&&t.effectiveType&&t.effectiveType.toLowerCase();"slow-2"===i&&(i="2g");var o=r||"unknown";if(n)switch(n){case"cellular":case"wimax":o=i||"unknown";break;case"wifi":o="wifi";break;case"ethernet":o="wired";break;case"none":case"other":case"unknown":o="unknown"}return o}var He={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry|BB10/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},specil:function(){return navigator.userAgent.match(/MicroMessenger/i)},any:function(){return He.Android()||He.BlackBerry()||He.iOS()||He.Opera()||He.Windows()},getOsName:function(){var e="Unknown OS";return He.Android()&&(e="Android"),He.BlackBerry()&&(e="BlackBerry"),He.iOS()&&(e="iOS"),He.Opera()&&(e="Opera Mini"),He.Windows()&&(e="Windows"),{osName:e,type:"mobile"}}};function ze(){var e,t,r=navigator.userAgent.toLocaleLowerCase();if(-1!=r.indexOf("firefox"))e="Firefox";else if(-1!=r.indexOf("trident"))e="IE",-1==r.indexOf("ie")&&(t=11);else if(-1!=r.indexOf("opr"))e="OPR";else if(-1!=r.indexOf("edge"))e="Edge";else if(-1!=r.indexOf("chrome"))e="Chrome";else if(-1!=r.indexOf("safari")){e="Safari";var n=r.match(/(version).*?([\d.]+)/);t=n?n[2]:""}else e="未知浏览器";if(void 0===t){var i=r.match(/(firefox|trident|opr|chrome|safari).*?([\d.]+)/);t=i?i[2]:""}return{browser:e,version:t}}var Ke,Je,qe,Ye,$e,Xe,Qe,Ze,et,tt,rt,nt,it,ot,at=ze(),st=at.browser,ct=at.version;function ut(e){switch(e){case Ze.ForwardStream:return"forward";case Ze.MixedStream:return"mixed"}return""}function dt(e){return"forward"==e?Ze.ForwardStream:"mixed"==e?Ze.MixedStream:Ze.Invalid}function lt(e){switch(e){case rt.Microphone:return"mic";case rt.ScreenShare:return"screen";case rt.File:return"file"}return""}function ht(e){return"mic"==e?rt.Microphone:"screen"==e?rt.ScreenShare:"file"==e?rt.File:rt.Unknown}function pt(e){switch(e){case nt.Camera:return"camera";case nt.ScreenShare:return"screen";case nt.File:return"file"}return""}function ft(e){return"camera"==e?nt.Camera:"screen"==e?nt.ScreenShare:"file"==e?nt.File:nt.Unknown}function mt(e){switch(e){case it.BigStream:return"h";case it.MiddleStream:return"m";case it.SmallStream:return"l"}return""}function vt(e){return"h"==e?it.BigStream:"m"==e?it.MiddleStream:"l"==e?it.SmallStream:it.Invalid}!function(e){e[e.Failed=0]="Failed",e[e.Success=1]="Success",e[e.Timeout=2]="Timeout"}(Ke||(Ke={})),function(e){e[e.Unknown=0]="Unknown",e[e.ActivelyLeave=1]="ActivelyLeave",e[e.RoomDissolved=2]="RoomDissolved",e[e.RepeatLogin=3]="RepeatLogin"}(Je||(Je={})),function(e){e[e.Normal=0]="Normal",e[e.Timeout=1]="Timeout",e[e.Kick=2]="Kick",e[e.RepeatLogin=3]="RepeatLogin",e[e.RoomDissolved=4]="RoomDissolved"}(qe||(qe={})),function(e){e[e.Unknown=0]="Unknown",e[e.Kicked=1]="Kicked",e[e.RepeatLogin=2]="RepeatLogin",e[e.RoomDissolved=3]="RoomDissolved"}(Ye||(Ye={})),function(e){e[e.New=0]="New",e[e.ConnectionConnected=1]="ConnectionConnected",e[e.ConnectionLost=2]="ConnectionLost",e[e.ConnectionRetring=3]="ConnectionRetring",e[e.ConnectionRecovery=4]="ConnectionRecovery"}($e||($e={})),function(e){e[e.ParticipantJoin=0]="ParticipantJoin",e[e.ParticipantLeave=1]="ParticipantLeave",e[e.StreamAdd=2]="StreamAdd",e[e.StreamUpdate=3]="StreamUpdate",e[e.StreamRemove=4]="StreamRemove",e[e.Drop=5]="Drop",e[e.PermissionChange=6]="PermissionChange",e[e.MuteLocal=7]="MuteLocal"}(Xe||(Xe={})),function(e){e[e.AudioMute=0]="AudioMute",e[e.VideoMute=1]="VideoMute",e[e.AudioUnmute=2]="AudioUnmute",e[e.VideoUnmute=3]="VideoUnmute",e[e.Kick=4]="Kick"}(Qe||(Qe={})),function(e){e[e.Invalid=0]="Invalid",e[e.ForwardStream=1]="ForwardStream",e[e.MixedStream=2]="MixedStream"}(Ze||(Ze={})),function(e){e[e.Invalid=0]="Invalid",e[e.AudioOnly=1]="AudioOnly",e[e.VideoOnly=2]="VideoOnly",e[e.AudioVideo=3]="AudioVideo"}(et||(et={})),function(e){e[e.Normal=0]="Normal",e[e.Shadow=1]="Shadow"}(tt||(tt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Microphone=1]="Microphone",e[e.ScreenShare=2]="ScreenShare",e[e.File=3]="File"}(rt||(rt={})),function(e){e[e.Unknown=0]="Unknown",e[e.Camera=1]="Camera",e[e.ScreenShare=2]="ScreenShare",e[e.File=3]="File"}(nt||(nt={})),function(e){e[e.Invalid=0]="Invalid",e[e.BigStream=1]="BigStream",e[e.MiddleStream=2]="MiddleStream",e[e.SmallStream=3]="SmallStream"}(it||(it={})),function(e){e[e.Amute=0]="Amute",e[e.Aunmute=1]="Aunmute",e[e.Vmute=2]="Vmute",e[e.Vunmute=3]="Vunmute"}(ot||(ot={}));var gt={TOP_ERROR:8801,SET_LOG_LEVEL:3001,ENABLE_UPLOAD_LOG:3002,DISABLE_UPLOAD_LOG:3003,JOIN:3004,JOIN_FIRST:8001,JOIN_SUCCESS:1103,JOIN_FAILED:1104,LEAVE:3007,LEAVE_SUCCESS:3008,LEAVE_FAILED:3009,SWITCH_ROLE_ANCHOR:3010,SWITCH_ROLE_AUDIENCE:3011,SWITCH_ROLE_ANCHOR_SUCCESS:3012,SWITCH_ROLE_ANCHOR_FAILED:3013,SWITCH_ROLE_AUDIENCE_SUCCESS:3014,SWITCH_ROLE_AUDIENCE_FAILED:3015,PUBLISH_STREAM:3016,PUBLISH_STREAM_SCREEN:3017,PUBLISH_STREAM_SUCCESS:3018,PUBLISH_STREAM_FAILED:3019,PUBLISH_STREAM_SCREEN_SUCCESS:3020,PUBLISH_STREAM_SCREEN_FAILED:3021,UNPUBLISH_STREAM:3022,UNPUBLISH_STREAM_SCREEN:3023,UNPUBLISH_STREAM_SUCCESS:3024,UNPUBLISH_STREAM_FAILED:3025,UNPUBLISH_STREAM_SCREEN_SUCCESS:3026,UNPUBLISH_STREAM_SCREEN_FAILED:3027,SUBSCRIBE_STREAM:3028,SUBSCRIBE_STREAM_SCREEN:3029,SUBSCRIBE_STREAM_SUCCESS:3030,SUBSCRIBE_STREAM_FAILED:3031,SUBSCRIBE_STREAM_SCREEN_SUCCESS:3032,SUBSCRIBE_STREAM_SCREEN_FAILED:3033,UNSUBSCRIBE_STREAM:3034,UNSUBSCRIBE_STREAM_SCREEN:3035,UNSUBSCRIBE_STREAM_SUCCESS:3036,UNSUBSCRIBE_STREAM_FAILED:3037,UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:3038,UNSUBSCRIBE_STREAM_SCREEN_FAILED:3039,HAS_PUBLISHED_STREAM:3040,GET_CLIENT_STATE:3041,GET_REMOTE_MUTED_STATE:3042,ENABLE_AUDIO_VOLUME_EVALUATION:3043,ENABLE_SMALL_STREAM:3044,DISABLE_SMALL_STREAM:3045,SET_SMALL_STREAM_PROFILE:3046,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL:3047,SET_REMOTE_VIDEO_STREAM_TYPE_BIG:3048,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_SUCCESS:3049,SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_FAILED:3050,SET_REMOTE_VIDEO_STREAM_TYPE_BIG_SUCCESSE:3051,SET_REMOTE_VIDEO_STREAM_TYPE_BIG_FAILED:3052,UPDATE_SIMULCAST:3053,UPDATE_SIMULCAST_SUCCESSE:3054,UPDATE_SIMULCAST_FAILED:3055,PLAY_LOCAL_VIDEO:3056,PLAY_LOCAL_AUDIO:3057,PLAY_LOCAL_VIDEO_SCREEN:3058,PLAY_LOCAL_AUDIO_SCREEN:3059,PLAY_REMOTE_VIDEO:3060,PLAY_REMOTE_AUDIO:3061,PLAY_REMOTE_VIDEO_SCREEN:3062,PLAY_REMOTE_AUDIO_SCREEN:3063,STOP_LOCAL_VIDEO:3064,STOP_LOCAL_AUDIO:3065,STOP_LOCAL_VIDEO_SCREEN:3066,STOP_LOCAL_AUDIO_SCREEN:3067,STOP_REMOTE_VIDEO:3068,STOP_REMOTE_AUDIO:3069,STOP_REMOTE_VIDEO_SCREEN:3070,STOP_REMOTE_AUDIO_SCREEN:3071,RESUME_LOCAL_VIDEO:3072,RESUME_LOCAL_AUDIO:3073,RESUME_LOCAL_VIDEO_SCREEN:3074,RESUME_LOCAL_AUDIO_SCREEN:3075,RESUME_REMOTE_VIDEO:3076,RESUME_REMOTE_AUDIO:3077,RESUME_REMOTE_VIDEO_SCREEN:3078,RESUME_REMOTE_AUDIO_SCREEN:3079,CLOSE_LOCAL_VIDEO:3080,CLOSE_LOCAL_AUDIO:3081,CLOSE_LOCAL_VIDEO_SCREEN:3082,CLOSE_LOCAL_AUDIO_SCREEN:3083,CLOSE_REMOTE_VIDEO:3084,CLOSE_REMOTE_AUDIO:3085,CLOSE_REMOTE_VIDEO_SCREEN:3086,CLOSE_REMOTE_AUDIO_SCREEN:3087,MUTE_LOCAL_AUDIO:3088,MUTE_LOCAL_AUDIO_SCREEN:3089,MUTE_REMOTE_AUDIO:3090,MUTE_REMOTE_AUDIO_SCREEN:3091,MUTE_LOCAL_VIDEO:3092,MUTE_LOCAL_VIDEO_SCREEN:3093,MUTE_REMOTE_VIDEO:3094,MUTE_REMOTE_VIDEO_SCREEN:3095,UNMUTE_LOCAL_AUDIO:3096,UNMUTE_LOCAL_AUDIO_SCREEN:3097,UNMUTE_REMOTE_AUDIO:3098,UNMUTE_REMOTE_AUDIO_SCREEN:3099,UNMUTE_LOCAL_VIDEO:3100,UNMUTE_LOCAL_VIDEO_SCREEN:3101,UNMUTE_REMOTE_VIDEO:3102,UNMUTE_REMOTE_VIDEO_SCREEN:3103,GET_LOCAL_ID:3104,GET_REMOTE_ID:3105,GET_LOCAL_USER_ID:3106,GET_REMOTE_USER_ID:3107,SET_AUDIO_OUTPUT:3108,SET_LOCAL_AUDIO_VOLUME:3109,SET_LOCAL_AUDIO_VOLUME_SCREEN:3110,SET_REMOTE_AUDIO_VOLUME:3111,SET_REMOTE_AUDIO_VOLUME_SCREEN:3112,GET_LOCAL_AUDIO_LEVEL:3113,GET_LOCAL_AUDIO_LEVEL_SCREEN:3114,GET_REMOTE_AUDIO_LEVEL:3115,GET_REMOTE_AUDIO_LEVEL_SCREEN:3116,HAS_LOCAL_AUDIO:3117,HAS_LOCAL_AUDIO_SCREEN:3118,HAS_REMOTE_AUDIO:3119,HAS_REMOTE_AUDIO_SCREEN:3120,HAS_LOCAL_VIDEO:3121,HAS_LOCAL_VIDEO_SCREEN:3122,HAS_REMOTE_VIDEO:3123,HAS_REMOTE_VIDEO_SCREEN:3124,GET_LCOAL_AUDIO_TRACK:3125,GET_LCOAL_AUDIO_TRACK_SCREEN:3126,GET_REMOTE_AUDIO_TRACK:3127,GET_REMOTE_AUDIO_TRACK_SCREEN:3128,GET_LCOAL_VIDEO_TRACK:3129,GET_LCOAL_VIDEO_TRACK_SCREEN:3130,GET_REMOTE_VIDEO_TRACK:3131,GET_REMOTE_VIDEO_TRACK_SCREEN:3132,GET_LCOAL_VIDEO_FRAME:3133,GET_LCOAL_VIDEO_FRAME_SCREEN:3134,GET_REMOTE_VIDEO_FRAME:3135,GET_REMOTE_VIDEO_FRAME_SCREEN:3136,GET_LCOAL_TYPE:3137,GET_REMOTE_TYPE:3138,GET_LOCAL_AUDIO_ELEMENT:3139,GET_LOCAL_AUDIO_ELEMENT_SCREEN:3140,GET_REMOTE_AUDIO_ELEMENT:3141,GET_REMOTE_AUDIO_ELEMENT_SCREEN:3142,GET_LOCAL_VIDEO_ELEMENT:3143,GET_LOCAL_VIDEO_ELEMENT_SCREEN:3144,GET_REMOTE_VIDEO_ELEMENT:3145,GET_REMOTE_VIDEO_ELEMENT_SCREEN:3146,SET_AUDIO_PROFILE:3147,SET_VIDEO_PROFILE:3148,SET_SCREEN_PROFILE:3149,SET_VIDEO_CONTENT_HINT:3150,SWITCH_DEVICE_AUDIO:3151,SWITCH_DEVICE_VIDEO:3152,ADD_AUDIO_TRACK:3153,ADD_AUDIO_TRACK_SCREEN:3154,ADD_VIDEO_TRACK:3155,ADD_VIDEO_TRACK_SCREEN:3156,REMOVE_TRACK:3157,REMOVE_TRACK_SCREEN:3158,REPLACE_AUDIO_TRACK:3159,REPLACE_AUDIO_TRACK_SCREEN:3160,REPLACE_VIDEO_TRACK:3161,REPLACE_VIDEO_TRACK_SCREEN:3162,GET_DEVICES_INFO_IN_USE:3163,ON_STREAM_ADDED:3164,ON_STREAM_ADDED_SCREEN:3165,ON_STREAM_REMOVED:3166,ON_STREAM_REMOVED_SCREEN:3167,ON_STREAM_UPDATED:3168,ON_STREAM_UPDATED_SCREEN:3169,ON_STREAM_SUBSCRIBED:3170,ON_STREAM_SUBSCRIBED_SCREEN:3171,ON_PEER_JOIN:3172,ON_PEER_LEVAE:3173,ON_MUTE_AUDIO:3174,ON_MUTE_AUDIO_SCREEN:3175,ON_MUTE_VIDEO:3176,ON_MUTE_VIDEO_SCREEN:3177,ON_UNMUTE_AUDIO:3178,ON_UNMUTE_AUDIO_SCREEN:3179,ON_UNMUTE_VIDEO:3180,ON_UNMUTE_VIDEO_SCREEN:3181,ON_CLIENT_BANNED:3182,ON_CAMERA_CHANGED:3183,ON_RECORDING_DEVICE_CHANGED:3184,ON_PLAYBACK_DEVICE_CHANGED:3185,ON_ERROR:3186,OFF_STREAM_ADDED:3187,OFF_STREAM_REMOVED:3188,OFF_STREAM_UPDATED:3189,OFF_STREAM_SUBSCRIBED:3190,OFF_CONNECTION_STATE_CHANGED:3191,OFF_PEER_JOIN:3192,OFF_PEER_LEVAE:3193,OFF_MUTE_AUDIO:3194,OFF_MUTE_VIDEO:3195,OFF_UNMUTE_VIDEO:3196,OFF_CLIENT_BANNED:3197,OFF_CAMERA_CHANGED:3198,OFF_RECORDING_DEVICE_CHANGED:3199,OFF_PLAYBACK_DEVICE_CHANGED:3200,OFF_NETWORK_QUALITY:3201,OFF_AUDIO_VOLUME:3202,OFF_ERROR:3203,ON_PLAYER_STATE_CHANGED:3204,ON_SCREEN_SHARING_STOPPED:3205,ON_STREAM_ERROR:3206,CONNECTIONLOST_CB:3207,TRY_TO_RECONNECT_CB:3208,CONNECTION_RECOVERY_CB:3209},yt={VUBIT:2001,VDBIT:2002,AUBIT:2003,ADBIT:2004,VULOSS:2005,VDLOSS:2006,AULOSS:2007,ADLOSS:2008,VURTT:2009,VDRTT:2010,AURTT:2011,ADRTT:2012,VUFPS:2013,VDFPS:2014,AUFPS:2015,ADFPS:2016,VUBLOCK:2017,VDBLOCK:2018,AUBLOCK:2019,ADBLOCK:2020,VUWIDTHHEIGHT:2021,VDWIDTHHEIGHT:2022,APPCPU:2023,SYSCPU:2024};function bt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function St(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?bt(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):bt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Et=St(St({},gt),yt);function Ct(){var e,t,r=navigator.userAgent.toLocaleLowerCase();if(-1!=r.indexOf("firefox"))e="Firefox";else if(-1!=r.indexOf("trident"))e="IE",-1==r.indexOf("ie")&&(t=11);else if(-1!=r.indexOf("opr"))e="OPR";else if(-1!=r.indexOf("edge"))e="Edge";else if(-1!=r.indexOf("chrome"))e="Chrome";else if(-1!=r.indexOf("safari")){var n;e="Safari",n=(n=r.indexOf("version"))+7+1,t=parseInt(r.slice(n,n+3))}else e="未知浏览器";return void 0===t&&(n=(n=r.indexOf(e.toLocaleLowerCase()))+e.length+1,t=parseInt(r.slice(n,n+3))),{browser:e,version:t}}function Tt(){return["RTCPeerConnection","webkitRTCPeerConnection","RTCIceGatherer"].filter((function(e){return e in window})).length>0}function wt(){var e=function(){var e=Ct(),t=e.browser,r=e.version;return"Chrome"===t?r>=74:"Edge"===t?r>=80:"Firefox"===t?r>=66:"OPR"===t?r>=60:"Safari"===t&&r>=13}(),t=Tt(),r=function(){if(!navigator.mediaDevices)return!1;var e=["getUserMedia","enumerateDevices"];return e.filter((function(e){return e in navigator.mediaDevices})).length===e.length}();return new Promise((function(n,i){new Promise((function(e,t){if(Tt()){var r=new RTCPeerConnection;r.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0}).then((function(t){var n=!!t.sdp&&t.sdp.toLowerCase().indexOf("h264")>-1;r.close(),r=null,e(n)}),(function(){Logger.onError({c:Et.TOP_ERROR,v:ke.H264_NOT_SUPPORTED}),t(new Ue({code:ke.H264_NOT_SUPPORTED,message:"h264 not supported"}))})).catch((function(e){Logger.onError({c:Et.TOP_ERROR,v:ke.H264_NOT_SUPPORTED});var r=new Ue({code:ke.H264_NOT_SUPPORTED,message:e.message});t(r)}))}else e(!1)})).then((function(i){n({result:e&&t&&r&&i,detail:{isBrowserSupported:e,isWebRTCSupported:t,isMediaDevicesSupported:r,isH264Supported:i}})}),(function(e){return i(e)}))}))}function _t(){if(!navigator.mediaDevices)throw Logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND}),new Ue({code:ke.DEVICE_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audioinput"!==e.kind||"communications"!=e.deviceId})).map((function(e,t){var r=e.label;e.label||(r=e.kind+"_"+t);var n={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND});var r=new Ue({code:ke.DEVICE_NOT_FOUND,message:e.message});t(r)}))}))}function kt(){if(!navigator.mediaDevices)throw Logger.onError({c:Et.TOP_ERROR,v:ke.CAMERAS_NOT_FOUND}),new Ue({code:ke.CAMERAS_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"videoinput"===e.kind})).map((function(e,t){var r=e.label;e.label||(r="camera_"+t);var n={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:Et.TOP_ERROR,v:ke.CAMERAS_NOT_FOUND});var r=new Ue({code:ke.CAMERAS_NOT_FOUND,message:e.message});t(r)}))}))}function Rt(){if(!navigator.mediaDevices)throw Logger.onError({c:Et.TOP_ERROR,v:ke.MICROPHONES_NOT_FOUND}),new Ue({code:ke.MICROPHONES_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audioinput"===e.kind&&"communications"!==e.deviceId})).map((function(e,t){var r=e.label;e.label||(r="microphone_"+t);var n={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n}));e(r)}),(function(e){t(e)})).catch((function(e){var r=new Ue({code:ke.MICROPHONES_NOT_FOUND,message:e.message});t(r)}))}))}function It(){if(!navigator.mediaDevices)throw Logger.onError({c:Et.TOP_ERROR,v:ke.SPEAKERS_NOT_FOUND}),new Ue({code:ke.SPEAKERS_NOT_FOUND,message:"navigator.mediaDevices is undefined"});return new Promise((function(e,t){navigator.mediaDevices.enumerateDevices().then((function(t){var r=t.filter((function(e){return"audiooutput"===e.kind})).map((function(e,t){var r=e.label;e.label||(r="speaker_"+t);var n={label:r,deviceId:e.deviceId,kind:e.kind};return e.groupId&&(n.groupId=e.groupId),n}));e(r)}),(function(e){t(e)})).catch((function(e){Logger.onError({c:Et.TOP_ERROR,v:ke.SPEAKERS_NOT_FOUND});var r=new Ue({code:ke.SPEAKERS_NOT_FOUND,message:e.message});t(r)}))}))}function Ot(){return!!("captureStream"in HTMLCanvasElement.prototype)}function Pt(){return"Safari"!==Ct().browser}var At=function(){function e(t,r,n,i){le(this,e),this.logger=r,this.streamConfig=t,this.streamId=t.streamId||null,this.mediaStream=t.mediaStream||null,this.type=t.type?t.type:t.screen?Ce:null,this.info=t.info||null,this.mixedInfo=t.mixedInfo||null,this.constraints={audio:t.audio,video:t.video},this.roomId=n||null,this.xsigoClient=i||null,this.isPlaying=!1,this.objectFit="cover",this.muted=!1,this.mirror=t.mirror||!1,this.audioPlayer=null,this.videoPlayer=null,this.audioOutputDeviceId="",this.audioOutputGroupId="",this.audioVolume=1,this.isRemote=!1,this.setUserId(t.userId),this.timer=null,this.waterStreamStream=null,this.waterMarkoptions=null,this.waterMarkVideo=null,this.isWaterMark=!1,this.localId="default",this._emitter=new Se,this.hasAudioTrack=!1,this.hasVideoTrack=!1,this.audioStreamId="",this.videoStreamId="",this.peerConnections=[],this.audioTrackEnabled=!0,this.videoTrackEnabled=!0,this.pcFailedCount=0,this.audioMuted=!0,this.videoMuted=!0,this.backgroundColor="#000000",this.isAlphaChannels=!1,this.virtualBackground=null,this.virtualBackgroundMix=!1,this.waterMarkImage=null,this.isEleLisenter=!0,this.setAudioOutput("default")}var t,r,n,i,o,a;return pe(e,[{key:"setPlayBackground",value:function(e){this.backgroundColor=e}},{key:"play",value:(a=ue(be.mark((function e(t,r){var n,i,o;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isPlaying){e.next=3;break}return this.logger.warn("duplicated play() call observed, please stop() firstly"),e.abrupt("return");case 3:if(this.isPlaying=!0,this.logger.info("stream start to play with options: ".concat(JSON.stringify(r))),i="string"==typeof t?document.getElementById(t):t,document.getElementById("player_".concat(this.userId))?n=document.getElementById("player_".concat(this.userId)):((n=document.createElement("div")).setAttribute("id","player_".concat(this.userId)),n.setAttribute("style","width: 100%; height: 100%; position: relative; background-color:".concat(this.backgroundColor,"; overflow: hidden;")),null===(o=i)||void 0===o||o.appendChild(n)),this.div=n,this.isRemote||(this.muted=!0),r&&void 0!==r.muted&&(this.muted=r.muted),this.isRemote&&this.info.video&&"screen"===this.info.video.source&&(this.objectFit="contain"),r&&void 0!==r.objectFit&&(this.objectFit=r.objectFit),r&&r.hasOwnProperty("isEleLisenter")&&(this.isEleLisenter=r.isEleLisenter),!this.hasVideo()||!this.hasAudio()){e.next=17;break}return this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.PLAY_REMOTE_VIDEO_SCREEN:Et.PLAY_REMOTE_VIDEO:this.type===Ce?Et.PLAY_LOCAL_VIDEO_SCREEN:Et.PLAY_LOCAL_VIDEO,v:this.addUid()}),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.PLAY_REMOTE_AUDIO_SCREEN:Et.PLAY_REMOTE_AUDIO:this.type===Ce?Et.PLAY_LOCAL_AUDIO_SCREEN:Et.PLAY_LOCAL_AUDIO,v:this.addUid()}),e.abrupt("return",(this.playVideo(),this.playAudio()));case 17:if(!this.hasVideo()){e.next=20;break}return this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.PLAY_REMOTE_VIDEO_SCREEN:Et.PLAY_REMOTE_VIDEO:this.type===Ce?Et.PLAY_LOCAL_VIDEO_SCREEN:Et.PLAY_LOCAL_VIDEO,v:this.addUid()}),e.abrupt("return",this.playVideo());case 20:if(!this.hasAudio()){e.next=23;break}return this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.PLAY_REMOTE_AUDIO_SCREEN:Et.PLAY_REMOTE_AUDIO:this.type===Ce?Et.PLAY_LOCAL_AUDIO_SCREEN:Et.PLAY_LOCAL_AUDIO,v:this.addUid()}),e.abrupt("return",this.playAudio());case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"stop",value:function(){this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&(this.logger.info("Stop playing audio and video"),this.audioPlayer&&this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.STOP_REMOTE_AUDIO_SCREEN:Et.STOP_REMOTE_AUDIO:this.type===Ce?Et.STOP_LOCAL_AUDIO_SCREEN:Et.STOP_LOCAL_AUDIO,v:this.addUid()}),this.videoPlayer&&this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.STOP_REMOTE_VIDEO_SCREEN:Et.STOP_REMOTE_VIDEO:this.type===Ce?Et.STOP_LOCAL_VIDEO_SCREEN:Et.STOP_LOCAL_VIDEO,v:this.addUid()}),this.isPlaying=!1,this.stopAudio(),this.stopVideo(),this.div.parentNode&&this.div.parentNode.removeChild(this.div))}},{key:"resume",value:(o=ue(be.mark((function e(){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&(this.logger.info("stream - resume"),this.audioPlayer&&(this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.RESUME_REMOTE_AUDIO_SCREEN:Et.RESUME_REMOTE_AUDIO:this.type===Ce?Et.RESUME_LOCAL_AUDIO_SCREEN:Et.RESUME_LOCAL_AUDIO,v:this.addUid()}),this.audioPlayer.resume()),this.videoPlayer&&(this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.RESUME_REMOTE_VIDEO_SCREEN:Et.RESUME_REMOTE_VIDEO:this.type===Ce?Et.RESUME_LOCAL_VIDEO_SCREEN:Et.RESUME_LOCAL_VIDEO,v:this.addUid()}),this.videoPlayer.resume()));case 2:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"close",value:function(){this.logger.info("is playing:"+this.isPlaying),this.isPlaying&&this.stop(),this.mediaStream&&(this.mediaStream.getTracks().forEach((function(e){e.stop()})),this.mediaStream=null)}},{key:"muteAudio",value:function(){return!(!this.mediaStream||!this.audioTrackEnabled)&&(this.logger.info("mute audio"),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.MUTE_REMOTE_AUDIO_SCREEN:Et.MUTE_REMOTE_AUDIO:this.type===Ce?Et.MUTE_LOCAL_AUDIO_SCREEN:Et.MUTE_LOCAL_AUDIO,v:this.addUid()}),this.addRemoteEvent(Qe.AudioMute),this.doEnableTrack("audio",!1))}},{key:"muteVideo",value:function(){return!(!this.mediaStream||!this.videoTrackEnabled)&&(this.logger.info("mute video"),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.MUTE_REMOTE_VIDEO_SCREEN:Et.MUTE_REMOTE_VIDEO:this.type===Ce?Et.MUTE_LOCAL_VIDEO_SCREEN:Et.MUTE_LOCAL_VIDEO,v:this.addUid()}),this.isAlphaChannels&&this.videoPlayer.mute(),this.addRemoteEvent(Qe.VideoMute),this.doEnableTrack("video",!1))}},{key:"unmuteAudio",value:function(){return!(!this.mediaStream||this.audioTrackEnabled)&&(this.logger.info("unmute audio"),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.UNMUTE_REMOTE_AUDIO_SCREEN:Et.UNMUTE_REMOTE_AUDIO:this.type===Ce?Et.UNMUTE_LOCAL_AUDIO_SCREEN:Et.UNMUTE_LOCAL_AUDIO,v:this.addUid()}),this.addRemoteEvent(Qe.AudioUnmute),this.doEnableTrack("audio",!0))}},{key:"unmuteVideo",value:function(){return!(!this.mediaStream||this.videoTrackEnabled)&&(this.logger.info("unmute video"),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.UNMUTE_REMOTE_VIDEO_SCREEN:Et.UNMUTE_REMOTE_VIDEO:this.type===Ce?Et.UNMUTE_LOCAL_VIDEO_SCREEN:Et.UNMUTE_LOCAL_VIDEO,v:this.addUid()}),this.isAlphaChannels&&this.videoPlayer.unmute(),this.addRemoteEvent(Qe.VideoUnmute),this.doEnableTrack("video",!0))}},{key:"updateTrack",value:function(e,t){var r;(r="audio"===e?this.getAudioTrack():this.getVideoTrack())&&this.mediaStream.removeTrack(r),this.mediaStream.addTrack(t)}},{key:"doEnableTrack",value:function(e,t){var r=!1;return"audio"===e?this.mediaStream.getAudioTracks().forEach((function(e){r=!0,e.enabled=t})):this.mediaStream.getVideoTracks().forEach((function(e){r=!0,e.enabled=t})),this.setEnableTrackFlag(e,t),r}},{key:"setEnableTrackFlag",value:function(e,t){"audio"===e?this.audioTrackEnabled=t:this.videoTrackEnabled=t}},{key:"addRemoteEvent",value:function(e,t){var r=this;return new Promise((function(n,i){if(!r.isRemote){var o=function(e,t,r){1===e&&n(!0),0===e&&i(!1)};if(r.xsigoClient)switch(e){case Qe.AudioMute:r.xsigoClient.muteAudio(r.roomId,r.audioStreamId,o,t);break;case Qe.VideoMute:r.xsigoClient.muteVideo(r.roomId,r.videoStreamId,o,t);break;case Qe.AudioUnmute:r.xsigoClient.unmuteAudio(r.roomId,r.audioStreamId,o,t);break;case Qe.VideoUnmute:r.xsigoClient.unmuteVideo(r.roomId,r.videoStreamId,o,t)}else r.logger.info("not xsigoClient")}}))}},{key:"getId",value:function(){return this.streamId||""}},{key:"getUserId",value:function(){return"main"===this.type?this.userId:this.userId.replace("share_","")}},{key:"setUserId",value:function(e){if(this.streamConfig.screen)return this.userId="share_".concat(e);this.userId=e}},{key:"setAudioOutput",value:function(e){this.audioOutputDeviceId=e,this.logger.info("setAudioOutput deviceId",this.userId,e),this.logger.buriedLog({c:Et.SET_AUDIO_OUTPUT,v:"deviceId:".concat(e,",uid:").concat(this.userId)}),this.audioPlayer&&this.audioPlayer.setSinkId(e)}},{key:"getInuseSpeaker",value:(i=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.buriedLog({c:Et.GET_DEVICES_INFO_IN_USE,v:"speaker:".concat(this.audioOutputDeviceId)}),!this.audioOutputDeviceId){e.next=6;break}return e.next=4,It();case 4:this.audioOutputGroupId=e.sent.filter((function(e){return e.deviceId===t.audioOutputDeviceId}))[0].groupId||"";case 6:return e.abrupt("return",{speaker:{deviceId:this.audioOutputDeviceId,groupId:this.audioOutputGroupId}});case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"setAudioVolume",value:function(e){this.audioVolume=e,this.logger.info("setAudioVolume to ".concat(e.toString())),this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.SET_REMOTE_AUDIO_VOLUME_SCREEN:Et.SET_REMOTE_AUDIO_VOLUME:this.type===Ce?Et.SET_LOCAL_AUDIO_VOLUME_SCREEN:Et.SET_LOCAL_AUDIO_VOLUME,v:"volume:".concat(e)}),this.audioPlayer&&this.audioPlayer.setVolume(e)}},{key:"getAudioLevel",value:function(){return this.audioPlayer?this.audioPlayer.getAudioLevel():0}},{key:"setHasAudio",value:function(e){this.hasAudioTrack=e}},{key:"hasAudio",value:function(){return!!this.checkMediaStream()&&this.hasAudioTrack}},{key:"setHasVideo",value:function(e){this.hasVideoTrack=e}},{key:"hasVideo",value:function(){return!!this.checkMediaStream()&&this.hasVideoTrack}},{key:"getAudioTrack",value:function(){var e=null;if(this.checkMediaStream()){var t=this.mediaStream.getAudioTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoTrack",value:function(){var e=null;if(this.checkMediaStream()){var t=this.mediaStream.getVideoTracks();t.length>0&&(e=t[0])}return e}},{key:"getVideoFrame",value:function(){return this.logger.buriedLog({c:this.isRemote?this.type===Ce?Et.GET_REMOTE_VIDEO_FRAME_SCREEN:Et.GET_REMOTE_VIDEO_FRAME:this.type===Ce?Et.GET_LCOAL_VIDEO_FRAME_SCREEN:Et.GET_LCOAL_VIDEO_FRAME}),this.videoPlayer?this.videoPlayer.getVideoFrame():null}},{key:"on",value:function(e,t){this._emitter.on(e,t)}},{key:"playAudio",value:(n=ue(be.mark((function e(){var t,r=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getAudioTrack(),!this.audioPlayer&&t){e.next=3;break}return e.abrupt("return");case 3:return this.logger.info("stream - create AudioPlayer and play"),this.audioPlayer=new je({stream:this,track:t,div:this.div,muted:this.muted,volume:this.audioVolume,deviceId:this.audioOutputDeviceId}),this.audioPlayer._emitter.on("player-state-changed",(function(e){r._emitter.emit("player-state-changed",{type:"audio",state:e.state,reason:e.reason}),"track"===e.type&&r._emitter.emit("track-state-changed",{type:"audio",state:e.state,reason:e.reason})})),e.abrupt("return",new Promise((function(e,t){r.audioPlayer.play().then((function(){e()})).catch((function(e){if(r.logger.warn("<audio> play() error:"+e),(e.toString()+" <audio>").startsWith("NotAllowedError")){r.logger.onError({c:Et.TOP_ERROR,v:ke.PLAY_NOT_ALLOWED});var n=new Ue({code:ke.PLAY_NOT_ALLOWED,message:e.message});r.logger.buriedLog({c:Et.ON_STREAM_ERROR,v:"code:".concat(ke.PLAY_NOT_ALLOWED)}),r._emitter.emit(Te,n),t(n)}}))})));case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getWaterStreamStream",value:(r=ue(be.mark((function e(t){var r,n,i,o,a,s,c,u,d,l=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.mediaStream,this.waterMarkVideo=document.createElement("video"),this.waterMarkVideo.srcObject=r,e.next=5,this.waterMarkVideo.play();case 5:return n=r.getVideoTracks()[0],i=document.createElement("canvas"),o=i.getContext("2d"),a=n.getSettings(),this.logger.info("settings frameRate ====>",1e3/a.frameRate),s=Math.floor(1e3/15),u=Date.now(),i.width=a.width,i.height=a.height,function e(){var r=n.getSettings().frameRate;r&&(s=Math.floor(1e3/r)),s<1e3/15&&(s=Math.floor(1e3/15)),l.timer&&cancelAnimationFrame(l.timer),l.timer=requestAnimationFrame(e),c=Date.now(),(d=c-u)>s&&(u=c-d/s,o.drawImage(l.waterMarkVideo,0,0,i.width,i.height),o.drawImage(t,0,0,a.width,a.height))}(),this.waterStreamStream=i.captureStream(),e.abrupt("return",this.waterStreamStream);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"startWaterMark",value:function(e,t){var r=this;return this.logger.info(this.userId+" startWaterMark",e),new Promise(function(){var n=ue(be.mark((function n(i,o){var a,s;return be.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!r.waterStreamStream){n.next=2;break}return n.abrupt("return",o("waterMark is starting"));case 2:if(r.waterMarkoptions=e,r.waterMarkImage=t,r.type===Ce&&r.isRemote){n.next=6;break}return n.abrupt("return",o("waterMark is only support remoteStream and screenShare"));case 6:if(!r.videoPlayer){n.next=17;break}return n.next=9,r.getWaterStreamStream(t);case 9:a=n.sent.getVideoTracks()[0],(s=new MediaStream).addTrack(a),r.getVideoElement().srcObject=s,n.next=18;break;case 17:r.isWaterMark=!0;case 18:i();case 19:case"end":return n.stop()}}),n)})));return function(e,t){return n.apply(this,arguments)}}())}},{key:"closeWaterMark",value:function(){if(this.waterStreamStream&&(this.logger.info(this.userId+" closeWaterMark"),this.isWaterMark=!1,this.waterStreamStream=null,this.waterMarkImage=null,this.waterMarkoptions=null,this.timer&&(cancelAnimationFrame(this.timer),this.timer=null),this.waterMarkVideo&&(this.waterMarkVideo.srcObject=null,this.waterMarkVideo=null),this.isPlaying)){var e=this.getVideoElement(),t=this.getVideoTrack(),r=new MediaStream;r.addTrack(t),e.srcObject=r}}},{key:"setLocalUserId",value:function(e){this.localId=e}},{key:"playVideo",value:(t=ue(be.mark((function e(){var t,r=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this.getVideoTrack(),!this.videoPlayer&&t){e.next=3;break}return e.abrupt("return");case 3:if(!this.isWaterMark){e.next=8;break}return e.next=6,this.getWaterStreamStream(this.waterMarkImage);case 6:t=e.sent.getVideoTracks()[0];case 8:return this.logger.info("stream - create VideoPlayer and play"),this.videoPlayer=new Be({stream:this,track:t,div:this.div,muted:this.muted,objectFit:this.objectFit,mirror:this.mirror,isAlphaChannels:this.isAlphaChannels,virtualBackground:this.virtualBackground,virtualBackgroundMix:this.virtualBackgroundMix,isEleLisenter:this.isEleLisenter}),this.videoPlayer._emitter.on("player-state-changed",(function(e){r._emitter.emit("player-state-changed",{type:"video",state:e.state,reason:e.reason}),"track"===e.type&&r._emitter.emit("track-state-changed",{type:"video",state:e.state,reason:e.reason})})),e.abrupt("return",new Promise((function(e,t){r.videoPlayer.play().then((function(){e()})).catch((function(e){if(r.logger.warn("<video> play() error:"+e),(e.toString()+" <video>").startsWith("NotAllowedError")){r.logger.onError({c:Et.TOP_ERROR,v:ke.PLAY_NOT_ALLOWED});var n=new Ue({code:ke.PLAY_NOT_ALLOWED,message:e.message});r.logger.buriedLog({c:Et.ON_STREAM_ERROR,v:"code:".concat(ke.PLAY_NOT_ALLOWED)}),r._emitter.emit(Te,n),t(n)}}))})));case 12:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"stopAudio",value:function(){this.audioPlayer&&(this.logger.info("stream - stop AudioPlayer"),this.audioPlayer.stop(),this.audioPlayer=null)}},{key:"stopVideo",value:function(){this.videoPlayer&&(this.logger.info("stream - stop VideoPlayer"),this.videoPlayer.stop(),this.videoPlayer=null)}},{key:"checkMediaStream",value:function(){return!!this.mediaStream}},{key:"restartAudio",value:function(){this.isPlaying&&(this.stopAudio(),this.playAudio())}},{key:"restartVideo",value:function(){this.isPlaying&&(this.stopVideo(),this.playVideo())}},{key:"setMediaStream",value:function(e){this.mediaStream=e}},{key:"setSimulcasts",value:function(e){this.info.video.simulcast=e}},{key:"getSimulcasts",value:function(){try{return this.info.video.simulcast||[]}catch(e){return[]}}},{key:"setInfo",value:function(e){this.info=e}},{key:"getType",value:function(){return this.type||"main"}},{key:"getAudioElement",value:function(){return this.audioPlayer&&this.audioPlayer.getAudioElement()}},{key:"getVideoElement",value:function(){return this.videoPlayer&&this.videoPlayer.getVideoElement()}},{key:"setAudioTrack",value:function(e){e.enabled=this.audioTrackEnabled,this.audioPlayer?this.audioPlayer.setAudioTrack(e):this.playAudio()}},{key:"setVideoTrack",value:function(e){e.enabled=this.videoTrackEnabled,this.videoPlayer?this.videoPlayer.setVideoTrack(e):this.playVideo()}},{key:"setAudioStreamId",value:function(e){this.audioStreamId=e}},{key:"setVideoStreamId",value:function(e){this.videoStreamId=e}},{key:"addUid",value:function(){if(this.isRemote)return"uid:".concat(this.getUserId())}},{key:"getAudioMuted",value:function(){return this.getAudioTrack()&&!this.audioTrackEnabled||this.audioMuted}},{key:"getVideoMuted",value:function(){return this.getVideoTrack()&&!this.videoTrackEnabled||this.videoMuted}},{key:"updatePeerConnectionFailed",value:function(e){if("failed"===e){this.pcFailedCount++,this.logger.onError({c:Et.TOP_ERROR,v:ke.RTCPEERCONNECTION_SATE_FAILED});var t=new Ue({code:ke.RTCPEERCONNECTION_SATE_FAILED,message:'{"count":'.concat(this.pcFailedCount,"}")});this._emitter.emit(Te,t),this.logger.warn("updatePeerConnectionFailed,count:".concat(this.pcFailedCount))}else"connected"===e&&0!==this.pcFailedCount&&(this.pcFailedCount=0)}},{key:"setMutedState",value:function(e,t){"audio"===e?this.audioMuted=t:"video"===e&&(this.videoMuted=t)}},{key:"setIsAlphaChannels",value:function(e){this.logger.info("set isAlphaChannels",e),this.isAlphaChannels=e}},{key:"hasAlphaChannels",value:function(){return this.isAlphaChannels}},{key:"setVirtualBackground",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.virtualBackground?(this.logger.warn("The virtual background has already been set"),!1):["IMG","VIDEO"].includes(e.nodeName)?(this.logger.info("set virtual background,element:".concat(e.nodeName,",mix:").concat(t)),this.virtualBackground=e,this.virtualBackgroundMix="VIDEO"===e.nodeName||t,!0):(this.logger.warn("Element must be img or video"),!1)}},{key:"resize",value:function(){return this.isAlphaChannels?this.videoPlayer?void this.videoPlayer.resize():(this.logger.warn("Please play video first"),!1):(this.logger.warn("Please start the stream containing alpha channel first"),!1)}}]),e}(),xt=new Map;xt.set("standard",{sampleRate:48e3,channelCount:1,bitrate:40}),xt.set("high",{sampleRate:48e3,channelCount:1,bitrate:128});var Lt=new Map;Lt.set("120p",{width:160,height:120,frameRate:15,bitrate:200}),Lt.set("180p",{width:320,height:180,frameRate:15,bitrate:350}),Lt.set("240p",{width:320,height:240,frameRate:15,bitrate:400}),Lt.set("360p",{width:640,height:360,frameRate:15,bitrate:800}),Lt.set("480p",{width:640,height:480,frameRate:15,bitrate:900}),Lt.set("720p",{width:1280,height:720,frameRate:15,bitrate:1500}),Lt.set("1080p",{width:1920,height:1080,frameRate:15,bitrate:2e3}),Lt.set("1440p",{width:2560,height:1440,frameRate:30,bitrate:4860}),Lt.set("4K",{width:3840,height:2160,frameRate:30,bitrate:9e3});var Mt=new Map;function Dt(e){return("function"==typeof Symbol&&"symbol"==Oe(Symbol.iterator)?function(e){return Oe(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":Oe(e)})(e)}Mt.set("480p",{width:640,height:480,frameRate:5,bitrate:900}),Mt.set("480p_2",{width:640,height:480,frameRate:30,bitrate:1e3}),Mt.set("720p",{width:1280,height:720,frameRate:5,bitrate:1200}),Mt.set("720p_2",{width:1280,height:720,frameRate:30,bitrate:3e3}),Mt.set("1080p",{width:1920,height:1080,frameRate:5,bitrate:1600}),Mt.set("1080p_2",{width:1920,height:1080,frameRate:30,bitrate:4e3});var Ut,Nt=window.navigator&&window.navigator.userAgent||"",jt=/Edge\//i.test(Nt),Vt=(Ut=Nt.match(/Chrome\/(\d+)/))&&Ut[1]?parseFloat(Ut[1]):null;function Ft(e,t){return new Promise((function(r,n){var i=document.createElement("canvas"),o=i.getContext("2d");i.width=1920,i.height=1080;var a=document.createElement("canvas");a.width=400,a.height=200,a.style.border="1px solid";var s=a.getContext("2d");s.rotate(-20*Math.PI/180),s.font="".concat(e.fontSize,"px ").concat(e.fontType),s.fillStyle=e.fontColor,s.textBaseline="middle",s.fillText(t,0,90);var c=new Image;c.src=a.toDataURL("image/png"),c.onload=function(){o.fillStyle=o.createPattern(c,"repeat"),o.fillRect(0,0,i.width,i.height);var e=new Image;return e.src=i.toDataURL("image/png"),r(e)}}))}function Wt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Bt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Wt(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Wt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Gt=function(){Ie(o,At);var e,t,r,n,i=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=xe(e);if(t){var i=xe(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Ae(this,r)}}(o);function o(e,t){var r;return le(this,o),(r=i.call(this,e,t)).screen=e.screen,r.audioProfile=xt.get("standard"),r.videoProfile=Lt.get("480p"),r.screenProfile=Mt.get("1080p"),r.bitrate={audio:r.audioProfile.bitrate,video:r.screen?r.screenProfile.bitrate:r.videoProfile.bitrate},r.cameraId_=e.cameraId||"",r.cameraGroupId_="",r.microphoneId_=e.microphoneId||"",r.microphoneGroupId_="",r.cameraLabel_="",r.microphoneLabel_="",r.recoverCaptureCount_=0,r.published=!1,r.audioPubState=ve.Create,r.videoPubState=ve.Create,r._emitter.on("track-state-changed",r.onTrackStopped.bind(Pe(r))),r}return pe(o,[{key:"initialize",value:(n=ue(be.mark((function e(t){var r=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.logger.info("initialize stream audio: ".concat(this.constraints.audio," video: ").concat(this.constraints.video)),e.abrupt("return",new Promise((function(e,n){return r.screen?r.initShareStream({audio:r.streamConfig.audio,screenAudio:r.streamConfig.screenAudio,microphoneId:r.microphoneId_,width:r.screenProfile.width,height:r.screenProfile.height,frameRate:r.screenProfile.frameRate,sampleRate:r.audioProfile.sampleRate,channelCount:r.audioProfile.channelCount,customStream:t}).then((function(t){r.mediaStream=t;var n=t.getAudioTracks().length>0,i=t.getVideoTracks().length>0;r.setHasAudio(n),r.setHasVideo(i),r.setMutedState("audio",!n),r.setMutedState("video",!i),r.listenForScreenSharingStopped(t.getVideoTracks()[0]),r.setVideoContentHint("detail"),r.updateDeviceIdInUse(),e(t),r.logger.info("init share stream success")})).catch((function(e){r.logger.onError({c:Et.TOP_ERROR,v:ke.INIT_STREAM_FAILED},"init share stream failed,".concat(e.name,":").concat(e.message));var t=new Ue({code:ke.INIT_STREAM_FAILED,message:e.message,name:e.name});n(t)})):r.initAvStream({audio:r.streamConfig.audio,video:r.streamConfig.video,facingMode:r.streamConfig.facingMode,cameraId:r.cameraId_,microphoneId:r.microphoneId_,width:r.videoProfile.width,height:r.videoProfile.height,frameRate:r.videoProfile.frameRate,sampleRate:r.audioProfile.sampleRate,channelCount:r.audioProfile.channelCount,customStream:t}).then((function(t){r.mediaStream=t;var n=t.getAudioTracks().length>0,i=t.getVideoTracks().length>0;r.setHasAudio(n),r.setHasVideo(i),r.setMutedState("audio",!n),r.setMutedState("video",!i),r.updateDeviceIdInUse(),r.videoSetting=i&&t.getVideoTracks()[0].getSettings(),e(t),r.logger.info("init local stream success")})).catch((function(e){r.logger.onError({c:Et.TOP_ERROR,v:ke.INIT_STREAM_FAILED},"init localstream failed,".concat(e.name,":").concat(e.message));var t=new Ue({code:ke.INIT_STREAM_FAILED,message:e.message,name:e.name});n(t)})).finally(ue(be.mark((function e(){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,_t();case 2:r.logger.info("mediaDevices",JSON.stringify(e.sent,null,4));case 4:case"end":return e.stop()}}),e)}))))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"initAvStream",value:(r=ue(be.mark((function e(t){var r,n,i,o,a,s;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.customStream){e.next=2;break}return e.abrupt("return",Promise.resolve(t.customStream));case 2:if(navigator.mediaDevices){e.next=5;break}return this.logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND},"navigator.mediaDevices is undefined"),e.abrupt("return",Promise.reject());case 5:if(n={audio:t.audio,video:t.video},!t.audio){e.next=20;break}return e.next=9,Rt();case 9:if(0!==(r=e.sent).length){e.next=15;break}throw this.logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND}),new Ue({code:ke.DEVICE_NOT_FOUND,message:"no microphone detected, but you are trying to get audio stream, please check your microphone and the configeration on XRTC.createStream."});case 15:(i=r.filter((function(e){return e.deviceId.length>0}))).length>0&&(o=i[0].deviceId),(a=r.filter((function(e){return"default"===e.deviceId}))).length>0&&(s=a[0].deviceId),n.audio={deviceId:{exact:t.microphoneId||s||o},echoCancellation:!0,autoGainControl:!0,noiseSuppression:!0,sampleRate:t.sampleRate,channelCount:t.channelCount};case 20:if(!t.video){e.next=32;break}return e.next=23,kt();case 23:if(0!==e.sent.length){e.next=29;break}throw this.logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND}),new Ue({code:ke.DEVICE_NOT_FOUND,message:"no camera detected, but you are trying to get video stream, please check your camera and the configeration on XRTC.createStream."});case 29:n.video={width:t.width,height:t.height,frameRate:t.frameRate},t.cameraId&&(n.video=Bt(Bt({},n.video),{},{deviceId:{exact:t.cameraId}})),t.facingMode&&(n.video=Bt(Bt({},n.video),{},{facingMode:t.facingMode}));case 32:return e.abrupt("return",navigator.mediaDevices.getUserMedia(n));case 33:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"initShareStream",value:function(e){if(e.customStream)return Promise.resolve(e.customStream);if(!navigator.mediaDevices)return this.logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_NOT_FOUND},"navigator.mediaDevices is undefined"),Promise.reject();if(e.screenAudio)jt||Vt<74?this.logger.onError({c:Et.TOP_ERROR,v:ke.BROWSER_NOT_SUPPORTED},"Your browser not support capture system audio"):e.audioConstraints={echoCancellation:!0,noiseSuppression:!0,sampleRate:44100};else if(e.audio){var t={audio:e.microphoneId?{deviceId:{exact:e.microphoneId},sampleRate:e.sampleRate,channelCount:e.channelCount}:{sampleRate:e.sampleRate,channelCount:e.channelCount},video:!1},r=this.setConstraints(e);return this.logger.info("getDisplayMedia with contraints1: "+JSON.stringify(r)),new Promise(function(){var e=ue(be.mark((function e(n,i){var o;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,navigator.mediaDevices.getDisplayMedia(r);case 3:o=e.sent,navigator.mediaDevices.getUserMedia(t).then((function(e){o.addTrack(e.getAudioTracks()[0]),n(o)})),e.next=10;break;case 7:e.prev=7,e.t0=e.catch(0),i(e.t0);case 10:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r){return e.apply(this,arguments)}}())}var n=this.setConstraints(e);return this.logger.info("getDisplayMedia with contraints2: "+JSON.stringify(n)),navigator.mediaDevices.getDisplayMedia(n)}},{key:"setAudioProfile",value:function(e){var t;this.mediaStream?this.logger.warn("Please set audio profile before initialize!"):("object"===Dt(e)?t=e:void 0===(t=xt.get(e))&&(t=xt.get("standard")),this.logger.info("setAudioProfile: "+JSON.stringify(t)),this.logger.buriedLog({c:Et.SET_AUDIO_PROFILE,v:JSON.stringify(t)}),this.audioProfile=t,this.bitrate.audio=t.bitrate)}},{key:"setVideoProfile",value:(t=ue(be.mark((function e(t){var r;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.mediaStream){e.next=3;break}return this.logger.warn("Please set video profile before initialize!"),e.abrupt("return");case 3:"object"===Dt(t)?r=t:void 0===(r=Lt.get(t))&&(r=Lt.get("480p")),this.logger.info("setVideoProfile "+JSON.stringify(r)),this.logger.buriedLog({c:Et.SET_VIDEO_PROFILE,v:JSON.stringify(r)}),this.videoProfile=r,this.bitrate.video=r.bitrate;case 8:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"setScreenProfile",value:function(e){var t;this.mediaStream?this.logger.warn("Please set screen profile before initialize!"):("object"===Dt(e)?t=e:void 0===(t=Mt.get(e))&&(t=Mt.get("1080p_2")),this.logger.info("setScreenProfile "+JSON.stringify(t)),this.logger.buriedLog({c:Et.SET_SCREEN_PROFILE,v:JSON.stringify(t)}),this.screenProfile=t,this.bitrate.video=t.bitrate)}},{key:"setConstraints",value:function(e){var t={};return t.video={width:e.width,height:e.height,frameRate:e.frameRate},void 0!==e.audioConstraints&&(t.audio=e.audioConstraints),this.constraints=t,t}},{key:"getBitrate",value:function(){return this.bitrate}},{key:"addTrack",value:function(e){var t=this;if(!this.mediaStream)throw this.logger.onError({c:Et.TOP_ERROR,v:ke.ADD_TRACK_FAILED}),new Ue({code:ke.ADD_TRACK_FAILED,message:"the local stream is not initialized yet"});if("audio"===e.kind&&this.getAudioTracks().length>0||"video"===e.kind&&this.getVideoTracks().length>0)throw this.logger.onError({c:Et.TOP_ERROR,v:ke.ADD_TRACK_FAILED}),new Ue({code:ke.ADD_TRACK_FAILED,message:"A Stream has at most one audio track and one video track"});var r=e.getSettings();return"video"===e.kind&&r&&this.videoSetting&&(r.width!==this.videoSetting.width||r.height!==this.videoSetting.height)&&this.logger.warn("video resolution of the track ".concat(r.width," x ").concat(r.height," shall be kept the same as the previous: ").concat(this.videoSetting.width," x ").concat(this.videoSetting.height)),new Promise((function(n,i){t._emitter.once("stream-track-update-result",(function(e){var r=e.code,o=e.message;if(t.logger.info("add track response",r),1===r)n(!0);else{t.logger.onError({c:Et.TOP_ERROR,v:ke.ADD_TRACK_FAILED});var a=new Ue({code:ke.ADD_TRACK_FAILED,message:o||"add track failed"});i(a)}})),"video"===e.kind?(t.cameraId_=r.deviceId,t.cameraGroupId_=r.groupId):"audio"===e.kind&&(t.microphoneId_=r.deviceId,t.microphoneGroupId_=r.groupId),t.setEnableTrackFlag(e.kind,e.enabled),t.logger.buriedLog({c:"audio"===e.kind?t.type===Ce?Et.ADD_AUDIO_TRACK_SCREEN:Et.ADD_AUDIO_TRACK:t.type===Ce?Et.ADD_VIDEO_TRACK_SCREEN:Et.ADD_VIDEO_TRACK}),t._emitter.emit("stream-add-track",{track:e,streamId:t.streamId})}))}},{key:"removeTrack",value:function(e){var t=this;if(e&&"audio"===e.kind)throw this.logger.onError({c:Et.TOP_ERROR,v:ke.INVALID_PARAMETER}),new Ue({code:ke.INVALID_PARAMETER,message:"remove audio track is not supported"});if(!this.mediaStream)throw new Ue({code:ke.INVALID_OPERATION,message:"the local stream is not initialized yet"});if(-1===this.mediaStream.getTracks().indexOf(e))throw this.logger.onError({c:Et.TOP_ERROR,v:ke.INVALID_PARAMETER}),new Ue({code:ke.INVALID_PARAMETER,message:"the track to be removed is not being publishing"});if(!this.supportPC())throw new Ue({code:ke.INVALID_OPERATION,message:"removeTrack is not supported in this browser"});return this.logger.info("remove video track from current published stream"),new Promise((function(r,n){t._emitter.once("stream-track-update-result",(function(e){var i=e.code,o=e.message;if(t.logger.info("remove track response",i),1===i)r(!0);else{t.logger.onError({c:Et.TOP_ERROR,v:ke.REMOVE_TRACK_FAILED});var a=new Ue({code:ke.REMOVE_TRACK_FAILED,message:o||"remove track failed"});n(a)}})),t.logger.buriedLog({c:t.type===Ce?Et.REMOVE_TRACK_SCREEN:Et.REMOVE_TRACK}),t._emitter.emit("stream-remove-track",{track:e,streamId:t.streamId})}))}},{key:"replaceTrack",value:function(e){if(!this.mediaStream)throw new Ue({code:ke.INVALID_OPERATION,message:"the local stream is not initialized yet"});var t=e.getSettings();if("video"===e.kind&&t&&this.videoSetting&&(t.width!==this.videoSetting.width||t.height!==this.videoSetting.height)&&this.logger.warn("video resolution of the track ".concat(t.width," x ").concat(t.height," shall be kept the same as the previous: ").concat(this.videoSetting.width," x ").concat(this.videoSetting.height)),"audio"===e.kind?(this.mediaStream.removeTrack(this.getAudioTrack()),this.mediaStream.addTrack(e),e.enabled=!this.getAudioMuted(),this.restartAudio()):(this.mediaStream.removeTrack(this.getVideoTrack()),this.mediaStream.addTrack(e),e.enabled=!this.getVideoMuted(),this.restartVideo()),!this.isReplaceTrackAvailable()||!this.supportPC())throw new Ue({code:ke.INVALID_OPERATION,message:"replaceTrack is not supported in this browser, please use switchDevice or addTrack instead"});this.logger.buriedLog({c:"audio"===e.kind?this.type===Ce?Et.REPLACE_AUDIO_TRACK_SCREEN:Et.REPLACE_AUDIO_TRACK:this.type===Ce?Et.REPLACE_VIDEO_TRACK_SCREEN:Et.REPLACE_VIDEO_TRACK}),this._emitter.emit("stream-replace-track",{streamId:this.streamId,type:e.kind,track:e})}},{key:"setVideoContentHint",value:function(e){var t=this.getVideoTrack();t&&"contentHint"in t&&(this.logger.info("set video track contentHint to: "+e),t.contentHint=e,t.contentHint!==e&&this.logger.info("Invalid video track contentHint: "+e),this.logger.buriedLog({c:Et.SET_VIDEO_CONTENT_HINT,v:"hint".concat(e)}))}},{key:"switchDevice",value:function(e,t){var r,n,i=this;if(this.screen)throw new Ue({code:ke.INVALID_OPERATION,message:"switch device is not supported in screen sharing"});if(!t||this.streamConfig.audioSource||this.streamConfig.videoSource)return Promise.reject();if("audio"===e&&this.microphoneId_===t||"video"===e&&this.cameraId_===t)return this.logger.warn("switch device is not supported same device"),Promise.reject("switch device is not supported same device");if(this.logger.info("switchDevice "+e+" to: "+t),"audio"===e&&this.microphoneId_!==t){if(!(r=this.getAudioTrack()))return this.microphoneId_=t,Promise.resolve();r&&r.stop(),this.microphoneId_=t,this.logger.buriedLog({c:Et.SWITCH_DEVICE_AUDIO,v:"deviceId:".concat(t)})}if("video"===e&&this.cameraId_!==t){if(!(n=this.getVideoTrack()))return this.cameraId_=t,Promise.resolve();n&&n.stop(),this.cameraId_=t,this.logger.buriedLog({c:Et.SWITCH_DEVICE_VIDEO,v:"deviceId:".concat(t)})}return new Promise((function(t,o){i.initAvStream({audio:"audio"===e,video:"video"===e,facingMode:i.streamConfig.facingMode,cameraId:i.cameraId_,microphoneId:i.microphoneId_,width:i.videoProfile.width,height:i.videoProfile.height,frameRate:i.videoProfile.frameRate,sampleRate:i.audioProfile.sampleRate,channelCount:i.audioProfile.channelCount}).then((function(o){"audio"===e&&(i.mediaStream.removeTrack(r),(r=o.getAudioTracks()[0])&&i.mediaStream.addTrack(r),r&&i.setHasAudio(!0),r&&i._emitter.emit("stream-switch-device",{streamId:i.streamId,type:e,track:r}),i.updateDeviceIdInUse("audio"),r.enabled=!i.getAudioMuted(),i.restartAudio()),"video"==e&&(i.mediaStream.removeTrack(n),(n=o.getVideoTracks()[0])&&i.mediaStream.addTrack(n),n&&i.setHasVideo(!0),n&&i._emitter.emit("stream-switch-device",{streamId:i.streamId,type:e,track:n}),i.updateDeviceIdInUse("video"),n.enabled=!i.getVideoMuted(),i.restartVideo()),t()})).catch((function(e){i.microphoneId_="",i.cameraId_="",i.logger.onError({c:Et.TOP_ERROR,v:ke.SWITCH_DEVICE_FAILED}),o(new Ue({code:ke.SWITCH_DEVICE_FAILED,message:"init audio or video stream failed"})),i.logger.onError({c:Et.TOP_ERROR,v:ke.SWITCH_DEVICE_FAILED});var t=new Ue({code:ke.SWITCH_DEVICE_FAILED,message:e.message});o(t)}))}))}},{key:"updateStream",value:function(e){var t=this;if(this.screen||this.streamConfig.audioSource||this.streamConfig.videoSource)return Promise.reject();var r,n,i=e.audio,o=e.video,a=e.cameraId,s=e.microphoneId;return i&&(r=this.getAudioTrack()),o&&(n=this.getVideoTrack()),new Promise((function(e,c){t.initAvStream({audio:i,video:o,facingMode:t.streamConfig.facingMode,cameraId:a||"",microphoneId:s||"",width:t.videoProfile.width,height:t.videoProfile.height,frameRate:t.videoProfile.frameRate,sampleRate:t.audioProfile.sampleRate,channelCount:t.audioProfile.channelCount}).then((function(a){i&&(t.logger.info("updateStream audio"),r&&r.stop(),t.mediaStream.removeTrack(r),(r=a.getAudioTracks()[0])&&t.mediaStream.addTrack(r),r&&t.setHasAudio(!0),r&&t._emitter.emit("stream-switch-device",{streamId:t.streamId,type:"audio",track:r}),t.updateDeviceIdInUse("audio"),t.setAudioTrack(r)),o&&(t.logger.info("updateStream video"),n&&n.stop(),t.mediaStream.removeTrack(n),(n=a.getVideoTracks()[0])&&t.mediaStream.addTrack(n),n&&t.setHasVideo(!0),n&&t._emitter.emit("stream-switch-device",{streamId:t.streamId,type:"video",track:n}),t.updateDeviceIdInUse("video"),t.setVideoTrack(n)),e()})).catch((function(e){t.logger.warn("NotReadableError"===e.name?"getUserMedia NotReadableError observed":e.name,e.message),t.logger.onError({c:Et.TOP_ERROR,v:ke.DEVICE_AUTO_RECOVER_FAILED});var r=new Ue({code:ke.DEVICE_AUTO_RECOVER_FAILED,message:e});c(r),t._emitter.emit(Te,r)}))}))}},{key:"getAudioTracks",value:function(){return this.mediaStream.getAudioTracks()}},{key:"getVideoTracks",value:function(){return this.mediaStream.getVideoTracks()}},{key:"isReplaceTrackAvailable",value:function(){return"RTCRtpSender"in window&&"replaceTrack"in window.RTCRtpSender.prototype}},{key:"supportPC",value:function(){return"RTCPeerConnection"in window&&"getSenders"in window.RTCPeerConnection.prototype}},{key:"listenForScreenSharingStopped",value:function(e){var t=this;e.addEventListener("ended",(function(e){t.logger.info("screen sharing was stopped because the video track is ended"),t.logger.buriedLog({c:Et.ON_SCREEN_SHARING_STOPPED}),t._emitter.emit("screen-sharing-stopped")}),{once:!0})}},{key:"updateDeviceIdInUse",value:function(e){if(!this.mediaStream)return this.microphoneId_="",this.microphoneGroupId_="",this.cameraId_="",this.cameraGroupId_="",this.microphoneLabel_="",void(this.cameraLabel_="");for(var t=this.mediaStream.getTracks(),r=t.length,n=0;n<r;n++){var i=t[n].getSettings(),o=i.deviceId,a=i.groupId;if(e&&o){if(e===t[n].kind&&"audio"===t[n].kind){this.microphoneId_=o,this.microphoneGroupId_=a,this.microphoneLabel_=t[n].label;break}if(e===t[n].kind&&"video"===t[n].kind&&!this.screen){this.cameraId_=o,this.cameraGroupId_=a,this.cameraLabel_=t[n].label;break}}else o&&("audio"===t[n].kind?(this.microphoneId_=o,this.microphoneGroupId_=a,this.microphoneLabel_=t[n].label):"video"!==t[n].kind||this.screen||(this.cameraId_=o,this.cameraGroupId_=a,this.cameraLabel_=t[n].label))}var s=this.mediaStream.getAudioTracks(),c=this.mediaStream.getVideoTracks();s&&0===s.length&&(this.microphoneId_="",this.microphoneGroupId_="",this.microphoneLabel_=""),c&&0===c.length&&(this.cameraId_="",this.cameraGroupId_="",this.cameraLabel_=""),this.logger.info("update device id: microphoneId: ".concat(this.microphoneId_,",microphoneLabel:").concat(this.microphoneLabel_,", microphoneGroupId:").concat(this.microphoneGroupId_,",cameraId: ").concat(this.cameraId_,",cameraLabel:").concat(this.cameraLabel_,",cameraGroupId:").concat(this.cameraGroupId_))}},{key:"getDevicesInfoInUse",value:function(){return this.logger.buriedLog({c:Et.GET_DEVICES_INFO_IN_USE,v:"microphone:".concat(this.microphoneId_,",camera:").concat(this.cameraId_)}),{camera:{deviceId:this.cameraId_,groupId:this.cameraGroupId_,label:this.cameraLabel_},microphone:{deviceId:this.microphoneId_,groupId:this.microphoneGroupId_,label:this.microphoneLabel_}}}},{key:"setPubState",value:function(e,t){"audio"===e?this.audioPubState=t:this.videoPubState=t}},{key:"getPubState",value:function(e){return"audio"===e?this.audioPubState:this.videoPubState}},{key:"onTrackAdd",value:function(e){this._emitter.on("stream-add-track",e)}},{key:"onTrackRemove",value:function(e){this._emitter.on("stream-remove-track",e)}},{key:"onSwitchDevice",value:function(e){this._emitter.on("stream-switch-device",e)}},{key:"onReplaceTrack",value:function(e){this._emitter.on("stream-replace-track",e)}},{key:"onTrackStopped",value:(e=ue(be.mark((function e(t){var r,n,i,o,a=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.type,this.logger.info("onTrackStopped",n=t.reason,this.recoverCaptureCount_),"audio"!==r||"ended"!==n){e.next=11;break}if(!(this.recoverCaptureCount_<=10)){e.next=9;break}return e.next=6,Rt();case 6:i=e.sent.findIndex((function(e){return e.deviceId===a.microphoneId_})),this.microphoneId_&&i>-1&&(this.logger.info("stat-local-audio-ended"),this.recoverCaptureCount_+=1,this.updateStream({audio:!0,video:!1,microphoneId:this.microphoneId_}));case 9:e.next=18;break;case 11:if("video"!==r||"ended"!==n){e.next=18;break}if(!(this.recoverCaptureCount_<=10)){e.next=18;break}return e.next=15,kt();case 15:o=e.sent.findIndex((function(e){return e.deviceId===a.cameraId_})),this.cameraId_&&o>-1&&(this.logger.info("stat-local-video-ended"),this.recoverCaptureCount_+=1,this.updateStream({audio:!1,video:!0,cameraId:this.cameraId_}));case 18:case"end":return e.stop()}}),e,this)}))),function(t){return e.apply(this,arguments)})}]),o}(),Ht=function(){Ie(t,At);var e=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=xe(e);if(t){var i=xe(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return Ae(this,r)}}(t);function t(r,n){var i;return le(this,t),(i=e.call(this,r,n)).isRemote=!0,i.subscribed=!1,i.audio=!1,i.video=!1,i.subscriptionId=null,i.audioSubscriptionId=null,i.videoSubscriptionId=null,i.audioSubState=ge.Create,i.videoSubState=ge.Create,i.simulcastType=null,i}return pe(t,[{key:"getUserSeq",value:function(){return this.userId}},{key:"setAudio",value:function(e){this.audio=e}},{key:"setVideo",value:function(e){this.video=e}},{key:"setAudioSubscriptionId",value:function(e){this.audioSubscriptionId=e}},{key:"setVideoSubscriptionId",value:function(e){this.videoSubscriptionId=e}},{key:"getStreamKind",value:function(e){return this.audioStreamId===this.videoStreamId?ye.AudioVideo:this.audioStreamId===e?ye.AudioOnly:this.videoStreamId===e?ye.VideoOnly:void 0}},{key:"setSimulcastType",value:function(e){this.simulcastType=e}},{key:"getSimulcastType",value:function(){return this.simulcastType}},{key:"setSubState",value:function(e,t){"audio"===e?this.audioSubState=t:this.videoSubState=t}},{key:"getSubState",value:function(e){return"audio"===e?this.audioSubState:this.videoSubState}}]),t}();function zt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Kt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?zt(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):zt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var Jt,qt,Yt=Kt(Kt({},gt),yt);function $t(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Xt(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?$t(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):$t(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Unpublished=3]="Unpublished"}(Jt||(Jt={})),function(e){e[e.Normal=0]="Normal",e[e.Half=1]="Half"}(qt||(qt={}));var Qt=function(){function e(t){le(this,e),this.options=t,this.userId=t.userId,this.streamId=null,this.localStream=t.mediaStream,this.peerConnection=new RTCPeerConnection({bundlePolicy:"max-bundle",sdpSemantics:"unified-plan"}),this.logger=t.logger,this.xsigoClient=t.xsigoClient,this.roomId=t.roomId,this.state=Jt.Create,this.transceiver=null,this._emitter=new Se,this._interval=-1,this.audioBytesSentIs0Count=0,this.videoBytesSentIs0Count=0,this.recoverCaptureCount=0,this.times=2e3,this.timer=null,this.level=qt.Normal}var t,r;return pe(e,[{key:"publish",value:function(){var e=this;return new Promise(function(){var t=ue(be.mark((function t(r,n){var i,o,a;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,e.state!==Jt.Create&&(e.logger.warn("Stream already publishing or published"),n({message:"stream already publishing or published"})),e.logger.info("stream publishing"),e.state=Jt.Publishing,t.next=6,e.createOffer(e.localStream);case 6:i=t.sent,e.logger.info("publishStream track",e.localStream.getTracks()),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"publish"),o="",a=[],e.peerConnection.onicecandidate=function(t){var s=t.candidate;e.logger.info("peerConnection publish ".concat(JSON.stringify(e.localStream.getTracks()[0].kind),"  IceCandidate data:\n ").concat((null==s?void 0:s.candidate)||"")),null!=s&&s.candidate&&(o=o+"a="+s.candidate+"\r\n"),a.push(s);var c=!1,u=window.setTimeout((function(){c=!0}),e.times);if(!s||c){window.clearTimeout(u),a[0]&&0!==a.length||n({code:ke.CANDIDATE_COLLECT_FAILED,message:"candidate is null"}),a=[];var d=i.sdp;if(d.toLowerCase().includes("audio")&&!d.toLowerCase().includes("opus"))return e.logger.warn("=======publish offer========\n",d),n("opus not supported");if(d.toLowerCase().includes("video")&&!d.toLowerCase().includes("h264"))return e.logger.warn("=======publish offer========\n",d),n("H264 not supported");d.includes("a=candidate")||(d+=o);var l=e.buildPublishParams();l.params.offerSdp=d,e.logger.info("=======publish offer========\n",d),e.streamId=e.xsigoClient.publishStream(e.roomId,l),r(e.streamId)}},t.next=17;break;case 14:t.prev=14,t.t0=t.catch(0),n(t.t0);case 17:case"end":return t.stop()}}),t,null,[[0,14]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"republish",value:function(){var e=this;return new Promise(function(){var t=ue(be.mark((function t(r,n){var i,o;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.close(),e.peerConnection=new RTCPeerConnection({bundlePolicy:"max-bundle",sdpSemantics:"unified-plan"}),e.state=Jt.Publishing,t.next=5,e.createOffer(e.localStream);case 5:i=t.sent,e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"republish"),o="",e.peerConnection.onicecandidate=function(t){var n=t.candidate;e.logger.info("peerConnection republish IceCandidate data:\n ".concat((null==n?void 0:n.candidate)||"")),null!=n&&n.candidate&&(o=o+"a="+n.candidate+"\r\n");var a=!1,s=window.setTimeout((function(){a=!0}),e.times);n&&!a||(window.clearTimeout(s),i.sdp.includes("a=candidate")||(i.sdp=i.sdp+o),e.logger.info("=======republish offer========\n",i.sdp),r(i))};case 9:case"end":return t.stop()}}),t)})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"unpublish",value:function(e){var t=this;this.xsigoClient.unpublishStream(this.roomId,this.streamId,(function(r,n,i){1===r&&(t.state=Jt.Unpublished,t.close()),e(r,n,i)}))}},{key:"updateSimulcast",value:function(e,t){this.xsigoClient.updateSimulcast(this.roomId,this.streamId,{simulcast:e},t)}},{key:"createOffer",value:function(e){var t=this;return new Promise(function(){var r=ue(be.mark((function r(n,i){var o,a,s,c,u;return be.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=t.options.minBitrate?t.options.minBitrate:t.options.bitrate.video<200?t.options.bitrate.video:200,r.prev=1,t.localStream.getTracks().forEach((function(r){var n=[];if("video"===r.kind){var i=t.options,a=i.isEnableSmallStream,s=i.smallStreamConfig,c=i.screen,u=r.getSettings();t.captureVideoWidth=u.width,t.captureVideoHeight=u.height,a&&!c&&(n.push({rid:"h",active:!0,scaleResolutionDownBy:1}),n.push({rid:"l",active:!0,scaleResolutionDownBy:t.captureVideoHeight/s.height,maxBitrate:1e3*s.bitrate}),o=t.options.minBitrate?t.options.minBitrate:t.options.bitrate.video<600?t.options.bitrate.video:600)}t.transceiver=t.peerConnection.addTransceiver(r.kind,{direction:"sendonly",sendEncodings:n}),t.peerConnection.addTrack(r,e)})),r.next=5,t.peerConnection.createOffer();case 5:s=[],(a=r.sent).sdp.includes("video")&&(c=(c=a.sdp.split("\r\n")).map((function(e){if(e.includes("a=rtpmap")&&!e.toLowerCase().includes("h264")){var t=e.indexOf(":")+1,r=e.indexOf(" ");s.push(e.slice(t,r))}return e.includes("a=fmtp:")&&o?e+";x-google-min-bitrate=".concat(o):e})),s.length&&s.forEach((function(e){c=c.filter((function(t){return!(t.includes("a=rtpmap:"+e)||t.includes("a=fmtp:"+e)||t.includes("a=rtcp-fb:"+e))}))})),a.sdp=c.join("\r\n")),a.sdp.includes("audio")&&((u=a.sdp.split("\r\n")).forEach((function(e){if(e.includes("a=rtpmap")&&!e.toLowerCase().includes("opus")){var t=e.indexOf(":")+1,r=e.indexOf(" ");s.push(e.slice(t,r))}})),s.length&&s.forEach((function(e){u=u.filter((function(t){return!(t.includes("a=rtpmap:"+e)||t.includes("a=fmtp:"+e)||t.includes("a=rtcp-fb:"+e))}))})),a.sdp=u.join("\r\n")),n(a),t.peerConnection.setLocalDescription(a),r.next=18;break;case 13:throw r.prev=13,r.t0=r.catch(1),t.logger.onError({c:Yt.TOP_ERROR,v:ke.CREATE_OFFER_FAILED},"code:".concat(ke.CREATE_OFFER_FAILED,",create offer error!, ").concat(r.t0)),t.state=Jt.Create,new Ue({code:ke.CREATE_OFFER_FAILED,message:"create offer error!,".concat(r.t0)});case 18:case"end":return r.stop()}}),r,null,[[1,13]])})));return function(e,t){return r.apply(this,arguments)}}())}},{key:"onConnectionstatechange",value:function(e){var t=this;["failed","connected"].includes(this.peerConnection.connectionState)&&this._emitter.emit("publish-ice-state",{state:this.peerConnection.connectionState,streamId:this.streamId}),this.logger.info("peerConnection ".concat(e," ICE State: ").concat(this.peerConnection.connectionState)),"connecting"===this.peerConnection.connectionState?-1===this._interval&&(this._interval=window.setInterval((function(){t.getRTCIceCandidatePairStats()}),this.times)):"connected"===this.peerConnection.connectionState?(this.localStream.getTracks().forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){t.replaceTrack(e)}))})),clearInterval(this._interval)):clearInterval(this._interval)}},{key:"filterCodecs",value:function(e){if(RTCRtpSender.getCapabilities){var t=RTCRtpSender.getCapabilities(e.kind).codecs.filter((function(t){return"audio"===e.kind?-1!=t.mimeType.indexOf("opus"):-1!=t.mimeType.indexOf("H264")}));this.transceiver.setCodecPreferences&&"function"==typeof this.transceiver.setCodecPreferences&&this.transceiver.setCodecPreferences(t)}}},{key:"setRemoteDesc",value:function(e,t){var r=this;return new Promise((function(n,i){var o=e.split("\r\n");if(!o.includes("a=ptime")){var a=o.findIndex((function(e){return e.includes("a=fmtp")}));-1!==a&&o.splice(a,0,"a=ptime:10")}if(!e.includes("x-google-min-bitrate")){var s=r.options.minBitrate?r.options.minBitrate:r.options.bitrate.video<200?r.options.bitrate.video:200,c=r.options;c.isEnableSmallStream&&!c.screen&&(s=r.options.minBitrate?r.options.minBitrate:r.options.bitrate.video<600?r.options.bitrate.video:600),o=o.map((function(e){return e.includes("a=fmtp:")&&s?e+";x-google-min-bitrate=".concat(s):e}))}var u=o.join("\r\n");r.logger.info("=======publish answer========\n",u),r.state=Jt.Published,r.streamId=t,r.peerConnection.setRemoteDescription({sdp:u,type:"answer"}).then((function(){r.setBandwidth(r.options.bitrate),n(!0)})).catch((function(e){r.logger.error("publish setRemoteDescription error",e),i(e)}))}))}},{key:"getPeerConnection",value:function(){return this.peerConnection}},{key:"close",value:function(){this.peerConnection&&(this.peerConnection.onicecandidate=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.close()),this.peerConnection=null,this.transceiver=null,this._interval&&clearInterval(this._interval),this._interval=null,this.timer&&clearInterval(this.timer),this.timer=null,this.audioBytesSentIs0Count=0,this.videoBytesSentIs0Count=0,this.recoverCaptureCount=0,this.logger.info("close publish stream peerConnection,streamId",this.streamId)}},{key:"setBandwidth",value:function(e){var t=this,r=this.peerConnection.getSenders(),n=e.audio,i=e.video;r.forEach((function(e){var r=e.getParameters();if(r.encodings.length||(r.encodings=[{}]),"video"===e.track.kind){var o=t.options;o.isEnableSmallStream&&!o.screen&&t.onchangeNet(e),r.encodings[0].maxBitrate=t.options.maxBitrate?1e3*t.options.maxBitrate:1e3*i}"audio"===e.track.kind&&(r.encodings[0].maxBitrate=1e3*n),t.logger.info("encodings",JSON.stringify(r.encodings)),e.setParameters(r).then((function(){t.logger.info("".concat(e.track.kind," set bitrate to ").concat(r.encodings[0].maxBitrate," success"))}),(function(r){t.logger.warn("".concat(e.track.kind," set bitrate error"),r)}))}))}},{key:"onchangeNet",value:function(e){var t,r=this,n=0,i=0;this.timer=setInterval(ue(be.mark((function o(){var a,s,c,u,d,l,h,p,f;return be.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:a=r.level,s=Date.now(),c=[],u=[];case 4:if(!(Date.now()-s<4e3)){o.next=13;break}return o.next=7,r.getLocalStats("video");case 7:return(t=o.sent)?(l=(d=t.video.retransmittedPacketsSent-n)<=0?0:Math.floor(d/(t.video.packetsSent-i)*100),n=t.video.retransmittedPacketsSent,i=t.video.packetsSent,c.push(t.rtt),u.push(l)):(c.push(0),u.push(0)),o.next=11,new Promise((function(e){return setTimeout(e,1e3)}));case 11:o.next=4;break;case 13:if(h=c.reduce((function(e,t){return e+t}),0)/c.length,p=u.reduce((function(e,t){return e+t}),0)/c.length,(f=e.getParameters()).encodings.length&&f.encodings[0]){o.next=18;break}return o.abrupt("return");case 18:if(h<150&&p<30?(f.encodings[0].scaleResolutionDownBy=1,r.level=qt.Normal):(h>=150||p>=30)&&(r.level=qt.Half,f.encodings[0].scaleResolutionDownBy=2),a!==r.level){o.next=21;break}return o.abrupt("return");case 21:e.setParameters(f).then((function(){r.logger.info("video onchangeBitrite set success ".concat(r.level))}),(function(e){r.logger.warn("video onchangeBitrite set failed ".concat(r.level),e)}));case 22:case"end":return o.stop()}}),o)}))),4e3)}},{key:"replaceMediaStreamTrack",value:function(e){var t=this;this.logger.info("replace mediaStream Track",e),this.peerConnection&&e&&(this.peerConnection.getSenders()||[]).forEach((function(r){if("audio"===e.kind&&r.track&&"audio"===r.track.kind){r.replaceTrack(e);var n=t.localStream.getAudioTracks()[0];n&&t.localStream.removeTrack(n),n&&t.localStream.addTrack(e)}if("video"===e.kind&&r.track&&"video"===r.track.kind){r.replaceTrack(e);var i=t.localStream.getVideoTracks()[0];i&&t.localStream.removeTrack(i),i&&t.localStream.addTrack(e)}}));var r="audio"===e.kind?this.localStream.getAudioTracks()[0]:this.localStream.getVideoTracks()[0];r&&this.localStream.removeTrack(r),r&&this.localStream.addTrack(e)}},{key:"buildPublishParams",value:function(){var e=this,t=this.options||{},r=t.hasAudio,n=t.hasVideo,i=t.screen,o={streamType:Ze.ForwardStream,streamKind:r&&n?et.AudioVideo:r?et.AudioOnly:n?et.VideoOnly:et.Invalid,params:{offerSdp:"",audioInfo:{source:i?rt.ScreenShare:rt.Microphone,muted:t.audioMuted,floor:!0},videoInfo:{source:i?nt.ScreenShare:nt.Camera,muted:t.videoMuted,floor:!0}},cb:function(t,r,n){1===t?e.setRemoteDesc(n.answer_sdp,n.streamId).then((function(){e.options.onPublish&&e.options.onPublish(t,r,n)})).catch((function(t){e.options.onPublish&&e.options.onPublish(0,t,n)})):e.options.onPublish&&e.options.onPublish(t,r,n)},updateCb:function(){}},a=this.options,s=a.smallStreamConfig,c=[];if(a.isEnableSmallStream&&!i){if(this.logger.info("publish width height",this.captureVideoWidth,this.captureVideoHeight),this.captureVideoWidth>0&&this.captureVideoHeight>0){var u={type:it.SmallStream,maxWidth:s.width,maxHeight:s.height};c.push({type:it.BigStream,maxWidth:this.captureVideoWidth,maxHeight:this.captureVideoHeight}),c.push(u)}o.params.videoInfo.simulcast=c}return o}},{key:"getTransportStats",value:(r=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){if(t.peerConnection){var n,i=(t.peerConnection.getSenders()||[])[0];i&&i.getStats().then((function(r){n=t.getSenderStats({send:r,mediaType:i.track.kind}),e(n)}),(function(e){t.logger.onError({c:Yt.TOP_ERROR,v:ke.INVALID_TRANSPORT_STATA},"Get transport stats error, ".concat(e)),r(e.message)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(){return r.apply(this,arguments)})},{key:"getLocalStats",value:(t=ue(be.mark((function e(t){var r=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){if(r.peerConnection){var i,o=(r.peerConnection.getSenders()||[]).find((function(e){return e.track.kind===t}));o&&o.getStats().then((function(n){i=r.getSenderStats({send:n,mediaType:t}),e(i)})).catch((function(e){n(e.message)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})},{key:"getSenderStats",value:function(e){var t=this,r={audio:{bytesSent:0,packetsSent:0,retransmittedPacketsSent:0,audioLevel:0},video:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,retransmittedPacketsSent:0,framesPerSecond:0,rid:"h"},smallVideo:{bytesSent:0,packetsSent:0,framesEncoded:0,frameWidth:0,frameHeight:0,framesSent:0,retransmittedPacketsSent:0,framesPerSecond:0,rid:"l"},rtt:0,timestamp:0};return e.send.forEach((function(n){if("outbound-rtp"===n.type)if(r.timestamp=n.timestamp,"video"===e.mediaType&&"l"===n.rid){if(0===n.bytesSent)return;r.smallVideo=Xt(Xt({},r.smallVideo),{},{bytesSent:n.bytesSent,packetsSent:n.packetsSent,framesEncoded:n.framesEncoded,retransmittedPacketsSent:n.retransmittedPacketsSent||0,framesPerSecond:n.framesPerSecond||0,frameWidth:n.frameWidth||0,frameHeight:n.frameHeight||0,framesSent:n.framesSent,rid:n.rid||"l"})}else if("video"===e.mediaType){if(0===n.bytesSent)return;r.video=Xt(Xt({},r.video),{},{bytesSent:n.bytesSent,packetsSent:n.packetsSent,framesEncoded:n.framesEncoded,retransmittedPacketsSent:n.retransmittedPacketsSent||0,rid:n.rid||"h"}),void 0!==n.framesPerSecond&&(r.video.framesPerSecond=n.framesPerSecond),void 0!==n.frameWidth&&(r.video.frameWidth=n.frameWidth),void 0!==n.frameHeight&&(r.video.frameHeight=n.frameHeight),void 0!==n.framesSent&&(r.video.framesSent=n.framesSent)}else"audio"===e.mediaType&&(r.audio=Xt(Xt({},r.audio),{},{bytesSent:n.bytesSent,packetsSent:n.packetsSent,retransmittedPacketsSent:n.retransmittedPacketsSent||0}));else if("candidate-pair"===n.type)"number"==typeof n.currentRoundTripTime&&(r.rtt=1e3*n.currentRoundTripTime);else if("track"===n.type){if(void 0!==n.frameWidth){var i=t.localStream.getVideoTracks();i.length&&i[0].id===n.trackIdentifier&&(r.video.frameWidth=n.frameWidth,r.video.frameHeight=n.frameHeight,r.video.framesSent=n.framesSent)}}else if("media-source"===n.type)if("video"===n.kind){var o=t.localStream.getVideoTracks();o.length&&o[0].id===n.trackIdentifier&&void 0!==n.framesPerSecond&&(r.video.framesPerSecond=n.framesPerSecond)}else"audio"===n.kind&&(r.audio.audioLevel=n.audioLevel||0)})),r}},{key:"onPublishPeerConnectionFailed",value:function(e){this._emitter.on("publish-ice-state",e)}},{key:"getRTCIceCandidatePairStats",value:function(){var e=this;this.peerConnection&&this.peerConnection.getStats().then((function(t){t.forEach((function(t){"candidate-pair"===t.type&&e.logger.warn("publish RTCIceCandidatePairStats",JSON.stringify(t,null,4))}))}))}},{key:"updateBytesSentIs0Count",value:function(e){var t=this;if("audio"===e){var r,n=this.localStream.getAudioTracks();n.length&&"connected"===(null===(r=this.peerConnection)||void 0===r?void 0:r.connectionState)&&(this.audioBytesSentIs0Count+=1,this.audioBytesSentIs0Count>=4&&this.recoverCaptureCount<=5&&(this.recoverCaptureCount+=1,this.audioBytesSentIs0Count=0,n.forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){"audio"===t.track.kind&&t.replaceTrack(e)}))})),this.logger.info("replace the track because the audio bytes sent is 0,recover count:",this.recoverCaptureCount)))}else if("video"===e){var i,o=this.localStream.getVideoTracks();o.length&&"connected"===(null===(i=this.peerConnection)||void 0===i?void 0:i.connectionState)&&(this.videoBytesSentIs0Count+=1,this.videoBytesSentIs0Count>=4&&this.recoverCaptureCount<=5&&(this.recoverCaptureCount+=1,this.videoBytesSentIs0Count=0,o.forEach((function(e){(t.peerConnection.getSenders()||[]).forEach((function(t){"video"===t.track.kind&&t.replaceTrack(e)}))})),this.logger.info("replace the track because the video bytes sent is 0,recover count:",this.recoverCaptureCount)))}}}]),e}();function Zt(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function er(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Zt(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Zt(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var tr,rr=function(){function e(t){le(this,e),this.subscribedStreams=new Map,this.subscriptedOptions=new Map,this.subscriptedState=new Map,this.logger=t}return pe(e,[{key:"addSubscriptionRecord",value:function(e,t){this.subscribedStreams.set(e,t)}},{key:"setSubscriptionOpts",value:function(e,t){this.logger.debug("set subscribe options:",t),this.subscriptedOptions.set(e,t)}},{key:"getSubscriptionOpts",value:function(e){return this.subscriptedOptions.get(e)||{audio:!0,video:!0,small:!1}}},{key:"updateSubscriptedState",value:function(e,t){var r=er(er({},this.getSubscriptedState(e)),t);this.subscriptedState.set(e,r),this.logger.info("-----\x3e update subscribe state <----------",e,JSON.stringify(r))}},{key:"getSubscriptedState",value:function(e){return this.subscriptedState.get(e)||{audio:!1,video:!1,small:!1}}},{key:"needSubscribeKind",value:function(e){var t=this.subscriptedState.get(e)||{audio:!1,video:!1},r=this.subscriptedOptions.get(e)||{audio:!1,video:!1};return this.logger.info("subscribe state",t),this.logger.info("subscribe options:",r),r.audio&&!t.audio&&r.video&&!t.video?ye.AudioVideo:r.audio&&!t.audio?ye.AudioOnly:r.video&&!t.video?ye.VideoOnly:void 0}},{key:"reset",value:function(e){if(e)return this.subscriptedState.delete(e),this.subscribedStreams.delete(e),void this.subscriptedOptions.delete(e);this.subscriptedState.clear(),this.subscribedStreams.clear(),this.subscriptedOptions.clear()}}]),e}(),nr=fe((function(e){var t=e.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return null!=e.address?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return null!=e.subtype?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return null!=e.sessionConfig?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=null!=e.raddr?" raddr %s rport %d":"%v%v",t+=null!=e.tcptype?" tcptype %s":"%v",null!=e.generation&&(t+=" generation %d"),(t+=null!=e["network-id"]?" network-id %d":"%v")+(null!=e["network-cost"]?" network-cost %d":"%v")}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return null!=e.attribute&&(t+=" %s",null!=e.value&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return null!=e.maxMessageSize?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(null!=e.clksrcExt?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=null!=e.id?"id=%s %s":"%v%s",t+=null!=e.mediaClockValue?"=%s":"",(t+=null!=e.rateNumerator?" rate=%s":"")+(null!=e.rateDenominator?"/%s":"")}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};Object.keys(t).forEach((function(e){t[e].forEach((function(e){e.reg||(e.reg=/(.*)/),e.format||(e.format="%s")}))}))})),ir=fe((function(e,t){var r=function(e){return String(Number(e))===e?Number(e):e},n=function(e,t,n){var i=e.name&&e.names;e.push&&!t[e.push]?t[e.push]=[]:i&&!t[e.name]&&(t[e.name]={});var o=e.push?{}:i?t[e.name]:t;!function(e,t,n,i){if(i&&!n)t[i]=r(e[1]);else for(var o=0;o<n.length;o+=1)null!=e[o+1]&&(t[n[o]]=r(e[o+1]))}(n.match(e.reg),o,e.names,e.name),e.push&&t[e.push].push(o)},i=RegExp.prototype.test.bind(/^([a-z])=(.*)/);t.parse=function(e){var t={},r=[],o=t;return e.split(/(\r\n|\r|\n)/).filter(i).forEach((function(e){var t=e[0],i=e.slice(2);"m"===t&&(r.push({rtp:[],fmtp:[]}),o=r[r.length-1]);for(var a=0;a<(nr[t]||[]).length;a+=1){var s=nr[t][a];if(s.reg.test(i))return n(s,o,i)}})),t.media=r,t};var o=function(e,t){var n=t.split(/=(.+)/,2);return 2===n.length?e[n[0]]=r(n[1]):1===n.length&&t.length>1&&(e[n[0]]=void 0),e};t.parseParams=function(e){return e.split(/;\s?/).reduce(o,{})},t.parseFmtpConfig=t.parseParams,t.parsePayloads=function(e){return e.toString().split(" ").map(Number)},t.parseRemoteCandidates=function(e){for(var t=[],n=e.split(" ").map(r),i=0;i<n.length;i+=3)t.push({component:n[i],ip:n[i+1],port:n[i+2]});return t},t.parseImageAttributes=function(e){return e.split(" ").map((function(e){return e.substring(1,e.length-1).split(",").reduce(o,{})}))},t.parseSimulcastStreamList=function(e){return e.split(";").map((function(e){return e.split(",").map((function(e){var t,n=!1;return"~"!==e[0]?t=r(e):(t=r(e.substring(1,e.length)),n=!0),{scid:t,paused:n}}))}))}})),or=/%[sdv%]/g,ar=function(e){var t=1,r=arguments,n=r.length;return e.replace(or,(function(e){if(t>=n)return e;var i=r[t];switch(t+=1,e){case"%%":return"%";case"%s":return String(i);case"%d":return Number(i);case"%v":return""}}))},sr=function(e,t,r){var n=[e+"="+(t.format instanceof Function?t.format(t.push?r:r[t.name]):t.format)];if(t.names)for(var i=0;i<t.names.length;i+=1)n.push(t.name?r[t.name][t.names[i]]:r[t.names[i]]);else n.push(r[t.name]);return ar.apply(null,n)},cr=["v","o","s","i","u","e","p","c","b","t","r","z","a"],ur=["i","c","b","a"],dr=function(e,t){t=t||{},null==e.version&&(e.version=0),null==e.name&&(e.name=" "),e.media.forEach((function(e){null==e.payloads&&(e.payloads="")}));var r=t.innerOrder||ur,n=[];return(t.outerOrder||cr).forEach((function(t){nr[t].forEach((function(r){r.name in e&&null!=e[r.name]?n.push(sr(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){n.push(sr(t,r,e))}))}))})),e.media.forEach((function(e){n.push(sr("m",nr.m[0],e)),r.forEach((function(t){nr[t].forEach((function(r){r.name in e&&null!=e[r.name]?n.push(sr(t,r,e)):r.push in e&&null!=e[r.push]&&e[r.push].forEach((function(e){n.push(sr(t,r,e))}))}))}))})),n.join("\r\n")+"\r\n"},lr=ir.parse,hr=ir.parsePayloads;function pr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function fr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?pr(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):pr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function mr(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return vr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?vr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function vr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}!function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Unsubscribed=3]="Unsubscribed"}(tr||(tr={}));var gr,yr=function(){function e(t){le(this,e),this.options=t,this.userId=t.userId,this.logger=t.logger,this.xsigoClient=t.xsigoClient||null,this.roomId=t.roomId,this.peerConnection=new RTCPeerConnection({sdpSemantics:"unified-plan"}),this.peerConnection.onnegotiationneeded=this.onNegotiationNeeded.bind(this),this.peerConnection.ontrack=this.onTrack.bind(this),this.state=tr.Create,this.subscriptionId=null,this._emitter=new Se,this._interval=-1,this.times=2e3,this.isAlphaChannels=!1}var t;return pe(e,[{key:"getState",value:function(){return this.state}},{key:"subscribe",value:function(){var e=this;return new Promise((function(t,r){e.logger.info("start subscribing to the stream"),e.state=tr.Subscribing,e.addTransceiver(),e.createOffer(),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"subscribe");var n="";e.peerConnection.onicecandidate=function(i){var o=i.candidate;e.logger.info("peercConnection subscribe IceCandidate data:\n ".concat((null==o?void 0:o.candidate)||"")),null!=o&&o.candidate&&(n=n+"a="+o.candidate+"\r\n");var a=!1,s=window.setTimeout((function(){a=!0}),e.times);if(!o||a){window.clearTimeout(s);var c=e.peerConnection.pendingLocalDescription.sdp;if(c.toLocaleLowerCase().includes("video")&&!c.toLowerCase().includes("h264"))e.logger.warn("=======subscribe offer========\n",c),r("H264 not supported");else{c.includes("a=candidate")||(c+=n);var u=e.buildSubscribeParams();u.params.offerSdp=c,e.logger.info("=======subscribe offer========\n",c),e.subscriptionId=e.xsigoClient.subscribeStream(e.roomId,u),t(e.subscriptionId)}}}}))}},{key:"resubscribe",value:function(){var e=this;return new Promise((function(t,r){e.logger.info("resubscribe stream",e.subscriptionId),e.close(),e.peerConnection=new RTCPeerConnection({sdpSemantics:"unified-plan"}),e.state=tr.Subscribing,e.addTransceiver(),e.createOffer(),e.peerConnection.onconnectionstatechange=e.onConnectionstatechange.bind(e,"resubscribe"),e.peerConnection.ontrack=e.onTrack.bind(e);var n="";e.peerConnection.onicecandidate=function(r){var i=r.candidate;e.logger.info("peercConnection resubscribe IceCandidate data:\n ".concat((null==i?void 0:i.candidate)||"")),null!=i&&i.candidate&&(n=n+"a="+i.candidate+"\r\n");var o=!1,a=window.setTimeout((function(){o=!0}),e.times);if(!i||o){window.clearTimeout(a);var s=e.peerConnection.pendingLocalDescription;s.sdp.includes("a=candidate")||(s.sdp=s.sdp+n),e.logger.info("=======resubscribe offer========\n",s.sdp),t(s)}}}))}},{key:"unsubscribe",value:function(e){var t=this;this.logger.info("unsubscribe subscriptionId",this.subscriptionId),this.xsigoClient.unsubscribeStream(this.roomId,this.subscriptionId,(function(r,n,i){1===r&&(t.state=tr.Unsubscribed,t.close()),e(r,n,i)}))}},{key:"switchSimulcast",value:function(e,t){this.xsigoClient.switchSimulcast(this.roomId,this.subscriptionId,{type:e},t)}},{key:"setRemoteDescription",value:function(e){var t=this;return new Promise((function(r,n){t.logger.info("=======subscribe answer========\n"+e),t.isAlphaChannels=e.includes("a=xrtc-alpha"),t.peerConnection.setRemoteDescription({sdp:e,type:"answer"}).then((function(){t.state=tr.Subscribed,r(!0)})).catch((function(e){t.logger.error("subscribe setRemoteDescription error",e),n(e)}))}))}},{key:"onConnectionstatechange",value:function(e){var t=this;["failed","connected"].includes(this.peerConnection.connectionState)&&this._emitter.emit("subscribe-ice-state",{state:this.peerConnection.connectionState,subscriptionId:this.subscriptionId}),this.logger.info("peerConnection ".concat(e," ICE State: ").concat(this.peerConnection.connectionState)),"connecting"===this.peerConnection.connectionState?-1===this._interval&&(this._interval=window.setInterval((function(){t.getRTCIceCandidatePairStats()}),this.times)):clearInterval(this._interval)}},{key:"addTransceiver",value:function(){this.options.hasAudio&&this.peerConnection.addTransceiver("audio",{direction:"recvonly"}),this.options.hasVideo&&this.peerConnection.addTransceiver("video",{direction:"recvonly"})}},{key:"createOffer",value:function(){var e=this;this.peerConnection.createOffer().then(this.onGotOffer.bind(this)).catch((function(t){e.logger.error("create offer error",t),e.state=tr.Create}))}},{key:"onGotOffer",value:function(e){var t,r=this,n=lr(e.sdp),i=mr(n.media);try{for(i.s();!(t=i.n()).done;){var o,a=t.value,s=mr(hr(a.payloads));try{for(s.s();!(o=s.n()).done;){var c=o.value;a.rtcpFb=a.rtcpFb?[].concat(de(a.rtcpFb),[{payload:c,type:"rrtr"}]):[{payload:c,type:"rrtr"}]}}catch(e){s.e(e)}finally{s.f()}}}catch(e){i.e(e)}finally{i.f()}var u={sdp:dr(n),type:"offer"};this.peerConnection.setLocalDescription(u).then((function(){r.logger.info("Set local description success",r.subscriptionId)})).catch((function(e){r.logger.error("Set local description failure",e)}))}},{key:"onNegotiationNeeded",value:function(){this.logger.info("onNegotiationneeded--")}},{key:"onTrack",value:function(e){this.logger.debug("on track return");var t=this.options||{},r=t.hasAudio,n=r&&t.hasVideo?et.AudioVideo:r?et.AudioOnly:et.VideoOnly,i=e.streams[0],o=e.track;t.audioStreamId||t.videoStreamId?this.options.onRemoteStream(i,o,n,this.isAlphaChannels):this.logger.info("not audio or video")}},{key:"getPeerConnection",value:function(){return this.peerConnection}},{key:"close",value:function(){this.peerConnection&&(this.peerConnection.onicecandidate=null,this.peerConnection.onnegotiationneeded=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.ontrack=null,this.peerConnection.close()),this.peerConnection=null,this._interval&&clearInterval(this._interval),this.logger.info("close subscribe stream peerConnection subscriptionId",this.subscriptionId)}},{key:"buildSubscribeParams",value:function(){var e=this,t=this.options||{},r=t.hasAudio,n=t.hasVideo,i=t.simulcast,o={publisherUserId:t.publisherUserId,streamId:r?t.audioStreamId:t.videoStreamId,streamKind:r&&n?et.AudioVideo:r?et.AudioOnly:et.VideoOnly,params:{offerSdp:"",hasAudio:r,hasVideo:n,type:(null==i?void 0:i.length)>0&&i[0].type},cb:function(t,r,n){1===t?e.setRemoteDescription(n.answer_sdp).then((function(){e.options.onSubscribe&&e.options.onSubscribe(t,r,n)})).catch((function(t){e.logger.error("setRemoteDescription is failed",t),e.options.onSubscribe&&e.options.onSubscribe(0,t,n)})):e.options.onSubscribe&&e.options.onSubscribe(t,r,n)},updateCb:function(){}};return t.small&&n&&((i||[]).find((function(e){return e.type===it.SmallStream}))?o.params.type=it.SmallStream:this.logger.warn("does not publish small stream")),o}},{key:"getTransportStats",value:(t=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,r){if(t.peerConnection){var n=(t.peerConnection.getReceivers()||[])[0];n&&n.getStats().then((function(r){var i=t.getReceiverStats({send:r,mediaType:n.track.kind});e(i.rtt)})).catch((function(e){r(e)}))}})));case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"getRemoteAudioOrVideoStats",value:function(e){var t=this;return new Promise((function(r,n){if(t.peerConnection){var i=t.peerConnection.getReceivers().find((function(t){return t.track.kind===e}));i&&i.getStats().then((function(n){var i=t.getReceiverStats({send:n,mediaType:e});r(i)})).catch((function(e){n(e)}))}}))}},{key:"getReceiverStats",value:function(e){var t={audio:{bytesReceived:0,packetsReceived:0,packetsLost:0,nackCount:0,audioLevel:0},video:{bytesReceived:0,packetsReceived:0,packetsLost:0,framesDecoded:0,frameWidth:0,frameHeight:0,framesPerSecond:0,nackCount:0},rtt:0,timestamp:0};return e.send.forEach((function(r){if("inbound-rtp"===r.type)if(t.timestamp=r.timestamp,"audio"===e.mediaType)t.audio=fr(fr({},t.audio),{},{bytesReceived:r.bytesReceived,packetsReceived:r.packetsReceived,packetsLost:r.packetsLost}),void 0!==r.nackCount&&(t.audio.nackCount=r.nackCount),void 0!==r.audioLevel&&(t.audio.audioLevel=r.audioLevel);else{if(0===r.bytesReceived)return;t.video=fr(fr({},t.video),{},{bytesReceived:r.bytesReceived,packetsReceived:r.packetsReceived,packetsLost:r.packetsLost,framesDecoded:r.framesDecoded,framesPerSecond:r.framesPerSecond||0,nackCount:r.nackCount}),void 0!==r.frameWidth&&(t.video.frameWidth=r.frameWidth),void 0!==r.frameHeight&&(t.video.frameHeight=r.frameHeight)}else"track"===r.type?void 0!==r.frameWidth?t.video=fr(fr({},t.video),{},{frameWidth:r.frameWidth,frameHeight:r.frameHeight}):void 0!==r.audioLevel&&(t.audio.audioLevel=r.audioLevel||0):"candidate-pair"===r.type&&"number"==typeof r.currentRoundTripTime&&(t.rtt=1e3*r.currentRoundTripTime)})),t}},{key:"onSubscribePeerConnectionFailed",value:function(e){this._emitter.on("subscribe-ice-state",e)}},{key:"getRTCIceCandidatePairStats",value:function(){var e=this;this.peerConnection&&this.peerConnection.getStats().then((function(t){t.forEach((function(t){"candidate-pair"===t.type&&e.logger.warn("subscribe RTCIceCandidatePairStats",JSON.stringify(t,null,4))}))}))}}]),e}();function br(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function Sr(e){var t,r=new Array,n=function(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return br(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?br(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}(e);try{for(n.s();!(t=n.n()).done;){var i=t.value,o={type:vt(i.rid),maxWidth:i.maxWidth,maxHeight:i.maxHeight};r.push(o)}}catch(e){n.e(e)}finally{n.f()}return r}function Er(e){var t={userId:e.userId,streamId:e.streamId,type:dt(e.type)};return e.info&&(t.info={},e.info.audio&&(t.info.audio={source:ht(e.info.audio.source),muted:e.info.audio.muted,floor:e.info.audio.floor}),e.info.video&&(t.info.video={source:ft(e.info.video.source),muted:e.info.video.muted,floor:e.info.video.floor},e.info.video.simulcast&&(t.info.video.simulcast=Sr(e.info.video.simulcast)))),t}function Cr(e){var t={userId:e.userId,streamId:e.streamId,type:dt(e.data.type)};return e.data.media.info&&(t.info={},e.data.media.info.audio&&(t.info.audio={source:ht(e.data.media.info.audio.source),muted:e.data.media.info.audio.muted,floor:e.data.media.info.audio.floor}),e.data.media.info.video&&(t.info.video={source:ft(e.data.media.info.video.source),muted:e.data.media.info.video.muted,floor:e.data.media.info.video.floor},e.data.media.info.video.simulcast&&(t.info.video.simulcast=Sr(e.data.media.info.video.simulcast)))),t}!function(e){e[e.Created=0]="Created",e[e.Entering=1]="Entering",e[e.EnterFailed=2]="EnterFailed",e[e.EnterTimeout=3]="EnterTimeout",e[e.Entered=4]="Entered",e[e.Exiting=5]="Exiting",e[e.ExitFailed=6]="ExitFailed",e[e.ExitTimeout=7]="ExitTimeout",e[e.Exited=8]="Exited",e[e.Destroyed=9]="Destroyed",e[e.StateMax=10]="StateMax"}(gr||(gr={}));var Tr,wr=["Created","Entering","EnterFailed","EnterTimeout","Entered","Exiting","ExitFailed","ExitTimeout","Exited","Destroyed"],_r=function(){function e(t){le(this,e),this.currentState=gr.Created,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return pe(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("RoomState : state change from "+wr[this.currentState]+" to "+wr[e]),this.currentState=e,!0):(this.logger.error("RoomState : INVALID state change from "+wr[this.currentState]+" to "+wr[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=gr.Created;e<gr.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=gr.Created;t<gr.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[gr.Created][gr.Entering]=!0,this.stateTransformTable[gr.Created][gr.Destroyed]=!0,this.stateTransformTable[gr.Entering][gr.Entered]=!0,this.stateTransformTable[gr.Entering][gr.EnterFailed]=!0,this.stateTransformTable[gr.Entering][gr.EnterTimeout]=!0,this.stateTransformTable[gr.Entering][gr.Destroyed]=!0,this.stateTransformTable[gr.EnterFailed][gr.Destroyed]=!0,this.stateTransformTable[gr.EnterTimeout][gr.Destroyed]=!0,this.stateTransformTable[gr.Entered][gr.Exiting]=!0,this.stateTransformTable[gr.Entered][gr.Destroyed]=!0,this.stateTransformTable[gr.Exiting][gr.Exited]=!0,this.stateTransformTable[gr.Exiting][gr.ExitTimeout]=!0,this.stateTransformTable[gr.Exiting][gr.Destroyed]=!0,this.stateTransformTable[gr.Exited][gr.Destroyed]=!0}}]),e}();!function(e){e[e.New=0]="New",e[e.Logining=1]="Logining",e[e.LoginFailed=2]="LoginFailed",e[e.LoginTimeout=3]="LoginTimeout",e[e.Logined=4]="Logined",e[e.Relogining=5]="Relogining",e[e.Relogined=6]="Relogined",e[e.Logouting=7]="Logouting",e[e.LogoutTimeout=8]="LogoutTimeout",e[e.Logouted=9]="Logouted",e[e.Destroyed=10]="Destroyed",e[e.StateMax=11]="StateMax"}(Tr||(Tr={}));var kr,Rr,Ir=["New","Logining","LoginFailed","LoginTimeout","Logined","Relogining","Relogined","Logouting","LogoutTimeout","Logouted","Destroy"],Or=function(){function e(t){le(this,e),this.currentState=Tr.New,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return pe(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("Login : state change from "+Ir[this.currentState]+" to "+Ir[e]),this.currentState=e,!0):(this.logger.error("Login : INVALID state change from "+Ir[this.currentState]+" to "+Ir[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=Tr.New;e<Tr.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=Tr.New;t<Tr.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[Tr.New][Tr.Logining]=!0,this.stateTransformTable[Tr.New][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Logining][Tr.Logined]=!0,this.stateTransformTable[Tr.Logining][Tr.LoginFailed]=!0,this.stateTransformTable[Tr.Logining][Tr.LoginTimeout]=!0,this.stateTransformTable[Tr.Logining][Tr.Destroyed]=!0,this.stateTransformTable[Tr.LoginFailed][Tr.Destroyed]=!0,this.stateTransformTable[Tr.LoginTimeout][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Logined][Tr.Logouting]=!0,this.stateTransformTable[Tr.Logined][Tr.Relogining]=!0,this.stateTransformTable[Tr.Logined][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Relogining][Tr.Relogining]=!0,this.stateTransformTable[Tr.Relogining][Tr.Relogined]=!0,this.stateTransformTable[Tr.Relogining][Tr.Logined]=!0,this.stateTransformTable[Tr.Relogining][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Relogined][Tr.Relogining]=!0,this.stateTransformTable[Tr.Relogined][Tr.Logouting]=!0,this.stateTransformTable[Tr.Relogined][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Logouting][Tr.Logouted]=!0,this.stateTransformTable[Tr.Logouting][Tr.LogoutTimeout]=!0,this.stateTransformTable[Tr.Logouting][Tr.Destroyed]=!0,this.stateTransformTable[Tr.Logouted][Tr.Destroyed]=!0}}]),e}();function Pr(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Ar(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Pr(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Pr(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.LoginSuccess=0]="LoginSuccess",e[e.LoginTimeout=1]="LoginTimeout",e[e.LoginFailed=2]="LoginFailed"}(kr||(kr={})),function(e){e[e.LogoutSuccess=0]="LogoutSuccess",e[e.LogoutTimeout=1]="LogoutTimeout",e[e.LogoutFailed=2]="LogoutFailed"}(Rr||(Rr={}));var xr,Lr=function(){function e(t){le(this,e),this.options=t,this.state=new Or(t.logger),this.connectionStatus=$e.New,this.timeout=1e4}return pe(e,[{key:"login",value:function(){var e=this;if(this.state.setState(Tr.Logining)){this.options.logger.info("Login room: ".concat(this.options.roomId));var t=null;this.buildLoginReuqest();var r={method:"login",params:this.loginRequestParams};t||(t=setTimeout((function(){e.options.logger.info("login timeout: ".concat(e.options.roomId)),e.state.setState(Tr.LoginTimeout)&&(t&&clearTimeout(t),t=null,e.options.loginCb&&e.options.loginCb(kr.LoginTimeout,null,"login timeout"))}),this.timeout)),this.options.rpcClient.sendRequest(r,(function(r){if(e.state.setState(Tr.Logined)&&(t&&clearTimeout(t),t=null,e.options.loginCb)){var n=r.result.room,i={room:Ar(Ar({},n),{},{roomUniqueId:n.roomUniqueId||n.roomId,participants:n.participants||[],streams:n.streams||[]})};e.options.loginCb(kr.LoginSuccess,i)}}),(function(r){e.state.setState(Tr.LoginFailed)&&(t&&clearTimeout(t),t=null,e.options.loginCb&&e.options.loginCb(kr.LoginFailed,null,r.error.message))}))||this.options.logger.error("Json Rpc Client send login request error")}}},{key:"logout",value:function(){var e=this;if(this.state.setState(Tr.Logouting)){this.options.logger.info("Logout room: ".concat(this.options.roomId));var t=null;this.options.rpcClient.sendRequest({method:"logout"},(function(r){e.state.setState(Tr.Logouted)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(Rr.LogoutSuccess))}),(function(r){e.state.setState(Tr.LoginFailed)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(Rr.LogoutFailed,r.error.message))}))||this.options.logger.error("Json Rpc Client send loginout request error"),t||(t=setTimeout((function(){e.options.logger.info("logout timeout: ".concat(e.options.roomId)),e.state.setState(Tr.LogoutTimeout)&&(t&&clearTimeout(t),t=null,e.options.logoutCb&&e.options.logoutCb(Rr.LogoutTimeout,"logout timeout"))}),this.timeout))}}},{key:"relogin",value:function(){var e=this;this.state.setState(Tr.Relogining)&&(this.buildLoginReuqest(),this.options.logger.info("Relogin room: ".concat(this.options.roomId)),this.options.rpcClient.sendRequest({method:"login",params:this.loginRequestParams},(function(t){if(e.state.setState(Tr.Relogined)&&e.options.reloginCb){var r=t.result.room,n={room:Ar(Ar({},r),{},{roomUniqueId:r.roomUniqueId||r.roomId,participants:r.participants||[],streams:r.streams||[]})};e.options.reloginCb(!0,r.sessionTimeout,n)}}),(function(t){e.options.logger.info("relogining failed")}))||this.options.logger.error("Json Rpc Client send relogin request error"))}},{key:"updatePermission",value:function(e){this.options.permission=e}},{key:"onConnectionLost",value:function(){this.connectionStatus=$e.ConnectionLost}},{key:"onConnectionRecovery",value:function(){this.connectionStatus=$e.ConnectionRecovery,this.relogin()}},{key:"buildLoginReuqest",value:function(){this.loginRequestParams={appId:this.options.appId,userId:this.options.userId,type:this.options.userType,roomId:this.options.roomId,previousRoomId:this.options.previousRoomId,permission:this.options.permission,userAgent:this.options.userAgent,userData:this.options.userData,protocol:"1.0"}}}]),e}();!function(e){e[e.Create=0]="Create",e[e.Publishing=1]="Publishing",e[e.Published=2]="Published",e[e.Republishing=3]="Republishing",e[e.Republished=4]="Republished",e[e.Unpublishing=5]="Unpublishing",e[e.Unpublished=6]="Unpublished",e[e.Destroyed=7]="Destroyed",e[e.StateMax=8]="StateMax"}(xr||(xr={}));var Mr=["Create","Publishing","Published","Republishing","Republished","Unpublishing","Unpublished","Destroy"],Dr=function(){function e(t){le(this,e),this.currentState=xr.Create,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return pe(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("PublicationState : state change from "+Mr[this.currentState]+" to "+Mr[e]),this.currentState=e,!0):(this.logger.error("PublicationState : INVALID state change from"+Mr[this.currentState]+" to "+Mr[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=xr.Create;e<xr.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=xr.Create;t<xr.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[xr.Create][xr.Publishing]=!0,this.stateTransformTable[xr.Create][xr.Destroyed]=!0,this.stateTransformTable[xr.Publishing][xr.Published]=!0,this.stateTransformTable[xr.Publishing][xr.Unpublishing]=!0,this.stateTransformTable[xr.Publishing][xr.Destroyed]=!0,this.stateTransformTable[xr.Publishing][xr.Republishing]=!0,this.stateTransformTable[xr.Published][xr.Unpublishing]=!0,this.stateTransformTable[xr.Published][xr.Republishing]=!0,this.stateTransformTable[xr.Published][xr.Destroyed]=!0,this.stateTransformTable[xr.Republishing][xr.Republishing]=!0,this.stateTransformTable[xr.Republishing][xr.Republished]=!0,this.stateTransformTable[xr.Republishing][xr.Unpublishing]=!0,this.stateTransformTable[xr.Republishing][xr.Published]=!0,this.stateTransformTable[xr.Republishing][xr.Destroyed]=!0,this.stateTransformTable[xr.Republished][xr.Republishing]=!0,this.stateTransformTable[xr.Republished][xr.Unpublishing]=!0,this.stateTransformTable[xr.Republished][xr.Destroyed]=!0,this.stateTransformTable[xr.Unpublishing][xr.Unpublished]=!0,this.stateTransformTable[xr.Unpublishing][xr.Destroyed]=!0,this.stateTransformTable[xr.Unpublished][xr.Destroyed]=!0}}]),e}();function Ur(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function Nr(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?Ur(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):Ur(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var jr=function(){function e(t){le(this,e),this.options=t,this.state=new Dr(t.logger),this.connectionStatus=$e.ConnectionConnected,t.stream.info&&(t.stream.info.audio&&t.stream.info.video?(this.streamKind=et.AudioVideo,this.audioMuteWanted=this.options.stream.info.audio.muted,this.simulcastWanted=this.options.stream.info.video.simulcast,this.videoMuteWanted=this.options.stream.info.video.muted):t.stream.info.audio?(this.streamKind=et.AudioOnly,this.audioMuteWanted=this.options.stream.info.audio.muted):t.stream.info.video?(this.streamKind=et.VideoOnly,this.simulcastWanted=this.options.stream.info.video.simulcast,this.videoMuteWanted=this.options.stream.info.video.muted):this.options.logger.warn("now not support mix"))}return pe(e,[{key:"publish",value:function(){if(this.options.logger.info("Publish stream: ".concat(this.options.stream.streamId)),this.state.setState(xr.Publishing)){var e=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(e)&&this.doPublish()}}},{key:"unpublish",value:function(e){if(this.options.logger.info("Unpublish stream: "+this.options.stream.streamId),this.state.setState(xr.Unpublishing)){this.unpublishCb=e;var t=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(t)?this.doUnpublish(e):this.options.logger.info("websocketState: ".concat(t,", unpublish has been cached"))}}},{key:"updateSimulcast",value:function(e,t){this.simulcastWanted=e,this.updateSimulcastCb=t;var r=this.options.rpcClient.getWsState().state,n=this.state.state();["CONNECTED","RECOVERY"].includes(r)?n===xr.Republished||n===xr.Published?this.doUpdateSimulcast(t):this.options.logger.info("publicationState: ".concat(r,",updateSimulcast has been cached")):this.options.logger.info("websocketState: ".concat(r,",updateSimulcast has been cached"))}},{key:"muteAudio",value:function(e,t,r,n){this.audioMuteWanted=!0,this.muteAudioOption={userId:e,cb:t,userData:n};var i=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(i)?o===xr.Republished||o===xr.Published?this.control(e,"mute",t,r,n):this.options.logger.info("publicationState: ".concat(i,",muteAudio has been cached")):this.options.logger.info("websocketState: ".concat(i,",muteAudio has been cached"))}},{key:"muteVideo",value:function(e,t,r,n){this.videoMuteWanted=!0,this.muteVideoOption={userId:e,cb:t,userData:n};var i=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(i)?o===xr.Republished||o===xr.Published?this.control(e,"vmute",t,r,n):this.options.logger.info("publicationState: ".concat(i,",muteVideo has been cached")):this.options.logger.info("websocketState: ".concat(i,",muteVideo has been cached"))}},{key:"unmuteAudio",value:function(e,t,r,n){this.audioMuteWanted=!1,this.unmuteAudioOption={userId:e,cb:t,userData:n};var i=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(i)?o===xr.Republished||o===xr.Published?this.control(e,"unmute",t,r,n):this.options.logger.info("publicationState: ".concat(i,",unmuteAudio has been cached")):this.options.logger.info("websocketState: ".concat(i,",unmuteAudio has been cached"))}},{key:"unmuteVideo",value:function(e,t,r,n){this.videoMuteWanted=!1,this.unmuteVideoOPtion={userId:e,cb:t,userData:n};var i=this.options.rpcClient.getWsState().state,o=this.state.state();["CONNECTED","RECOVERY"].includes(i)?o===xr.Republished||o===xr.Published?this.control(e,"unvmute",t,r,n):this.options.logger.info("publicationState: ".concat(i,",unmuteVideo has been cached")):this.options.logger.info("websocketState: ".concat(i,",unmuteVideo has been cached"))}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("onConnectionRecovery streamId",this.options.stream.streamId,"sessionTimeout",e,"sdp",t),this.state.state()===xr.Unpublishing)return this.doUnpublish(this.unpublishCb);e?t&&(this.options.offerSdp=t.sdp,this.options.stream.streamId=t.pubId,this.republish()):this.recoveryOperations()}},{key:"republish",value:function(){this.options.logger.info("start republish: "+this.options.stream.streamId),this.state.setState(xr.Republishing)&&this.doPublish()}},{key:"recoveryOperations",value:function(){var e,t,r,n,i,o;if(this.audioMuteWanted!==(null===(e=this.options.stream.info)||void 0===e||null===(t=e.audio)||void 0===t?void 0:t.muted))if(this.audioMuteWanted){var a=this.muteAudioOption;this.control(a.userId,"mute",a.cb,a.userData)}else{var s=this.unmuteAudioOption;this.control(s.userId,"unmute",s.cb,s.userData)}if(this.videoMuteWanted!==(null===(r=this.options.stream.info)||void 0===r||null===(n=r.video)||void 0===n?void 0:n.muted))if(this.videoMuteWanted){var c=this.muteVideoOption;this.control(c.userId,"vmute",c.cb,c.userData)}else{var u=this.unmuteVideoOPtion;this.control(u.userId,"unvmute",u.cb,u.userData)}this.simulcastWanted&&null!==(i=this.options.stream.info)&&void 0!==i&&null!==(o=i.video)&&void 0!==o&&o.simulcast&&JSON.stringify(this.simulcastWanted)!==JSON.stringify(this.options.stream.info.video.simulcast)&&this.doUpdateSimulcast(this.updateSimulcastCb)}},{key:"buildPublishParams",value:function(){if(this.streamKind===et.AudioVideo){var e={streamId:this.options.stream.streamId,type:ut(this.options.stream.type),media:{audio:{source:lt(this.options.stream.info.audio.source),muted:this.audioMuteWanted,floor:this.options.stream.info.audio.floor},video:{source:pt(this.options.stream.info.video.source),muted:this.videoMuteWanted,floor:this.options.stream.info.video.floor}},sdp:this.options.offerSdp};return this.simulcastWanted&&this.simulcastWanted.length&&(e.media.video.simulcast=this.simulcastWanted.map((function(e){return Nr(Nr({},e),{},{rid:mt(e.type)})}))),e}if(this.streamKind===et.AudioOnly)return{streamId:this.options.stream.streamId,type:ut(this.options.stream.type),media:{audio:{source:lt(this.options.stream.info.audio.source),muted:this.audioMuteWanted,floor:this.options.stream.info.audio.floor}},sdp:this.options.offerSdp};if(this.streamKind===et.VideoOnly){var t={streamId:this.options.stream.streamId,type:ut(this.options.stream.type),media:{video:{source:pt(this.options.stream.info.video.source),muted:this.videoMuteWanted,floor:this.options.stream.info.video.floor}},sdp:this.options.offerSdp};return this.simulcastWanted&&this.simulcastWanted.length&&(t.media.video.simulcast=this.simulcastWanted.map((function(e){return Nr(Nr({},e),{},{rid:mt(e.type)})}))),t}}},{key:"doPublish",value:function(){var e=this;try{var t=this.buildPublishParams();null!==t&&(this.options.rpcClient.sendRequest({method:"publish",params:t},(function(t){if((e.state.state()!==xr.Publishing||e.state.setState(xr.Published))&&(e.state.state()!==xr.Republishing||e.state.setState(xr.Republished))){if(e.options.publishCb){var r=t.result;e.options.publishCb(Ke.Success,null,{roomId:e.options.roomId,streamId:r.streamId,answer_sdp:r.sdp})}e.recoveryOperations()}}),(function(t){e.options.logger.info("publish stream failed"),e.options.publishCb&&e.options.publishCb(Ke.Failed,t.error.message,{roomId:e.options.roomId,streamId:e.options.stream.streamId})}))||this.options.logger.error("Json Rpc Client send publish request error"))}catch(e){this.options.publishCb&&this.options.publishCb(Ke.Failed,e,{roomId:this.options.roomId}),this.options.logger.error(e)}}},{key:"doUnpublish",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"unpublish",params:{id:this.options.stream.streamId}},(function(){t.state.setState(xr.Unpublished)&&e&&(e(Ke.Success,null,{roomId:t.options.roomId}),t.unpublishCb=null)}),(function(r){e&&(t.options.logger.info("unpublish stream failed"),e(Ke.Failed,r.error.message,{roomId:t.options.roomId}),t.unpublishCb=null)}))||this.options.logger.error("Json Rpc Client send unpublish request error")}},{key:"doUpdateSimulcast",value:function(e){var t=this,r={method:"publishControl",params:{type:"simulcast",streamId:this.options.stream.streamId,simulcast:this.simulcastWanted.map((function(e){return{rid:mt(e.type),maxWidth:e.maxWidth,maxHeight:e.maxHeight}}))}};this.options.rpcClient.sendRequest(r,(function(r){t.options.logger.info("updateSimulcast ".concat(t.options.stream.streamId," success")),t.options.stream.info.video.simulcast=t.simulcastWanted,e&&e(Ke.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("updateSimulcast ".concat(t.options.stream.streamId," failed")),e&&e(Ke.Failed,r.error.message,null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}},{key:"control",value:function(e,t,r,n,i){var o=this,a={method:"controlCommand",params:{type:t,streamId:this.options.stream.streamId,member:e,userData:i}};this.options.logger.info("control command with",t),this.options.rpcClient.sendRequest(a,(function(i){switch(o.options.logger.info("control command with ".concat(t," success")),t){case"mute":n&&n(o.options.roomId,Xe.MuteLocal,{type:ot.Amute,userId:e});break;case"unmute":n&&n(o.options.roomId,Xe.MuteLocal,{type:ot.Aunmute,userId:e}),o.options.stream.info.audio.muted=o.audioMuteWanted;break;case"vmute":n&&n(o.options.roomId,Xe.MuteLocal,{type:ot.Vmute,userId:e});break;case"unvmute":n&&n(o.options.roomId,Xe.MuteLocal,{type:ot.Vunmute,userId:e}),o.options.stream.info.video.muted=o.videoMuteWanted}r&&r(Ke.Success,null,{roomId:o.options.roomId})}),(function(e){o.options.logger.info("control command with ".concat(t," failed")),r&&r(Ke.Failed,e.error.message,{roomId:o.options.roomId})}))||this.options.logger.error("Json Rpc Client send ControlCommand request error")}}]),e}(),Vr=function(){function e(t){le(this,e),this.options=t,this.publiccation=new jr({roomId:this.options.roomId,stream:this.options.stream,offerSdp:this.options.offerSdp,rpcClient:this.options.rpcClient,logger:this.options.logger,publishCb:this.options.publishCb,publishUpdateCb:this.options.publishUpdateCb})}return pe(e,[{key:"publish",value:function(){this.publiccation.publish()}},{key:"unpublish",value:function(e){this.publiccation.unpublish(e)}},{key:"updateSimulcast",value:function(e,t){this.publiccation.updateSimulcast(e,t)}},{key:"muteAudio",value:function(e,t,r,n){this.publiccation.muteAudio(e,t,r,n)}},{key:"muteVideo",value:function(e,t,r,n){this.publiccation.muteVideo(e,t,r,n)}},{key:"unmuteAudio",value:function(e,t,r,n){this.publiccation.unmuteAudio(e,t,r,n)}},{key:"unmuteVideo",value:function(e,t,r,n){this.publiccation.unmuteVideo(e,t,r,n)}},{key:"onConnectionLost",value:function(){this.publiccation.onConnectionLost()}},{key:"onConnectionRecovery",value:function(e,t){this.options.logger.info("localStreams onConnectionRecovery"),this.publiccation.onConnectionRecovery(e,t)}}]),e}();function Fr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Wr,Br=function(){function e(t){le(this,e),this.options=t,this.permissionWanted=t.permission,this.permissionCb=null,this.localStreams=new Map}return pe(e,[{key:"getUserId",value:function(){return this.options.userId}},{key:"switchPermission",value:function(e,t){this.permissionWanted=e,this.permissionCb=t;var r=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(r)?this.doSwitchPermission(t):this.options.logger.info("websocketState: ".concat(r,",the operation has been cached"))}},{key:"publishStream",value:function(e,t,r,n,i,o){var a={roomId:this.options.roomId,stream:{userId:this.options.userId,streamId:e,type:t,info:{}},offerSdp:n.offerSdp,rpcClient:this.options.rpcClient,logger:this.options.logger,publishCb:i,publishUpdateCb:o};r===et.AudioVideo&&(a.stream.info={audio:n.audioInfo,video:n.videoInfo}),r===et.AudioOnly&&(a.stream.info.audio=n.audioInfo),r===et.VideoOnly&&(a.stream.info.video=n.videoInfo);var s=new Vr(a);s.publish(),this.localStreams.set(e,s)}},{key:"unpublishStream",value:function(e,t){var r=this;this.localStreams.has(e)&&this.localStreams.get(e).unpublish((function(n,i,o){n===Ke.Success&&r.localStreams.delete(e),t&&t(n,i,o)}))}},{key:"updateSimulcast",value:function(e,t,r){this.localStreams.has(e)&&this.localStreams.get(e).updateSimulcast(t.simulcast,r)}},{key:"muteAudio",value:function(e,t,r,n){this.localStreams.has(e)&&this.localStreams.get(e).muteAudio(this.options.userId,t,r,n)}},{key:"muteVideo",value:function(e,t,r,n){this.localStreams.has(e)&&this.localStreams.get(e).muteVideo(this.options.userId,t,r,n)}},{key:"unmuteAudio",value:function(e,t,r,n){this.localStreams.has(e)&&this.localStreams.get(e).unmuteAudio(this.options.userId,t,r,n)}},{key:"unmuteVideo",value:function(e,t,r,n){this.localStreams.has(e)&&this.localStreams.get(e).unmuteVideo(this.options.userId,t,r,n)}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("localUser onConnectionRecovery",e),e){var r,n=function(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Fr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Fr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}(new Map(this.localStreams));try{for(n.s();!(r=n.n()).done;){var i=se(r.value,2),o=i[0],a=i[1];this.options.logger.info("localUser onConnectionRecovery",o),a.onConnectionRecovery(e,null==t?void 0:t.get(o)),this.localStreams.delete(o);var s=null==t?void 0:t.get(o).pubId;this.localStreams.set(s,a)}}catch(e){n.e(e)}finally{n.f()}JSON.stringify(this.permissionWanted)!==JSON.stringify(this.options.permission)&&this.doSwitchPermission(this.permissionCb)}}},{key:"doSwitchPermission",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"switchPermission",params:{permission:this.permissionWanted}},(function(r){t.options.logger.info("switch permission success"),t.options.permission=t.permissionWanted,e&&e(Ke.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("switch permission failed"),e&&e(Ke.Failed,r.error.message,t.options.roomId)}))||this.options.logger.error("Json Rpc Client send switch permission request error")}}]),e}();!function(e){e[e.Create=0]="Create",e[e.Subscribing=1]="Subscribing",e[e.Subscribed=2]="Subscribed",e[e.Resubscribing=3]="Resubscribing",e[e.Resubscribed=4]="Resubscribed",e[e.Unsubscribing=5]="Unsubscribing",e[e.Unsubscribed=6]="Unsubscribed",e[e.Destroyed=7]="Destroyed",e[e.StateMax=8]="StateMax"}(Wr||(Wr={}));var Gr=["Create","Subscribing","Subscribed","Resubscribing","Resubscribed","Unsubscribing","Unsubscribed","Destroy"],Hr=function(){function e(t){le(this,e),this.currentState=Wr.Create,this.stateTransformTable=new Array,this.logger=t,this.initStateTransformTable()}return pe(e,[{key:"setState",value:function(e){return this.checkStateChange(this.currentState,e)?(this.logger.info("SubscriptionState : state change from "+Gr[this.currentState]+" to "+Gr[e]),this.currentState=e,!0):(this.logger.error("SubscriptionState : INVALID state change from"+Gr[this.currentState]+" to "+Gr[e]),!1)}},{key:"state",value:function(){return this.currentState}},{key:"checkStateChange",value:function(e,t){return this.stateTransformTable[e][t]}},{key:"initStateTransformTable",value:function(){for(var e=Wr.Create;e<Wr.StateMax;e++){this.stateTransformTable[e]=new Array;for(var t=Wr.Create;t<Wr.StateMax;t++)this.stateTransformTable[e][t]=!1}this.stateTransformTable[Wr.Create][Wr.Subscribing]=!0,this.stateTransformTable[Wr.Create][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Subscribing][Wr.Subscribed]=!0,this.stateTransformTable[Wr.Subscribing][Wr.Unsubscribing]=!0,this.stateTransformTable[Wr.Subscribing][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Subscribing][Wr.Resubscribing]=!0,this.stateTransformTable[Wr.Subscribed][Wr.Unsubscribing]=!0,this.stateTransformTable[Wr.Subscribed][Wr.Resubscribing]=!0,this.stateTransformTable[Wr.Subscribed][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Resubscribing][Wr.Resubscribing]=!0,this.stateTransformTable[Wr.Resubscribing][Wr.Resubscribed]=!0,this.stateTransformTable[Wr.Resubscribing][Wr.Unsubscribing]=!0,this.stateTransformTable[Wr.Resubscribing][Wr.Subscribed]=!0,this.stateTransformTable[Wr.Resubscribing][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Resubscribed][Wr.Resubscribing]=!0,this.stateTransformTable[Wr.Resubscribed][Wr.Unsubscribing]=!0,this.stateTransformTable[Wr.Resubscribed][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Unsubscribing][Wr.Unsubscribed]=!0,this.stateTransformTable[Wr.Unsubscribing][Wr.Destroyed]=!0,this.stateTransformTable[Wr.Unsubscribed][Wr.Destroyed]=!0}}]),e}(),zr=function(){function e(t){le(this,e),this.options=t,this.state=new Hr(t.logger),this.connectionStatus=$e.ConnectionConnected,this.options.rid&&(this.ridWanted=this.options.rid),this.switchSimulcastCb=null,this.unsubscribeCb=null}return pe(e,[{key:"subscribe",value:function(){if(this.options.logger.info("start subscribe: ".concat(this.options.subscriptionId)),this.state.setState(Wr.Subscribing)){var e=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(e)&&this.doSubscribe()}}},{key:"unsubscribe",value:function(e){if(this.options.logger.info("unsubscribe: ".concat(this.options.subscriptionId)),this.state.setState(Wr.Unsubscribing)){this.unsubscribeCb=e;var t=this.options.rpcClient.getWsState().state;["CONNECTED","RECOVERY"].includes(t)?this.doUnsubscribe(this.unsubscribeCb):this.options.logger.info("websocketState: ".concat(t,",unsubscribe has been cached"))}}},{key:"switchSimulcast",value:function(e,t){if(this.ridWanted!==e){this.ridWanted=e,this.switchSimulcastCb=t;var r=this.options.rpcClient.getWsState().state,n=this.state.state();["CONNECTED","RECOVERY"].includes(r)?n===Wr.Resubscribed||n===Wr.Subscribed?this.doSwitchSimulcast(t):this.options.logger.info("publicationState: ".concat(r,",switchSimulcast has been cached")):this.options.logger.info("websocketState: ".concat(r,",switchSimulcast has been cached"))}else this.options.logger.info("can not switch the same simulcast")}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){if(this.options.logger.info("onConnectionRecovery subscriptionId",this.options.subscriptionId,"sessionTimeout",e,"sdp",t),this.state.state()===Wr.Unsubscribing)return this.doUnsubscribe(this.unsubscribeCb);e?t&&(this.options.offerSdp=t.sdp,this.options.subscriptionId=t.subId,this.resubscribe()):this.recoveryOperations()}},{key:"resubscribe",value:function(){this.options.logger.info("start resubscribe: "+this.options.subscriptionId),this.state.setState(Wr.Resubscribing)&&this.doSubscribe()}},{key:"recoveryOperations",value:function(){this.ridWanted&&this.ridWanted!==this.options.rid&&this.doSwitchSimulcast(this.switchSimulcastCb)}},{key:"doSubscribe",value:function(){var e=this;try{var t={userId:this.options.userId,subscriptionId:this.options.subscriptionId,media:{audio:{has:this.options.subAudio},video:{has:this.options.subVideo}},sdp:this.options.offerSdp};this.options.subAudio&&(t.media.audio.streamId=this.options.audioStreamId),this.options.subVideo&&(t.media.video.streamId=this.options.videoStreamId,t.media.video.rid=this.ridWanted),this.options.rpcClient.sendRequest({method:"subscribe",params:t},(function(t){if((e.state.state()!==Wr.Subscribing||e.state.setState(Wr.Subscribed))&&(e.state.state()!==Wr.Resubscribing||e.state.setState(Wr.Resubscribed))){e.options.logger.info("subscribe ".concat(e.options.subscriptionId," success"));var r=t.result;e.options.subscribeCb&&e.options.subscribeCb(Ke.Success,null,{roomId:e.options.roomId,subscriptionId:r.subscriptionId,answer_sdp:r.sdp}),e.recoveryOperations()}}),(function(t){e.options.logger.info("subscribe ".concat(e.options.subscriptionId," failed")),e.options.subscribeCb&&e.options.subscribeCb(Ke.Failed,t.error.message,{roomId:e.options.roomId,subscriptionId:e.options.subscriptionId})}))||this.options.logger.error("Json Rpc Client send subscribe request error")}catch(e){this.options.subscribeCb&&this.options.subscribeCb(Ke.Failed,e,null),this.options.logger.error(e)}}},{key:"doSwitchSimulcast",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"subscribeControl",params:{subscriptionId:this.options.subscriptionId,type:"simulcast",rid:this.ridWanted}},(function(r){t.options.logger.info("switchSimulcast ".concat(t.options.subscriptionId," success")),t.options.rid=t.ridWanted,e&&e(Ke.Success,null,t.options.roomId)}),(function(r){t.options.logger.info("switchSimulcast ".concat(t.options.subscriptionId," failed")),e&&e(Ke.Failed,r.error.message,null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}},{key:"doUnsubscribe",value:function(e){var t=this;this.options.rpcClient.sendRequest({method:"unsubscribe",params:{id:this.options.subscriptionId}},(function(r){t.state.setState(Wr.Unsubscribed)&&(t.options.logger.info("unsubscribe ".concat(t.options.subscriptionId," success")),e&&(e(Ke.Success,null,{roomId:t.options.roomId}),t.unsubscribeCb=null))}),(function(r){t.options.logger.info("unsubscribe ".concat(t.options.subscriptionId," failed")),e&&(e(Ke.Failed,r.error.message,null),t.unsubscribeCb=null)}))||this.options.logger.error("Json Rpc Client send unsubscribe request error")}}]),e}();function Kr(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return Jr(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Jr(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function Jr(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var qr=function(){function e(t){le(this,e),this.options=t,this.subscriptions=new Map}return pe(e,[{key:"subscribe",value:function(e,t,r,n,i,o,a){var s=new zr({roomId:this.options.roomId,userId:this.options.stream.userId,subscriptionId:e,offerSdp:i,subAudio:t,audioStreamId:this.options.stream.streamId,subVideo:r,videoStreamId:this.options.stream.streamId,rid:n,rpcClient:this.options.rpcClient,logger:this.options.logger,subscribeCb:o,subscribeUpdateCb:a});s.subscribe(),this.options.logger.info("remoteStream subscribe subscriptionId",e),this.subscriptions.set(e,s)}},{key:"unsubscribe",value:function(e,t){var r=this;this.subscriptions.has(e)&&this.subscriptions.get(e).unsubscribe((function(n,i,o){n===Ke.Success&&(r.options.logger.info("remoteStream unsubscribe subscriptionId",e),r.subscriptions.delete(e)),t&&t(n,i,o)}))}},{key:"updateSimulcast",value:function(e){this.options.stream.info.video.simulcast=e}},{key:"updateLiveStatus",value:function(e){e.audio&&(this.options.stream.info.audio.muted=e.audio.muted),e.video&&(this.options.stream.info.video.muted=e.video.muted)}},{key:"switchSimulcast",value:function(e,t,r){this.subscriptions.has(e)&&this.subscriptions.get(e).switchSimulcast(t,r)}},{key:"onConnectionLost",value:function(){var e,t=Kr(this.subscriptions.values());try{for(t.s();!(e=t.n()).done;)e.value.onConnectionLost()}catch(e){t.e(e)}finally{t.f()}}},{key:"onConnectionRecovery",value:function(e,t,r){this.options.logger.info("remoteStream onConnectionRecovery subscriptionId",this.subscriptions,t,r);var n,i=Kr(new Map(this.subscriptions));try{for(i.s();!(n=i.n()).done;){var o=se(n.value,2),a=o[1];o[0]===t&&(this.subscriptions.get(t).onConnectionRecovery(e,r),this.subscriptions.delete(t),this.subscriptions.set(null==r?void 0:r.subId,a))}}catch(e){i.e(e)}finally{i.f()}}}]),e}();function Yr(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return $r(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?$r(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function $r(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var Xr=function(){function e(t){le(this,e),this.options=t,this.remoteStreams=new Map,this.streamIdArray=new Array,this.subPubIdMap=new Map}return pe(e,[{key:"addStream",value:function(e){var t=e.streamId;this.remoteStreams.set(t,new qr({roomId:this.options.roomId,stream:e,rpcClient:this.options.rpcClient,logger:this.options.logger})),this.streamIdArray.push(t)}},{key:"deleteStream",value:function(e){if(this.remoteStreams.has(e)){this.remoteStreams.delete(e);var t=this.streamIdArray.indexOf(e);-1!=t&&this.streamIdArray.splice(t,1);var r,n=null,i=Yr(this.subPubIdMap);try{for(i.s();!(r=i.n()).done;){var o=se(r.value,2);o[1]===e&&(n=o[0])}}catch(e){i.e(e)}finally{i.f()}n&&this.subPubIdMap.delete(n)}}},{key:"updateStreamSimulcast",value:function(e,t){this.remoteStreams.has(e)&&this.remoteStreams.get(e).updateSimulcast(t)}},{key:"updateStreamStatus",value:function(e,t){this.remoteStreams.has(e)&&this.remoteStreams.get(e).updateLiveStatus(t)}},{key:"subscribeStream",value:function(e,t,r,n,i,o){this.options.logger.info("remote user subscribe stream",this.remoteStreams.has(t)),this.remoteStreams.has(t)&&(this.remoteStreams.get(t).subscribe(e,n.hasAudio,n.hasVideo,mt(null==n?void 0:n.type),n.offerSdp,i,o),this.options.logger.info("remoteUser subscribeStream subscriptionId",e),this.subPubIdMap.set(e,t))}},{key:"unsubscribeStream",value:function(e,t){var r=this,n=this.subPubIdMap.get(e);n&&this.remoteStreams.has(n)&&this.remoteStreams.get(n).unsubscribe(e,(function(n,i,o){n===Ke.Success&&r.subPubIdMap.delete(e),t&&t(n,i,o)}))}},{key:"switchSimulcast",value:function(e,t,r){var n=this.subPubIdMap.get(e);n&&this.remoteStreams.has(n)&&this.remoteStreams.get(n).switchSimulcast(e,mt(t.type),r)}},{key:"getAllStreamId",value:function(){return this.streamIdArray}},{key:"onConnectionLost",value:function(){}},{key:"onConnectionRecovery",value:function(e,t){this.options.logger.info("remoteUser onConnectionRecovery",e);var r,n=Yr(new Map(this.subPubIdMap));try{for(n.s();!(r=n.n()).done;){var i=se(r.value,2),o=i[0],a=i[1];if(this.options.logger.info("remoteUser onConnectionRecovery subscriptionId",o,"streamId",a),this.remoteStreams.has(a)){this.remoteStreams.get(a).onConnectionRecovery(e,o,t.get(o)),this.subPubIdMap.delete(o);var s=null==t?void 0:t.get(o).subId;this.subPubIdMap.set(s,a)}}}catch(e){n.e(e)}finally{n.f()}}}]),e}(),Qr=function(){function e(t,r){le(this,e),this.options=t,this.wsUrlList=de(t.wsUrl),this.userId=t.userId,this.ssl=t.ssl,this.roomId=t.roomId,this.logger=r,this.wsSocket=null,this.pendingRequests=new Array,this.successCallbacks=new Map,this.errorCallbacks=new Map,this.requestTypes=new Map,this.retryTimerId=0,this.retryCount=0,this.maxRetryCount=30,this.currentId=1,this.times=6e4,this.timer=null,this.state="DISCONNECTED",this.prevState="DISCONNECTED",this.autoReconnected=!0,this.lockReconnect=!1,this.heartCheck=this.initHeartCheck()}var t,r;return pe(e,[{key:"sendRequest",value:function(e,t,r){if(!e)return!1;e.jsonrpc="2.0",e.id="".concat(this.userId,"_").concat(Date.now(),"_").concat(this.currentId++);var n=this;t||(t=function(e){n.logger.debug("success: "+JSON.stringify(e))}),r||(r=function(e){n.logger.debug("error: "+JSON.stringify(e))});var i=JSON.stringify(e);return!!this.wsSocket&&(this.wsSocket.readyState<1?this.pendingRequests.push(i):(n.logger.info("send message: \n"+JSON.stringify(JSON.parse(i),null,4)),this.sendMessage(i)),this.successCallbacks.set(e.id,t),this.errorCallbacks.set(e.id,r),this.requestTypes.set(e.id,e.method),!0)}},{key:"socketReady",value:function(){return this.logger.info("wsSocket readyState",this.wsSocket&&this.wsSocket.readyState),!(null==this.wsSocket||this.wsSocket.readyState>1)}},{key:"connect",value:(r=ue(be.mark((function e(){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.options.wsUrl||0!==this.options.wsUrl.length){e.next=3;break}return this.logger.error("Websocket url is empty!"),e.abrupt("return",!1);case 3:if(this.retryTimerId&&window.clearTimeout(this.retryTimerId),this.socketReady()){e.next=13;break}return this.prevState=this.state,this.state="CONNECTING",this.options.onWsStateChange(this.prevState,this.state,this.retryCount),e.next=10,this.getWsUrl();case 10:this.wsSocket=new WebSocket(e.sent),this.wsSocket&&(this.wsSocket.onmessage=this.onWsMessage.bind(this),this.wsSocket.onclose=this.onWsClose.bind(this),this.wsSocket.onerror=this.onWsError.bind(this),this.wsSocket.onopen=this.onConnect.bind(this));case 13:return e.abrupt("return",!!this.wsSocket);case 14:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"close",value:function(){this.socketReady()&&(this.autoReconnected=!1,this.pendingRequests=[],this.wsSocket.close(),this.resetWs(),this.timer&&clearTimeout(this.timer),this.retryTimerId&&clearTimeout(this.retryTimerId),this.heartCheck.reset(),this.heartCheck=null,this.logger.info("close websocket"))}},{key:"onConnect",value:function(){var e;for(this.heartCheck.start(),this.prevState=this.state,this.retryTimerId?(window.clearTimeout(this.retryTimerId),this.retryTimerId=null,this.state="RECOVERY"):this.state="CONNECTED",this.options.onConnect(this.state),this.retryCount=0,this.options.onWsStateChange(this.prevState,this.state,this.retryCount);e=this.pendingRequests.shift();)this.logger.info("send message: \n"+e),this.sendMessage(e)}},{key:"onWsMessage",value:function(e){var t;if(this.heartCheck&&this.heartCheck.serverTimeoutObj&&(clearTimeout(this.heartCheck.serverTimeoutObj),this.heartCheck.serverTimeoutObj=null),this.timer&&clearTimeout(this.timer),this.timer=null,"object"!==Oe(t=JSON.parse(e.data))||"pong"!==t.method){if(this.logger.info("格式化消息: \n"+JSON.stringify(t,null,4)),"object"===Oe(t)&&"jsonrpc"in t&&"2.0"===t.jsonrpc){var r=t.id,n=this.successCallbacks.get(r),i=this.errorCallbacks.get(r);if("result"in t&&n)return n({jsonrpc:"2.0",id:t.id,result:t.result}),this.successCallbacks.delete(r),void this.errorCallbacks.delete(r);if("error"in t&&i){var o={jsonrpc:"2.0",id:t.id,error:t.error};return this.logger.error("信令返回错误: \n"+JSON.stringify(o,null,4)),i(o),this.successCallbacks.delete(r),void this.errorCallbacks.delete(r)}}if("id"in t){if("function"==typeof this.options.onRequest){var a=this.options.onRequest({jsonrpc:"2.0",id:t.id,method:t.method,params:t.params});a.jsonrpc="2.0",a.id=t.id,this.wsSocket&&this.wsSocket.send(JSON.stringify(a))}}else this.options.onNotification({jsonrpc:"2.0",method:t.method,params:t.params})}}},{key:"onWsClose",value:function(e){this.logger.info("onWsClose",e),this.heartCheck&&this.heartCheck.reset(),this.pendingRequests=[],this.prevState=this.state,this.state="DISCONNECTED",this.prevState!==this.state&&this.options.onWsStateChange(this.prevState,this.state,this.retryCount)}},{key:"onWsError",value:function(e){if(this.logger.info("onWsError",e),this.heartCheck&&this.heartCheck.reset(),this.pendingRequests=[],this.prevState=this.state,this.state="DISCONNECTED",this.prevState!==this.state&&this.options.onWsStateChange(this.prevState,this.state,this.retryCount),0===this.retryCount){this.logger.onError({c:Et.TOP_ERROR,v:ke.SIGNAL_CHANNEL_SETUP_FAILED});var t=new Ue({code:ke.SIGNAL_CHANNEL_SETUP_FAILED,message:"WebSocket connect failed"});"function"==typeof this.options.onError&&this.options.onError(t)}}},{key:"reconnect",value:function(){var e=this;!this.autoReconnected&&this.lockReconnect||(this.lockReconnect=!0,this.prevState=this.state,this.retryTimerId&&clearTimeout(this.retryTimerId),this.retryCount<this.maxRetryCount?this.retryTimerId=window.setTimeout((function(){e.retryCount++,e.logger.info("".concat((new Date).toLocaleString()," Try to reconnect, count: ").concat(e.retryCount)),e.state="RECONNECTING",e.options.onWsStateChange(e.prevState,e.state,e.retryCount),e.resetWs(),e.connect(),e.lockReconnect=!1}),this.getReconnectDelay(this.retryCount)):(this.logger.warn("SDK has tried reconnect signal channel for ".concat(this.maxRetryCount," times, but all failed. please check your network")),this.options.onWsReconnectFailed&&this.options.onWsReconnectFailed()))}},{key:"sendMessage",value:function(e){var t=this;this.wsSocket.send(e),this.timer||(this.timer=setTimeout((function(){t.logger.onError({c:Et.TOP_ERROR,v:ke.SERVER_TIMEOUT},"websocket connection timeout!");var e=new Ue({code:ke.SERVER_TIMEOUT,message:"server timeout"});"function"==typeof t.options.onError&&t.options.onError(e)}),this.times))}},{key:"getWsState",value:function(){return{state:this.state,prevState:this.prevState}}},{key:"resetWs",value:function(){this.wsSocket&&(this.wsSocket.onmessage=null,this.wsSocket.onclose=null,this.wsSocket.onerror=null,this.wsSocket.onopen=null,this.wsSocket=null)}},{key:"initHeartCheck",value:function(){var e=this;return{timeout:2e3,serverTimeout:1e4,timeoutObj:null,serverTimeoutObj:null,reset:function(){return clearInterval(this.timeoutObj),clearTimeout(this.serverTimeoutObj),this.timeoutObj=null,this.serverTimeoutObj=null,this},start:function(){var t=this;this.reset(),this.timeoutObj=setInterval((function(){e.sendMessage(JSON.stringify({jsonrpc:"2.0",id:0,method:"ping",params:{}})),t.serverTimeoutObj||(t.serverTimeoutObj=setTimeout((function(){e.logger.info((new Date).toLocaleString(),"not received pong, close the websocket"),e.onWsError()}),t.serverTimeout))}),this.timeout)}}}},{key:"getReconnectDelay",value:function(e){return Math.round(e/2)+1>6?13e3:3e3}},{key:"getWsUrl",value:(t=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t="","string"==typeof this.options.wsUrl?t="".concat(this.options.wsUrl,"/xsigo?roomNum=").concat(this.roomId,"&userId=").concat(this.userId,"&appKey=").concat(this.options.appId):(r=this.getWsUrlList(),t="".concat(this.ssl?"wss":"ws","://").concat(r,"/xsigo?roomNum=").concat(this.roomId,"&userId=").concat(this.userId,"&appKey=").concat(this.options.appId)),this.options.privateKey&&(t+="&privateKey=".concat(this.options.privateKey)),this.options.extendInfo&&this.options.extendInfo.location&&(t+="&location=".concat(this.options.extendInfo.location)),!(n=this.options.onCustomSignParam)){e.next=13;break}return e.next=8,n();case 8:if("object"===Oe((i=e.sent).getHeader)&&"{}"!==JSON.stringify(i.getHeader)&&(o=i.getHeader,"[object Object]"===Object.prototype.toString.call(o)&&"{}"!==JSON.stringify(o)))for(a=0,s=Object.entries(o);a<s.length;a++)c=se(s[a],2),u=c[1],t+="&".concat(c[0],"=").concat(u);if("object"===Oe(i.getQuery)&&"{}"!==JSON.stringify(i.getQuery)&&(d=i.getQuery,"[object Object]"===Object.prototype.toString.call(d)&&"{}"!==JSON.stringify(d)))for(l=0,h=Object.entries(d);l<h.length;l++)p=se(h[l],2),f=p[1],t+="&".concat(p[0],"=").concat(f);e.next=14;break;case 13:n||(t="".concat(t,"&Authorization=").concat(this.options.userSig));case 14:return e.abrupt("return",t);case 15:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"getWsUrlList",value:function(){var e=this.options.wsUrl.length;if(1===e)return this.options.wsUrl[0];if(e&&!this.wsUrlList.length&&(this.wsUrlList=de(this.options.wsUrl)),e===this.wsUrlList.length)for(;e;){var t=Math.floor(Math.random()*e--),r=[this.wsUrlList[e],this.wsUrlList[t]];this.wsUrlList[t]=r[0],this.wsUrlList[e]=r[1]}return this.wsUrlList.shift()}}]),e}();function Zr(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return en(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?en(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function en(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var tn=function(){function e(t){le(this,e),this.options=t,this.isFirstLogin=!0;var r=t.roomCbs;this.roomCbs={connectionLostCb:r.connectionLostCb,connectionRecoveryCb:r.connectionRecoveryCb,tryToReconnectCb:r.tryToReconnectCb,notificationCb:r.notificationCb,onWsStateChange:r.onWsStateChange,onWsError:r.onWsError,onWsReconnectFailed:r.onWsReconnectFailed},this.remoteUsers=new Map,this.remoteUserIdArray=new Array,this.remoteStreams=new Map,this.remoteStreamIdArray=new Array,this.subUserIdMap=new Map,this.state=new _r(this.options.logger),this.connectionStatus=$e.New}var t,r,n,i;return pe(e,[{key:"enter",value:(i=ue(be.mark((function e(t,r,n,i,o,a,s,c,u,d,l,h,p){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.loginParams={appId:r,userId:i,userType:o,previousRoomId:a,permission:s,userData:c,extendInfo:u},this.state.setState(gr.Entering)){e.next=3;break}return e.abrupt("return");case 3:return this.options.logger.info("Enter Room "+this.options.roomId),this.roomCbs.enterRoomCb=l,e.next=7,this.initJsonRpcClient(t,r,n,i,d,u,h,p);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o,a,s,c,u,d,l,h,p){return i.apply(this,arguments)})},{key:"exit",value:function(e){this.state.setState(gr.Exiting)&&(this.options.logger.info("Exit Room "+this.options.roomId),this.isFirstLogin=!0,this.roomCbs.exitRoomCb=e,this.login.logout())}},{key:"publishStream",value:function(e,t,r,n,i,o){if(this.state.state()==gr.Entered)return this.localUser.publishStream(e,t,r,n,i,o);this.options.logger.info("We are not enter room, can not publish stream")}},{key:"unpublishStream",value:function(e,t){if(this.state.state()==gr.Entered)return this.localUser.unpublishStream(e,t);this.options.logger.info("We are not enter room, can not unpublish stream")}},{key:"updateSimulcast",value:function(e,t,r){if(this.state.state()==gr.Entered)return this.localUser.updateSimulcast(e,t,r);this.options.logger.info("We arn not enter room, can not publish updateSimulcast")}},{key:"muteLocalAudio",value:function(e,t,r){this.state.state()==gr.Entered?this.localUser.muteAudio(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not muteLocalAudio")}},{key:"muteLocalVideo",value:function(e,t,r){this.state.state()==gr.Entered?this.localUser.muteVideo(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not muteLocalVideo")}},{key:"unmuteLocalAudio",value:function(e,t,r){this.state.state()==gr.Entered?this.localUser.unmuteAudio(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not unmuteLocalAudio")}},{key:"unmuteLocalVideo",value:function(e,t,r){this.state.state()==gr.Entered?this.localUser.unmuteVideo(e,t,this.roomCbs.notificationCb,r):this.options.logger.info("We are not enter room, can not unmuteLocalVideo")}},{key:"subscribeStream",value:function(e,t,r,n,i,o,a){this.state.state()==gr.Entered?(this.options.logger.info("room subscribe stream",this.remoteUsers.has(t)),this.remoteUsers.has(t)&&(this.remoteUsers.get(t).subscribeStream(e,r,n,i,o,a),this.subUserIdMap.set(e,t))):this.options.logger.info("We are not enter room, can not subscribe stream")}},{key:"unsubscribeStream",value:function(e,t){if(this.state.state()==gr.Entered)if(this.options.logger.debug("subUserIdMap",this.subUserIdMap,e),this.subUserIdMap.has(e)){var r=this.subUserIdMap.get(e);this.remoteUsers.has(r)?(this.remoteUsers.get(r).unsubscribeStream(e,t),this.subUserIdMap.delete(e)):this.options.logger.info("unsubscription: "+e+"  no related user")}else this.options.logger.info("unsubscription: "+e+"  no related user");else this.options.logger.info("We are not enter room, can not unsubscribe stream")}},{key:"switchSimulcast",value:function(e,t,r){if(this.state.state()==gr.Entered)if(this.subUserIdMap.has(e)){var n=this.subUserIdMap.get(e);this.remoteUsers.has(n)&&this.remoteUsers.get(n).switchSimulcast(e,t,r)}else this.options.logger.info("Subscription: "+e+" not exist");else this.options.logger.info("We are not enter room, can not switchSimulcast")}},{key:"switchPermission",value:function(e,t){var r=this;this.state.state()==gr.Entered?this.localUser.switchPermission(e,(function(n,i,o){1===n&&r.login.updatePermission(e),t&&t(n,i,o)})):this.options.logger.info("We are not enter room, can not switchPermission")}},{key:"getWsState",value:function(){return this.rpcClient.getWsState()}},{key:"onLogin",value:function(e,t,r){if(e===kr.LoginSuccess){if(this.connectionStatus=$e.ConnectionConnected,!this.state.setState(gr.Entered))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," success")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ke.Success,null,{roomId:this.options.roomId,roomUniqueId:t.room.roomUniqueId,participants:t.room.participants});var n=this.buildRemoteUserAndCollectNotification(t,!1),i=this.buildRemoteStreamsAndCollectNotification(t,!1),o=setTimeout((function(){var e,t=Zr(n);try{for(t.s();!(e=t.n()).done;)(0,e.value)()}catch(e){t.e(e)}finally{t.f()}var r,a=Zr(i);try{for(a.s();!(r=a.n()).done;)(0,r.value)()}catch(e){a.e(e)}finally{a.f()}o&&clearTimeout(o),o=null}),300)}else if(e===kr.LoginTimeout){if(!this.state.setState(gr.EnterTimeout))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," timeout")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ke.Timeout,r,{roomId:this.options.roomId})}else if(e===kr.LoginFailed){if(!this.state.setState(gr.EnterFailed))return;this.options.logger.info("Enter Room ".concat(this.options.roomId," failed")),this.roomCbs.enterRoomCb&&this.roomCbs.enterRoomCb(Ke.Failed,r,{roomId:this.options.roomId})}else this.options.logger.error("Enter room result type is invalid!")}},{key:"onRelogin",value:(n=ue(be.mark((function e(t,r,n){var i,o,a,s,c,u,d,l,h,p,f,m,v,g,y,b,S,E,C,T,w,_,k,R;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=22;break}if(this.connectionStatus=$e.ConnectionRecovery,this.options.logger.info("onRelogin:",t,r,n),i=this.buildRemoteUserAndCollectNotification(n,!0),o=this.buildRemoteStreamsAndCollectNotification(n,!0),a=n.room.roomUniqueId,s=null,!this.roomCbs.connectionRecoveryCb){e.next=16;break}return e.next=10,this.roomCbs.connectionRecoveryCb(this.options.roomId,a,r);case 10:this.localUser.onConnectionRecovery(r,null===(c=s=e.sent)||void 0===c?void 0:c.publishOfferSdp),u=new Map(this.subUserIdMap),this.options.logger.info("subUserIdMap",u,s),d=Zr(u);try{for(d.s();!(l=d.n()).done;)f=se(l.value,2),m=f[0],v=f[1],null!==(h=s)&&void 0!==h&&null!==(p=h.subscribeOfferSdp)&&void 0!==p&&p.has(m)&&(S=null===(g=s)||void 0===g||null===(y=g.subscribeOfferSdp)||void 0===y||null===(b=y.get(m))||void 0===b?void 0:b.subId,this.subUserIdMap.delete(m),this.subUserIdMap.set(S,v))}catch(e){d.e(e)}finally{d.f()}case 16:E=Zr(this.remoteUsers.values());try{for(E.s();!(C=E.n()).done;)C.value.onConnectionRecovery(r,null===(T=s)||void 0===T?void 0:T.subscribeOfferSdp)}catch(e){E.e(e)}finally{E.f()}w=Zr(i);try{for(w.s();!(_=w.n()).done;)(0,_.value)()}catch(e){w.e(e)}finally{w.f()}k=Zr(o);try{for(k.s();!(R=k.n()).done;)(0,R.value)()}catch(e){k.e(e)}finally{k.f()}case 22:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"onLogout",value:function(e,t){if(e===Rr.LogoutSuccess){if(!this.state.setState(gr.Exited))return;this.options.logger.info("Exit Room "+this.options.roomId+" success"),this.roomCbs.exitRoomCb&&this.roomCbs.exitRoomCb(Ke.Success,null,{roomId:this.options.roomId,reason:Je.ActivelyLeave}),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if(e===Rr.LogoutFailed){if(!this.state.setState(gr.ExitFailed))return;this.roomCbs.exitRoomCb&&(this.options.logger.info("exit room failed"),this.roomCbs.exitRoomCb(Ke.Failed,t,{roomId:this.options.roomId,reason:Je.ActivelyLeave})),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if(e===Rr.LogoutTimeout){if(!this.state.setState(gr.ExitTimeout))return;this.options.logger.info("Exit Room "+this.options.roomId+" timeout"),this.roomCbs.exitRoomCb&&(this.options.logger.info("exit room timeout"),this.roomCbs.exitRoomCb(Ke.Failed,t,{roomId:this.options.roomId,reason:Je.ActivelyLeave})),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else this.options.logger.error("Exit room result type is invalid!")}},{key:"onNotification",value:function(e){this.options.logger.info("room: "+this.options.roomId+" receive notification message");var t,r=e.method;if(r)if("participant"===r){var n=e.params.type;if("join"===n){var i=e.params,o={participant:{userId:i.userId,previousRoomId:i.previousRoomId,userData:i.userData}};this.buildRemoteUser(o.participant),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+o.participant.userId+"join notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.ParticipantJoin,o))}else if("leave"===n){var a=e.params,s={userId:a.userId,reason:a.reason};this.remoteUsers.has(s.userId)&&this.deleteRemoteUser(s.userId),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+s.userId+" leave notification",this.remoteStreams,this.remoteUsers,this.remoteStreamIdArray),this.roomCbs.notificationCb(this.options.roomId,Xe.ParticipantLeave,s))}else this.options.logger.error("participant notification type error!!!")}else if("stream"===r){var c=e.params.type;if("add"===c){var u={stream:Cr(e.params)};this.options.logger.info("room-add ",this.remoteStreams,this.remoteUsers,u),this.remoteUsers.has(u.stream.userId)&&!this.remoteStreams.has(u.stream.streamId)&&(this.buildRemoteStream(u.stream),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+u.stream.userId+", stream "+u.stream.streamId+" add notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.StreamAdd,u)))}else if("remove"===c){var d=e.params,l={userId:d.userId,streamId:d.streamId};this.remoteStreams.has(l.streamId)&&(this.deleteRemoteStream(l.streamId),this.options.logger.info("room-remove ",this.remoteStreams,this.remoteUsers,l),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+l.userId+", stream "+l.streamId+" remove notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.StreamRemove,l)))}else if("update"===c){var h=e.params,p={userId:h.userId,streamId:h.streamId,liveStatus:h.data.liveStatus,userData:h.userData};h.data.simulcast&&this.remoteStreams.has(p.streamId)&&(p.simulcast=Sr(h.data.simulcast),this.remoteStreams.get(p.streamId).info.video.simulcast=p.simulcast,this.remoteUsers.get(p.userId).updateStreamSimulcast(p.streamId,p.simulcast)),h.data.liveStatus&&(p.liveStatus=h.data.liveStatus,this.remoteStreams.has(p.streamId)&&(p.liveStatus.audio&&(this.remoteStreams.get(p.streamId).info.audio.muted=p.liveStatus.audio.muted),p.liveStatus.video&&(this.remoteStreams.get(p.streamId).info.video.muted=p.liveStatus.video.muted),this.remoteUsers.get(p.userId).updateStreamStatus(p.streamId,p.liveStatus))),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+p.userId+", stream "+p.streamId+" update notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.StreamUpdate,p))}else this.options.logger.error("Stream notification type error!!!")}else if("drop"===r){var f={cause:(t=e.params.cause,"kicked"==t?Ye.Kicked:"repeatlogin"==t?Ye.RepeatLogin:"disbanded"==t?Ye.RoomDissolved:Ye.Unknown)};if(!this.state.setState(gr.Destroyed))return;this.roomCbs.notificationCb&&(this.options.logger.info("drop notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.Drop,f)),this.rpcClient&&(this.rpcClient.close(),this.rpcClient=null)}else if("permission"===r){var m=e.params,v={userId:m.userId,publish:m.publish,subscribe:m.subscribe,control:m.control};this.roomCbs.notificationCb&&(this.options.logger.info("permission change notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.PermissionChange,v));var g=v.publish&&(v.publish.audio||v.publish.video);if(this.remoteUsers.has(v.userId)){if(!g){this.deleteRemoteUser(v.userId);var y={userId:v.userId,reason:qe.Normal};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+y.userId+"leave notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.ParticipantLeave,y))}}else if(g){var b={userId:v.userId,previousRoomId:"",userData:{userId:v.userId,userName:""}};this.buildRemoteUser(b),this.roomCbs.notificationCb&&(this.options.logger.info("user: "+b.userId+"join notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.ParticipantJoin,{participant:b}))}}}},{key:"onRpcStateChange",value:function(e,t,r){this.options.logger.info("prevState: ".concat(e,",state: ").concat(t)),"DISCONNECTED"===t?this.onConnectionLost():"RECONNECTING"===t&&this.onTryToReconenct(),this.roomCbs.onWsStateChange&&this.roomCbs.onWsStateChange(this.options.roomId,e,t)}},{key:"onConnectionLost",value:function(){this.options.logger.info("room: "+this.options.roomId+" connection lost!!!"),this.connectionStatus=$e.ConnectionLost;var e,t=Zr(this.remoteUsers.values());try{for(t.s();!(e=t.n()).done;)e.value.onConnectionLost()}catch(e){t.e(e)}finally{t.f()}this.roomCbs.connectionLostCb&&this.roomCbs.connectionLostCb(this.options.roomId),this.rpcClient.reconnect()}},{key:"onTryToReconenct",value:function(){this.options.logger.info("room: "+this.options.roomId+" connection retring ......"),this.connectionStatus=$e.ConnectionRetring,this.roomCbs.tryToReconnectCb&&this.roomCbs.tryToReconnectCb(this.options.roomId)}},{key:"onConnectionRecovery",value:function(){this.options.logger.info("room: ".concat(this.options.roomId," connection recovery!!!")),this.state.state()!=gr.Entering&&this.login.onConnectionRecovery()}},{key:"onRpcReconnectFailed",value:function(){this.options.logger.info("room: "+this.options.roomId+" reconnection failed!!!"),this.roomCbs.onWsReconnectFailed&&this.roomCbs.onWsReconnectFailed(this.options.roomId)}},{key:"initJsonRpcClient",value:(r=ue(be.mark((function e(t,r,n,i,o,a,s,c){var u;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u={onCustomSignParam:t,appId:r,userSig:n,userId:i,privateKey:o,extendInfo:a,wsUrl:this.options.serverUrl,ssl:s,roomId:c,onRequest:null,onNotification:this.onNotification.bind(this),onError:this.roomCbs.onWsError,onConnect:this.initLoginAndLocalUser.bind(this),onWsStateChange:this.onRpcStateChange.bind(this),onWsReconnectFailed:this.onRpcReconnectFailed.bind(this)},this.rpcClient=new Qr(u,this.options.logger),e.next=4,this.rpcClient.connect();case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,n,i,o,a,s,c){return r.apply(this,arguments)})},{key:"initLoginAndLocalUser",value:(t=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u,d;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.isFirstLogin){e.next=2;break}return e.abrupt("return",this.onConnectionRecovery());case 2:return this.isFirstLogin=!1,r=(t=this.loginParams).appId,n=t.userId,i=t.userType,o=t.previousRoomId,a=t.permission,s=t.userData,c=t.extendInfo,e.next=6,new Promise(function(){var e=ue(be.mark((function e(t){var r;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r={sdk:{type:"WebRTC",version:"5.2024.2.1_00_hotfix2"},device:{osName:"",osVersion:"".concat(st,"/").concat(ct),netType:Ge()},capabilities:{isp:"unknown",location:"unknown",trikleIce:!1,secure:!0}},e.prev=1,e.next=4,new Promise(function(){var e=ue(be.mark((function e(t,r){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!He.any()){e.next=5;break}t(He.getOsName()),e.next=9;break;case 5:return e.next=7,new Promise(function(){var e=ue(be.mark((function e(t,r){var n,i,o,a,s,c,u,d;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n="-",i=navigator.appVersion,o=navigator.userAgent,a=n,s=[{s:"Chrome OS",r:/CrOS/},{s:"Windows 10",r:/(Windows 10.0|Windows NT 10.0)/},{s:"Windows 8.1",r:/(Windows 8.1|Windows NT 6.3)/},{s:"Windows 8",r:/(Windows 8|Windows NT 6.2)/},{s:"Windows 7",r:/(Windows 7|Windows NT 6.1)/},{s:"Windows Vista",r:/Windows NT 6.0/},{s:"Windows Server 2003",r:/Windows NT 5.2/},{s:"Windows XP",r:/(Windows NT 5.1|Windows XP)/},{s:"Windows 2000",r:/(Windows NT 5.0|Windows 2000)/},{s:"Windows ME",r:/(Win 9x 4.90|Windows ME)/},{s:"Windows 98",r:/(Windows 98|Win98)/},{s:"Windows 95",r:/(Windows 95|Win95|Windows_95)/},{s:"Windows NT 4.0",r:/(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/},{s:"Windows CE",r:/Windows CE/},{s:"Windows 3.11",r:/Win16/},{s:"Android",r:/Android/},{s:"Open BSD",r:/OpenBSD/},{s:"Sun OS",r:/SunOS/},{s:"Linux",r:/(Linux|X11)/},{s:"iOS",r:/(iPhone|iPad|iPod)/},{s:"Mac OS X",r:/Mac OS X/},{s:"Mac OS",r:/(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/},{s:"QNX",r:/QNX/},{s:"UNIX",r:/UNIX/},{s:"BeOS",r:/BeOS/},{s:"OS/2",r:/OS\/2/},{s:"Search Bot",r:/(nuhk|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask Jeeves\/Teoma|ia_archiver)/}],c=0;case 6:if(!(u=s[c])){e.next=13;break}if(!u.r.test(o)){e.next=10;break}return a=u.s,e.abrupt("break",13);case 10:c++,e.next=6;break;case 13:if(d=n,!/Windows/.test(a)){e.next=28;break}if(!/Windows (.*)/.test(a)){e.next=27;break}if(10!=(d=/Windows (.*)/.exec(a)[1])){e.next=27;break}return e.prev=18,e.next=21,new Promise((function(e){navigator&&navigator.userAgentData&&navigator.userAgentData.getHighEntropyValues?navigator.userAgentData.getHighEntropyValues(["platformVersion"]).then((function(t){if(navigator.userAgentData.platform&&"windows"===navigator.userAgentData.platform.toLowerCase()&&t.platformVersion){var r=parseInt(t.platformVersion.split(".")[0]);e(r>=13?11:10)}else e(10)})).catch((function(){e(10)})):e(10)}));case 21:d=e.sent,e.next=27;break;case 24:e.prev=24,e.t0=e.catch(18),d=10;case 27:a="Windows";case 28:e.t1=a,e.next="Mac OS X"===e.t1?31:"Android"===e.t1?33:"iOS"===e.t1?35:37;break;case 31:return/Mac OS X (10[/._\d]+)/.test(o)&&(d=/Mac OS X (10[\.\_\d]+)/.exec(o)[1]),e.abrupt("break",37);case 33:return/Android ([\.\_\d]+)/.test(o)&&(d=/Android ([\.\_\d]+)/.exec(o)[1]),e.abrupt("break",37);case 35:return/OS (\d+)_(\d+)_?(\d+)?/.test(o)&&(d=(d=/OS (\d+)_(\d+)_?(\d+)?/.exec(i))[1]+"."+d[2]+"."+(0|d[3])),e.abrupt("break",37);case 37:t({osName:a+d,type:"desktop"});case 38:case"end":return e.stop()}}),e,null,[[18,24]])})));return function(t,r){return e.apply(this,arguments)}}());case 7:t(e.sent);case 9:e.next=14;break;case 11:e.prev=11,e.t0=e.catch(0),r(e.t0);case 14:case"end":return e.stop()}}),e,null,[[0,11]])})));return function(t,r){return e.apply(this,arguments)}}());case 4:r.device.osName=e.sent.osName,t(r),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),t(r);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})));return function(t){return e.apply(this,arguments)}}());case 6:u=e.sent,c&&c.location&&(u.capabilities.location=c.location),d={appId:r,userId:n,userType:i,roomId:this.options.roomId,previousRoomId:o,userAgent:u,permission:a,userData:s,rpcClient:this.rpcClient,logger:this.options.logger,loginCb:this.onLogin.bind(this),reloginCb:this.onRelogin.bind(this),logoutCb:this.onLogout.bind(this)},this.login=new Lr(d),this.localUser=new Br({userId:n,roomId:this.options.roomId,previousRoomId:o,userAgent:d.userAgent,permission:a,userData:s,rpcClient:this.rpcClient,logger:this.options.logger}),this.login.login();case 13:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"buildRemoteUser",value:function(e){var t=e.userId,r=new Xr({roomId:this.options.roomId,participant:e,rpcClient:this.rpcClient,logger:this.options.logger});this.remoteUsers.set(t,r),this.remoteUserIdArray.push(t),this.options.logger.info("this.remoteUsers",JSON.stringify(this.remoteUsers,null,4))}},{key:"deleteRemoteStream",value:function(e){if(this.options.logger.info("delete-streamId",e,this.remoteStreams),this.remoteStreams.has(e)){var t=this.remoteStreams.get(e).userId;this.remoteUsers.has(t)&&this.remoteUsers.get(t).deleteStream(e),this.remoteStreams.delete(e);var r=this.remoteStreamIdArray.indexOf(e);-1!=r&&this.remoteStreamIdArray.splice(r,1)}}},{key:"deleteRemoteUser",value:function(e){if(this.remoteUsers.has(e)){var t,r=Zr(JSON.parse(JSON.stringify(this.remoteUsers.get(e).getAllStreamId())));try{for(r.s();!(t=r.n()).done;)this.deleteRemoteStream(t.value)}catch(e){r.e(e)}finally{r.f()}this.remoteUsers.delete(e);var n=this.remoteUserIdArray.indexOf(e);-1!=n&&this.remoteUserIdArray.splice(n,1)}}},{key:"buildRemoteStream",value:function(e){var t=e.streamId;this.remoteUsers.get(e.userId).addStream(e),this.remoteStreams.set(t,e),this.remoteStreamIdArray.push(t)}},{key:"buildRemoteUserAndCollectNotification",value:function(e,t){var r=this,n=new Array;if(t){var i,o=Zr(e.room.participants);try{var a=function(){var e=i.value,t={participant:e},o=e.userId;if(o===r.localUser.getUserId())return"continue";r.remoteUsers.has(o)||(r.buildRemoteUser(e),n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+t.participant.userId+"join notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.ParticipantJoin,t))})))};for(o.s();!(i=o.n()).done;)a()}catch(e){o.e(e)}finally{o.f()}var s,c=Zr(JSON.parse(JSON.stringify(this.remoteUserIdArray)));try{for(c.s();!(s=c.n()).done;){var u,d=s.value,l=!0,h=Zr(e.room.participants);try{for(h.s();!(u=h.n()).done;)u.value.userId===d&&(l=!1)}catch(e){h.e(e)}finally{h.f()}if(l){this.deleteRemoteUser(d);var p={userId:d,reason:qe.Normal};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+p.userId+"leave notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.ParticipantLeave,p))}}}catch(e){c.e(e)}finally{c.f()}}else{var f,m=Zr(e.room.participants);try{var v=function(){var e=f.value,t={participant:e};if(e.userId===r.localUser.getUserId())return"continue";r.buildRemoteUser(e),n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: ".concat(t.participant.userId," join notification")),r.roomCbs.notificationCb(r.options.roomId,Xe.ParticipantJoin,t))}))};for(m.s();!(f=m.n()).done;)v()}catch(e){m.e(e)}finally{m.f()}}return n}},{key:"buildRemoteStreamsAndCollectNotification",value:function(e,t){var r=this,n=new Array;if(t){var i,o=Zr(JSON.parse(JSON.stringify(this.remoteStreamIdArray)));try{for(o.s();!(i=o.n()).done;){var a,s=i.value,c=!0,u=Zr(e.room.streams);try{for(u.s();!(a=u.n()).done;)a.value.streamId===s&&(c=!1)}catch(e){u.e(e)}finally{u.f()}if(c&&this.remoteStreams.has(s)){var d=this.remoteStreams.get(s).userId;this.deleteRemoteStream(s);var l={userId:d,streamId:s};this.roomCbs.notificationCb&&(this.options.logger.info("user: "+l.userId+", stream "+l.streamId+" remove notification"),this.roomCbs.notificationCb(this.options.roomId,Xe.StreamRemove,l))}}}catch(e){o.e(e)}finally{o.f()}var h,p=Zr(e.room.streams);try{var f=function(){var e=h.value,t={stream:Er(e)},i=e.userId,o=e.streamId;if(i===r.localUser.getUserId())return"continue";if(r.remoteStreams.has(o)){if(e.info.audio&&e.info.audio.muted!=r.remoteStreams.get(o).info.audio.muted){var a={audio:{muted:e.info.audio.muted,floor:e.info.audio.floor}};r.remoteStreams.get(o).info.audio.muted=e.info.audio.muted,r.remoteStreams.get(o).info.audio.floor=e.info.audio.floor,r.remoteUsers.get(i).updateStreamStatus(o,a);var s={userId:i,streamId:o,liveStatus:a};n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+i+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.StreamUpdate,s))}))}if(e.info.video&&e.info.video.muted!=r.remoteStreams.get(o).info.video.muted){var c={video:{muted:e.info.video.muted,floor:e.info.video.floor}};r.remoteStreams.get(o).info.video.muted=e.info.video.muted,r.remoteStreams.get(o).info.video.floor=e.info.video.floor,r.remoteUsers.get(i).updateStreamStatus(o,c);var u={userId:i,streamId:o,liveStatus:c};n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+i+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.StreamUpdate,u))}))}if(e.info.video&&e.info.video.simulcast&&e.info.video.simulcast.length!=r.remoteStreams.get(o).info.video.simulcast.length){var d=Sr(e.info.video.simulcast);r.remoteStreams.get(o).info.video.simulcast=d,r.remoteUsers.get(i).updateStreamSimulcast(o,d);var l={userId:i,streamId:o,simulcast:d};n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+i+", stream "+o+" update notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.StreamUpdate,l))}))}}else{if(!r.remoteUsers.has(i))return r.options.logger.error("Stream "+o+" no related user!"),{v:n};r.buildRemoteStream(t.stream),n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+i+", stream "+o+" add notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.StreamAdd,t))}))}};for(p.s();!(h=p.n()).done;){var m=f();if("continue"!==m&&"object"===Oe(m))return m.v}}catch(e){p.e(e)}finally{p.f()}}else{var v,g=Zr(e.room.streams);try{var y=function(){var e=v.value,t={stream:Er(e)},i=e.userId,o=e.streamId;return i===r.localUser.getUserId()?"continue":r.remoteUsers.has(i)?(r.buildRemoteStream(t.stream),void n.push((function(){r.roomCbs.notificationCb&&(r.options.logger.info("user: "+i+", stream "+o+" add notification"),r.roomCbs.notificationCb(r.options.roomId,Xe.StreamAdd,t))}))):(r.options.logger.error("Stream "+o+" no related user!"),{v:n})};for(g.s();!(v=g.n()).done;){var b=y();if("continue"!==b&&"object"===Oe(b))return b.v}}catch(e){g.e(e)}finally{g.f()}}return n}}]),e}();function rn(){function e(){return(65536*(1+Math.random())|0).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}var nn,on=function(){function e(t,r){le(this,e),this.rooms=new Map,this.logger=t,this.roomCbs=r}return pe(e,[{key:"enterRoom",value:function(e,t){var r=t.onCustomSignParam,n=t.appId,i=t.userSig,o=t.userId,a=t.userType,s=t.previousRoomId,c=t.permission,u=t.userData,d=t.extendInfo,l=t.serverUrl,h=t.privateKey,p=t.enterRoomCb,f=t.ssl;if(this.logger.info("XsigoStackClient enterRoom: "+e),!this.rooms.has(e)){var m=new tn({roomId:e,serverUrl:l,logger:this.logger,roomCbs:this.roomCbs});this.rooms.set(e,m)}this.rooms.get(e).enter(r,n,i,o,a,s,c,u,d,h,p,f,e)}},{key:"exitRoom",value:function(e,t){if(this.logger.info("XsigoStackClient exitRoom: "+e),this.rooms.has(e))return this.rooms.get(e).exit(t),void this.rooms.delete(e);this.logger.error("XsigoStackClient exitRoom: "+e+"error, room not exist")}},{key:"publishStream",value:function(e,t){var r=t.streamType,n=t.streamKind,i=t.params,o=t.cb,a=t.updateCb,s=rn();if(this.logger.info("XsigoStackClient publishStream :  "+s+" in room"+e,this.rooms.has(e)),this.rooms.has(e))return this.rooms.get(e).publishStream(s,r,n,i,o,a),s}},{key:"unpublishStream",value:function(e,t,r){this.logger.info("XsigoStackClient unpublishStream :  "+t+" in room"+e),this.rooms.has(e)&&this.rooms.get(e).unpublishStream(t,r)}},{key:"updateSimulcast",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).updateSimulcast(t,r,n)}},{key:"muteAudio",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).muteLocalAudio(t,r,n)}},{key:"muteVideo",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).muteLocalVideo(t,r,n)}},{key:"unmuteAudio",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).unmuteLocalAudio(t,r,n)}},{key:"unmuteVideo",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).unmuteLocalVideo(t,r,n)}},{key:"subscribeStream",value:function(e,t){var r=t.publisherUserId,n=t.streamId,i=t.streamKind,o=t.params,a=t.cb,s=t.updateCb;this.logger.info("XsigoStackClient subscribeStream :  "+n+" in room"+e);var c=rn();return this.rooms.has(e)?(this.rooms.get(e).subscribeStream(c,r,n,i,o,a,s),c):""}},{key:"unsubscribeStream",value:function(e,t,r){this.logger.info("XsigoStackClient unsubscribe :  "+t+" in room"+e),this.rooms.has(e)&&this.rooms.get(e).unsubscribeStream(t,r)}},{key:"switchSimulcast",value:function(e,t,r,n){this.rooms.has(e)&&this.rooms.get(e).switchSimulcast(t,r,n)}},{key:"switchPermission",value:function(e,t,r){this.rooms.has(e)&&this.rooms.get(e).switchPermission(t,r)}},{key:"getWsState",value:function(e){if(this.rooms.has(e))return this.rooms.get(e).getWsState()}},{key:"isDisconnected",value:function(e){var t=this.getWsState(e).state;return["CONNECTED","RECOVERY"].includes(t)||this.logger.warn("cannot operate during network disconnection"),!["CONNECTED","RECOVERY"].includes(t)}}]),e}();function an(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function sn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?an(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):an(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.AuthTypeHeader=0]="AuthTypeHeader",e[e.AuthTypeQuery=1]="AuthTypeQuery"}(nn||(nn={}));var cn={appKey:null,authorization:"",timeout:1e4,extendInfo:{},ssl:!0,onCustomSignParam:null,path:"",privateKey:"",timeoutObj:{},init:function(e){var t=e.sdkAppId,r=e.userSig,n=e.onCustomSignParam,i=e.extendInfo,o=e.userId;this.ssl=e.ssl,this.userId=o,this.appKey=t,this.authorization=r,this.onCustomSignParam=n,this.extendInfo=i},timeoutPromise:function(e,t,r){var n=this;return new Promise((function(i,o){n.timeoutObj[r]=setTimeout((function(){i(new Response("timeout",{status:408,statusText:"request timeout"})),t.abort()}),e)}))},getHeader:function(){var e=this;return ue(be.mark((function t(){var r,n;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.onCustomSignParam){t.next=18;break}return t.next=3,e.onCustomSignParam();case 3:if((r=t.sent).getHeader){t.next=6;break}return t.abrupt("return",new Headers({"Content-Type":"application/json",appKey:e.appKey,userId:e.userId}));case 6:if("object"!==Oe(r.getHeader)){t.next=15;break}if(n=r.getHeader,"[object Object]"!==Object.prototype.toString.call(n)){t.next=12;break}return t.abrupt("return",new Headers(sn({"Content-Type":"application/json",appKey:e.appKey},n)));case 12:throw new Error("onCustomSignParam.getHeader result is not an object");case 13:t.next=16;break;case 15:throw new Error("onCustomSignParam.getHeader is not a object");case 16:t.next=19;break;case 18:return t.abrupt("return",new Headers({"Content-Type":"application/json",appKey:e.appKey,Authorization:e.authorization,userId:e.userId}));case 19:case"end":return t.stop()}}),t)})))()},getQuerys:function(){var e=this;return ue(be.mark((function t(){var r,n,i,o,a,s,c;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.onCustomSignParam){t.next=20;break}return t.next=3,e.onCustomSignParam();case 3:if((r=t.sent).getQuery){t.next=6;break}return t.abrupt("return","");case 6:if("object"!==Oe(r.getQuery)){t.next=17;break}if(n=r.getQuery,"[object Object]"!==Object.prototype.toString.call(n)){t.next=14;break}for(i="",o=0,a=Object.entries(n);o<a.length;o++)s=se(a[o],2),c=s[1],i+="&".concat(s[0],"=").concat(c);return t.abrupt("return",i.slice(1));case 14:throw new Error("onCustomSignParam.getQuery result is not an object");case 15:t.next=18;break;case 17:throw new Error("onCustomSignParam.getQuery is not a object");case 18:t.next=21;break;case 20:return t.abrupt("return","");case 21:case"end":return t.stop()}}),t)})))()},baseUrl:function(e){return e.includes("https://")||e.includes("http://")?e:"".concat(this.ssl?"https://":"http://").concat(e)},getAppConfig:function(e,t){var r=this;return ue(be.mark((function n(){var i,o,a,s,c;return be.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r.path=r.baseUrl(e),n.next=3,r.getQuerys();case 3:return i=n.sent,n.next=6,r.getHeader();case 6:return o=n.sent,a=new AbortController,s="".concat(r.path,"/api/v1/app/config/get?").concat(i&&i+"&","appId=").concat(r.appKey),r.extendInfo&&r.extendInfo.location&&(s+="&location=".concat(r.extendInfo.location)),t&&(r.privateKey=t,s+="&privateKey=".concat(t)),c=function(){return fetch(s,{method:"GET",headers:o,signal:a.signal})},n.abrupt("return",Promise.race([r.timeoutPromise(r.timeout,a,"getAppConfig"),c()]).then((function(e){if(e.ok)return e.json();throw new Ue(401===e.status?{code:ke.AUTHORIZATION_FAILED,message:"Authorization failed: /api/v1/app/config/get?appId"}:404===e.status?{code:ke.GET_SERVER_NODE_FAILED,message:"404: /api/v1/app/config/get?appId"}:408===e.status?{code:ke.REQUEST_TIMEOUT,message:"".concat(e.statusText,": /api/v1/app/config/get?appId")}:{code:ke.SERVER_UNKNOWN_ERROR,message:"Server unknown error: /api/v1/app/config/get?appId"})})).catch((function(e){return Promise.reject(s+e)})).finally((function(){r.timeoutObj.getAppConfig&&clearTimeout(r.timeoutObj.getAppConfig),r.timeoutObj.getAppConfig=null})));case 13:case"end":return n.stop()}}),n)})))()},getWsUrl:function(e,t,r){var n=this;return ue(be.mark((function i(){var o,a,s,c,u;return be.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return n.path=n.baseUrl(t),i.next=3,n.getQuerys();case 3:return o=i.sent,i.next=6,n.getHeader();case 6:return a=i.sent,s="".concat(n.path,"/api/v1/dispatch/get-can-use?").concat(o&&o+"&","mucNum=").concat(e),n.extendInfo&&n.extendInfo.location&&(s+="&location=".concat(n.extendInfo.location)),r&&(s+="&privateKey=".concat(r)),c=new AbortController,u=function(){return fetch(s,{method:"GET",headers:a,signal:c.signal})},i.abrupt("return",Promise.race([n.timeoutPromise(n.timeout,c,"getWsUrl"),u()]).then((function(e){if(e.ok)return e.json();throw new Ue(401===e.status?{code:ke.AUTHORIZATION_FAILED,message:"Authorization failed: /api/v1/dispatch/get-can-use?mucNum"}:404===e.status?{code:ke.GET_SERVER_NODE_FAILED,message:"404: /api/v1/dispatch/get-can-use?mucNum"}:408===e.status?{code:ke.REQUEST_TIMEOUT,message:"".concat(e.statusText,": /api/v1/dispatch/get-can-use?mucNum")}:{code:ke.SERVER_UNKNOWN_ERROR,message:"Server unknown error: /api/v1/dispatch/get-can-use?mucNum"})})).catch((function(e){return Promise.reject(s+e)})).finally((function(){n.timeoutObj.getWsUrl&&clearTimeout(n.timeoutObj.getWsUrl),n.timeoutObj.getWsUrl=null})));case 13:case"end":return i.stop()}}),i)})))()},upload:function(e){var t=this;return ue(be.mark((function r(){var n,i,o;return be.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.getQuerys();case 2:return n=r.sent,r.next=5,t.getHeader();case 5:return i=r.sent,o="".concat(t.path,"/api/v1/logging/collect/list").concat(n&&"?".concat(n)),t.extendInfo&&t.extendInfo.location&&(o+=n?"&location=".concat(t.extendInfo.location):"?location=".concat(t.extendInfo.location)),t.privateKey&&(o+=n?"&privateKey=".concat(t.privateKey):"?privateKey=".concat(t.privateKey)),r.abrupt("return",fetch(o,{method:"POST",body:JSON.stringify(e),headers:i}).then((function(e){if(e.ok)return e.json();throw new Ue({code:e.status,message:e.statusText})})).catch((function(e){return Promise.reject(e)})));case 10:case"end":return r.stop()}}),r)})))()}};function un(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function dn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?un(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):un(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function ln(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return hn(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?hn(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(s)throw o}}}}function hn(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var pn,fn,mn=function(){function e(t,r){le(this,e),this.logger=r,this.ssl=!!t.ssl||!!t.wsUrl.includes("https")||!t.wsUrl.includes("http"),this.wsUrl=t.wsUrl,this.wsUrlList=t.backupWsUrlList?de(new Set([this.wsUrl].concat(de(t.backupWsUrlList)))):[this.wsUrl],this.userId=t.userId,this.userName="undefined"!==t.userName&&t.userName?t.userName:"",this.mode=t.mode,this.sdkAppId=t.sdkAppId,this.userSig=t.userSig,this.onCustomSignParam=t.onCustomSignParam,this.extendInfo=t.extendInfo,this.appConfig=null,this.reconnectCount=0,this.init()}var t,r,n,i,o,a,s,c,u,d,l,h,p,f,m;return pe(e,[{key:"init",value:function(){var e=this;this.publications=new Map,this.subscriptions=new Map,this.roomId=null,this.roomUniqueId=null,this.role="anchor",this.remoteStreams=new Map,this.state=me.New,this.localStreams=[],this.enablemicVolume=!1,this.soundMeter=null,this.timer=null,this.micStream=null,this.isEnableSmallStream=!1,this._emitter=new Se(this.logger),this.subscribeManager=new rr(this.logger),this._interval=-1,this._remoteMutedStateMap=new Map,this.audioVolumeInterval=null,this.isWaterMark=!1,this.waterMarkoptions=null,this.waterMarkImage=null,this.smallStreamConfig={width:160,height:120,bitrate:100,framerate:15},this.logger.setUserId(this.userId),this.logger.setServerUrl(this.wsUrl),cn.init({userId:this.userId,ssl:this.ssl,sdkAppId:this.sdkAppId,userSig:this.userSig,onCustomSignParam:this.onCustomSignParam,extendInfo:this.extendInfo}),this.xsigoClient=new on(this.logger,{notificationCb:this.notificationCb.bind(this),connectionLostCb:this.connectionLostCb.bind(this),tryToReconnectCb:this.tryToReconnectCb.bind(this),connectionRecoveryCb:this.connectionRecoveryCb.bind(this),onWsStateChange:this.onWsStateChange.bind(this),onWsError:this.onError.bind(this),onWsReconnectFailed:this.onWsReconnectFailed.bind(this)}),this.ssl&&navigator.mediaDevices&&_t().then((function(t){e._preDiviceList=t,e.logger.info("mediaDevices",JSON.stringify(e._preDiviceList,null,4))})).catch((function(){e._preDiviceList=[]})),this.senderStats=new Map,this.receiverStats=new Map,this.senderLocalStats=new Map,this.deviceChange=this.onDeviceChange.bind(this),this.visibilitychange=this.onVisibilitychange.bind(this),this.logger.info("userAgent:",navigator.userAgent)}},{key:"setAppConfig",value:function(e){var t=e.serverTs,r=e.logPeriod,n=e.enableLog,i=e.eventPeriod,o=e.enableEvent,a=e.metricCollectPeriod;this.appConfig={serverTs:t,timeDiff:t?Date.now()-t:0,logPeriod:r,enableLog:!1!==n,eventPeriod:i,enableEvent:!1!==o,metricCollectPeriod:a},this.logger.setAppConfig(this.appConfig),this.logger.info("get app config",JSON.stringify(this.appConfig,null,4))}},{key:"reset",value:function(){this.publications=new Map,this.subscriptions=new Map,this.localStreams=[],this.remoteStreams.clear(),this.subscribeManager.reset(),this._remoteMutedStateMap.clear(),this.appConfig=null,this._interval&&window.clearInterval(this._interval),this._interval=-1,this.reconnectCount=0,this.audioVolumeInterval&&window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null,this.removeEventListenser("devicechange"),this.removeEventListenser("visibilitychange"),this.logger.setServerUrl(null),this.logger.setAppConfig(null),this.closeWaterMark()}},{key:"notificationCb",value:function(e,t,r){if(t===Xe.ParticipantJoin){var n=r.participant,i=n.userId,o=n.previousRoomId,a=n.userData;this.logger.info("======notification: participant join======"),this.updateRemoteMutedState(i),this.logger.buriedLog({c:Et.ON_PEER_JOIN,v:"uid:".concat(i)}),this._emitter.emit("peer-join",{userId:i,previousRoomId:o,userData:a})}if(t===Xe.ParticipantLeave){var s=r.userId;this.logger.info("======notification: participant leave======"),this.onParticipantLeave(s)}if(t===Xe.StreamAdd&&(this.logger.info("======notification: stream add======"),this.onStreamAdd(r.stream)),t===Xe.StreamRemove&&(this.logger.info("======notification: stream remove======"),this.onStreamChange(r.userId,r.streamId)),t===Xe.Drop){var c=r.cause;this.logger.info("======notification: participant drop======"),this.onClientBanned(c)}if(t===Xe.StreamUpdate&&(this.logger.info("======notification: stream update======"),this.onStreamUpdate(r.userId,r.streamId,r.liveStatus,r.simulcast)),t===Xe.PermissionChange){var u=r;this.logger.info("======notification: role change======",u.userId,u.publish)}if(t===Xe.MuteLocal){var d=r.type,l=r.userId;this.logger.info("======notification: muteLocal ======",d),this.onMuteLocal(d,l)}}},{key:"connectionLostCb",value:function(e){this.logger&&(this.logger.info("room: ".concat(e," connection lost")),this.logger.buriedLog({c:Et.CONNECTIONLOST_CB}))}},{key:"tryToReconnectCb",value:function(e){this.logger.info("room: ".concat(e," connection retring ......"))}},{key:"connectionRecoveryCb",value:function(e,t,r){var n=this;return new Promise(function(){var i=ue(be.mark((function i(o,a){var s,c,u,d,l,h,p,f,m,v,g,y,b,S;return be.wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(n.logger.info("room: ".concat(e," connection recovery")),n.logger.buriedLog({c:Et.CONNECTION_RECOVERY_CB}),!r){i.next=50;break}if(n.roomUniqueId=t,n.logger.setRoomUniqueId(t),s=new Map,c=new Map,u=new Map(n.publications),!n.publications.size){i.next=25;break}d=ln(u.entries()),i.prev=10,h=be.mark((function e(){var t,r,i,o,a,c,u;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=se(l.value,2),r=t[0],i=t[1],e.next=3,i.republish();case 3:(o=e.sent)&&(a=rn(),s.set(r,{sdp:o.sdp,pubId:a}),n.publications.delete(r),n.publications.set(a,i),(c=n.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(r)})))&&(u=c.screen?"share_".concat(c.getUserId()):c.getUserId(),n.senderStats.delete(u),c.streamId=a));case 5:case"end":return e.stop()}}),e)})),d.s();case 13:if((l=d.n()).done){i.next=17;break}return i.delegateYield(h(),"t0",15);case 15:i.next=13;break;case 17:i.next=22;break;case 19:i.prev=19,i.t1=i.catch(10),d.e(i.t1);case 22:return i.prev=22,d.f(),i.finish(22);case 25:if(!n.subscriptions.size){i.next=48;break}p=new Map(n.subscriptions),f=ln(p.entries()),i.prev=28,f.s();case 30:if((m=f.n()).done){i.next=40;break}return v=se(m.value,2),y=v[1],n.logger.info("resubscribe stream",g=v[0]),i.next=35,y.subscriber.resubscribe();case 35:b=i.sent,n.receiverStats.delete(y.stream.getUserSeq()),b&&(S=rn(),c.set(g,{sdp:b.sdp,subId:S}),n.subscriptions.delete(g),n.subscriptions.set(S,y));case 38:i.next=30;break;case 40:i.next=45;break;case 42:i.prev=42,i.t2=i.catch(28),f.e(i.t2);case 45:return i.prev=45,f.f(),i.finish(45);case 48:n.logger.info("publishOfferSdp==>",s,"subscribeOfferSdp==>",c),o({publishOfferSdp:s,subscribeOfferSdp:c});case 50:case"end":return i.stop()}}),i,null,[[10,19,22,25],[28,42,45,48]])})));return function(e,t){return i.apply(this,arguments)}}())}},{key:"join",value:function(e){var t=this;if(this.logger.info("join room with options",JSON.stringify(e)),this.logger.buriedLog({c:Et.JOIN}),this.logger.buriedLog({c:Et.JOIN_FIRST}),[me.New,me.Leaved].includes(this.state))return new Promise(function(){var r=ue(be.mark((function r(n,i){var o,a,s,c,u,d,l,h,p,f,m,v;return be.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.isJoinRoomSupported();case 2:if(a=(o=r.sent).code,s=o.message,o.isSupported){r.next=11;break}return t.logger.buriedLog({c:Et.JOIN_FAILED},!0),c="join room failed,".concat(s),t.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},c,!0),r.abrupt("return",i(new Ue({code:a,message:s})));case 11:if(d=e.role,l="",e.privateKey&&(l=e.privateKey),h=/^[A-Za-z0-9_-]+$/g,!(u=e.roomId)||h.test(u)){r.next=20;break}return p="join room failed,roomId:".concat(u,' is invalid，roomId can only be numbers, letters and "-" '),t.logger.buriedLog({c:Et.JOIN_FAILED},!0),t.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},p,!0),r.abrupt("return",i(new Ue({code:ke.INVALID_OPERATION,message:p})));case 20:if(!(t.wsUrl&&t.sdkAppId&&(t.userSig||t.onCustomSignParam)&&u&&t.userId)){r.next=28;break}t.roomId=u,t.role="live"===t.mode&&d||t.role,t.logger.setRoomId(t.roomId),f=function(r){t.state=me.Joining;var o={onCustomSignParam:t.onCustomSignParam,appId:t.sdkAppId,userSig:t.userSig,userId:t.userId,userType:tt.Normal,previousRoomId:"",permission:Ee.get(t.role),userData:{userId:t.userId,userName:t.userName,extra:e.extra},extendInfo:t.extendInfo,serverUrl:r,privateKey:l,ssl:t.ssl,enterRoomCb:function(e,r,o){if(1===e){t.state=me.Joined;var a=o.participants,s=o.roomUniqueId;t.getNetworkQuality(),t.addEventListenser("devicechange"),t.addEventListenser("visibilitychange"),t.roomUniqueId=s,t.logger.setRoomUniqueId(s),t.logger.buriedLog({c:Et.JOIN_SUCCESS}),t._emitter.emit("members",a),t.logger.info("join room ".concat(t.roomId," success")),n(!0)}else if(2===e){t.state=me.New;var c="".concat(ke.JOIN_ROOM_FAILED," join room timeout");t.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},c,!0),t.logger.buriedLog({c:Et.JOIN_FAILED},!0),i(new Ue({code:ke.JOIN_ROOM_FAILED,message:"join room timeout"}))}else{t.state=me.New;var u="join room failed:, ".concat(r);t.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},u,!0),t.logger.buriedLog({c:Et.JOIN_FAILED},!0),i(new Ue({code:ke.JOIN_ROOM_FAILED,message:r}))}}};t.xsigoClient.enterRoom(t.roomId,o)},t.getWsUrl(l,f,i),r.next=35;break;case 28:return r.next=30,t.onCustomSignParam();case 30:m=r.sent,v="join room failed, options is invalid,wsUrl:".concat(t.wsUrl,",sdkAppId:").concat(t.sdkAppId,",userSig:").concat(t.userSig,",onCustomSignParam:").concat(JSON.stringify(m),",roomId:").concat(e.roomId,",userId:").concat(t.userId),t.logger.error(v),t.logger.buriedLog({c:Et.JOIN_FAILED},!0),i(new Ue({code:ke.INVALID_OPERATION,message:v}));case 35:case"end":return r.stop()}}),r)})));return function(e,t){return r.apply(this,arguments)}}());this.logger.buriedLog({c:Et.JOIN_FAILED});var r="join room failed,client state is error ,state:".concat(this.state);this.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},r,!0)}},{key:"getWsUrl",value:(m=ue(be.mark((function e(t,r,n){var i,o,a,s,c,u,d,l,h,p;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=[],this.logger.info("wsUrlList,".concat(this.wsUrlList)),o=this.wsUrlList.shift(),this.wsUrlList.push(o),!o.includes("ws:")&&!o.includes("wss:")){e.next=9;break}return r(o),e.abrupt("return");case 9:return e.prev=9,e.next=12,cn.getAppConfig(o,t);case 12:return(a=e.sent)&&this.setAppConfig(a.data),e.next=16,cn.getWsUrl(this.roomId,o,t);case 16:c=((s=e.sent).data||{}).metadata,(o.includes("https://")||o.includes("http://"))&&(o=o.split("//")[1]),u=o.split(":").length-1>=2,c?u?(l=c.hostV6,(d=c.sslHostV6).includes(":")&&(d=c.sslHostV6.includes("[")?c.sslHostV6:"[".concat(d),d=c.sslHostV6.includes("]")?c.sslHostV6:"".concat(d,"]")),l.includes(":")&&(l=c.hostV6.includes("[")?c.hostV6:"[".concat(l),l=c.hostV6.includes("]")?c.hostV6:"".concat(l,"]")),i=this.ssl?"wss://".concat(d,":").concat(c.sslPort):"ws://".concat(l,":").concat(c.port)):i=this.ssl?"wss://".concat(c.sslHost,":").concat(c.sslPort):"ws://".concat(c.host,":").concat(c.port):i="wss://".concat(s.data.host,":").concat(s.data.port),this.logger.info(" httpUrl==>".concat(o,"  , serverIPUrl==>").concat(i)),r(i),e.next=40;break;case 25:if(e.prev=25,e.t0=e.catch(9),this.reconnectCount++,!(this.reconnectCount<this.wsUrlList.length)){e.next=36;break}if(this.state!==me.Leaved&&this.state!==me.Leaving){e.next=31;break}return e.abrupt("return");case 31:h="http connect faild ,sdk is reconnecting,count:".concat(this.reconnectCount," ==>").concat(e.t0),this.logger.warn(h),this.getWsUrl(t,r,n),e.next=40;break;case 36:p="http connect faild, SDK has tried reconnect , but faild,  please check your network and server ==>".concat(e.t0),this.logger.onError({c:Et.TOP_ERROR,v:ke.JOIN_ROOM_FAILED},p,!0),this.logger.buriedLog({c:Et.JOIN_FAILED},!0),n(new Ue({code:ke.JOIN_ROOM_FAILED,message:e.t0}));case 40:case"end":return e.stop()}}),e,this,[[9,25]])}))),function(e,t,r){return m.apply(this,arguments)})},{key:"leave",value:(f=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(![me.Leaving,me.Leaved].includes(this.state)){e.next=2;break}return e.abrupt("return");case 2:return this.logger.buriedLog({c:Et.LEAVE}),e.abrupt("return",new Promise((function(e,r){var n,i=ln(t.publications.entries());try{var o=function(){var e=se(n.value,2),r=e[0],i=e[1],o=t.localStreams.find((function(e){return e.streamId===r}));o&&o.close(),i.close()};for(i.s();!(n=i.n()).done;)o()}catch(e){i.e(e)}finally{i.f()}var a,s=ln(t.subscriptions.values());try{for(s.s();!(a=s.n()).done;){var c=a.value;c.stream.close(),c.subscriber.close()}}catch(e){s.e(e)}finally{s.f()}t.state=me.Leaving,t.xsigoClient.exitRoom(t.roomId,(function(r,n,i){if(1===r)t.logger.info("leave room success");else{var o="leave room failed:, ".concat(n);t.logger.onError({c:Et.TOP_ERROR,v:ke.LEAVE_ROOM_FAILED},o,!0)}t.logger.buriedLog({c:Et.LEAVE_SUCCESS},!0),t.state=me.Leaved,t.reset(),e(!0)}))})));case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"publish",value:(p=ue(be.mark((function e(t){var r,n,i=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.logger.info("publish stream"),t){e.next=5;break}throw this.logger.error("stream is undefined or null"),new Ue({code:ke.INVALID_OPERATION,message:"stream is undefined or null"});case 5:if(!(r=[ve.Publishing,ve.Published]).includes(t.getPubState("audio"))||!r.includes(t.getPubState("video"))){e.next=8;break}throw new Ue({code:ke.INVALID_OPERATION,message:"duplicate publishing, please unpublish and then re-publish"});case 8:if("live"!==this.mode||"audience"!==this.role){e.next=10;break}throw new Ue({code:ke.INVALID_OPERATION,message:'no permission to publish() under live/audience, please call swithRole("anchor") firstly before publish()'});case 10:if(t.mediaStream){e.next=12;break}throw new Ue({code:ke.INVALID_OPERATION,message:"stream not initialized!"});case 12:return this.logger.buriedLog({c:t.screen?Et.PUBLISH_STREAM_SCREEN:Et.PUBLISH_STREAM}),n=t.mediaStream.getTracks().map((function(e){return new Promise((function(n,o){var a=new MediaStream;a.addTrack(e);var s="audio"===e.kind,c=s&&!e.enabled,u="video"===e.kind,d=u&&!e.enabled;if(r.includes(t.getPubState(e.kind)))i.logger.warn("".concat(s?"audio":"video"," is publishing or published"));else{t.setPubState(e.kind,ve.Publishing);var l={localStream:t,mediaStream:a,screen:t.screen,hasAudio:s,audioMuted:c,hasVideo:u,videoMuted:d,bitrate:t.getBitrate(),videoProfile:t.videoProfile};i.doPublish(l,(function(r,a,c){if(i.logger.info("xsigo client publish stream success",c&&c.streamId),t.getPubState(e.kind)!==ve.Unpublished)if(1===r)t.published||(t.published=!0,t.roomId=c.roomId,t.streamId=c.streamId,t.xsigoClient=i.xsigoClient,-1===i.localStreams.findIndex((function(e){return e.streamId===c.streamId}))&&(i.localStreams.push(t),t.onTrackAdd(i.onAddTrack.bind(i)),t.onTrackRemove(i.onRemoveTrack.bind(i)),t.onSwitchDevice(i.onReplaceTrack.bind(i)),t.onReplaceTrack(i.onReplaceTrack.bind(i)))),s&&(t.setHasAudio(!!s),t.setAudioStreamId(c.streamId)),u&&(t.setHasVideo(!!u),t.setVideoStreamId(c.streamId)),i.logger.buriedLog({c:t.screen?Et.PUBLISH_STREAM_SCREEN_SUCCESS:Et.PUBLISH_STREAM_SUCCESS,v:s?"audio":"video"}),t.setPubState(e.kind,ve.Published),n(t);else if(i.logger.buriedLog({c:t.screen?Et.PUBLISH_STREAM_SCREEN_FAILED:Et.PUBLISH_STREAM_FAILED,v:s?"audio":"video"}),c&&i.publications.delete(c.streamId),t.setPubState(e.kind,ve.Create),"H264 not supported"===a){i.logger.onError({c:Et.TOP_ERROR,v:ke.H264_NOT_SUPPORTED});var d=new Ue({code:ke.H264_NOT_SUPPORTED,message:"publish stream failed h264 not supported"});i._emitter.emit(Te,d),o(d)}else i.logger.onError({c:Et.TOP_ERROR,v:ke.PUBLISH_STREAM_FAILED},a),o(new Ue({code:ke.PUBLISH_STREAM_FAILED,message:a}))}))}}))})),e.abrupt("return",Promise.all(n));case 16:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"onAddTrack",value:function(e){var t=this,r=e.track,n=e.streamId,i=new MediaStream;i.addTrack(r);var o="audio"===r.kind,a=o&&!r.enabled,s="video"===r.kind,c=s&&!r.enabled,u=this.localStreams.find((function(e){return e.streamId===n}));if(this.logger.info("PublishState",u&&u.getPubState(r.kind)),u&&![ve.Publishing,ve.Published].includes(u.getPubState(r.kind))){var d={localStream:u,screen:!1,hasAudio:o,audioMuted:a,hasVideo:s,videoMuted:c,mediaStream:i,bitrate:u.getBitrate(),videoProfile:u.videoProfile};u.setPubState(r.kind,ve.Publishing),this.doPublish(d,(function(e,n,i){u.getPubState(r.kind)!==ve.Unpublished&&(1===e?(u.mediaStream.addTrack(r),u.published=!0,o&&(u.setHasAudio(o),u.setAudioStreamId(i.streamId),u.setAudioTrack(r)),s&&(u.setHasVideo(s),u.setVideoStreamId(i.streamId),u.setVideoTrack(r)),u.setPubState(r.kind,ve.Published)):(i&&t.publications.delete(i.streamId),u.setPubState(r.kind,ve.Create)),t.logger.buriedLog({c:1===e?Et.PUBLISH_STREAM_SUCCESS:Et.PUBLISH_STREAM_FAILED,v:o?"addAudioTrack":"addVideoTrack"}),u._emitter.emit("stream-track-update-result",{code:e,message:n}))}))}else r.stop(),this.logger.warn(u?"same track is publishing or published":"stream is not published")}},{key:"doPublish",value:(h=ue(be.mark((function e(t,r){var n,i,o,a,s,c,u,d;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,c=(o=t||{}).localStream,u=new Qt({roomId:this.roomId,userId:this.userId,mediaStream:o.mediaStream,screen:o.screen,bitrate:o.bitrate,isEnableSmallStream:this.isEnableSmallStream,smallStreamConfig:this.smallStreamConfig,hasAudio:a=o.hasAudio,audioMuted:o.audioMuted,hasVideo:s=o.hasVideo,videoMuted:o.videoMuted,minBitrate:(null===(n=t.videoProfile)||void 0===n?void 0:n.minBitrate)||0,maxBitrate:(null===(i=t.videoProfile)||void 0===i?void 0:i.maxBitrate)||0,logger:this.logger,xsigoClient:this.xsigoClient,onPublish:r}),e.next=5,u.publish();case 5:"string"!=typeof(d=e.sent)||this.publications.has(d)||(u.onPublishPeerConnectionFailed(this.onPublishPeerConnectionFailed.bind(this)),this.publications.set(d,u),c.streamId=d,a&&c.setAudioStreamId(d),s&&c.setVideoStreamId(d)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(0),r&&r(0,e.t0);case 12:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(e,t){return h.apply(this,arguments)})},{key:"onPublishPeerConnectionFailed",value:function(e){var t=this,r=e.state,n=e.streamId,i=this.xsigoClient.getWsState(this.roomId);if(this.publications.has(n)){var o=this.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(n)}));o&&("failed"===r&&i&&["CONNECTED","RECOVERY"].includes(i.state)?(this.logger.warn("publish peerConnection failed try to republish streamId:".concat(n)),o.updatePeerConnectionFailed(r),this.doUnpublish(o,n).then((function(){var e=new MediaStream,r=o.audioStreamId===n,i=o.videoStreamId===n,a=r?o.getAudioTrack():o.getVideoTrack(),s=r&&!a.enabled,c=i&&!a.enabled;t.logger.info("publish ".concat(r?"audio":"video",",trackId:").concat(a&&a.id)),e.addTrack(a);var u={localStream:o,screen:o.screen,hasAudio:r,audioMuted:s,hasVideo:i,videoMuted:c,mediaStream:e,bitrate:o.getBitrate()};t.doPublish(u,(function(e,n,a){1===e?(o.published=!0,r&&(o.setHasAudio(r),o.setAudioStreamId(a.streamId)),i&&(o.setHasVideo(i),o.setVideoStreamId(a.streamId))):a&&t.publications.delete(a.streamId)}))}))):"connected"===r&&o.updatePeerConnectionFailed(r))}}},{key:"onRemoveTrack",value:function(e){var t=this,r=e.track,n=e.streamId,i=r.kind,o=this.localStreams.find((function(e){return e.streamId===n}));if(o&&![ve.Create,ve.Unpublished].includes(o.getPubState(r.kind))){var a="audio"===i?o.audioStreamId:o.videoStreamId;o.mediaStream.removeTrack(r),"audio"===i&&o.setHasAudio(!1),"video"===i&&o.setHasVideo(!1),this.doUnpublish(o,a,(function(e,r){1===e&&t.logger.info("remove track success"),o._emitter.emit("stream-track-update-result",{code:e,message:r})}))}else this.logger.warn("stream is not published")}},{key:"onReplaceTrack",value:function(e){var t=e.streamId,r=e.type,n=e.track,i=this.localStreams.find((function(e){return e.streamId===t}));if(i){var o="audio"===r?i.audioStreamId:i.videoStreamId;o&&this.publications.has(o)&&this.publications.get(o).replaceMediaStreamTrack(n)}}},{key:"unpublish",value:function(e){var t=this;if(this.logger.info("unpublish stream"),!e)throw this.logger.error("stream is undefined or null"),new Ue({code:ke.INVALID_OPERATION,message:"stream is undefined or null"});this.logger.buriedLog({c:e.screen?Et.UNPUBLISH_STREAM_SCREEN:Et.UNPUBLISH_STREAM});var r,n=[],i=ln(this.publications.keys());try{for(i.s();!(r=i.n()).done;){var o=r.value;[e.audioStreamId,e.videoStreamId].includes(o)&&n.push(this.doUnpublish(e,o))}}catch(e){i.e(e)}finally{i.f()}return Promise.all(n).then((function(){var r=t.localStreams.findIndex((function(t){return t.getId()===e.getId()}));-1!==r&&t.localStreams.splice(r,1)}))}},{key:"doUnpublish",value:function(e,t,r){var n=this;return new Promise((function(i,o){var a=n.publications.get(t);if(a){n.publications.delete(t),e.audioStreamId===t&&e.setHasAudio(!1),e.videoStreamId===t&&e.setHasVideo(!1);var s=e.screen?"share_".concat(e.getUserId()):e.getUserId();if(e.hasAudio()||e.hasVideo()||(e.published=!1),e.setPubState(e.audioStreamId===t?"audio":"video",ve.Unpublished),n.senderStats.has(s)){var c=dn({},n.senderStats.get(s));e.hasAudio()||(c.audio={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}),e.hasVideo()||(c.video={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},c.smallVideo={bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}),n.senderStats.set(s,c)}i(!0),a.unpublish((function(i,o,a){1===i?(n.logger.info("unpublish stream success",t),r&&r(i,o),n.logger.buriedLog({c:e.screen?Et.UNPUBLISH_STREAM_SCREEN_SUCCESS:Et.UNPUBLISH_STREAM_SUCCESS,v:e.audioStreamId===t?"audio":"video"})):(n.logger.buriedLog({c:e.screen?Et.UNPUBLISH_STREAM_SCREEN_FAILED:Et.UNPUBLISH_STREAM_FAILED,v:e.audioStreamId===t?"audio":"video"}),r&&r(i,o),n.logger.onError({c:Et.TOP_ERROR,v:ke.UNPUBLISH_STREAM_FAILED},"unpublish stream with response:, ".concat(i,",").concat(o)))}))}else n.logger.warn("stream is not published",t),i(!0)}))}},{key:"subscribe",value:(l=ue(be.mark((function e(t,r){var n,i,o;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}throw this.logger.error("stream is undefined or null"),new Ue({code:ke.INVALID_OPERATION,message:"stream is undefined or null"});case 3:if(t.isRemote){e.next=6;break}throw this.logger.error("try to subscribe a local stream"),new Ue({code:ke.INVALID_OPERATION,message:"try to subscribe a local stream"});case 6:if(!(n=[ge.Subscribing,ge.Subscribed]).includes(t.getSubState("audio"))||!n.includes(t.getSubState("video"))){e.next=10;break}throw this.logger.error("Stream already subscribing or subscribed"),new Ue({code:ke.INVALID_OPERATION,message:"Stream already subscribing or subscribed"});case 10:return!r&&(r={audio:!0,video:!0,small:!1}),i=t.getUserSeq(),t=this.remoteStreams.get(i),this.logger.info("subscribe with options:",JSON.stringify(r,null,4),t),this.subscribeManager.setSubscriptionOpts(i,r),o=[],t&&t.audioStreamId&&!n.includes(t.getSubState("audio"))?r.audio&&o.push(this.doSubscribe(t,{audio:!0,video:!1,small:!!r.small&&r.small})):n.includes(t.getSubState("audio"))&&this.logger.warn("audio is subscribing or subscribed"),t&&t.videoStreamId&&!n.includes(t.getSubState("video"))?r.video&&o.push(this.doSubscribe(t,{audio:!1,video:!0,small:!!r.small&&r.small})):n.includes(t.getSubState("video"))&&this.logger.warn("video is subscribing or subscribed"),e.abrupt("return",Promise.all(o));case 19:case"end":return e.stop()}}),e,this)}))),function(e,t){return l.apply(this,arguments)})},{key:"doSubscribe",value:(d=ue(be.mark((function e(t,r,n){var i=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise(function(){var e=ue(be.mark((function e(o,a){var s,c,u,d,l,h,p,f,m,v;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i.logger.info("doSubscribe options",JSON.stringify(r,null,4)),s=t.getUserSeq(),c=t.getSimulcasts(),l=!!r.small&&r.small,i.logger.info("---do subscribe options",u=r.audio?t.audio:r.audio,d=r.video?t.video:r.video),i.logger.buriedLog({c:t.getType()===Ce?Et.SUBSCRIBE_STREAM_SCREEN:Et.SUBSCRIBE_STREAM,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")}),t.setSubState(u?"audio":"video",ge.Subscribing),u&&i.subscribeManager.updateSubscriptedState(s,{audio:u,small:l}),d&&i.subscribeManager.updateSubscriptedState(s,{video:d,small:l}),h=0,p=0,f=new yr({userId:t.userId,publisherUserId:t.getUserId(),hasAudio:u,hasVideo:d,simulcast:c,audioStreamId:u?t.audioStreamId:null,videoStreamId:d?t.videoStreamId:null,logger:i.logger,xsigoClient:i.xsigoClient,roomId:i.roomId,small:l,onRemoteStream:function(){var e=ue(be.mark((function e(r,a,c,l){var f,m,v;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!u||t.getSubState("audio")!==ge.Unsubscribed){e.next=2;break}return e.abrupt("return");case 2:if(!d||t.getSubState("video")!==ge.Unsubscribed){e.next=4;break}return e.abrupt("return");case 4:f=i.remoteStreams.get(s),"audio"===a.kind&&h++,"video"===a.kind&&p++,f&&(c!==et.AudioVideo&&c!==et.VideoOnly||f.setIsAlphaChannels(l),f.mediaStream||f.setMediaStream(r),"audio"===a.kind&&(h>1||n||!f.getAudioTrack())&&(f.updateTrack("audio",a),n||h>1?f.setAudioTrack(a):f.restartAudio()),"video"===a.kind&&(p>1||n||!f.getVideoTrack())&&(f.updateTrack("video",a),n||p>1?f.setVideoTrack(a):f.restartVideo()),i.subscribeManager.addSubscriptionRecord(s,f),m=t.getType()===Ce?"share_".concat(t.getUserId()):t.getUserId(),f.subscribed?(i._emitter.emit("stream-updated",{stream:f}),v="",c===et.AudioOnly?v=f.audioMuted?"mute-audio":"unmute-audio":c===et.VideoOnly&&(v=f.videoMuted?"mute-video":"unmute-video"),i._emitter.emit(v,{userId:m})):(f.subscribed=!0,i.logger.buriedLog({c:t.getType()===Ce?Et.ON_STREAM_SUBSCRIBED_SCREEN:Et.ON_STREAM_SUBSCRIBED,v:"uid:".concat(t.getUserId())}),i._emitter.emit("stream-subscribed",{stream:f}),f.getType()===Ce&&i.isWaterMark&&f.startWaterMark(i.waterMarkoptions,i.waterMarkImage),c===et.AudioOnly?i._emitter.emit(f.audioMuted?"mute-audio":"unmute-audio",{userId:m}):c===et.VideoOnly&&i._emitter.emit(f.videoMuted?"mute-video":"unmute-video",{userId:m})),t.setSubState(u?"audio":"video",ge.Subscribed),o(!0));case 8:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),onSubscribe:function(e,r,n){var o=i.subscribeManager.getSubscriptedState(s);if(!(u&&t.getSubState("audio")===ge.Unsubscribed||d&&t.getSubState("video")===ge.Unsubscribed))if(1===e)u&&(o.audio=!0),d&&(o.video=!0),i.subscribeManager.updateSubscriptedState(s,o),c.length&&(l?c.find((function(e){return e.type===it.SmallStream}))&&t.setSimulcastType(it.SmallStream):t.setSimulcastType(c[0].type)),i.logger.info("subscribe stream success"),i.logger.buriedLog({c:t.getType()===Ce?Et.SUBSCRIBE_STREAM_SCREEN_SUCCESS:Et.SUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")});else{i.logger.onError({c:Et.TOP_ERROR,v:ke.SUBSCRIBE_FAILED},"on subscribe stream with response:, ".concat(e,", ").concat(r)),i.logger.buriedLog({c:t.getType()===Ce?Et.SUBSCRIBE_STREAM_SCREEN_FAILED:Et.SUBSCRIBE_STREAM_FAILED,v:"uid:".concat(t.getUserId(),",").concat(u?"audio":"video")}),i.subscriptions.delete(n.subscriptionId),t.setSubState(u?"audio":"video",ge.Create);var h=i.subscribeManager.getSubscriptedState(s),p=i.subscribeManager.needSubscribeKind(s);p===et.AudioVideo&&h.audio&&h.video&&(u&&i.subscribeManager.updateSubscriptedState(s,{audio:!1}),d&&i.subscribeManager.updateSubscriptedState(s,{video:!1})),p===et.VideoOnly&&d&&i.subscribeManager.updateSubscriptedState(s,{video:!1}),p===et.AudioVideo&&u&&i.subscribeManager.updateSubscriptedState(s,{audio:!1}),a(new Ue({code:ke.SUBSCRIBE_FAILED,message:r}))}}}),e.next=17,f.subscribe();case 17:if(m=e.sent,i.logger.info("time Date.now doSubscribe",i.remoteStreams.has(s),t.audioStreamId,t.videoStreamId),!u||t.audioStreamId){e.next=21;break}return e.abrupt("return",f.close());case 21:if(!d||t.videoStreamId){e.next=23;break}return e.abrupt("return",f.close());case 23:i.subscriptions.has(m)||(f.onSubscribePeerConnectionFailed(i.onSubscribePeerConnectionFailed.bind(i)),i.subscriptions.set(m,{subscriber:f,stream:t})),u&&t.setAudioSubscriptionId(m),d&&t.setVideoSubscriptionId(m),e.next=31;break;case 28:e.prev=28,e.t0=e.catch(0),"H264 not supported"===e.t0?(i.logger.onError({c:Et.TOP_ERROR,v:ke.H264_NOT_SUPPORTED},"subscribe stream failed h264 not supported"),v=new Ue({code:ke.H264_NOT_SUPPORTED,message:"subscribe stream failed h264 not supported"}),i._emitter.emit(Te,v)):(i.logger.onError({c:Et.TOP_ERROR,v:ke.SUBSCRIBE_FAILED},"subscribe stream error:, ".concat(e.t0,"}")),a(new Ue({code:ke.SUBSCRIBE_FAILED,message:e.t0})));case 31:case"end":return e.stop()}}),e,null,[[0,28]])})));return function(t,r){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)}))),function(e,t,r){return d.apply(this,arguments)})},{key:"onSubscribePeerConnectionFailed",value:function(e){var t=this,r=e.state,n=e.subscriptionId,i=this.xsigoClient.getWsState(this.roomId);if(this.subscriptions.has(n)){var o=this.subscribeManager.getSubscriptionOpts(this.userId),a=this.subscriptions.get(n).stream;if(a)if("failed"===r&&i&&["CONNECTED","RECOVERY"].includes(i.state)){this.logger.warn("subscribe peerConnection failed try to resubscribe subscriptionId:".concat(n)),a.updatePeerConnectionFailed(r);var s=a.audioSubscriptionId,c=a.videoSubscriptionId;this.doUnsubscribe(a,n).then((function(){s===n&&o.audio&&t.doSubscribe(a,{audio:!0,video:!1,small:!!o.small&&o.small},!0),c===n&&o.video&&t.doSubscribe(a,{audio:!1,video:!0,small:!!o.small&&o.small},!0)}))}else"connected"===r&&a.updatePeerConnectionFailed(r)}}},{key:"unsubscribe",value:function(e){if(!e)throw this.logger.error("stream is undefined or null"),new Ue({code:ke.INVALID_OPERATION,message:"stream is undefined or null"});var t=[],r=this.subscribeManager.getSubscriptionOpts(e.getUserSeq());return e.setSubState("audio",ge.Unsubscribed),e.setSubState("video",ge.Unsubscribed),r.audio&&e.audioSubscriptionId&&(t.push(this.doUnsubscribe(e,e.audioSubscriptionId)),e.setEnableTrackFlag("audio",!0)),r.video&&e.videoSubscriptionId&&(t.push(this.doUnsubscribe(e,e.videoSubscriptionId)),e.setEnableTrackFlag("video",!0)),Promise.all(t)}},{key:"doUnsubscribe",value:function(e,t){var r=this,n=e.audioSubscriptionId&&e.audioSubscriptionId===t,i=e.videoSubscriptionId&&e.videoSubscriptionId===t;this.logger.buriedLog({c:e.getType()===Ce?Et.UNSUBSCRIBE_STREAM_SCREEN:Et.UNSUBSCRIBE_STREAM,v:"uid:".concat(e.getUserId(),",").concat(n?"audio":"video")});var o=e.getUserSeq(),a=this.remoteStreams.get(o),s=this.subscribeManager.getSubscriptedState(o);return a&&n&&(a.getAudioTrack()&&a.mediaStream.removeTrack(a.getAudioTrack()),a.setSubState("audio",ge.Unsubscribed),e.setAudioSubscriptionId(null),this.subscribeManager.updateSubscriptedState(o,dn(dn({},s),{},{audio:!1,small:!1}))),a&&i&&(a.getVideoTrack()&&a.mediaStream.removeTrack(a.getVideoTrack()),a.setSubState("video",ge.Unsubscribed),e.setVideoSubscriptionId(null),this.subscribeManager.updateSubscriptedState(o,dn(dn({},s),{},{video:!1,small:!1}))),!a||e.getAudioTrack()||e.getVideoTrack()||(a.subscribed=!1,a.mediaStream=null),this.receiverStats.has(o)&&this.receiverStats.delete(o),new Promise((function(i,o){if(r.subscriptions.has(t)){var a=r.subscriptions.get(t);r.subscriptions.delete(t),i(!0),a.subscriber.unsubscribe((function(t,i,o){1===t?(r.logger.info("unsubscribe stream success"),r.logger.buriedLog({c:e.getType()===Ce?Et.UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:Et.UNSUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(e.getUserId(),",").concat(n?"audio":"video")})):(r.logger.buriedLog({c:e.getType()===Ce?Et.UNSUBSCRIBE_STREAM_SCREEN_FAILED:Et.UNSUBSCRIBE_STREAM_FAILED,v:"uid:".concat(e.getUserId(),",").concat(n?"audio":"video")}),r.logger.onError({c:Et.TOP_ERROR,v:ke.UNSUBSCRIBE_FAILED},"unsubscribe stream with response:,".concat(t,", ").concat(i)))}))}else r.logger.warn("stream is not subscribed",e.getUserId()),r.logger.buriedLog({c:e.getType()===Ce?Et.UNSUBSCRIBE_STREAM_SCREEN_SUCCESS:Et.UNSUBSCRIBE_STREAM_SUCCESS,v:"uid:".concat(e.getUserId(),",").concat(n?"audio":"video")}),i(!0)}))}},{key:"updateSimulcast",value:function(e,t){var r=this;return new Promise((function(n,i){var o=r.publications.get(e.videoStreamId);if(!o&&e.screen)throw new Ue({code:ke.INVALID_OPERATION,message:"stream is invalid"});var a=t.map((function(e){return{type:vt(e.rid),maxWidth:e.maxWidth,maxHeight:e.maxHeight}})),s=e.getSimulcasts();if(JSON.stringify(a)===JSON.stringify(s))return r.logger.warn("simulcast  ".concat(t," is same"));r.logger.info("Update Simulcast ".concat(t)),o.updateSimulcast(a,(function(e,o,a){if(1===e)n(!0),r.logger.info("Update Simulcast ".concat(t," Success"));else{r.logger.onError({c:Et.TOP_ERROR,v:ke.LOCAL_SWITCH_SIMULCAST});var s=new Ue({code:ke.LOCAL_SWITCH_SIMULCAST,message:o});i(s)}}))}))}},{key:"setRemoteVideoStreamType",value:function(e,t){var r=this;if(!e||!t)throw this.logger.error("stream or status is undefined or null"),new Ue({code:ke.INVALID_OPERATION,message:"stream or status is undefined or null"});return new Promise((function(n,i){var o={big:"h",small:"l"}[t];if(!o)throw new Ue({code:ke.INVALID_OPERATION,message:"status: ".concat(t," is invalid")});var a=r.getRemoteMutedState().filter((function(t){return t.userId===e.getUserId()}))[0];if("small"===t&&a&&!a.hasSmall)throw new Ue({code:ke.INVALID_OPERATION,message:"does not publish small stream"});var s=r.subscriptions.get(e.videoSubscriptionId);if(!s)throw new Ue({code:ke.INVALID_OPERATION,message:"remoteStream is invalid"});var c=vt(o);if(e.getSimulcastType()===c)return r.logger.warn("status ".concat(t," is same"));r.logger.info("Set Remote Video Stream Type ".concat(t)),r.logger.buriedLog({c:c===it.SmallStream?Et.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL:Et.SET_REMOTE_VIDEO_STREAM_TYPE_BIG}),s.subscriber.switchSimulcast(c,(function(o,a,s){if(1===o)e.setSimulcastType(c),r.logger.info("Set Remote Video Stream Type ".concat(t," Success")),r.logger.buriedLog({c:c===it.SmallStream?Et.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_SUCCESS:Et.SET_REMOTE_VIDEO_STREAM_TYPE_BIG_SUCCESSE}),n(!0);else{var u=new Ue({code:ke.REMOTE_SWITCH_SIMULCAST,message:a});r.logger.onError({c:Et.TOP_ERROR,v:ke.LOCAL_SWITCH_SIMULCAST},a),r.logger.buriedLog({c:c===it.SmallStream?Et.SET_REMOTE_VIDEO_STREAM_TYPE_SAMLL_FAILED:Et.SET_REMOTE_VIDEO_STREAM_TYPE_BIG_FAILED}),i(u)}}))}))}},{key:"switchRole",value:(u=ue(be.mark((function e(t){var r,n,i,o=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}throw new Ue({code:ke.INVALID_OPERATION,message:"role is undefined or null"});case 2:if("rtc"!==this.mode){e.next=4;break}throw new Ue({code:ke.INVALID_OPERATION,message:"role is only valid in live mode"});case 4:if("anchor"===t||"audience"===t){e.next=7;break}throw this.logger.onError({c:Et.TOP_ERROR,v:ke.INVALID_PARAMETER}),new Ue({code:ke.INVALID_PARAMETER,message:"role could only be set to a value as anchor or audience"});case 7:if(t!==this.role){e.next=10;break}return this.logger.warn("can not switch the same role"),e.abrupt("return",Promise.resolve(!0));case 10:if(this.logger.buriedLog({c:"anchor"===t?Et.SWITCH_ROLE_ANCHOR:Et.SWITCH_ROLE_AUDIENCE}),"audience"===t){r=ln(this.publications.keys());try{for(i=function(){var e=n.value,t=o.localStreams.find((function(t){return[t.audioStreamId,t.videoStreamId].includes(e)}));t&&o.doUnpublish(t,e)},r.s();!(n=r.n()).done;)i()}catch(e){r.e(e)}finally{r.f()}}return e.abrupt("return",new Promise(function(){var e=ue(be.mark((function e(r,n){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o.xsigoClient.switchPermission(o.roomId,Ee.get(t),(function(e,i,a){if(1===e)o.logger.info("switch role from ".concat(o.role," to ").concat(t)),o.role=t,o.localStreams=[],o.logger.buriedLog({c:"anchor"===t?Et.SWITCH_ROLE_ANCHOR_SUCCESS:Et.SWITCH_ROLE_AUDIENCE_SUCCESS}),r(!0);else{o.logger.buriedLog({c:"anchor"===t?Et.SWITCH_ROLE_ANCHOR_FAILED:Et.SWITCH_ROLE_AUDIENCE_FAILED}),o.logger.onError({c:Et.TOP_ERROR,v:ke.SWITCH_ROLE_ERROR});var s=new Ue({code:ke.SWITCH_ROLE_ERROR,message:i});n(s)}}));case 1:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}()));case 13:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"on",value:function(e,t){this._emitter.on(e,t)}},{key:"off",value:function(e,t){this.logger&&this.logger.buriedLog({c:Et["OFF_".concat(e.replace("-","_").toUpperCase())]}),this._emitter.off(e,t)}},{key:"getRemoteMutedState",value:function(){this.logger.buriedLog({c:Et.GET_REMOTE_MUTED_STATE});var e,t=[],r=ln(this._remoteMutedStateMap);try{for(r.s();!(e=r.n()).done;){var n=se(e.value,2);t.push(dn({userId:n[0]},n[1]))}}catch(e){r.e(e)}finally{r.f()}return t.filter((function(e){return!e.userId.includes("share_")}))}},{key:"updateRemoteMutedState",value:function(e,t){if(![e,"share_".concat(e)].includes(this.userId)){var r={hasAudio:!1,hasVideo:!1,audioMuted:!0,videoMuted:!0,hasSmall:!1};t=t||r;var n=this._remoteMutedStateMap.get(e)||r;this._remoteMutedStateMap.set(e,dn(dn({},n),t))}}},{key:"getTransportStats",value:(c=ue(be.mark((function e(){var t,r,n,i=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.publications.size){e.next=2;break}throw new Ue({code:ke.INVALID_OPERATION,message:"local stream is not published"});case 2:t=null,r=ln(this.publications.values()),e.prev=4,r.s();case 6:if((n=r.n()).done){e.next=12;break}return t=n.value,e.abrupt("break",12);case 10:e.next=6;break;case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(4),r.e(e.t0);case 17:return e.prev=17,r.f(),e.finish(17);case 20:return e.abrupt("return",new Promise((function(e,r){t.getTransportStats().then((function(r){var n=t.userId,o=0;if(i.senderStats.has(n)){var a=i.senderStats.get(n);a.video.timestamp?o=a.video.packetLossRate:a.audio.timestamp?o=a.audio.packetLossRate:a.smallVideo.timestamp&&(o=a.smallVideo.packetLossRate)}r.packetLossRate=o,e(r)})).catch((function(e){i.logger.onError({c:Et.TOP_ERROR,v:ke.INVALID_TRANSPORT_STATA});var t=new Ue({code:ke.INVALID_TRANSPORT_STATA,message:e});r(t)}))})));case 21:case"end":return e.stop()}}),e,this,[[4,14,17,20]])}))),function(){return c.apply(this,arguments)})},{key:"getRemoteTransportStats",value:(s=ue(be.mark((function e(){var t=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e){try{var r,n=[],i=[],o=[],a=function(e,t,r){e.getTransportStats().then((function(e){-1===o.findIndex((function(e){return e.userId===t}))&&o.push({userId:t,packetLossRate:r,rtt:e})})).catch((function(){-1===o.findIndex((function(e){return e.userId===t}))&&o.push({userId:t,packetLossRate:-1,rtt:-1})}))},s=ln(t.subscriptions.values());try{for(s.s();!(r=s.n()).done;){var c=r.value,u=c.subscriber.userId,d=0;if(t.receiverStats.has(u)){var l=t.receiverStats.get(u);l.video.timestamp?a(c.subscriber,u,d=l.video.packetLossRate):l.audio.timestamp&&a(c.subscriber,u,d=l.audio.packetLossRate)}i.push(d),n.push(c.subscriber.getTransportStats())}}catch(e){s.e(e)}finally{s.f()}Promise.all(n).then((function(r){de(t._remoteMutedStateMap.keys()).forEach((function(e){-1===o.findIndex((function(t){return t.userId===e}))&&o.push({userId:e,packetLossRate:-1,rtt:-1})}));var n=r.length>0?r.reduce((function(e,t){return e+t}))/r.length:-1,a=i.length>0?i.reduce((function(e,t){return e+t}))/i.length:-1;e({packetLossRate:a,rtt:n,list:o})}))}catch(r){var h=de(t._remoteMutedStateMap.keys()).map((function(e){return{userId:e,packetLossRate:-1,rtt:-1}}));e({packetLossRate:-1,rtt:-1,list:h})}})));case 1:case"end":return e.stop()}}),e)}))),function(){return s.apply(this,arguments)})},{key:"getNetworkQuality",value:function(){var e=this;if(-1===this._interval){var t={uplinkNetworkQuality:0,downlinkNetworkQuality:0,downlinkNetworkQualityList:[]};this._interval=window.setInterval((function(){if(e.xsigoClient){var r,n=e.xsigoClient.getWsState(e.roomId),i=n||{},o=i.state;n&&("DISCONNECTED"===o||"RECONNECTING"===o||"CONNECTING"===o&&"RECONNECTING"===i.prevState)?(t.uplinkNetworkQuality=6,t.downlinkNetworkQuality=6,t.downlinkNetworkQualityList=de(e._remoteMutedStateMap.keys()).map((function(e){return{userId:e,downlinkNetworkQuality:6}}))):(e.getTransportStats().then((function(r){t.uplinkNetworkQuality=e.networkLevel(r.packetLossRate,r.rtt)})).catch((function(){t.uplinkNetworkQuality=0})),e.getRemoteTransportStats().then((function(r){t.downlinkNetworkQuality=e.networkLevel(r.packetLossRate,r.rtt),r.list&&(t.downlinkNetworkQualityList=r.list.map((function(t){return{userId:t.userId,downlinkNetworkQuality:e.networkLevel(t.packetLossRate,t.rtt)}})))})).catch((function(e){t.downlinkNetworkQuality=0,t.downlinkNetworkQualityList=e.list.map((function(e){return{userId:e.userId,downlinkNetworkQuality:0}}))}))),(t.uplinkNetworkQuality>=3||t.downlinkNetworkQuality>=3)&&e.logger.warn("network-quality",JSON.stringify(t,null,4)),e._emitter.emit("network-quality",t),null!==(r=e.appConfig)&&void 0!==r&&r.enableEvent&&(e.getSenderStats(),e.getReceiverStats())}}),2e3)}else this.logger.warn("network quality calculating is already started")}},{key:"getSenderStats",value:(a=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f,m,v,g,y,b,S,E,C,T,w,_,k,R,I,O,P,A,x,L,M,D,U,N,j,V,F,W,B,G,H,z;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=ln(this.publications.entries()),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=27;break}n=se(r.value,2),i=n[0],o=n[1],e.t0=be.keys(this.localStreams);case 6:if((e.t1=e.t0()).done){e.next=25;break}if(s=(a=this.localStreams[e.t1.value]).screen?"share_".concat(a.getUserId()):a.getUserId(),this.senderStats.has(s)||this.senderStats.set(s,{audio:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},video:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0},smallVideo:{bytesSent:0,timestamp:0,retransmittedPacketsSent:0,packetsSent:0,packetLossRate:0}}),!a.audioStreamId||a.audioStreamId!==i||a.screen){e.next=18;break}return c=this.senderStats.get(s),d=(u=c.audio).bytesSent,l=u.timestamp,h=u.retransmittedPacketsSent,p=u.packetsSent,e.next=16,o.getLocalStats("audio");case 16:(f=e.sent)&&(v=(f.timestamp-l)/1e3,y=(g=(m=f.audio).bytesSent-d)<=0?0:Number((8*g/v/1024).toFixed(2)),S=(b=m.retransmittedPacketsSent-h)<=0?0:parseFloat((b/(m.packetsSent-p)).toFixed(6)),this.senderStats.set(s,dn(dn({},c),{},{audio:{bytesSent:m.bytesSent,timestamp:f.timestamp,packetsSent:m.packetsSent,retransmittedPacketsSent:m.retransmittedPacketsSent,packetLossRate:S}})),this.logger.mediaLog({med_type:"mic",pub:!0,ruid:this.roomUniqueId,uid:this.userId,streams:[{rate:y,lost:S,rtt:f.rtt}]}),E=this.xsigoClient.getWsState(this.roomId),["CONNECTED","RECOVERY"].includes((E||{}).state)&&0===m.bytesSent&&o.updateBytesSentIs0Count("audio"));case 18:if(!a.videoStreamId||a.videoStreamId!==i){e.next=23;break}return e.next=21,o.getLocalStats("video");case 21:(C=e.sent)&&(T={med_type:a.screen?"screen":"camera",pub:!0,ruid:this.roomUniqueId,uid:this.userId,sess_id:i,streams:[]},w=this.senderStats.get(s),R=(_=w.video).retransmittedPacketsSent,I=_.packetsSent,P=(C.timestamp-_.timestamp)/1e3,x=(A=(O=C.video).bytesSent-(k=_.bytesSent))<=0?0:(8*A/P/1024).toFixed(2),this.logger.debug("video vStats.bytesSent:".concat(O.bytesSent,",bytesSent:").concat(k,",bitrate:").concat(x)),M=(L=O.retransmittedPacketsSent-R)<=0?0:parseFloat((L/(O.packetsSent-I)).toFixed(6)),T.streams.push({rate:x,lost:M,rtt:C.rtt,fps:O.framesPerSecond,rid:O.rid,width:O.frameWidth,height:O.frameHeight}),D=w.smallVideo,!a.screen&&this.isEnableSmallStream&&(N=(U=D).retransmittedPacketsSent,j=U.packetsSent,F=(C.timestamp-U.timestamp)/1e3,B=(W=(V=C.smallVideo).bytesSent-U.bytesSent)<=0?0:(8*W/F/1024).toFixed(2),H=(G=V.retransmittedPacketsSent-N)<=0?0:parseFloat((G/(V.packetsSent-j)).toFixed(6)),D={bytesSent:V.bytesSent,timestamp:C.timestamp,packetsSent:V.packetsSent,retransmittedPacketsSent:V.retransmittedPacketsSent,packetLossRate:H},T.streams.push({rate:B,lost:H,rtt:C.rtt,fps:V.framesPerSecond,rid:V.rid,width:V.frameWidth,height:V.frameHeight})),this.senderStats.set(s,dn(dn({},w),{},{video:{bytesSent:O.bytesSent,timestamp:C.timestamp,packetsSent:O.packetsSent,retransmittedPacketsSent:O.retransmittedPacketsSent,packetLossRate:M},smallVideo:D})),this.logger.mediaLog(T),z=this.xsigoClient.getWsState(this.roomId),["CONNECTED","RECOVERY"].includes((z||{}).state)&&0===O.bytesSent&&o.updateBytesSentIs0Count("video"));case 23:e.next=6;break;case 25:e.next=3;break;case 27:e.next=32;break;case 29:e.prev=29,e.t2=e.catch(1),t.e(e.t2);case 32:return e.prev=32,t.f(),e.finish(32);case 35:case"end":return e.stop()}}),e,this,[[1,29,32,35]])}))),function(){return a.apply(this,arguments)})},{key:"getReceiverStats",value:(o=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f,m,v,g,y,b,S,E,C,T,w,_,k,R,I,O,P,A,x,L,M,D,U,N,j,V,F,W;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=ln(this.subscriptions.entries()),e.prev=1,t.s();case 3:if((r=t.n()).done){e.next=25;break}if(n=se(r.value,2),i=n[0],a=(o=n[1]).stream.getUserSeq(),s=o.stream.getUserId(),this.receiverStats.has(a)||this.receiverStats.set(a,{audio:{bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0},video:{bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}}),c=o.stream.getType(),i!==o.stream.audioSubscriptionId||c===Ce){e.next=16;break}return u=this.receiverStats.get(a),l=(d=u.audio).bytesReceived,h=d.timestamp,p=d.packetsLost,f=d.packetsReceived,m=d.nackCount,e.next=14,o.subscriber.getRemoteAudioOrVideoStats("audio");case 14:(v=e.sent)&&(y=(v.timestamp-h)/1e3,S=(b=(g=v.audio).bytesReceived-l)<=0?0:Number((8*b/y/1024).toFixed(2)),E=g.packetsLost-p,C=g.packetsReceived-f,w=(T=g.nackCount-m)<=0||C<=0?0:T>C?100:E<0?parseFloat((T/C).toFixed(6)):parseFloat(((E+T)/(E+C)).toFixed(6)),this.receiverStats.set(a,dn(dn({},u),{},{audio:{bytesReceived:g.bytesReceived,timestamp:v.timestamp,packetsReceived:g.packetsReceived,packetsLost:g.packetsLost,nackCount:g.nackCount,packetLossRate:w}})),this.logger.mediaLog({med_type:"mic",pub:!1,ruid:this.roomUniqueId,uid:s,streams:[{rate:S,lost:w,rtt:v.rtt}]}));case 16:if(i!==o.stream.videoSubscriptionId){e.next=23;break}return _=this.receiverStats.get(a),R=(k=_.video).bytesReceived,I=k.timestamp,O=k.packetsLost,P=k.packetsReceived,A=k.nackCount,e.next=21,o.subscriber.getRemoteAudioOrVideoStats("video");case 21:(x=e.sent)&&(M=(x.timestamp-I)/1e3,U=(D=(L=x.video).bytesReceived-R)<=0?0:Number((8*D/M/1024).toFixed(2)),N=L.packetsLost-O,j=L.packetsReceived-P,F=(V=L.nackCount-A)<=0||j<=0?0:V>j?100:N<0?parseFloat((V/j).toFixed(6)):parseFloat(((N+V)/(N+j)).toFixed(6)),this.receiverStats.set(a,dn(dn({},_),{},{video:{bytesReceived:L.bytesReceived,timestamp:x.timestamp,packetsReceived:L.packetsReceived,packetsLost:L.packetsLost,nackCount:L.nackCount,packetLossRate:F}})),W=o.stream.getSimulcastType(),this.logger.mediaLog({med_type:c!==Ce?"camera":"screen",pub:!1,ruid:this.roomUniqueId,uid:s,streams:[{rate:U,lost:F,rtt:x.rtt,fps:L.framesPerSecond,rid:W===it.SmallStream?"l":"h",width:L.frameWidth,height:L.frameHeight}]}));case 23:e.next=3;break;case 25:e.next=30;break;case 27:e.prev=27,e.t0=e.catch(1),t.e(e.t0);case 30:return e.prev=30,t.f(),e.finish(30);case 33:case"end":return e.stop()}}),e,this,[[1,27,30,33]])}))),function(){return o.apply(this,arguments)})},{key:"networkLevel",value:function(e,t){return e>50||t>500?5:e>30||t>350?4:e>20||t>200?3:e>10||t>100?2:e>=0||t>=0?1:0}},{key:"getLocalAudioStats",value:function(){return this.getLocalStatsMap("audio")}},{key:"getLocalVideoStats",value:function(){return this.getLocalStatsMap("video")}},{key:"getLocalStatsMap",value:(i=ue(be.mark((function e(t){var r,n,i,o,a,s,c,u,d,l,h,p,f,m,v,g,y,b;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.localStreams.some((function(e){return e.published&&("audio"===t?e.audioStreamId:e.videoStreamId)}))){e.next=3;break}throw new Ue({code:ke.INVALID_OPERATION,message:"local stream is not published"});case 3:r=new Map,e.prev=4,n=ln(this.publications.entries()),e.prev=6,n.s();case 8:if((i=n.n()).done){e.next=25;break}o=se(i.value,2),a=o[0],s=o[1],e.t0=be.keys(this.localStreams);case 11:if((e.t1=e.t0()).done){e.next=23;break}if(c=this.localStreams[e.t1.value],!("audio"===t?c.audioStreamId===a:c.videoStreamId===a)){e.next=21;break}return u=c.screen?"share_".concat(c.getUserId()):c.getUserId(),e.next=18,s.getLocalStats(t);case 18:d=e.sent,"audio"===t&&d&&(this.senderLocalStats.has(u)||this.senderLocalStats.set(u,{audio:{bytesSent:0,timestamp:0,packetsSent:0}}),l=this.senderLocalStats.get(u),f=(h=d[t]).packetsSent,m=(d.timestamp-l.audio.timestamp)/1e3,g=(v=(p=h.bytesSent)-l.audio.bytesSent)<=0?0:Number((8*v/m/1024).toFixed()),r.set(u,{bytesSent:p,packetsSent:f,bitrate:g}),this.senderLocalStats.set(c.getUserId(),dn(dn({},l),{},{audio:{bytesSent:p,timestamp:d.timestamp,packetsSent:f}}))),"video"===t&&d&&r.set(u,{bytesSent:(y=d[t]).bytesSent,packetsSent:y.packetsSent,framesEncoded:y.framesEncoded,frameWidth:y.frameWidth,frameHeight:y.frameHeight,framesSent:y.framesSent});case 21:e.next=11;break;case 23:e.next=8;break;case 25:e.next=30;break;case 27:e.prev=27,e.t2=e.catch(6),n.e(e.t2);case 30:return e.prev=30,n.f(),e.finish(30);case 33:return e.abrupt("return",Promise.resolve(r));case 36:return e.prev=36,e.t3=e.catch(4),this.logger.info("Get local ".concat(t," stats failed"),e.t3),this.logger.onError({c:Et.TOP_ERROR,v:"audio"===t?ke.LOCAL_AUDIO_STATA_ERROR:ke.LOCAL_VIDEO_STATA_ERROR}),b=new Ue({code:"audio"===t?ke.LOCAL_AUDIO_STATA_ERROR:ke.LOCAL_VIDEO_STATA_ERROR,message:e.t3.message}),e.abrupt("return",Promise.reject(b));case 42:case"end":return e.stop()}}),e,this,[[4,36],[6,27,30,33]])}))),function(e){return i.apply(this,arguments)})},{key:"getRemoteAudioStats",value:function(){var e=this;return new Promise(function(){var t=ue(be.mark((function t(r,n){var i,o,a,s,c,u,d,l,h;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=new Map,t.prev=1,e.logger.info("get remote audio Stats",e.subscriptions),o=ln(e.subscriptions.entries()),t.prev=4,o.s();case 6:if((a=o.n()).done){t.next=16;break}if(s=se(a.value,2),c=s[0],d=(u=s[1]).stream.getUserSeq(),c!==u.stream.audioSubscriptionId){t.next=14;break}return t.next=12,u.subscriber.getRemoteAudioOrVideoStats("audio");case 12:(l=t.sent)&&i.set(d,l.audio);case 14:t.next=6;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(4),o.e(t.t0);case 21:return t.prev=21,o.f(),t.finish(21);case 24:r(i),t.next=32;break;case 27:t.prev=27,t.t1=t.catch(1),e.logger.onError({c:Et.TOP_ERROR,v:ke.REMOTE_AUDIO_STATA_ERROR},"Get Remote Audio Stats Failed, ".concat(t.t1)),h=new Ue({code:ke.REMOTE_AUDIO_STATA_ERROR,message:t.t1.message}),n(h);case 32:case"end":return t.stop()}}),t,null,[[1,27],[4,18,21,24]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"getRemoteVideoStats",value:function(){var e=this;return new Promise(function(){var t=ue(be.mark((function t(r,n){var i,o,a,s,c,u,d,l,h,p;return be.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:i=new Map,t.prev=1,e.logger.info("get remote video Stats",e.subscriptions),o=ln(e.subscriptions.entries()),t.prev=4,o.s();case 6:if((a=o.n()).done){t.next=16;break}if(s=se(a.value,2),c=s[0],d=(u=s[1]).stream.getUserSeq(),c!==u.stream.videoSubscriptionId){t.next=14;break}return t.next=12,u.subscriber.getRemoteAudioOrVideoStats("video");case 12:(l=t.sent)&&i.set(d,{bytesReceived:(h=l.video).bytesReceived,packetsReceived:h.packetsReceived,packetsLost:h.packetsLost,framesDecoded:h.framesDecoded,frameWidth:h.frameWidth,frameHeight:h.frameHeight});case 14:t.next=6;break;case 16:t.next=21;break;case 18:t.prev=18,t.t0=t.catch(4),o.e(t.t0);case 21:return t.prev=21,o.f(),t.finish(21);case 24:r(i),t.next=32;break;case 27:t.prev=27,t.t1=t.catch(1),e.logger.onError({c:Et.TOP_ERROR,v:ke.REMOTE_VIDEO_STATA_ERROR},"Get Remote Video Stats Failed, ".concat(t.t1)),p=new Ue({code:ke.REMOTE_VIDEO_STATA_ERROR,message:t.t1.message}),n(p);case 32:case"end":return t.stop()}}),t,null,[[1,27],[4,18,21,24]])})));return function(e,r){return t.apply(this,arguments)}}())}},{key:"onWsStateChange",value:function(e,t,r){this.logger.info("Ws state from ".concat(t," to ").concat(r)),this._emitter.emit("connection-state-changed",{state:r,prevState:t})}},{key:"onError",value:function(e){this.logger.buriedLog({c:Et.ON_ERROR,v:"".concat(e.message)}),this._emitter.emit(Te,e)}},{key:"onWsReconnectFailed",value:function(e){this.logger.warn("room: ".concat(e," reconnection failed")),this.logger.onError({c:Et.TOP_ERROR,v:ke.SIGNAL_CHANNEL_RECONNECTION_FAILED});var t=new Ue({code:ke.SIGNAL_CHANNEL_RECONNECTION_FAILED,message:"signal channel reconnection failed, please check your network"});this._emitter.emit(Te,t),this.leave()}},{key:"onParticipantLeave",value:function(e){var t=this;this.logger.info("======notification: ".concat(e," leave======"));try{var r="share_".concat(e),n=this.remoteStreams.get(e),i=this.remoteStreams.get(r),o=function(r,n){t.logger.buriedLog({c:r.type===Ce?Et.ON_STREAM_REMOVED_SCREEN:Et.ON_STREAM_REMOVED,v:"uid:".concat(e)}),t._emitter.emit("stream-removed",{stream:r}),r.close(),t.remoteStreams.delete(n),t.subscribeManager.subscriptedState.delete(n),t.receiverStats.has(n)&&t.receiverStats.delete(n);var i,o=ln(t.subscriptions.entries());try{for(o.s();!(i=o.n()).done;){var a=se(i.value,2),s=a[0],c=a[1];[r.audioSubscriptionId,r.videoSubscriptionId].includes(s)&&(c.subscriber.close(),t.subscriptions.delete(s))}}catch(e){o.e(e)}finally{o.f()}};n&&o(n,e),i&&o(i,r),this._remoteMutedStateMap.has(e)&&this._remoteMutedStateMap.delete(e)}catch(e){this.logger.info(e)}this.logger.buriedLog({c:Et.ON_PEER_LEVAE,v:"uid:".concat(e)}),this._emitter.emit("peer-leave",{userId:e})}},{key:"onStreamAdd",value:function(e){var t=e||{},r=t.userId,n=t.streamId,i=t.info,o=t.mixedInfo,a=i||{},s=a.audio,c=a.video;if(this.logger.info("time  Date.now stream-add",Date.now()),r!==this.userId){var u=(s||c||{}).source;u===nt.ScreenShare&&(r="share_".concat(r));var d=this.remoteStreams.get(r);if(this.logger.info("userId: "+r,"remote stream",d),d){var l=this.subscribeManager.needSubscribeKind(r),h=this.subscribeManager.getSubscriptionOpts(r);this.logger.info("userId: "+r,l,h,null,4);var p={audio:!1,video:!1,small:h.small};if(l===et.AudioOnly&&(p.audio=!0),l===et.VideoOnly&&(p.video=!0),l===et.AudioVideo&&(p.audio=!0,p.video=!0),s&&(d.setAudio(!!s),d.setHasAudio(!!s),d.setAudioStreamId(n),d.setMutedState("audio",s.muted),this.updateRemoteMutedState(r,{hasAudio:!0,audioMuted:s.muted})),c){d.setVideo(!!c),d.setHasVideo(!!c),d.setVideoStreamId(n),d.setInfo(i);var f=(c.simulcast||[]).find((function(e){return e.type===it.SmallStream}));d.setMutedState("video",c.muted),this.updateRemoteMutedState(r,{hasVideo:!0,videoMuted:c.muted,hasSmall:!!f})}this._emitter.emit("stream-updated",{stream:d}),this.logger.info("Auto subscribe options",JSON.stringify(p)),(p.audio||p.video)&&this.doSubscribe(d,p)}else{if(d=new Ht({userId:r,type:u===nt.ScreenShare?Ce:"main",info:i,mixedInfo:o},this.logger),u===nt.ScreenShare&&d.setLocalUserId(this.userId),d.streamId=n,this.remoteStreams.set(r,d),s&&(d.setAudio(!!s),d.setHasAudio(!!s),d.setAudioStreamId(n),d.setMutedState("audio",s.muted),this.updateRemoteMutedState(r,{hasAudio:!0,audioMuted:s.muted})),c){d.setVideo(!!c),d.setHasVideo(!!c),d.setVideoStreamId(n);var m=(c.simulcast||[]).find((function(e){return e.type===it.SmallStream}));d.setMutedState("video",c.muted),this.updateRemoteMutedState(r,{hasVideo:!0,videoMuted:c.muted,hasSmall:!!m})}this.logger.buriedLog({c:d.type===Ce?Et.ON_STREAM_ADDED_SCREEN:Et.ON_STREAM_ADDED,v:"uid:".concat(d.getUserId())}),this._emitter.emit("stream-added",{stream:d})}}}},{key:"onStreamChange",value:function(e,t){var r=e;this.getType(t)===Ce&&(r="share_".concat(r),this.remoteStreams.get(r).closeWaterMark()),this.logger.info("time  Date.now stream-remove",Date.now());var n=this.remoteStreams.get(r);if(r!==this.userId&&r!=="share_".concat(r)&&n){var i=this.subscribeManager.getSubscriptedState(r);if(n&&n.getStreamKind(t)===et.AudioOnly){if(!n.videoStreamId)return void this.doStreamRemove(r);if(n.audioStreamId){if(n.hasAudio()){var o=n.getAudioTrack();o&&n.mediaStream.removeTrack(o)}i.audio=!1,n.setHasAudio(!1),n.setAudioStreamId(null),this.subscriptions.has(n.audioSubscriptionId)&&(this.subscriptions.get(n.audioSubscriptionId).subscriber.close(),this.subscriptions.delete(n.audioSubscriptionId),n.setAudioSubscriptionId(null)),n.setMutedState("audio",!0),this.updateRemoteMutedState(r,{hasAudio:!1,audioMuted:!0}),this.receiverStats.has(r)&&(this.receiverStats.get(r).audio={bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}),this._emitter.emit("mute-audio",{userId:r})}}if(n&&n.getStreamKind(t)===et.VideoOnly){if(!n.audioStreamId)return void this.doStreamRemove(r);if(n.videoStreamId){if(n.hasVideo()){var a=n.getVideoTrack();a&&n.mediaStream.removeTrack(a)}i.video=!1,n.setHasVideo(!1),n.setVideoStreamId(null),this.subscriptions.has(n.videoSubscriptionId)&&(this.subscriptions.get(n.videoSubscriptionId).subscriber.close(),this.subscriptions.delete(n.videoSubscriptionId),n.setVideoSubscriptionId(null)),n.setSimulcasts([]),n.setMutedState("video",!0),this.updateRemoteMutedState(r,{hasVideo:!1,videoMuted:!0,hasSmall:!1}),this.receiverStats.has(r)&&(this.receiverStats.get(r).video={bytesReceived:0,timestamp:0,packetsReceived:0,packetsLost:0,nackCount:0,packetLossRate:0}),this._emitter.emit("mute-video",{userId:r})}}this.subscribeManager.updateSubscriptedState(r,i),this._emitter.emit("stream-updated",{stream:n})}}},{key:"doStreamRemove",value:function(e){var t=this,r=this.remoteStreams.get(e),n=this.subscribeManager.getSubscriptedState(e);if(n.audio=!1,n.video=!1,this.subscribeManager.updateSubscriptedState(e,n),r){r.getType()===Ce&&r.closeWaterMark(),r.setAudioStreamId(null),r.setVideoStreamId(null),r.setMutedState("audio",!0),r.setMutedState("video",!0),this.remoteStreams.delete(e),this.logger.info("time  Date.now delete remoteStreams",Date.now(),r.audioSubscriptionId,r.videoSubscriptionId),this.receiverStats.has(e)&&this.receiverStats.delete(e);var i=[];r.audioSubscriptionId&&i.push(r.audioSubscriptionId),r.videoSubscriptionId&&i.push(r.videoSubscriptionId),i.forEach((function(e){t.subscriptions.has(e)&&(t.subscriptions.get(e).subscriber.close(),t.subscriptions.delete(e),e===r.audioSubscriptionId&&r.setAudioSubscriptionId(null),e===r.videoSubscriptionId&&r.setVideoSubscriptionId(null))})),this.logger.info("do stream remove with ",this.subscriptions),this.logger.buriedLog({c:r.type===Ce?Et.ON_STREAM_REMOVED_SCREEN:Et.ON_STREAM_REMOVED,v:"uid:".concat(r.getUserId())}),this.updateRemoteMutedState(e),this._emitter.emit("stream-removed",{stream:r})}}},{key:"onClientBanned",value:function(e){var t=this;this.logger.buriedLog({c:Et.ON_CLIENT_BANNED,v:"cause:".concat(e)},!0);var r,n=ln(this.publications.entries());try{var i=function(){var e=se(r.value,2),n=e[0],i=e[1],o=t.localStreams.find((function(e){return e.streamId===n}));o&&o.close(),i.close()};for(n.s();!(r=n.n()).done;)i()}catch(e){n.e(e)}finally{n.f()}var o,a=ln(this.subscriptions.values());try{for(a.s();!(o=a.n()).done;){var s=o.value;s.stream.close(),s.subscriber.close()}}catch(e){a.e(e)}finally{a.f()}this.state=me.Leaved,this.reset(),this._emitter.emit("client-banned",{cause:e})}},{key:"onStreamUpdate",value:function(e,t,r,n){var i=e;if(this.remoteStreams.has("share_".concat(e))){var o=this.remoteStreams.get("share_".concat(e));[o.audioStreamId,o.videoStreamId].includes(t)&&(i="share_".concat(e))}var a=this.localStreams.find((function(e){return[e.audioStreamId,e.videoStreamId].includes(t)}));if(a||(a=this.remoteStreams.get(i)),null!=r&&r.audio&&(e!==this.userId&&(this.logger.buriedLog({c:r.audio.muted?Et.ON_MUTE_AUDIO:Et.ON_UNMUTE_AUDIO,v:"uid:".concat(e)}),this._emitter.emit(r.audio.muted?"mute-audio":"unmute-audio",{userId:i})),a.setMutedState("audio",r.audio.muted),this.updateRemoteMutedState(e,{audioMuted:r.audio.muted})),null!=r&&r.video&&(e!==this.userId&&(this.logger.buriedLog({c:r.video.muted?Et.ON_MUTE_VIDEO:Et.ON_UNMUTE_VIDEO,v:"uid:".concat(e)}),this._emitter.emit(r.video.muted?"mute-video":"unmute-video",{userId:i})),a.setMutedState("video",r.video.muted),this.updateRemoteMutedState(e,{videoMuted:r.video.muted})),n&&n.length){var s=(n||[]).find((function(e){return e.type===it.SmallStream}));if(this.remoteStreams.has(e)){var c=this.remoteStreams.get(e);c.setSimulcasts(n),this.logger.buriedLog({c:c.getType()===Ce?Et.ON_STREAM_UPDATED_SCREEN:Et.ON_STREAM_UPDATED,v:"uid:".concat(c.getUserId())}),this._emitter.emit("stream-updated",{stream:c}),s||c.getSimulcastType()===it.SmallStream&&(this.logger.info("auto setRemoteVideoStreamType big"),this.setRemoteVideoStreamType(c,"big"))}this.updateRemoteMutedState(e,{hasVideo:!0,hasSmall:!!s})}}},{key:"onMuteLocal",value:function(e,t){switch(e){case ot.Amute:this._emitter.emit("mute-audio",{userId:t});break;case ot.Aunmute:this._emitter.emit("unmute-audio",{userId:t});break;case ot.Vmute:this._emitter.emit("mute-video",{userId:t});break;case ot.Vunmute:this._emitter.emit("unmute-video",{userId:t})}}},{key:"getType",value:function(e){var t,r,n=ln(this.remoteStreams);try{for(n.s();!(r=n.n()).done;){var i=se(r.value,2)[1];if(i.audioStreamId===e||i.videoStreamId===e){t=i.getType();break}}}catch(e){n.e(e)}finally{n.f()}return t}},{key:"hasPublishedStream",value:function(){return this.localStreams.some((function(e){return e.published}))}},{key:"getClientState",value:function(){return this.state}},{key:"onDeviceChange",value:(n=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f,m,v,g,y,b,S,E,C,T,w=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,_t();case 3:if(t=e.sent,r=JSON.parse(JSON.stringify(this._preDiviceList)),this._preDiviceList=t,(n=t.filter((function(e){return-1===r.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length&&this.logger.info("onDeviceChange addedDevices",JSON.stringify(n,null,4)),(i=r.filter((function(e){return-1===t.findIndex((function(t){return t.deviceId===e.deviceId}))}))).length&&this.logger.info("onDeviceChange removedDevices",JSON.stringify(i,null,4)),o=this.localStreams.find((function(e){return!e.screen})),a=n.filter((function(e){return"audiooutput"===e.kind})),s=t.filter((function(e){return"default"===e.deviceId})),!o){e.next=63;break}if(c=t.filter((function(e){return"audioinput"===e.kind&&"default"===e.deviceId})),!n||!n.length){e.next=42;break}if(u=r.find((function(e){return"audioinput"===e.kind})),d=r.find((function(e){return"videoinput"===e.kind})),l=n.filter((function(e){return"audioinput"===e.kind})),h=n.filter((function(e){return"videoinput"===e.kind})),p=!u&&l.length>0&&o.hasAudio(),f=!d&&h.length>0&&o.hasVideo(),!p||!f){e.next=30;break}return this.logger.warn("new microphone and camera detected, but there was no device before."),e.next=26,o.updateStream({audio:!0,video:!0,cameraId:h[0].deviceId,microphoneId:c.length?c[0].deviceId:l[0].deviceId});case 26:this._emitter.emit("auto-switch-device",{type:"audio",deviceId:c.length?c[0].deviceId:l[0].deviceId}),this._emitter.emit("auto-switch-device",{type:"video",deviceId:h[0].deviceId}),e.next=42;break;case 30:if(!p){e.next=37;break}return this.logger.warn("new microphone  detected, but there was no device before."),e.next=34,o.updateStream({audio:!0,video:!1,microphoneId:l[0].deviceId});case 34:this._emitter.emit("auto-switch-device",{type:"audio",deviceId:l[0].deviceId}),e.next=42;break;case 37:if(!f){e.next=42;break}return this.logger.warn("new camera  detected, but there was no device before."),e.next=41,o.updateStream({audio:!1,video:!0,cameraId:h[0].deviceId});case 41:this._emitter.emit("auto-switch-device",{type:"video",deviceId:h[0].deviceId});case 42:if(!i||!i.length){e.next=63;break}if(m=o.getDevicesInfoInUse(),v=m.microphone,g=m.camera,this.logger.warn("Devices in use microphone:".concat(JSON.stringify(v,null,4),",camera:").concat(JSON.stringify(g,null,4))),y=i.find((function(e){return e.groupId&&v.groupId?e.deviceId===v.deviceId&&e.groupId===v.groupId:e.deviceId===v.deviceId})),b=i.find((function(e){return e.groupId&&g.groupId?e.deviceId===g.deviceId&&e.groupId===g.groupId:e.deviceId===g.deviceId})),S=t.find((function(e){return"audioinput"===e.kind})),E=t.find((function(e){return"videoinput"===e.kind})),C=y&&o.hasAudio(),T=b&&o.hasVideo(),!C){e.next=57;break}if(this.logger.warn("current microphone in use is lost, deviceId: ".concat(v.deviceId)),!S){e.next=57;break}return e.next=56,o.updateStream({audio:!0,video:!1});case 56:this._emitter.emit("auto-switch-device",{type:"audio"});case 57:if(!T){e.next=63;break}if(this.logger.warn("current camera in use is lost, deviceId: ".concat(g.deviceId)),!E){e.next=63;break}return e.next=62,o.updateStream({audio:!1,video:!0});case 62:this._emitter.emit("auto-switch-device",{type:"video"});case 63:a.length&&s.length&&this.remoteStreams.forEach((function(e){e.setAudioOutput("default")})),n.forEach((function(e){switch(e.kind){case"audioinput":w.logger.info("The new microphone device be detected is",e.label),w._emitter.emit("recording-device-changed",{deviceId:e.deviceId,state:"ADD"});break;case"videoinput":w.logger.info("The new camera device be detected is",e.label),w._emitter.emit("camera-changed",{deviceId:e.deviceId,state:"ADD"});break;case"audiooutput":w.logger.info("The new speaker device be detected is",e.label),w._emitter.emit("playback-device-changed",{deviceId:e.deviceId,state:"ADD"})}})),i.forEach((function(e){switch(e.kind){case"audioinput":w.logger.info("The microphone device is detected to be removed: ",e.label),w._emitter.emit("recording-device-changed",{deviceId:e.deviceId,state:"REMOVE"});break;case"videoinput":w.logger.info("The camera device is detected to be removed: ",e.label),w._emitter.emit("camera-changed",{deviceId:e.deviceId,state:"REMOVE"});break;case"audiooutput":w.logger.info("The speaker device is detected to be removed: ",e.label),w._emitter.emit("playback-device-changed",{deviceId:e.deviceId,state:"REMOVE"})}})),e.next=71;break;case 68:e.prev=68,e.t0=e.catch(0),this.logger.onError({c:Et.TOP_ERROR,v:ke.SWITCH_DEVICE_FAILED},"on device change error, ".concat(e.t0));case 71:case"end":return e.stop()}}),e,this,[[0,68]])}))),function(){return n.apply(this,arguments)})},{key:"enableAudioVolumeEvaluation",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:2e3;if(this.logger.info("enableAudioVolumeEvaluation with interval: "+t),this.logger.buriedLog({c:Et.ENABLE_AUDIO_VOLUME_EVALUATION,v:"time:".concat(t)}),"number"!=typeof t)throw this.logger.onError({c:Et.TOP_ERROR,v:ke.INVALID_PARAMETER}),new Ue({code:ke.INVALID_PARAMETER,message:"parameter must be numeric type"});t<=0?(window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null):(this.audioVolumeInterval&&(window.clearInterval(this.audioVolumeInterval),this.audioVolumeInterval=null),this.audioVolumeInterval=window.setInterval((function(){var t=[];e.localStreams.forEach((function(e){if(!e.screen&&e.published){var r=Math.floor(100*e.getAudioLevel());t.push({userId:e.getUserId(),audioVolume:r,stream:e})}}));var r,n=ln(e.remoteStreams);try{for(n.s();!(r=n.n()).done;){var i=se(r.value,2)[1];if("main"===i.getType()&&i.subscribed){var o=Math.floor(100*i.getAudioLevel());t.push({userId:i.getUserId(),audioVolume:o,stream:i})}}}catch(e){n.e(e)}finally{n.f()}e._emitter.emit("audio-volume",{result:t})}),Math.floor(Math.max(t,16))))}},{key:"addEventListenser",value:function(e){this.ssl&&navigator.mediaDevices&&"devicechange"===e&&navigator.mediaDevices.addEventListener(e,this.deviceChange),"visibilitychange"===e&&document.addEventListener(e,this.visibilitychange)}},{key:"removeEventListenser",value:function(e){this.ssl&&navigator.mediaDevices&&"devicechange"===e&&navigator.mediaDevices.removeEventListener(e,this.deviceChange),"visibilitychange"===e&&document.removeEventListener(e,this.visibilitychange)}},{key:"startWaterMark",value:(r=ue(be.mark((function e(t){var r,n,i,o,a=this;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.isWaterMark){e.next=2;break}return e.abrupt("return");case 2:return this.isWaterMark=!0,r={fontColor:"rgba(200,200,200,0.6)",fontSize:"12",fontType:"Microsoft Yahei"},n=t.fontColor,i=t.fontSize,o=t.fontType,t&&(n&&(r.fontColor=n),i&&(r.fontSize=i),o&&(r.fontType=o)),e.next=8,Ft(r,this.userId);case 8:this.waterMarkImage=e.sent,this.waterMarkoptions=r,this.remoteStreams.size&&this.remoteStreams.forEach(function(){var e=ue(be.mark((function e(t){return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.getType()!==Ce){e.next=3;break}return e.next=3,t.startWaterMark(r,a.waterMarkImage);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 11:case"end":return e.stop()}}),e,this)}))),function(e){return r.apply(this,arguments)})},{key:"closeWaterMark",value:function(){this.isWaterMark&&(this.isWaterMark=!1,this.waterMarkImage=null,this.remoteStreams.size&&this.remoteStreams.forEach((function(e){e.getType()===Ce&&e.closeWaterMark()})))}},{key:"enableSmallStream",value:function(){var e=this.localStreams.find((function(e){return e.videoStreamId&&!e.screen}));if(e&&e.published)throw new Ue({code:ke.INVALID_OPERATION,message:"Cannot enable small stream after localStream published."});if(!Ot())throw new Ue({code:ke.INVALID_OPERATION,message:"Your browser does not support opening small stream"});return this.setIsEnableSmallStream(!0),this.logger.info("SmallStream successfully enabled"),this.logger.buriedLog({c:Et.ENABLE_SMALL_STREAM}),Promise.resolve(!0)}},{key:"disableSmallStream",value:function(){var e=this.localStreams.find((function(e){return e.videoStreamId&&!e.screen}));if(e&&e.published)throw new Ue({code:ke.INVALID_OPERATION,message:"Cannot enable small stream after having published."});return this.setIsEnableSmallStream(!1),this.logger.info("SmallStream successfully disabled"),this.logger.buriedLog({c:Et.DISABLE_SMALL_STREAM}),Promise.resolve(!0)}},{key:"setSmallStreamProfile",value:function(e){var t=e.width,r=e.height,n=e.bitrate,i=e.framerate;if(this.logger.info("setSmallStreamProfile:width=".concat(t,",height=").concat(r,",bitrate=").concat(n,",framerate=").concat(i)),t<0||r<0||n<0||i<0)throw new Ue({code:ke.INVALID_OPERATION,message:"Small stream profile is invalid."});this.logger.buriedLog({c:Et.SET_SMALL_STREAM_PROFILE,v:JSON.stringify(e)}),this.smallStreamConfig={width:t,height:r,bitrate:n,framerate:i}}},{key:"setIsEnableSmallStream",value:function(e){this.isEnableSmallStream=e}},{key:"onVisibilitychange",value:function(){"visible"===document.visibilityState?(this.logger.warn("User enter the page"),this._emitter.emit("page-visibility-state",{state:"visible"})):"hidden"===document.visibilityState&&(this.logger.warn("User leave the pag"),this._emitter.emit("page-visibility-state",{state:"hidden"}))}},{key:"isJoinRoomSupported",value:(t=ue(be.mark((function e(){var t,r,n,i,o,a,s,c,u;return be.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!He.specil()){e.next=4;break}return e.abrupt("return",Promise.resolve({isSupported:!0,code:0,message:""}));case 4:if(!He.any()){e.next=6;break}return e.abrupt("return",Promise.resolve({isSupported:!1,code:ke.OS_NOT_SUPPORTED,message:"".concat(He.getOsName().osName," is not supported!")}));case 6:return e.next=8,wt();case 8:if(r=(t=e.sent.detail).isBrowserSupported,i=t.isH264Supported,(n=t.isWebRTCSupported)&&i&&r){e.next=15;break}return o=ze(),a=o.browser,s=o.version,c=n?i?ke.BROWSER_NOT_SUPPORTED:ke.H264_NOT_SUPPORTED:ke.WEBRTC_NOT_SUPPORTED,u=n?i?"".concat(a).concat(s," browser is not supported"):"your device does not support H.264 encoding.":"your browser does NOT support WebRTC!",e.abrupt("return",Promise.resolve({isSupported:!1,code:c,message:u}));case 15:return e.abrupt("return",Promise.resolve({isSupported:!0,code:0,message:""}));case 16:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})},{key:"enableMicVolume",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3,t=arguments.length>1?arguments[1]:void 0,r=this;if(e>=0){if("number"!=typeof e)throw new Ue({code:ke.INVALID_PARAMETER,message:"parameter must be numeric type"});navigator.mediaDevices.getUserMedia({audio:{deviceId:{exact:t}}}).then((function(t){r.logger.info("microphone permission is ok"),r.micStream=t,r.soundMeter=new Ne,r.soundMeter.connectToSource(r.micStream.getAudioTracks()[0]),r.timer=setInterval((function(){r._emitter.emit("mic-volume",{volumes:Math.round(100*r.soundMeter.getVolume())})}),Math.floor(Math.max(e,100)))})).catch((function(e){r.logger.error("init error ",e)}))}else clearInterval(r.timer),r.timer=null,r.micStream&&r.micStream.getAudioTracks()[0].stop()}}]),e}();function vn(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function gn(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?vn(Object(r),!0).forEach((function(t){ie(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):vn(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}!function(e){e[e.TRACE=0]="TRACE",e[e.DEBUG=1]="DEBUG",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.NONE=5]="NONE"}(pn||(pn={})),function(e){e.NORMAL="normal",e.POINT="point",e.MEDIA="media"}(fn||(fn={}));var yn=function(){function e(){le(this,e),this.LogLevel={TRACE:pn.TRACE,DEBUG:pn.DEBUG,INFO:pn.INFO,WARN:pn.WARN,ERROR:pn.ERROR,NONE:pn.NONE},this.level=pn.INFO,this.myConsole=window.console,this.uploadLog=!1,this.logList=[],this.buriedLogList=[],this.mediaLogList=[],this.maxNumber=10,this.timeout=1e4,this._interval=0,this._intervalBuried=0,this.roomId=null,this.serverUrl="",this.appConfig=null,this.roomUniqueId=null,this.reUploadMaxCount=30,this.logReUploadCount=0,this.buriedlogReUploadCount=0,this.enableUploadLog(),window.addEventListener("beforeunload",this.beforeUnload.bind(this),{once:!0})}return pe(e,[{key:"setLogLevel",value:function(e){this.level=e,this.buriedLog({c:Yt.SET_LOG_LEVEL,v:["TRACE","DEBUG","INFO","WARN","ERROR","NONE"][e]})}},{key:"getLogLevel",value:function(){return this.level}},{key:"setUserId",value:function(e){this.userId=e}},{key:"setRoomId",value:function(e){this.roomId=e}},{key:"setRoomUniqueId",value:function(e){this.roomUniqueId=e}},{key:"setServerUrl",value:function(e){e||(this.uploadLogList=this.logList.splice(0,this.logList.length),this.upload(this.uploadLogList)),this.serverUrl=e}},{key:"setAppConfig",value:function(e){var t,r;this.appConfig=e,null!==(t=this.appConfig)&&void 0!==t&&t.enableLog?this.enableUploadLog():this.disableUploadLog(),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent?this.enableUploadBuriedLogs():this.disableUploadBuriedLogs()}},{key:"debug",value:function(e){var t;if(!(this.level===pn.NONE||pn.DEBUG<this.level)){for(var r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];(t=this.myConsole).debug.apply(t,["XRTC <Debug> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(n)),this.collect(pn.DEBUG,e,n)}}},{key:"info",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];this.collect(pn.INFO,e,n),this.level===pn.NONE||pn.INFO<this.level||(t=this.myConsole).info.apply(t,["XRTC <Info> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(n))}},{key:"warn",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];this.collect(pn.WARN,e,n),this.level===pn.NONE||pn.WARN<this.level||(t=this.myConsole).warn.apply(t,["XRTC <Warn> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(n))}},{key:"error",value:function(e){for(var t,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];this.collect(pn.ERROR,e,n),this.level===pn.NONE||pn.ERROR<this.level||(t=this.myConsole).error.apply(t,["XRTC <Error> ".concat(this.userId?"[".concat(this.userId,"]"):""),e].concat(n))}},{key:"enableUploadLog",value:function(){var e=this;this._interval||(this.uploadLog=!0,this._interval=window.setInterval((function(){e.roomId&&e.logList.length>0&&(e.uploadLogList=e.logList.splice(0,e.logList.length),e.upload(e.uploadLogList))}),this.timeout),this.buriedLog({c:Yt.ENABLE_UPLOAD_LOG}))}},{key:"disableUploadLog",value:function(){this.uploadLog=!1,window.clearInterval(this._interval),this._interval=0,this.buriedLog({c:Yt.DISABLE_UPLOAD_LOG})}},{key:"collect",value:function(e,t,r){this.uploadLog&&(this.logList.push({t:Date.now(),lv:e,mdu:"XRTC",msg:"XRTC ".concat(this.userId?"[".concat(this.userId,"]"):""," ").concat(t," ").concat((r||[]).join(" "),"\r\n")}),this.roomId&&this.logList.length>=this.maxNumber&&(this.uploadLogList=this.logList.splice(0,this.logList.length),this.upload(this.uploadLogList)))}},{key:"upload",value:function(e){var t=this;this.serverUrl&&cn.upload({type:fn.NORMAL,app:cn.appKey,rid:this.roomId,uid:this.userId,pf:"web",list:e}).then((function(){})).catch((function(){t.logReUploadCount=t.logReUploadCount+1,t.logReUploadCount>t.reUploadMaxCount?(t.logList=[],t.logReUploadCount=0,t.info("SDK has tried reupload log ".concat(t.reUploadMaxCount," times, but all failed, and old log cleared"))):t.logList=[].concat(de(e),de(t.logList))}))}},{key:"buriedLog",value:function(e,t){var r,n=this;if((!this.appConfig||this.appConfig.enableEvent)&&(this.buriedLogList.push(gn(gn({},e),{},{t:this.adjustServerTime(Date.now())})),e.c===Yt.JOIN_SUCCESS&&this.buriedLogList.forEach((function(e){e.c!==Yt.JOIN_SUCCESS&&(e.t=n.adjustServerTime(e.t))})),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent&&this.roomUniqueId&&(t||this.buriedLogList.length>=this.maxNumber))){var i=this.buriedLogList.splice(0,this.buriedLogList.length);this.uploadBuriedLogs(i,fn.POINT)}}},{key:"mediaLog",value:function(e,t){var r;if((!this.appConfig||this.appConfig.enableEvent)&&(this.mediaLogList.push(gn(gn({},e),{},{t:this.adjustServerTime(Date.now())})),null!==(r=this.appConfig)&&void 0!==r&&r.enableEvent&&this.roomUniqueId&&(t||this.mediaLogList.length>=this.maxNumber))){var n=this.mediaLogList.splice(0,this.mediaLogList.length);this.uploadBuriedLogs(n,fn.MEDIA)}}},{key:"uploadBuriedLogs",value:function(e,t){var r=this;!this.serverUrl||this.appConfig&&!this.appConfig.enableEvent||cn.upload({type:t,app:cn.appKey,ruid:this.roomUniqueId,uid:this.userId,pf:"web",list:e}).then((function(){})).catch((function(n){r.buriedlogReUploadCount=r.buriedlogReUploadCount+1,r.buriedlogReUploadCount>r.reUploadMaxCount?(t===fn.POINT&&(r.buriedLogList=[]),t===fn.MEDIA&&(r.mediaLogList=[]),r.buriedlogReUploadCount=0,r.info("SDK has tried reupload buried log ".concat(r.reUploadMaxCount," times, but all failed, and old log cleared"))):t===fn.POINT?r.buriedLogList=[].concat(de(e),de(r.buriedLogList)):t===fn.MEDIA&&(r.mediaLogList=[].concat(de(e),de(r.mediaLogList)))}))}},{key:"enableUploadBuriedLogs",value:function(){var e=this;this._intervalBuried||(this._intervalBuried=window.setInterval((function(){if(e.buriedLogList.length>0){var t=e.buriedLogList.splice(0,e.buriedLogList.length);e.uploadBuriedLogs(t,fn.POINT)}if(e.mediaLogList.length>0){var r=e.mediaLogList.splice(0,e.mediaLogList.length);e.uploadBuriedLogs(r,fn.MEDIA)}}),this.timeout))}},{key:"disableUploadBuriedLogs",value:function(){window.clearInterval(this._intervalBuried),this._intervalBuried=0}},{key:"beforeUnload",value:function(){if(this.logList.length>0){var e=this.logList.splice(0,this.logList.length);this.upload(e)}if(this.buriedLogList.length>0){var t=this.buriedLogList.splice(0,this.buriedLogList.length);this.uploadBuriedLogs(t,fn.POINT)}if(this.mediaLogList.length>0){var r=this.mediaLogList.splice(0,this.mediaLogList.length);this.uploadBuriedLogs(r,fn.MEDIA)}this.disableUploadLog(),this.disableUploadBuriedLogs()}},{key:"adjustServerTime",value:function(e){var t;return null!==(t=this.appConfig)&&void 0!==t&&t.timeDiff?e-this.appConfig.timeDiff:e}},{key:"onError",value:function(e,t,r){r?this.buriedLog(e,r):this.buriedLog(e),t&&this.error(t)}}]),e}();let bn=!0,Sn=!0;function En(e,t,r){const n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function Cn(e,t,r){if(!e.RTCPeerConnection)return;const n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);const o=e=>{const t=r(e);t&&(n.handleEvent?n.handleEvent(t):n(t))};return this._eventMap=this._eventMap||{},this._eventMap[t]||(this._eventMap[t]=new Map),this._eventMap[t].set(n,o),i.apply(this,[e,o])};const o=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[t])return o.apply(this,arguments);if(!this._eventMap[t].has(r))return o.apply(this,arguments);const n=this._eventMap[t].get(r);return this._eventMap[t].delete(r),0===this._eventMap[t].size&&delete this._eventMap[t],0===Object.keys(this._eventMap).length&&delete this._eventMap,o.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get(){return this["_on"+t]},set(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}function Tn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(bn=e,e?"adapter.js logging disabled":"adapter.js logging enabled")}function wn(e){return"boolean"!=typeof e?new Error("Argument type: "+typeof e+". Please use a boolean."):(Sn=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))}function _n(){if("object"==typeof window){if(bn)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}}function kn(e,t){Sn&&console.warn(e+" is deprecated, please use "+t+" instead.")}function Rn(e){return"[object Object]"===Object.prototype.toString.call(e)}function In(e){return Rn(e)?Object.keys(e).reduce((function(t,r){const n=Rn(e[r]),i=n?In(e[r]):e[r],o=n&&!Object.keys(i).length;return void 0===i||o?t:Object.assign(t,{[r]:i})}),{}):e}function On(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((n=>{n.endsWith("Id")?On(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach((t=>{On(e,e.get(t),r)}))})))}function Pn(e,t,r){const n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;const o=[];return e.forEach((e=>{"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((t=>{e.forEach((r=>{r.type===n&&r.trackId===t.id&&On(e,r,i)}))})),i}const An=_n;function xn(e,t){const r=e&&e.navigator;if(!r.mediaDevices)return;const n=function(e){if("object"!=typeof e||e.mandatory||e.optional)return e;const t={};return Object.keys(e).forEach((r=>{if("require"===r||"advanced"===r||"mediaSource"===r)return;const n="object"==typeof e[r]?e[r]:{ideal:e[r]};void 0!==n.exact&&"number"==typeof n.exact&&(n.min=n.max=n.exact);const i=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==n.ideal){t.optional=t.optional||[];let e={};"number"==typeof n.ideal?(e[i("min",r)]=n.ideal,t.optional.push(e),e={},e[i("max",r)]=n.ideal,t.optional.push(e)):(e[i("",r)]=n.ideal,t.optional.push(e))}void 0!==n.exact&&"number"!=typeof n.exact?(t.mandatory=t.mandatory||{},t.mandatory[i("",r)]=n.exact):["min","max"].forEach((e=>{void 0!==n[e]&&(t.mandatory=t.mandatory||{},t.mandatory[i(e,r)]=n[e])}))})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},i=function(e,i){if(t.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"==typeof e.audio){const t=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};t((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),t(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=n(e.audio)}if(e&&"object"==typeof e.video){let o=e.video.facingMode;o=o&&("object"==typeof o?o:{ideal:o});const a=t.version<66;if(o&&("user"===o.exact||"environment"===o.exact||"user"===o.ideal||"environment"===o.ideal)&&(!r.mediaDevices.getSupportedConstraints||!r.mediaDevices.getSupportedConstraints().facingMode||a)){let t;if(delete e.video.facingMode,"environment"===o.exact||"environment"===o.ideal?t=["back","rear"]:"user"!==o.exact&&"user"!==o.ideal||(t=["front"]),t)return r.mediaDevices.enumerateDevices().then((r=>{let a=(r=r.filter((e=>"videoinput"===e.kind))).find((e=>t.some((t=>e.label.toLowerCase().includes(t)))));return!a&&r.length&&t.includes("back")&&(a=r[r.length-1]),a&&(e.video.deviceId=o.exact?{exact:a.deviceId}:{ideal:a.deviceId}),e.video=n(e.video),An("chrome: "+JSON.stringify(e)),i(e)}))}e.video=n(e.video)}return An("chrome: "+JSON.stringify(e)),i(e)},o=function(e){return t.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(r.getUserMedia=function(e,t,n){i(e,(e=>{r.webkitGetUserMedia(e,t,(e=>{n&&n(o(e))}))}))}.bind(r),r.mediaDevices.getUserMedia){const e=r.mediaDevices.getUserMedia.bind(r.mediaDevices);r.mediaDevices.getUserMedia=function(t){return i(t,(t=>e(t).then((e=>{if(t.audio&&!e.getAudioTracks().length||t.video&&!e.getVideoTracks().length)throw e.getTracks().forEach((e=>{e.stop()})),new DOMException("","NotFoundError");return e}),(e=>Promise.reject(o(e))))))}}}function Ln(e){e.MediaStream=e.MediaStream||e.webkitMediaStream}function Mn(e){if("object"==typeof e&&e.RTCPeerConnection&&!("ontrack"in e.RTCPeerConnection.prototype)){Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=t=>{t.stream.addEventListener("addtrack",(r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.track.id)):{track:r.track};const i=new Event("track");i.track=r.track,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)})),t.stream.getTracks().forEach((r=>{let n;n=e.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find((e=>e.track&&e.track.id===r.id)):{track:r};const i=new Event("track");i.track=r,i.receiver=n,i.transceiver={receiver:n},i.streams=[t.stream],this.dispatchEvent(i)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}else Cn(e,"track",(e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e)))}function Dn(e){if("object"==typeof e&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){const t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&(this._dtmf="audio"===t.kind?e.createDTMFSender(t):null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){let i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};const n=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){n.apply(this,arguments);const t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._senders=this._senders||[],r.apply(this,[e]),e.getTracks().forEach((e=>{this._senders.push(t(this,e))}))};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._senders=this._senders||[],n.apply(this,[e]),e.getTracks().forEach((e=>{const t=this._senders.find((t=>t.track===e));t&&this._senders.splice(this._senders.indexOf(t),1)}))}}else if("object"==typeof e&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get(){return void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null),this._dtmf}})}}function Un(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,r,n]=arguments;if(arguments.length>0&&"function"==typeof e)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof e))return t.apply(this,[]);const i=function(e){const t={};return e.result().forEach((e=>{const r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((t=>{r[t]=e.stat(t)})),t[r.id]=r})),t},o=function(e){return new Map(Object.keys(e).map((t=>[t,e[t]])))};return arguments.length>=2?t.apply(this,[function(e){r(o(i(e)))},e]):new Promise(((e,r)=>{t.apply(this,[function(t){e(o(i(t)))},r])})).then(r,n)}}function Nn(e){if(!("object"==typeof e&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver))return;if(!("getStats"in e.RTCRtpSender.prototype)){const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Pn(t,e.track,!0)))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Cn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){const e=this;return this._pc.getStats().then((t=>Pn(t,e.track,!1)))}}if(!("getStats"in e.RTCRtpSender.prototype)||!("getStats"in e.RTCRtpReceiver.prototype))return;const t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){const e=arguments[0];let t,r,n;return this.getSenders().forEach((r=>{r.track===e&&(t?n=!0:t=r)})),this.getReceivers().forEach((t=>(t.track===e&&(r?n=!0:r=t),t.track===e))),n||t&&r?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):t?t.getStats():r?r.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return t.apply(this,arguments)}}function jn(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((e=>this._shimmedLocalStreams[e][0]))};const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};const r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")}));const t=this.getSenders();r.apply(this,arguments);const n=this.getSenders().filter((e=>-1===t.indexOf(e)));this._shimmedLocalStreams[e.id]=[e].concat(n)};const n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};const i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((t=>{const r=this._shimmedLocalStreams[t].indexOf(e);-1!==r&&this._shimmedLocalStreams[t].splice(r,1),1===this._shimmedLocalStreams[t].length&&delete this._shimmedLocalStreams[t]})),i.apply(this,arguments)}}function Vn(e,t){if(!e.RTCPeerConnection)return;if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return jn(e);const r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){const e=r.apply(this);return this._reverseStreams=this._reverseStreams||{},e.map((e=>this._reverseStreams[e.id]))};const n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((e=>{if(this.getSenders().find((t=>t.track===e)))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){const r=new e.MediaStream(t.getTracks());this._streams[t.id]=r,this._reverseStreams[r.id]=t,t=r}n.apply(this,[t])};const i=e.RTCPeerConnection.prototype.removeStream;function o(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t];r=r.replace(new RegExp(e._streams[n.id].id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const n=[].slice.call(arguments,1);if(1!==n.length||!n[0].getTracks().find((e=>e===t)))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");const i=this.getSenders().find((e=>e.track===t));if(i)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const o=this._streams[r.id];if(o)o.addTrack(t),Promise.resolve().then((()=>{this.dispatchEvent(new Event("negotiationneeded"))}));else{const n=new e.MediaStream([t]);this._streams[r.id]=n,this._reverseStreams[n.id]=r,this.addStream(n)}return this.getSenders().find((e=>e.track===t))},["createOffer","createAnswer"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){const e=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[t=>{const r=o(this,t);e[0].apply(null,[r])},t=>{e[1]&&e[1].apply(null,t)},arguments[2]]):r.apply(this,arguments).then((e=>o(this,e)))}}[t]}));const a=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(e,t){let r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((t=>{const n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}(this,arguments[0]),a.apply(this,arguments)):a.apply(this,arguments)};const s=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get(){const e=s.get.apply(this);return""===e.type?e:o(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let t;this._streams=this._streams||{},Object.keys(this._streams).forEach((r=>{this._streams[r].getTracks().find((t=>e.track===t))&&(t=this._streams[r])})),t&&(1===t.getTracks().length?this.removeStream(this._reverseStreams[t.id]):t.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function Fn(e,t){!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection&&t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}[t]}))}function Wn(e,t){Cn(e,"negotiationneeded",(e=>{const r=e.target;if(!(t.version<72||r.getConfiguration&&"plan-b"===r.getConfiguration().sdpSemantics)||"stable"===r.signalingState)return e}))}var Bn=Object.freeze({__proto__:null,shimMediaStream:Ln,shimOnTrack:Mn,shimGetSendersWithDtmf:Dn,shimGetStats:Un,shimSenderReceiverGetStats:Nn,shimAddTrackRemoveTrackWithNative:jn,shimAddTrackRemoveTrack:Vn,shimPeerConnection:Fn,fixNegotiationNeeded:Wn,shimGetUserMedia:xn,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((t=>{const n=r.video&&r.video.width,i=r.video&&r.video.height;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:r.video&&r.video.frameRate||3}},n&&(r.video.mandatory.maxWidth=n),i&&(r.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}});function Gn(e,t){const r=e&&e.navigator,n=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){kn("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){const e=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},t=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(r){return"object"==typeof r&&"object"==typeof r.audio&&(r=JSON.parse(JSON.stringify(r)),e(r.audio,"autoGainControl","mozAutoGainControl"),e(r.audio,"noiseSuppression","mozNoiseSuppression")),t(r)},n&&n.prototype.getSettings){const t=n.prototype.getSettings;n.prototype.getSettings=function(){const r=t.apply(this,arguments);return e(r,"mozAutoGainControl","autoGainControl"),e(r,"mozNoiseSuppression","noiseSuppression"),r}}if(n&&n.prototype.applyConstraints){const t=n.prototype.applyConstraints;n.prototype.applyConstraints=function(r){return"audio"===this.kind&&"object"==typeof r&&(r=JSON.parse(JSON.stringify(r)),e(r,"autoGainControl","mozAutoGainControl"),e(r,"noiseSuppression","mozNoiseSuppression")),t.apply(this,[r])}}}}function Hn(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function zn(e,t){if("object"!=typeof e||!e.RTCPeerConnection&&!e.mozRTCPeerConnection)return;!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){const r=e.RTCPeerConnection.prototype[t];e.RTCPeerConnection.prototype[t]={[t](){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}}[t]}));const r={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){const[e,i,o]=arguments;return n.apply(this,[e||null]).then((e=>{if(t.version<53&&!i)try{e.forEach((e=>{e.type=r[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach(((t,n)=>{e.set(n,Object.assign({},t,{type:r[t.type]||t.type}))}))}return e})).then(i,o)}}function Kn(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpSender.prototype)return;const t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e});const r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){const e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function Jn(e){if("object"!=typeof e||!e.RTCPeerConnection||!e.RTCRtpSender)return;if(e.RTCRtpSender&&"getStats"in e.RTCRtpReceiver.prototype)return;const t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){const e=t.apply(this,[]);return e.forEach((e=>e._pc=this)),e}),Cn(e,"track",(e=>(e.receiver._pc=e.srcElement,e))),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function qn(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){kn("removeStream","removeTrack"),this.getSenders().forEach((t=>{t.track&&e.getTracks().includes(t.track)&&this.removeTrack(t)}))})}function Yn(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)}function $n(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];const e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((e=>{if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));const n=t.apply(this,arguments);if(r){const{sender:t}=n,r=t.getParameters();(!("encodings"in r)||1===r.encodings.length&&0===Object.keys(r.encodings[0]).length)&&(r.encodings=e.sendEncodings,t.sendEncodings=e.sendEncodings,this.setParametersPromises.push(t.setParameters(r).then((()=>{delete t.sendEncodings})).catch((()=>{delete t.sendEncodings}))))}return n})}function Xn(e){if("object"!=typeof e||!e.RTCRtpSender)return;const t=e.RTCRtpSender.prototype.getParameters;t&&(e.RTCRtpSender.prototype.getParameters=function(){const e=t.apply(this,arguments);return"encodings"in e||(e.encodings=[].concat(this.sendEncodings||[{}])),e})}function Qn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}function Zn(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((()=>t.apply(this,arguments))).finally((()=>{this.setParametersPromises=[]})):t.apply(this,arguments)}}var ei=Object.freeze({__proto__:null,shimOnTrack:Hn,shimPeerConnection:zn,shimSenderGetStats:Kn,shimReceiverGetStats:Jn,shimRemoveStream:qn,shimRTCDataChannel:Yn,shimAddTransceiver:$n,shimGetParameters:Xn,shimCreateOffer:Qn,shimCreateAnswer:Zn,shimGetUserMedia:Gn,shimGetDisplayMedia:function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){const e=new DOMException("getDisplayMedia without video constraints is undefined");return e.name="NotFoundError",e.code=8,Promise.reject(e)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}});function ti(e){if("object"==typeof e&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){const t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((r=>t.call(this,r,e))),e.getVideoTracks().forEach((r=>t.call(this,r,e)))},e.RTCPeerConnection.prototype.addTrack=function(e,...r){return r&&r.forEach((e=>{this._localStreams?this._localStreams.includes(e)||this._localStreams.push(e):this._localStreams=[e]})),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);const t=this._localStreams.indexOf(e);if(-1===t)return;this._localStreams.splice(t,1);const r=e.getTracks();this.getSenders().forEach((e=>{r.includes(e.track)&&this.removeTrack(e)}))})}}function ri(e){if("object"==typeof e&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(e){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=e=>{e.streams.forEach((e=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(e))return;this._remoteStreams.push(e);const t=new Event("addstream");t.stream=e,this.dispatchEvent(t)}))})}});const t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){const e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((t=>{if(e._remoteStreams||(e._remoteStreams=[]),e._remoteStreams.indexOf(t)>=0)return;e._remoteStreams.push(t);const r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}))}),t.apply(e,arguments)}}}function ni(e){if("object"!=typeof e||!e.RTCPeerConnection)return;const t=e.RTCPeerConnection.prototype,r=t.createOffer,n=t.createAnswer,i=t.setLocalDescription,o=t.setRemoteDescription,a=t.addIceCandidate;t.createOffer=function(e,t){const n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){const r=arguments.length>=2?arguments[2]:arguments[0],i=n.apply(this,[r]);return t?(i.then(e,t),Promise.resolve()):i};let s=function(e,t,r){const n=i.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=s,s=function(e,t,r){const n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=s,s=function(e,t,r){const n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=s}function ii(e){const t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){const e=t.mediaDevices,r=e.getUserMedia.bind(e);t.mediaDevices.getUserMedia=e=>r(oi(e))}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))}function oi(e){return e&&void 0!==e.video?Object.assign({},e,{video:In(e.video)}):e}function ai(e){if(!e.RTCPeerConnection)return;const t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){const t=[];for(let r=0;r<e.iceServers.length;r++){let n=e.iceServers[r];!n.hasOwnProperty("urls")&&n.hasOwnProperty("url")?(kn("RTCIceServer.url","RTCIceServer.urls"),n=JSON.parse(JSON.stringify(n)),n.urls=n.url,delete n.url,t.push(n)):t.push(e.iceServers[r])}e.iceServers=t}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in t&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:()=>t.generateCertificate})}function si(e){"object"==typeof e&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function ci(e){const t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);const t=this.getTransceivers().find((e=>"audio"===e.receiver.track.kind));!1===e.offerToReceiveAudio&&t?"sendrecv"===t.direction?t.setDirection?t.setDirection("sendonly"):t.direction="sendonly":"recvonly"===t.direction&&(t.setDirection?t.setDirection("inactive"):t.direction="inactive"):!0!==e.offerToReceiveAudio||t||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);const r=this.getTransceivers().find((e=>"video"===e.receiver.track.kind));!1===e.offerToReceiveVideo&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveVideo||r||this.addTransceiver("video")}return t.apply(this,arguments)}}function ui(e){"object"!=typeof e||e.AudioContext||(e.AudioContext=e.webkitAudioContext)}var di=Object.freeze({__proto__:null,shimLocalStreamsAPI:ti,shimRemoteStreamsAPI:ri,shimCallbacksAPI:ni,shimGetUserMedia:ii,shimConstraints:oi,shimRTCIceServerUrls:ai,shimTrackEventTransceiver:si,shimCreateOfferLegacy:ci,shimAudioContext:ui}),li=fe((function(e){const t={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};t.localCName=t.generateIdentifier(),t.splitLines=function(e){return e.trim().split("\n").map((e=>e.trim()))},t.splitSections=function(e){return e.split("\nm=").map(((e,t)=>(t>0?"m="+e:e).trim()+"\r\n"))},t.getDescription=function(e){const r=t.splitSections(e);return r&&r[0]},t.getMediaSections=function(e){const r=t.splitSections(e);return r.shift(),r},t.matchPrefix=function(e,r){return t.splitLines(e).filter((e=>0===e.indexOf(r)))},t.parseCandidate=function(e){let t;t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" ");const r={foundation:t[0],component:{1:"rtp",2:"rtcp"}[t[1]]||t[1],protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]};for(let n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:void 0===r[t[n]]&&(r[t[n]]=t[n+1])}return r},t.writeCandidate=function(e){const t=[];t.push(e.foundation);const r=e.component;t.push("rtp"===r?1:"rtcp"===r?2:r),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);const n=e.type;return t.push("typ"),t.push(n),"host"!==n&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},t.parseIceOptions=function(e){return e.substr(14).split(" ")},t.parseRtpMap=function(e){let t=e.substr(9).split(" ");const r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},t.writeRtpMap=function(e){let t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);const r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},t.parseExtmap=function(e){const t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},t.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},t.parseFmtp=function(e){const t={};let r;const n=e.substr(e.indexOf(" ")+1).split(";");for(let i=0;i<n.length;i++)r=n[i].trim().split("="),t[r[0].trim()]=r[1];return t},t.writeFmtp=function(e){let t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){const n=[];Object.keys(e.parameters).forEach((t=>{n.push(void 0!==e.parameters[t]?t+"="+e.parameters[t]:t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},t.parseRtcpFb=function(e){const t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},t.writeRtcpFb=function(e){let t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((e=>{t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},t.parseSsrcMedia=function(e){const t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},t.parseSsrcGroup=function(e){const t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((e=>parseInt(e,10)))}},t.getMid=function(e){const r=t.matchPrefix(e,"a=mid:")[0];if(r)return r.substr(6)},t.parseFingerprint=function(e){const t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1].toUpperCase()}},t.getDtlsParameters=function(e,r){return{role:"auto",fingerprints:t.matchPrefix(e+r,"a=fingerprint:").map(t.parseFingerprint)}},t.writeDtlsParameters=function(e,t){let r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((e=>{r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},t.parseCryptoLine=function(e){const t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},t.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==typeof e.keyParams?t.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},t.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;const t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},t.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},t.getCryptoParameters=function(e,r){return t.matchPrefix(e+r,"a=crypto:").map(t.parseCryptoLine)},t.getIceParameters=function(e,r){const n=t.matchPrefix(e+r,"a=ice-ufrag:")[0],i=t.matchPrefix(e+r,"a=ice-pwd:")[0];return n&&i?{usernameFragment:n.substr(12),password:i.substr(10)}:null},t.writeIceParameters=function(e){let t="a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n";return e.iceLite&&(t+="a=ice-lite\r\n"),t},t.parseRtpParameters=function(e){const r={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},n=t.splitLines(e)[0].split(" ");for(let i=3;i<n.length;i++){const o=n[i],a=t.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){const n=t.parseRtpMap(a),i=t.matchPrefix(e,"a=fmtp:"+o+" ");switch(n.parameters=i.length?t.parseFmtp(i[0]):{},n.rtcpFeedback=t.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(t.parseRtcpFb),r.codecs.push(n),n.name.toUpperCase()){case"RED":case"ULPFEC":r.fecMechanisms.push(n.name.toUpperCase())}}}return t.matchPrefix(e,"a=extmap:").forEach((e=>{r.headerExtensions.push(t.parseExtmap(e))})),r},t.writeRtpDescription=function(e,r){let n="";n+="m="+e+" ",n+=r.codecs.length>0?"9":"0",n+=" UDP/TLS/RTP/SAVPF ",n+=r.codecs.map((e=>void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType)).join(" ")+"\r\n",n+="c=IN IP4 0.0.0.0\r\n",n+="a=rtcp:9 IN IP4 0.0.0.0\r\n",r.codecs.forEach((e=>{n+=t.writeRtpMap(e),n+=t.writeFmtp(e),n+=t.writeRtcpFb(e)}));let i=0;return r.codecs.forEach((e=>{e.maxptime>i&&(i=e.maxptime)})),i>0&&(n+="a=maxptime:"+i+"\r\n"),r.headerExtensions&&r.headerExtensions.forEach((e=>{n+=t.writeExtmap(e)})),n},t.parseRtpEncodingParameters=function(e){const r=[],n=t.parseRtpParameters(e),i=-1!==n.fecMechanisms.indexOf("RED"),o=-1!==n.fecMechanisms.indexOf("ULPFEC"),a=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute)),s=a.length>0&&a[0].ssrc;let c;const u=t.matchPrefix(e,"a=ssrc-group:FID").map((e=>e.substr(17).split(" ").map((e=>parseInt(e,10)))));u.length>0&&u[0].length>1&&u[0][0]===s&&(c=u[0][1]),n.codecs.forEach((e=>{if("RTX"===e.name.toUpperCase()&&e.parameters.apt){let t={ssrc:s,codecPayloadType:parseInt(e.parameters.apt,10)};s&&c&&(t.rtx={ssrc:c}),r.push(t),i&&(t=JSON.parse(JSON.stringify(t)),t.fec={ssrc:s,mechanism:o?"red+ulpfec":"red"},r.push(t))}})),0===r.length&&s&&r.push({ssrc:s});let d=t.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((e=>{e.maxBitrate=d}))),r},t.parseRtcpParameters=function(e){const r={},n=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"cname"===e.attribute))[0];n&&(r.cname=n.value,r.ssrc=n.ssrc);const i=t.matchPrefix(e,"a=rtcp-rsize");r.reducedSize=i.length>0,r.compound=0===i.length;const o=t.matchPrefix(e,"a=rtcp-mux");return r.mux=o.length>0,r},t.writeRtcpParameters=function(e){let t="";return e.reducedSize&&(t+="a=rtcp-rsize\r\n"),e.mux&&(t+="a=rtcp-mux\r\n"),void 0!==e.ssrc&&e.cname&&(t+="a=ssrc:"+e.ssrc+" cname:"+e.cname+"\r\n"),t},t.parseMsid=function(e){let r;const n=t.matchPrefix(e,"a=msid:");if(1===n.length)return r=n[0].substr(7).split(" "),{stream:r[0],track:r[1]};const i=t.matchPrefix(e,"a=ssrc:").map((e=>t.parseSsrcMedia(e))).filter((e=>"msid"===e.attribute));return i.length>0?(r=i[0].value.split(" "),{stream:r[0],track:r[1]}):void 0},t.parseSctpDescription=function(e){const r=t.parseMLine(e),n=t.matchPrefix(e,"a=max-message-size:");let i;n.length>0&&(i=parseInt(n[0].substr(19),10)),isNaN(i)&&(i=65536);const o=t.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:i};const a=t.matchPrefix(e,"a=sctpmap:");if(a.length>0){const e=a[0].substr(10).split(" ");return{port:parseInt(e[0],10),protocol:e[1],maxMessageSize:i}}},t.writeSctpDescription=function(e,t){let r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},t.generateSessionId=function(){return Math.random().toString().substr(2,21)},t.writeSessionBoilerplate=function(e,r,n){let i;const o=void 0!==r?r:2;return i=e||t.generateSessionId(),"v=0\r\no="+(n||"thisisadapterortc")+" "+i+" "+o+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},t.getDirection=function(e,r){const n=t.splitLines(e);for(let t=0;t<n.length;t++)switch(n[t]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return n[t].substr(2)}return r?t.getDirection(r):"sendrecv"},t.getKind=function(e){return t.splitLines(e)[0].split(" ")[0].substr(2)},t.isRejected=function(e){return"0"===e.split(" ",2)[1]},t.parseMLine=function(e){const r=t.splitLines(e)[0].substr(2).split(" ");return{kind:r[0],port:parseInt(r[1],10),protocol:r[2],fmt:r.slice(3).join(" ")}},t.parseOLine=function(e){const r=t.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:r[0],sessionId:r[1],sessionVersion:parseInt(r[2],10),netType:r[3],addressType:r[4],address:r[5]}},t.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;const r=t.splitLines(e);for(let t=0;t<r.length;t++)if(r[t].length<2||"="!==r[t].charAt(1))return!1;return!0},e.exports=t})),hi=Object.freeze(Object.assign(Object.create(null),li,{default:li}));function pi(e){if(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)return;const t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"==typeof e&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){const r=new t(e),n=li.parseCandidate(e.candidate),i=Object.assign(r,n);return i.toJSON=function(){return{candidate:i.candidate,sdpMid:i.sdpMid,sdpMLineIndex:i.sdpMLineIndex,usernameFragment:i.usernameFragment}},i}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,Cn(e,"icecandidate",(t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t)))}function fi(e,t){if(!e.RTCPeerConnection)return;"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get(){return void 0===this._sctp?null:this._sctp}});const r=function(e){let r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},n=function(e,r){let n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);const i=li.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?n=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},i=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76){const{sdpSemantics:e}=this.getConfiguration();"plan-b"===e&&Object.defineProperty(this,"sctp",{get(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0})}if(function(e){if(!e||!e.sdp)return!1;const t=li.splitSections(e.sdp);return t.shift(),t.some((e=>{const t=li.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))}(arguments[0])){const e=function(e){const t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;const r=parseInt(t[1],10);return r!=r?-1:r}(arguments[0]),t=r(e),i=n(arguments[0],e);let o;o=0===t&&0===i?Number.POSITIVE_INFINITY:0===t||0===i?Math.max(t,i):Math.min(t,i);const a={};Object.defineProperty(a,"maxMessageSize",{get:()=>o}),this._sctp=a}return i.apply(this,arguments)}}function mi(e){if(!e.RTCPeerConnection||!("createDataChannel"in e.RTCPeerConnection.prototype))return;function t(e,t){const r=e.send;e.send=function(){const n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}const r=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){const e=r.apply(this,arguments);return t(e,this),e},Cn(e,"datachannel",(e=>(t(e.channel,e.target),e)))}function vi(e){if(!e.RTCPeerConnection||"connectionState"in e.RTCPeerConnection.prototype)return;const t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((e=>{const r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=e=>{const t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;const r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}function gi(e,t){if(!e.RTCPeerConnection)return;if("chrome"===t.browser&&t.version>=71)return;if("safari"===t.browser&&t.version>=605)return;const r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(t){if(t&&t.sdp&&-1!==t.sdp.indexOf("\na=extmap-allow-mixed")){const r=t.sdp.split("\n").filter((e=>"a=extmap-allow-mixed"!==e.trim())).join("\n");e.RTCSessionDescription&&t instanceof e.RTCSessionDescription?arguments[0]=new e.RTCSessionDescription({type:t.type,sdp:r}):t.sdp=r}return r.apply(this,arguments)}}function yi(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.addIceCandidate;r&&0!==r.length&&(e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?("chrome"===t.browser&&t.version<78||"firefox"===t.browser&&t.version<68||"safari"===t.browser)&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function bi(e,t){if(!e.RTCPeerConnection||!e.RTCPeerConnection.prototype)return;const r=e.RTCPeerConnection.prototype.setLocalDescription;r&&0!==r.length&&(e.RTCPeerConnection.prototype.setLocalDescription=function(){let e=arguments[0]||{};if("object"!=typeof e||e.type&&e.sdp)return r.apply(this,arguments);if(e={type:e.type,sdp:e.sdp},!e.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":e.type="offer";break;default:e.type="answer"}return e.sdp||"offer"!==e.type&&"answer"!==e.type?r.apply(this,[e]):("offer"===e.type?this.createOffer:this.createAnswer).apply(this).then((e=>r.apply(this,[e])))})}var Si=Object.freeze({__proto__:null,shimRTCIceCandidate:pi,shimMaxMessageSize:fi,shimSendThrowTypeError:mi,shimConnectionState:vi,removeExtmapAllowMixed:gi,shimAddIceCandidateNullOrEmpty:yi,shimParameterlessSetLocalDescription:bi});const Ei=function({window:e}={},t={shimChrome:!0,shimFirefox:!0,shimSafari:!0}){const r=_n,n=function(e){const t={browser:null,version:null};if(void 0===e||!e.navigator)return t.browser="Not a browser.",t;const{navigator:r}=e;if(r.mozGetUserMedia)t.browser="firefox",t.version=En(r.userAgent,/Firefox\/(\d+)\./,1);else if(r.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)t.browser="chrome",t.version=En(r.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!e.RTCPeerConnection||!r.userAgent.match(/AppleWebKit\/(\d+)\./))return t.browser="Not a supported browser.",t;t.browser="safari",t.version=En(r.userAgent,/AppleWebKit\/(\d+)\./,1),t.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return t}(e),i={browserDetails:n,commonShim:Si,extractVersion:En,disableLog:Tn,disableWarnings:wn,sdp:hi};switch(n.browser){case"chrome":if(!Bn||!Fn||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),i;if(null===n.version)return r("Chrome shim can not determine version, not shimming."),i;r("adapter.js shimming chrome."),i.browserShim=Bn,yi(e,n),bi(e),xn(e,n),Ln(e),Fn(e,n),Mn(e),Vn(e,n),Dn(e),Un(e),Nn(e),Wn(e,n),pi(e),vi(e),fi(e,n),mi(e),gi(e,n);break;case"firefox":if(!ei||!zn||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),i;r("adapter.js shimming firefox."),i.browserShim=ei,yi(e,n),bi(e),Gn(e,n),zn(e,n),Hn(e),qn(e),Kn(e),Jn(e),Yn(e),$n(e),Xn(e),Qn(e),Zn(e),pi(e),vi(e),fi(e,n),mi(e);break;case"safari":if(!di||!t.shimSafari)return r("Safari shim is not included in this adapter release."),i;r("adapter.js shimming safari."),i.browserShim=di,yi(e,n),bi(e),ai(e),ci(e),ni(e),ti(e),ri(e),si(e),ii(e),ui(e),pi(e),fi(e,n),mi(e),gi(e,n);break;default:r("Unsupported browser!")}return i}({window:"undefined"==typeof window?void 0:window});var Ci;(Ci=(Ci=window)||self).RTCBeautyPlugin=function(e){function t(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function r(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}e=e&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e;var o="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof n.g?n.g:"undefined"!=typeof self?self:{};function a(e,t){return e(t={exports:{}},t.exports),t.exports}var s,c,u=function(e){return e&&e.Math==Math&&e},d=u("object"==("undefined"==typeof globalThis?"undefined":Oe(globalThis))&&globalThis)||u("object"==("undefined"==typeof window?"undefined":Oe(window))&&window)||u("object"==("undefined"==typeof self?"undefined":Oe(self))&&self)||u("object"==Oe(o)&&o)||function(){return this}()||Function("return this")(),l=function(e){try{return!!e()}catch(e){return!0}},h=!l((function(){return 7!=Object.defineProperty({},1,{get:function(){return 7}})[1]})),p={}.propertyIsEnumerable,f=Object.getOwnPropertyDescriptor,m={f:f&&!p.call({1:2},1)?function(e){var t=f(this,e);return!!t&&t.enumerable}:p},v=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}},g={}.toString,y=function(e){return g.call(e).slice(8,-1)},b="".split,S=l((function(){return!Object("z").propertyIsEnumerable(0)}))?function(e){return"String"==y(e)?b.call(e,""):Object(e)}:Object,E=function(e){if(null==e)throw TypeError("Can't call method on "+e);return e},C=function(e){return S(E(e))},T=function(e){return"object"==Oe(e)?null!==e:"function"==typeof e},w=function(e,t){return arguments.length<2?function(e){return"function"==typeof e?e:void 0}(d[e]):d[e]&&d[e][t]},_=w("navigator","userAgent")||"",k=d.process,R=d.Deno,I=k&&k.versions||R&&R.version,O=I&&I.v8;O?c=(s=O.split("."))[0]<4?1:s[0]+s[1]:_&&(!(s=_.match(/Edge\/(\d+)/))||s[1]>=74)&&(s=_.match(/Chrome\/(\d+)/))&&(c=s[1]);var P=c&&+c,A=!!Object.getOwnPropertySymbols&&!l((function(){var e=Symbol();return!String(e)||!(Object(e)instanceof Symbol)||!Symbol.sham&&P&&P<41})),x=A&&!Symbol.sham&&"symbol"==Oe(Symbol.iterator),L=x?function(e){return"symbol"==Oe(e)}:function(e){var t=w("Symbol");return"function"==typeof t&&Object(e)instanceof t},M=function(e,t){try{Object.defineProperty(d,e,{value:t,configurable:!0,writable:!0})}catch(r){d[e]=t}return t},D=d["__core-js_shared__"]||M("__core-js_shared__",{}),U=a((function(e){(e.exports=function(e,t){return D[e]||(D[e]=void 0!==t?t:{})})("versions",[]).push({version:"3.16.0",mode:"global",copyright:"© 2021 Denis Pushkarev (zloirock.ru)"})})),N=function(e){return Object(E(e))},j={}.hasOwnProperty,V=Object.hasOwn||function(e,t){return j.call(N(e),t)},F=0,W=Math.random(),B=function(e){return"Symbol("+String(void 0===e?"":e)+")_"+(++F+W).toString(36)},G=U("wks"),H=d.Symbol,z=x?H:H&&H.withoutSetter||B,K=function(e){return V(G,e)&&(A||"string"==typeof G[e])||(G[e]=A&&V(H,e)?H[e]:z("Symbol."+e)),G[e]},J=K("toPrimitive"),q=function(e){var t=function(e,t){if(!T(e)||L(e))return e;var r,n=e[J];if(void 0!==n){if(void 0===t&&(t="default"),r=n.call(e,t),!T(r)||L(r))return r;throw TypeError("Can't convert object to primitive value")}return void 0===t&&(t="number"),function(e,t){var r,n;if("string"===t&&"function"==typeof(r=e.toString)&&!T(n=r.call(e)))return n;if("function"==typeof(r=e.valueOf)&&!T(n=r.call(e)))return n;if("string"!==t&&"function"==typeof(r=e.toString)&&!T(n=r.call(e)))return n;throw TypeError("Can't convert object to primitive value")}(e,t)}(e,"string");return L(t)?t:String(t)},Y=d.document,$=T(Y)&&T(Y.createElement),X=function(e){return $?Y.createElement(e):{}},Q=!h&&!l((function(){return 7!=Object.defineProperty(X("div"),"a",{get:function(){return 7}}).a})),Z=Object.getOwnPropertyDescriptor,ee={f:h?Z:function(e,t){if(e=C(e),t=q(t),Q)try{return Z(e,t)}catch(e){}if(V(e,t))return v(!m.f.call(e,t),e[t])}},te=function(e){if(!T(e))throw TypeError(String(e)+" is not an object");return e},re=Object.defineProperty,ne={f:h?re:function(e,t,r){if(te(e),t=q(t),te(r),Q)try{return re(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported");return"value"in r&&(e[t]=r.value),e}},ie=h?function(e,t,r){return ne.f(e,t,v(1,r))}:function(e,t,r){return e[t]=r,e},oe=Function.toString;"function"!=typeof D.inspectSource&&(D.inspectSource=function(e){return oe.call(e)});var ae,se,ce,ue=D.inspectSource,de=d.WeakMap,le="function"==typeof de&&/native code/.test(ue(de)),he=U("keys"),pe=function(e){return he[e]||(he[e]=B(e))},fe={},me=d.WeakMap;if(le||D.state){var ve=D.state||(D.state=new me),ge=ve.get,ye=ve.has,be=ve.set;ae=function(e,t){if(ye.call(ve,e))throw new TypeError("Object already initialized");return t.facade=e,be.call(ve,e,t),t},se=function(e){return ge.call(ve,e)||{}},ce=function(e){return ye.call(ve,e)}}else{var Se=pe("state");fe[Se]=!0,ae=function(e,t){if(V(e,Se))throw new TypeError("Object already initialized");return t.facade=e,ie(e,Se,t),t},se=function(e){return V(e,Se)?e[Se]:{}},ce=function(e){return V(e,Se)}}var Ee={set:ae,get:se,has:ce,enforce:function(e){return ce(e)?se(e):ae(e,{})},getterFor:function(e){return function(t){var r;if(!T(t)||(r=se(t)).type!==e)throw TypeError("Incompatible receiver, "+e+" required");return r}}},Ce=a((function(e){var t=Ee.get,r=Ee.enforce,n=String(String).split("String");(e.exports=function(e,t,i,o){var a,s=!!o&&!!o.unsafe,c=!!o&&!!o.enumerable,u=!!o&&!!o.noTargetGet;"function"==typeof i&&("string"!=typeof t||V(i,"name")||ie(i,"name",t),(a=r(i)).source||(a.source=n.join("string"==typeof t?t:""))),e!==d?(s?!u&&e[t]&&(c=!0):delete e[t],c?e[t]=i:ie(e,t,i)):c?e[t]=i:M(t,i)})(Function.prototype,"toString",(function(){return"function"==typeof this&&t(this).source||ue(this)}))})),Te=Math.ceil,we=Math.floor,_e=function(e){return isNaN(e=+e)?0:(e>0?we:Te)(e)},ke=Math.min,Re=function(e){return e>0?ke(_e(e),9007199254740991):0},Ie=Math.max,Pe=Math.min,Ae=function(e,t){var r=_e(e);return r<0?Ie(r+t,0):Pe(r,t)},xe=function(e){return function(t,r,n){var i,o=C(t),a=Re(o.length),s=Ae(n,a);if(e&&r!=r){for(;a>s;)if((i=o[s++])!=i)return!0}else for(;a>s;s++)if((e||s in o)&&o[s]===r)return e||s||0;return!e&&-1}},Le={includes:xe(!0),indexOf:xe(!1)},Me=Le.indexOf,De=function(e,t){var r,n=C(e),i=0,o=[];for(r in n)!V(fe,r)&&V(n,r)&&o.push(r);for(;t.length>i;)V(n,r=t[i++])&&(~Me(o,r)||o.push(r));return o},Ue=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Ne=Ue.concat("length","prototype"),je={f:Object.getOwnPropertyNames||function(e){return De(e,Ne)}},Ve={f:Object.getOwnPropertySymbols},Fe=w("Reflect","ownKeys")||function(e){var t=je.f(te(e)),r=Ve.f;return r?t.concat(r(e)):t},We=function(e,t){for(var r=Fe(t),n=ne.f,i=ee.f,o=0;o<r.length;o++){var a=r[o];V(e,a)||n(e,a,i(t,a))}},Be=/#|\.prototype\./,Ge=function(e,t){var r=ze[He(e)];return r==Je||r!=Ke&&("function"==typeof t?l(t):!!t)},He=Ge.normalize=function(e){return String(e).replace(Be,".").toLowerCase()},ze=Ge.data={},Ke=Ge.NATIVE="N",Je=Ge.POLYFILL="P",qe=Ge,Ye=ee.f,$e=function(e,t){var r,n,i,o,a,s=e.target,c=e.global,u=e.stat;if(r=c?d:u?d[s]||M(s,{}):(d[s]||{}).prototype)for(n in t){if(o=t[n],i=e.noTargetGet?(a=Ye(r,n))&&a.value:r[n],!qe(c?n:s+(u?".":"#")+n,e.forced)&&void 0!==i){if(Oe(o)==Oe(i))continue;We(o,i)}(e.sham||i&&i.sham)&&ie(o,"sham",!0),Ce(r,n,o,e)}},Xe=function(e){if("function"!=typeof e)throw TypeError(String(e)+" is not a function");return e},Qe=function(e,t,r){if(Xe(e),void 0===t)return e;switch(r){case 0:return function(){return e.call(t)};case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,i){return e.call(t,r,n,i)}}return function(){return e.apply(t,arguments)}},Ze=Array.isArray||function(e){return"Array"==y(e)},et=K("species"),tt=function(e,t){return new(function(e){var t;return Ze(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!Ze(t.prototype)?T(t)&&null===(t=t[et])&&(t=void 0):t=void 0),void 0===t?Array:t}(e))(0===t?0:t)},rt=[].push,nt=function(e){var t=1==e,r=2==e,n=3==e,i=4==e,o=6==e,a=7==e,s=5==e||o;return function(c,u,d,l){for(var h,p,f=N(c),m=S(f),v=Qe(u,d,3),g=Re(m.length),y=0,b=l||tt,E=t?b(c,g):r||a?b(c,0):void 0;g>y;y++)if((s||y in m)&&(p=v(h=m[y],y,f),e))if(t)E[y]=p;else if(p)switch(e){case 3:return!0;case 5:return h;case 6:return y;case 2:rt.call(E,h)}else switch(e){case 4:return!1;case 7:rt.call(E,h)}return o?-1:n||i?i:E}},it={forEach:nt(0),map:nt(1),filter:nt(2),some:nt(3),every:nt(4),find:nt(5),findIndex:nt(6),filterReject:nt(7)},ot=K("species"),at=it.filter,st=P>=51||!l((function(){var e=[];return(e.constructor={})[ot]=function(){return{foo:1}},1!==e.filter(Boolean).foo}));$e({target:"Array",proto:!0,forced:!st},{filter:function(e){return at(this,e,arguments.length>1?arguments[1]:void 0)}});var ct=Date.prototype,ut=ct.toString,dt=ct.getTime;"Invalid Date"!=String(new Date(NaN))&&Ce(ct,"toString",(function(){var e=dt.call(this);return e==e?ut.call(this):"Invalid Date"}));var lt=[].slice,ht={};$e({target:"Function",proto:!0},{bind:Function.bind||function(e){var t=Xe(this),r=lt.call(arguments,1),n=function n(){var i=r.concat(lt.call(arguments));return this instanceof n?function(e,t,r){if(!(t in ht)){for(var n=[],i=0;i<t;i++)n[i]="a["+i+"]";ht[t]=Function("C,a","return new C("+n.join(",")+")")}return ht[t](e,r)}(t,i.length,i):t.apply(e,i)};return T(t.prototype)&&(n.prototype=t.prototype),n}});var pt=[].slice,ft=/MSIE .\./.test(_),mt=function(e){return function(t,r){var n=arguments.length>2,i=n?pt.call(arguments,2):void 0;return e(n?function(){("function"==typeof t?t:Function(t)).apply(this,i)}:t,r)}};$e({global:!0,bind:!0,forced:ft},{setTimeout:mt(d.setTimeout),setInterval:mt(d.setInterval)});var vt,gt=Object.keys||function(e){return De(e,Ue)},yt=h?Object.defineProperties:function(e,t){te(e);for(var r,n=gt(t),i=n.length,o=0;i>o;)ne.f(e,r=n[o++],t[r]);return e},bt=w("document","documentElement"),St=pe("IE_PROTO"),Et=function(){},Ct=function(e){return"<script>"+e+"<\/script>"},Tt=function(e){e.write(Ct("")),e.close();var t=e.parentWindow.Object;return e=null,t},wt=function(){try{vt=new ActiveXObject("htmlfile")}catch(e){}wt=document.domain&&vt?Tt(vt):function(){var e,t=X("iframe");if(t.style)return t.style.display="none",bt.appendChild(t),t.src=String("javascript:"),(e=t.contentWindow.document).open(),e.write(Ct("document.F=Object")),e.close(),e.F}()||Tt(vt);for(var e=Ue.length;e--;)delete wt.prototype[Ue[e]];return wt()};fe[St]=!0;var _t=Object.create||function(e,t){var r;return null!==e?(Et.prototype=te(e),r=new Et,Et.prototype=null,r[St]=e):r=wt(),void 0===t?r:yt(r,t)},kt=K("unscopables"),Rt=Array.prototype;null==Rt[kt]&&ne.f(Rt,kt,{configurable:!0,value:_t(null)});var It,Ot,Pt,At=function(e){Rt[kt][e]=!0},xt={},Lt=!l((function(){function e(){}return e.prototype.constructor=null,Object.getPrototypeOf(new e)!==e.prototype})),Mt=pe("IE_PROTO"),Dt=Object.prototype,Ut=Lt?Object.getPrototypeOf:function(e){return e=N(e),V(e,Mt)?e[Mt]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?Dt:null},Nt=K("iterator"),jt=!1;[].keys&&("next"in(Pt=[].keys())?(Ot=Ut(Ut(Pt)))!==Object.prototype&&(It=Ot):jt=!0),(null==It||l((function(){var e={};return It[Nt].call(e)!==e})))&&(It={}),V(It,Nt)||ie(It,Nt,(function(){return this}));var Vt={IteratorPrototype:It,BUGGY_SAFARI_ITERATORS:jt},Ft=ne.f,Wt=K("toStringTag"),Bt=function(e,t,r){e&&!V(e=r?e:e.prototype,Wt)&&Ft(e,Wt,{configurable:!0,value:t})},Gt=Vt.IteratorPrototype,Ht=function(){return this},zt=Object.setPrototypeOf||("__proto__"in{}?function(){var e,t=!1,r={};try{(e=Object.getOwnPropertyDescriptor(Object.prototype,"__proto__").set).call(r,[]),t=r instanceof Array}catch(e){}return function(r,n){return te(r),function(e){if(!T(e)&&null!==e)throw TypeError("Can't set "+String(e)+" as a prototype")}(n),t?e.call(r,n):r.__proto__=n,r}}():void 0),Kt=Vt.IteratorPrototype,Jt=Vt.BUGGY_SAFARI_ITERATORS,qt=K("iterator"),Yt=function(){return this},$t=function(e,t,r,n,i,o,a){!function(e,t,r){var n=t+" Iterator";e.prototype=_t(Gt,{next:v(1,r)}),Bt(e,n,!1),xt[n]=Ht}(r,t,n);var s,c,u,d=function(e){if(e===i&&m)return m;if(!Jt&&e in p)return p[e];switch(e){case"keys":case"values":case"entries":return function(){return new r(this,e)}}return function(){return new r(this)}},l=t+" Iterator",h=!1,p=e.prototype,f=p[qt]||p["@@iterator"]||i&&p[i],m=!Jt&&f||d(i),g="Array"==t&&p.entries||f;if(g&&(s=Ut(g.call(new e)),Kt!==Object.prototype&&s.next&&(Ut(s)!==Kt&&(zt?zt(s,Kt):"function"!=typeof s[qt]&&ie(s,qt,Yt)),Bt(s,l,!0))),"values"==i&&f&&"values"!==f.name&&(h=!0,m=function(){return f.call(this)}),p[qt]!==m&&ie(p,qt,m),xt[t]=m,i)if(c={values:d("values"),keys:o?m:d("keys"),entries:d("entries")},a)for(u in c)(Jt||h||!(u in p))&&Ce(p,u,c[u]);else $e({target:t,proto:!0,forced:Jt||h},c);return c},Xt=Ee.set,Qt=Ee.getterFor("Array Iterator"),Zt=$t(Array,"Array",(function(e,t){Xt(this,{type:"Array Iterator",target:C(e),index:0,kind:t})}),(function(){var e=Qt(this),t=e.target,r=e.kind,n=e.index++;return!t||n>=t.length?(e.target=void 0,{value:void 0,done:!0}):"keys"==r?{value:n,done:!1}:"values"==r?{value:t[n],done:!1}:{value:[n,t[n]],done:!1}}),"values");xt.Arguments=xt.Array,At("keys"),At("values"),At("entries");var er=je.f,tr={}.toString,rr="object"==("undefined"==typeof window?"undefined":Oe(window))&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],nr={f:function(e){return rr&&"[object Window]"==tr.call(e)?function(e){try{return er(e)}catch(e){return rr.slice()}}(e):er(C(e))}},ir=!l((function(){return Object.isExtensible(Object.preventExtensions({}))})),or=a((function(e){var t=ne.f,r=!1,n=B("meta"),i=0,o=Object.isExtensible||function(){return!0},a=function(e){t(e,n,{value:{objectID:"O"+i++,weakData:{}}})},s=e.exports={enable:function(){s.enable=function(){},r=!0;var e=je.f,t=[].splice,i={};i[n]=1,e(i).length&&(je.f=function(r){for(var i=e(r),o=0,a=i.length;o<a;o++)if(i[o]===n){t.call(i,o,1);break}return i},$e({target:"Object",stat:!0,forced:!0},{getOwnPropertyNames:nr.f}))},fastKey:function(e,t){if(!T(e))return"symbol"==Oe(e)?e:("string"==typeof e?"S":"P")+e;if(!V(e,n)){if(!o(e))return"F";if(!t)return"E";a(e)}return e[n].objectID},getWeakData:function(e,t){if(!V(e,n)){if(!o(e))return!0;if(!t)return!1;a(e)}return e[n].weakData},onFreeze:function(e){return ir&&r&&o(e)&&!V(e,n)&&a(e),e}};fe[n]=!0})),ar=K("iterator"),sr=Array.prototype,cr=function(e){return void 0!==e&&(xt.Array===e||sr[ar]===e)},ur={};ur[K("toStringTag")]="z";var dr="[object z]"===String(ur),lr=K("toStringTag"),hr="Arguments"==y(function(){return arguments}()),pr=dr?y:function(e){var t,r,n;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),lr))?r:hr?y(t):"Object"==(n=y(t))&&"function"==typeof t.callee?"Arguments":n},fr=K("iterator"),mr=function(e){if(null!=e)return e[fr]||e["@@iterator"]||xt[pr(e)]},vr=function(e){var t=e.return;if(void 0!==t)return te(t.call(e)).value},gr=function(e,t){this.stopped=e,this.result=t},yr=function(e,t,r){var n,i,o,a,s,c,u,d=!(!r||!r.AS_ENTRIES),l=!(!r||!r.IS_ITERATOR),h=!(!r||!r.INTERRUPTED),p=Qe(t,r&&r.that,1+d+h),f=function(e){return n&&vr(n),new gr(!0,e)},m=function(e){return d?(te(e),h?p(e[0],e[1],f):p(e[0],e[1])):h?p(e,f):p(e)};if(l)n=e;else{if("function"!=typeof(i=mr(e)))throw TypeError("Target is not iterable");if(cr(i)){for(o=0,a=Re(e.length);a>o;o++)if((s=m(e[o]))&&s instanceof gr)return s;return new gr(!1)}n=i.call(e)}for(c=n.next;!(u=c.call(n)).done;){try{s=m(u.value)}catch(e){throw vr(n),e}if("object"==Oe(s)&&s&&s instanceof gr)return s}return new gr(!1)},br=function(e,t,r){if(!(e instanceof t))throw TypeError("Incorrect "+(r?r+" ":"")+"invocation");return e},Sr=K("iterator"),Er=!1;try{var Cr=0,Tr={next:function(){return{done:!!Cr++}},return:function(){Er=!0}};Tr[Sr]=function(){return this},Array.from(Tr,(function(){throw 2}))}catch(e){}var wr=function(e,t){if(!t&&!Er)return!1;var r=!1;try{var n={};n[Sr]=function(){return{next:function(){return{done:r=!0}}}},e(n)}catch(e){}return r},_r=function(e,t,r){var n,i;return zt&&"function"==typeof(n=t.constructor)&&n!==r&&T(i=n.prototype)&&i!==r.prototype&&zt(e,i),e},kr=function(e,t,r){for(var n in t)Ce(e,n,t[n],r);return e},Rr=K("species"),Ir=function(e){var t=w(e);h&&t&&!t[Rr]&&(0,ne.f)(t,Rr,{configurable:!0,get:function(){return this}})},Or=ne.f,Pr=or.fastKey,Ar=Ee.set,xr=Ee.getterFor,Lr=(function(e,t,r){var n=-1!==e.indexOf("Map"),i=-1!==e.indexOf("Weak"),o=n?"set":"add",a=d[e],s=a&&a.prototype,c=a,u={},h=function(e){var t=s[e];Ce(s,e,"add"==e?function(e){return t.call(this,0===e?0:e),this}:"delete"==e?function(e){return!(i&&!T(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return i&&!T(e)?void 0:t.call(this,0===e?0:e)}:"has"==e?function(e){return!(i&&!T(e))&&t.call(this,0===e?0:e)}:function(e,r){return t.call(this,0===e?0:e,r),this})};if(qe(e,"function"!=typeof a||!(i||s.forEach&&!l((function(){(new a).entries().next()})))))c=r.getConstructor(t,e,n,o),or.enable();else if(qe(e,!0)){var p=new c,f=p[o](i?{}:-0,1)!=p,m=l((function(){p.has(1)})),v=wr((function(e){new a(e)})),g=!i&&l((function(){for(var e=new a,t=5;t--;)e[o](t,t);return!e.has(-0)}));v||((c=t((function(t,r){br(t,c,e);var i=_r(new a,t,c);return null!=r&&yr(r,i[o],{that:i,AS_ENTRIES:n}),i}))).prototype=s,s.constructor=c),(m||g)&&(h("delete"),h("has"),n&&h("get")),(g||f)&&h(o),i&&s.clear&&delete s.clear}u[e]=c,$e({global:!0,forced:c!=a},u),Bt(c,e),i||r.setStrong(c,e,n)}("Map",(function(e){return function(){return e(this,arguments.length?arguments[0]:void 0)}}),{getConstructor:function(e,t,r,n){var i=e((function(e,o){br(e,i,t),Ar(e,{type:t,index:_t(null),first:void 0,last:void 0,size:0}),h||(e.size=0),null!=o&&yr(o,e[n],{that:e,AS_ENTRIES:r})})),o=xr(t),a=function(e,t,r){var n,i,a=o(e),c=s(e,t);return c?c.value=r:(a.last=c={index:i=Pr(t,!0),key:t,value:r,previous:n=a.last,next:void 0,removed:!1},a.first||(a.first=c),n&&(n.next=c),h?a.size++:e.size++,"F"!==i&&(a.index[i]=c)),e},s=function(e,t){var r,n=o(e),i=Pr(t);if("F"!==i)return n.index[i];for(r=n.first;r;r=r.next)if(r.key==t)return r};return kr(i.prototype,{clear:function(){for(var e=o(this),t=e.index,r=e.first;r;)r.removed=!0,r.previous&&(r.previous=r.previous.next=void 0),delete t[r.index],r=r.next;e.first=e.last=void 0,h?e.size=0:this.size=0},delete:function(e){var t=o(this),r=s(this,e);if(r){var n=r.next,i=r.previous;delete t.index[r.index],r.removed=!0,i&&(i.next=n),n&&(n.previous=i),t.first==r&&(t.first=n),t.last==r&&(t.last=i),h?t.size--:this.size--}return!!r},forEach:function(e){for(var t,r=o(this),n=Qe(e,arguments.length>1?arguments[1]:void 0,3);t=t?t.next:r.first;)for(n(t.value,t.key,this);t&&t.removed;)t=t.previous},has:function(e){return!!s(this,e)}}),kr(i.prototype,r?{get:function(e){var t=s(this,e);return t&&t.value},set:function(e,t){return a(this,0===e?0:e,t)}}:{add:function(e){return a(this,e=0===e?0:e,e)}}),h&&Or(i.prototype,"size",{get:function(){return o(this).size}}),i},setStrong:function(e,t,r){var n=t+" Iterator",i=xr(t),o=xr(n);$t(e,t,(function(e,t){Ar(this,{type:n,target:e,state:i(e),kind:t,last:void 0})}),(function(){for(var e=o(this),t=e.kind,r=e.last;r&&r.removed;)r=r.previous;return e.target&&(e.last=r=r?r.next:e.state.first)?"keys"==t?{value:r.key,done:!1}:"values"==t?{value:r.value,done:!1}:{value:[r.key,r.value],done:!1}:(e.target=void 0,{value:void 0,done:!0})}),r?"entries":"values",!r,!0),Ir(t)}}),dr?{}.toString:function(){return"[object "+pr(this)+"]"});dr||Ce(Object.prototype,"toString",Lr,{unsafe:!0});var Mr=function(e){if(L(e))throw TypeError("Cannot convert a Symbol value to a string");return String(e)},Dr=function(e){return function(t,r){var n,i,o=Mr(E(t)),a=_e(r),s=o.length;return a<0||a>=s?e?"":void 0:(n=o.charCodeAt(a))<55296||n>56319||a+1===s||(i=o.charCodeAt(a+1))<56320||i>57343?e?o.charAt(a):n:e?o.slice(a,a+2):i-56320+(n-55296<<10)+65536}},Ur={codeAt:Dr(!1),charAt:Dr(!0)},Nr=Ur.charAt,jr=Ee.set,Vr=Ee.getterFor("String Iterator");$t(String,"String",(function(e){jr(this,{type:"String Iterator",string:Mr(e),index:0})}),(function(){var e,t=Vr(this),r=t.string,n=t.index;return n>=r.length?{value:void 0,done:!0}:(e=Nr(r,n),t.index+=e.length,{value:e,done:!1})}));var Fr={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Wr=K("iterator"),Br=K("toStringTag"),Gr=Zt.values;for(var Hr in Fr){var zr=d[Hr],Kr=zr&&zr.prototype;if(Kr){if(Kr[Wr]!==Gr)try{ie(Kr,Wr,Gr)}catch(e){Kr[Wr]=Gr}if(Kr[Br]||ie(Kr,Br,Hr),Fr[Hr])for(var Jr in Zt)if(Kr[Jr]!==Zt[Jr])try{ie(Kr,Jr,Zt[Jr])}catch(e){Kr[Jr]=Zt[Jr]}}}var qr="undefined"!=typeof ArrayBuffer&&"undefined"!=typeof DataView,Yr=function(e){if(void 0===e)return 0;var t=_e(e),r=Re(t);if(t!==r)throw RangeError("Wrong length or index");return r},$r=Math.abs,Xr=Math.pow,Qr=Math.floor,Zr=Math.log,en=Math.LN2,tn=function(e){for(var t=N(this),r=Re(t.length),n=arguments.length,i=Ae(n>1?arguments[1]:void 0,r),o=n>2?arguments[2]:void 0,a=void 0===o?r:Ae(o,r);a>i;)t[i++]=e;return t},rn=je.f,nn=ne.f,on=Ee.get,an=Ee.set,sn=d.ArrayBuffer,cn=sn,un=d.DataView,dn=un&&un.prototype,ln=Object.prototype,hn=d.RangeError,pn=function(e,t,r){var n,i,o,a=new Array(r),s=8*r-t-1,c=(1<<s)-1,u=c>>1,d=23===t?Xr(2,-24)-Xr(2,-77):0,l=e<0||0===e&&1/e<0?1:0,h=0;for((e=$r(e))!=e||1/0===e?(i=e!=e?1:0,n=c):(n=Qr(Zr(e)/en),e*(o=Xr(2,-n))<1&&(n--,o*=2),(e+=n+u>=1?d/o:d*Xr(2,1-u))*o>=2&&(n++,o/=2),n+u>=c?(i=0,n=c):n+u>=1?(i=(e*o-1)*Xr(2,t),n+=u):(i=e*Xr(2,u-1)*Xr(2,t),n=0));t>=8;a[h++]=255&i,i/=256,t-=8);for(n=n<<t|i,s+=t;s>0;a[h++]=255&n,n/=256,s-=8);return a[--h]|=128*l,a},fn=function(e,t){var r,n=e.length,i=8*n-t-1,o=(1<<i)-1,a=o>>1,s=i-7,c=n-1,u=e[c--],d=127&u;for(u>>=7;s>0;d=256*d+e[c],c--,s-=8);for(r=d&(1<<-s)-1,d>>=-s,s+=t;s>0;r=256*r+e[c],c--,s-=8);if(0===d)d=1-a;else{if(d===o)return r?NaN:u?-1/0:1/0;r+=Xr(2,t),d-=a}return(u?-1:1)*r*Xr(2,d-t)},mn=function(e){return[255&e]},vn=function(e){return[255&e,e>>8&255]},gn=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},yn=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},bn=function(e){return pn(e,23,4)},Sn=function(e){return pn(e,52,8)},En=function(e,t){nn(e.prototype,t,{get:function(){return on(this)[t]}})},Cn=function(e,t,r,n){var i=Yr(r),o=on(e);if(i+t>o.byteLength)throw hn("Wrong index");var a=on(o.buffer).bytes,s=i+o.byteOffset,c=a.slice(s,s+t);return n?c:c.reverse()},Tn=function(e,t,r,n,i,o){var a=Yr(r),s=on(e);if(a+t>s.byteLength)throw hn("Wrong index");for(var c=on(s.buffer).bytes,u=a+s.byteOffset,d=n(+i),l=0;l<t;l++)c[u+l]=d[o?l:t-l-1]};if(qr){if(!l((function(){sn(1)}))||!l((function(){new sn(-1)}))||l((function(){return new sn,new sn(1.5),new sn(NaN),"ArrayBuffer"!=sn.name}))){for(var wn,_n=(cn=function(e){return br(this,cn),new sn(Yr(e))}).prototype=sn.prototype,kn=rn(sn),Rn=0;kn.length>Rn;)(wn=kn[Rn++])in cn||ie(cn,wn,sn[wn]);_n.constructor=cn}zt&&Ut(dn)!==ln&&zt(dn,ln);var In=new un(new cn(2)),On=dn.setInt8;In.setInt8(0,2147483648),In.setInt8(1,2147483649),!In.getInt8(0)&&In.getInt8(1)||kr(dn,{setInt8:function(e,t){On.call(this,e,t<<24>>24)},setUint8:function(e,t){On.call(this,e,t<<24>>24)}},{unsafe:!0})}else cn=function(e){br(this,cn,"ArrayBuffer");var t=Yr(e);an(this,{bytes:tn.call(new Array(t),0),byteLength:t}),h||(this.byteLength=t)},un=function(e,t,r){br(this,un,"DataView"),br(e,cn,"DataView");var n=on(e).byteLength,i=_e(t);if(i<0||i>n)throw hn("Wrong offset");if(i+(r=void 0===r?n-i:Re(r))>n)throw hn("Wrong length");an(this,{buffer:e,byteLength:r,byteOffset:i}),h||(this.buffer=e,this.byteLength=r,this.byteOffset=i)},h&&(En(cn,"byteLength"),En(un,"buffer"),En(un,"byteLength"),En(un,"byteOffset")),kr(un.prototype,{getInt8:function(e){return Cn(this,1,e)[0]<<24>>24},getUint8:function(e){return Cn(this,1,e)[0]},getInt16:function(e){var t=Cn(this,2,e,arguments.length>1?arguments[1]:void 0);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=Cn(this,2,e,arguments.length>1?arguments[1]:void 0);return t[1]<<8|t[0]},getInt32:function(e){return yn(Cn(this,4,e,arguments.length>1?arguments[1]:void 0))},getUint32:function(e){return yn(Cn(this,4,e,arguments.length>1?arguments[1]:void 0))>>>0},getFloat32:function(e){return fn(Cn(this,4,e,arguments.length>1?arguments[1]:void 0),23)},getFloat64:function(e){return fn(Cn(this,8,e,arguments.length>1?arguments[1]:void 0),52)},setInt8:function(e,t){Tn(this,1,e,mn,t)},setUint8:function(e,t){Tn(this,1,e,mn,t)},setInt16:function(e,t){Tn(this,2,e,vn,t,arguments.length>2?arguments[2]:void 0)},setUint16:function(e,t){Tn(this,2,e,vn,t,arguments.length>2?arguments[2]:void 0)},setInt32:function(e,t){Tn(this,4,e,gn,t,arguments.length>2?arguments[2]:void 0)},setUint32:function(e,t){Tn(this,4,e,gn,t,arguments.length>2?arguments[2]:void 0)},setFloat32:function(e,t){Tn(this,4,e,bn,t,arguments.length>2?arguments[2]:void 0)},setFloat64:function(e,t){Tn(this,8,e,Sn,t,arguments.length>2?arguments[2]:void 0)}});Bt(cn,"ArrayBuffer"),Bt(un,"DataView");var Pn={ArrayBuffer:cn,DataView:un},An=K("species"),xn=function(e,t){var r,n=te(e).constructor;return void 0===n||null==(r=te(n)[An])?t:Xe(r)},Ln=Pn.ArrayBuffer,Mn=Pn.DataView,Dn=Ln.prototype.slice,Un=l((function(){return!new Ln(2).slice(1,void 0).byteLength}));$e({target:"ArrayBuffer",proto:!0,unsafe:!0,forced:Un},{slice:function(e,t){if(void 0!==Dn&&void 0===t)return Dn.call(te(this),e);for(var r=te(this).byteLength,n=Ae(e,r),i=Ae(void 0===t?r:t,r),o=new(xn(this,Ln))(Re(i-n)),a=new Mn(this),s=new Mn(o),c=0;n<i;)s.setUint8(c++,a.getUint8(n++));return o}});var Nn,jn,Vn,Fn=ne.f,Wn=d.Int8Array,Bn=Wn&&Wn.prototype,Gn=d.Uint8ClampedArray,Hn=Gn&&Gn.prototype,zn=Wn&&Ut(Wn),Kn=Bn&&Ut(Bn),Jn=Object.prototype,qn=Jn.isPrototypeOf,Yn=K("toStringTag"),$n=B("TYPED_ARRAY_TAG"),Xn=B("TYPED_ARRAY_CONSTRUCTOR"),Qn=qr&&!!zt&&"Opera"!==pr(d.opera),Zn=!1,ei={Int8Array:1,Uint8Array:1,Uint8ClampedArray:1,Int16Array:2,Uint16Array:2,Int32Array:4,Uint32Array:4,Float32Array:4,Float64Array:8},ti={BigInt64Array:8,BigUint64Array:8},ri=function(e){if(!T(e))return!1;var t=pr(e);return V(ei,t)||V(ti,t)};for(Nn in ei)(Vn=(jn=d[Nn])&&jn.prototype)?ie(Vn,Xn,jn):Qn=!1;for(Nn in ti)(Vn=(jn=d[Nn])&&jn.prototype)&&ie(Vn,Xn,jn);if((!Qn||"function"!=typeof zn||zn===Function.prototype)&&(zn=function(){throw TypeError("Incorrect invocation")},Qn))for(Nn in ei)d[Nn]&&zt(d[Nn],zn);if((!Qn||!Kn||Kn===Jn)&&(Kn=zn.prototype,Qn))for(Nn in ei)d[Nn]&&zt(d[Nn].prototype,Kn);if(Qn&&Ut(Hn)!==Kn&&zt(Hn,Kn),h&&!V(Kn,Yn))for(Nn in Zn=!0,Fn(Kn,Yn,{get:function(){return T(this)?this[$n]:void 0}}),ei)d[Nn]&&ie(d[Nn],$n,Nn);var ni={NATIVE_ARRAY_BUFFER_VIEWS:Qn,TYPED_ARRAY_CONSTRUCTOR:Xn,TYPED_ARRAY_TAG:Zn&&$n,aTypedArray:function(e){if(ri(e))return e;throw TypeError("Target is not a typed array")},aTypedArrayConstructor:function(e){if(zt&&!qn.call(zn,e))throw TypeError("Target is not a typed array constructor");return e},exportTypedArrayMethod:function(e,t,r){if(h){if(r)for(var n in ei){var i=d[n];if(i&&V(i.prototype,e))try{delete i.prototype[e]}catch(e){}}Kn[e]&&!r||Ce(Kn,e,r?t:Qn&&Bn[e]||t)}},exportTypedArrayStaticMethod:function(e,t,r){var n,i;if(h){if(zt){if(r)for(n in ei)if((i=d[n])&&V(i,e))try{delete i[e]}catch(e){}if(zn[e]&&!r)return;try{return Ce(zn,e,r?t:Qn&&zn[e]||t)}catch(e){}}for(n in ei)!(i=d[n])||i[e]&&!r||Ce(i,e,t)}},isView:function(e){if(!T(e))return!1;var t=pr(e);return"DataView"===t||V(ei,t)||V(ti,t)},isTypedArray:ri,TypedArray:zn,TypedArrayPrototype:Kn},ii=d.ArrayBuffer,oi=d.Int8Array,ai=!ni.NATIVE_ARRAY_BUFFER_VIEWS||!l((function(){oi(1)}))||!l((function(){new oi(-1)}))||!wr((function(e){new oi,new oi(null),new oi(1.5),new oi(e)}),!0)||l((function(){return 1!==new oi(new ii(2),1,void 0).length})),si=Math.floor,ci=function(e,t){var r=function(e){var t=_e(e);if(t<0)throw RangeError("The argument can't be less than 0");return t}(e);if(r%t)throw RangeError("Wrong offset");return r},ui=ni.aTypedArrayConstructor,di=function(e){var t,r,n,i,o,a,s=N(e),c=arguments.length,u=c>1?arguments[1]:void 0,d=void 0!==u,l=mr(s);if(null!=l&&!cr(l))for(a=(o=l.call(s)).next,s=[];!(i=a.call(o)).done;)s.push(i.value);for(d&&c>2&&(u=Qe(u,arguments[2],2)),r=Re(s.length),n=new(ui(this))(r),t=0;r>t;t++)n[t]=d?u(s[t],t):s[t];return n};a((function(e){var t=je.f,r=it.forEach,n=Ee.get,i=Ee.set,o=ne.f,a=ee.f,s=Math.round,c=d.RangeError,u=Pn.ArrayBuffer,l=Pn.DataView,p=ni.NATIVE_ARRAY_BUFFER_VIEWS,f=ni.TYPED_ARRAY_CONSTRUCTOR,m=ni.TYPED_ARRAY_TAG,g=ni.TypedArray,y=ni.TypedArrayPrototype,b=ni.aTypedArrayConstructor,S=ni.isTypedArray,E=function(e,t){for(var r=0,n=t.length,i=new(b(e))(n);n>r;)i[r]=t[r++];return i},C=function(e,t){o(e,t,{get:function(){return n(this)[t]}})},w=function(e){var t;return e instanceof u||"ArrayBuffer"==(t=pr(e))||"SharedArrayBuffer"==t},_=function(e,t){return S(e)&&!L(t)&&t in e&&!T(r=+t)&&isFinite(r)&&si(r)===r&&t>=0;var r},k=function(e,t){return t=q(t),_(e,t)?v(2,e[t]):a(e,t)},R=function(e,t,r){return t=q(t),!(_(e,t)&&T(r)&&V(r,"value"))||V(r,"get")||V(r,"set")||r.configurable||V(r,"writable")&&!r.writable||V(r,"enumerable")&&!r.enumerable?o(e,t,r):(e[t]=r.value,e)};h?(p||(ee.f=k,ne.f=R,C(y,"buffer"),C(y,"byteOffset"),C(y,"byteLength"),C(y,"length")),$e({target:"Object",stat:!0,forced:!p},{getOwnPropertyDescriptor:k,defineProperty:R}),e.exports=function(e,a,h){var v=e.match(/\d+$/)[0]/8,b=e+(h?"Clamped":"")+"Array",C="get"+e,_="set"+e,k=d[b],R=k,I=R&&R.prototype,O={},P=function(e,t){o(e,t,{get:function(){return function(e,t){var r=n(e);return r.view[C](t*v+r.byteOffset,!0)}(this,t)},set:function(e){return function(e,t,r){var i=n(e);h&&(r=(r=s(r))<0?0:r>255?255:255&r),i.view[_](t*v+i.byteOffset,r,!0)}(this,t,e)},enumerable:!0})};p?ai&&(R=a((function(e,t,r,n){return br(e,R,b),_r(T(t)?w(t)?void 0!==n?new k(t,ci(r,v),n):void 0!==r?new k(t,ci(r,v)):new k(t):S(t)?E(R,t):di.call(R,t):new k(Yr(t)),e,R)})),zt&&zt(R,g),r(t(k),(function(e){e in R||ie(R,e,k[e])})),R.prototype=I):(R=a((function(e,t,r,n){br(e,R,b);var o,a,s,d=0,h=0;if(T(t)){if(!w(t))return S(t)?E(R,t):di.call(R,t);o=t,h=ci(r,v);var p=t.byteLength;if(void 0===n){if(p%v)throw c("Wrong length");if((a=p-h)<0)throw c("Wrong length")}else if((a=Re(n)*v)+h>p)throw c("Wrong length");s=a/v}else s=Yr(t),o=new u(a=s*v);for(i(e,{buffer:o,byteOffset:h,byteLength:a,length:s,view:new l(o)});d<s;)P(e,d++)})),zt&&zt(R,g),I=R.prototype=_t(y)),I.constructor!==R&&ie(I,"constructor",R),ie(I,f,R),m&&ie(I,m,b),O[b]=R,$e({global:!0,forced:R!=k,sham:!p},O),"BYTES_PER_ELEMENT"in R||ie(R,"BYTES_PER_ELEMENT",v),"BYTES_PER_ELEMENT"in I||ie(I,"BYTES_PER_ELEMENT",v),Ir(b)}):e.exports=function(){}}))("Float32",(function(e){return function(t,r,n){return e(this,t,r,n)}}));var li=Math.min,hi=[].copyWithin||function(e,t){var r=N(this),n=Re(r.length),i=Ae(e,n),o=Ae(t,n),a=arguments.length>2?arguments[2]:void 0,s=li((void 0===a?n:Ae(a,n))-o,n-i),c=1;for(o<i&&i<o+s&&(c=-1,o+=s-1,i+=s-1);s-- >0;)o in r?r[i]=r[o]:delete r[i],i+=c,o+=c;return r},pi=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("copyWithin",(function(e,t){return hi.call(pi(this),e,t,arguments.length>2?arguments[2]:void 0)}));var fi=it.every,mi=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("every",(function(e){return fi(mi(this),e,arguments.length>1?arguments[1]:void 0)}));var vi=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("fill",(function(e){return tn.apply(vi(this),arguments)}));var gi=ni.TYPED_ARRAY_CONSTRUCTOR,yi=ni.aTypedArrayConstructor,bi=function(e){return yi(xn(e,e[gi]))},Si=it.filter,Ei=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("filter",(function(e){return function(e,t){return function(e,t){for(var r=0,n=t.length,i=new e(n);n>r;)i[r]=t[r++];return i}(bi(e),t)}(this,Si(Ei(this),e,arguments.length>1?arguments[1]:void 0))}));var Ci=it.find,Ti=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("find",(function(e){return Ci(Ti(this),e,arguments.length>1?arguments[1]:void 0)}));var wi=it.findIndex,_i=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("findIndex",(function(e){return wi(_i(this),e,arguments.length>1?arguments[1]:void 0)}));var ki=it.forEach,Ri=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("forEach",(function(e){ki(Ri(this),e,arguments.length>1?arguments[1]:void 0)}));var Ii=Le.includes,Oi=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("includes",(function(e){return Ii(Oi(this),e,arguments.length>1?arguments[1]:void 0)}));var Pi=Le.indexOf,Ai=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("indexOf",(function(e){return Pi(Ai(this),e,arguments.length>1?arguments[1]:void 0)}));var xi=K("iterator"),Li=d.Uint8Array,Mi=Zt.values,Di=Zt.keys,Ui=Zt.entries,Ni=ni.aTypedArray,ji=ni.exportTypedArrayMethod,Vi=Li&&Li.prototype[xi],Fi=!!Vi&&("values"==Vi.name||null==Vi.name),Wi=function(){return Mi.call(Ni(this))};ji("entries",(function(){return Ui.call(Ni(this))})),ji("keys",(function(){return Di.call(Ni(this))})),ji("values",Wi,!Fi),ji(xi,Wi,!Fi);var Bi=ni.aTypedArray,Gi=[].join;(0,ni.exportTypedArrayMethod)("join",(function(e){return Gi.apply(Bi(this),arguments)}));var Hi=function(e,t){var r=[][e];return!!r&&l((function(){r.call(null,t||function(){throw 1},1)}))},zi=Math.min,Ki=[].lastIndexOf,Ji=!!Ki&&1/[1].lastIndexOf(1,-0)<0,qi=Hi("lastIndexOf"),Yi=Ji||!qi?function(e){if(Ji)return Ki.apply(this,arguments)||0;var t=C(this),r=Re(t.length),n=r-1;for(arguments.length>1&&(n=zi(n,_e(arguments[1]))),n<0&&(n=r+n);n>=0;n--)if(n in t&&t[n]===e)return n||0;return-1}:Ki,$i=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("lastIndexOf",(function(e){return Yi.apply($i(this),arguments)}));var Xi=it.map,Qi=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("map",(function(e){return Xi(Qi(this),e,arguments.length>1?arguments[1]:void 0,(function(e,t){return new(bi(e))(t)}))}));var Zi=function(e){return function(t,r,n,i){Xe(r);var o=N(t),a=S(o),s=Re(o.length),c=e?s-1:0,u=e?-1:1;if(n<2)for(;;){if(c in a){i=a[c],c+=u;break}if(c+=u,e?c<0:s<=c)throw TypeError("Reduce of empty array with no initial value")}for(;e?c>=0:s>c;c+=u)c in a&&(i=r(i,a[c],c,o));return i}},eo={left:Zi(!1),right:Zi(!0)},to=eo.left,ro=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("reduce",(function(e){return to(ro(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var no=eo.right,io=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("reduceRight",(function(e){return no(io(this),e,arguments.length,arguments.length>1?arguments[1]:void 0)}));var oo=ni.aTypedArray,ao=Math.floor;(0,ni.exportTypedArrayMethod)("reverse",(function(){for(var e,t=oo(this).length,r=ao(t/2),n=0;n<r;)e=this[n],this[n++]=this[--t],this[t]=e;return this}));var so=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("set",(function(e){so(this);var t=ci(arguments.length>1?arguments[1]:void 0,1),r=this.length,n=N(e),i=Re(n.length),o=0;if(i+t>r)throw RangeError("Wrong length");for(;o<i;)this[t+o]=n[o++]}),l((function(){new Int8Array(1).set({})})));var co=ni.aTypedArray,uo=[].slice;(0,ni.exportTypedArrayMethod)("slice",(function(e,t){for(var r=uo.call(co(this),e,t),n=bi(this),i=0,o=r.length,a=new n(o);o>i;)a[i]=r[i++];return a}),l((function(){new Int8Array(1).slice()})));var lo=it.some,ho=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("some",(function(e){return lo(ho(this),e,arguments.length>1?arguments[1]:void 0)}));var po=Math.floor,fo=function(e,t){for(var r,n,i=e.length,o=1;o<i;){for(n=o,r=e[o];n&&t(e[n-1],r)>0;)e[n]=e[--n];n!==o++&&(e[n]=r)}return e},mo=function(e,t,r){for(var n=e.length,i=t.length,o=0,a=0,s=[];o<n||a<i;)s.push(o<n&&a<i?r(e[o],t[a])<=0?e[o++]:t[a++]:o<n?e[o++]:t[a++]);return s},vo=function e(t,r){var n=t.length,i=po(n/2);return n<8?fo(t,r):mo(e(t.slice(0,i),r),e(t.slice(i),r),r)},go=_.match(/firefox\/(\d+)/i),yo=!!go&&+go[1],bo=/MSIE|Trident/.test(_),So=_.match(/AppleWebKit\/(\d+)\./),Eo=!!So&&+So[1],Co=ni.aTypedArray,To=ni.exportTypedArrayMethod,wo=d.Uint16Array,_o=wo&&wo.prototype.sort,ko=!!_o&&!l((function(){var e=new wo(2);e.sort(null),e.sort({})})),Ro=!!_o&&!l((function(){if(P)return P<74;if(yo)return yo<67;if(bo)return!0;if(Eo)return Eo<602;var e,t,r=new wo(516),n=Array(516);for(e=0;e<516;e++)t=e%4,r[e]=515-e,n[e]=e-2*t+3;for(r.sort((function(e,t){return(e/4|0)-(t/4|0)})),e=0;e<516;e++)if(r[e]!==n[e])return!0}));To("sort",(function(e){if(void 0!==e&&Xe(e),Ro)return _o.call(this,e);Co(this);var t,r=Re(this.length),n=Array(r);for(t=0;t<r;t++)n[t]=this[t];for(n=vo(this,function(e){return function(t,r){return void 0!==e?+e(t,r)||0:r!=r?-1:t!=t?1:0===t&&0===r?1/t>0&&1/r<0?1:-1:t>r}}(e)),t=0;t<r;t++)this[t]=n[t];return this}),!Ro||ko);var Io=ni.aTypedArray;(0,ni.exportTypedArrayMethod)("subarray",(function(e,t){var r=Io(this),n=r.length,i=Ae(e,n);return new(bi(r))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,Re((void 0===t?n:Ae(t,n))-i))}));var Oo=d.Int8Array,Po=ni.aTypedArray,Ao=ni.exportTypedArrayMethod,xo=[].toLocaleString,Lo=[].slice,Mo=!!Oo&&l((function(){xo.call(new Oo(1))}));Ao("toLocaleString",(function(){return xo.apply(Mo?Lo.call(Po(this)):Po(this),arguments)}),l((function(){return[1,2].toLocaleString()!=new Oo([1,2]).toLocaleString()}))||!l((function(){Oo.prototype.toLocaleString.call([1,2])})));var Do=ni.exportTypedArrayMethod,Uo=d.Uint8Array,No=Uo&&Uo.prototype||{},jo=[].toString,Vo=[].join;l((function(){jo.call({})}))&&(jo=function(){return Vo.call(this)}),Do("toString",jo,No.toString!=jo);var Fo=function(){var e=te(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.dotAll&&(t+="s"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t},Wo=function(e,t){return RegExp(e,t)},Bo={UNSUPPORTED_Y:l((function(){var e=Wo("a","y");return e.lastIndex=2,null!=e.exec("abcd")})),BROKEN_CARET:l((function(){var e=Wo("^r","gy");return e.lastIndex=2,null!=e.exec("str")}))},Go=l((function(){var e=RegExp(".","string".charAt(0));return!(e.dotAll&&e.exec("\n")&&"s"===e.flags)})),Ho=l((function(){var e=RegExp("(?<a>b)","string".charAt(5));return"b"!==e.exec("b").groups.a||"bc"!=="b".replace(e,"$<a>c")})),zo=Ee.get,Ko=RegExp.prototype.exec,Jo=U("native-string-replace",String.prototype.replace),qo=Ko,Yo=function(){var e=/a/,t=/b*/g;return Ko.call(e,"a"),Ko.call(t,"a"),0!==e.lastIndex||0!==t.lastIndex}(),$o=Bo.UNSUPPORTED_Y||Bo.BROKEN_CARET,Xo=void 0!==/()??/.exec("")[1];(Yo||Xo||$o||Go||Ho)&&(qo=function(e){var t,r,n,i,o,a,s,c=this,u=zo(c),d=Mr(e),l=u.raw;if(l)return l.lastIndex=c.lastIndex,t=qo.call(l,d),c.lastIndex=l.lastIndex,t;var h=u.groups,p=$o&&c.sticky,f=Fo.call(c),m=c.source,v=0,g=d;if(p&&(-1===(f=f.replace("y","")).indexOf("g")&&(f+="g"),g=d.slice(c.lastIndex),c.lastIndex>0&&(!c.multiline||c.multiline&&"\n"!==d.charAt(c.lastIndex-1))&&(m="(?: "+m+")",g=" "+g,v++),r=new RegExp("^(?:"+m+")",f)),Xo&&(r=new RegExp("^"+m+"$(?!\\s)",f)),Yo&&(n=c.lastIndex),i=Ko.call(p?r:c,g),p?i?(i.input=i.input.slice(v),i[0]=i[0].slice(v),i.index=c.lastIndex,c.lastIndex+=i[0].length):c.lastIndex=0:Yo&&i&&(c.lastIndex=c.global?i.index+i[0].length:n),Xo&&i&&i.length>1&&Jo.call(i[0],r,(function(){for(o=1;o<arguments.length-2;o++)void 0===arguments[o]&&(i[o]=void 0)})),i&&h)for(i.groups=a=_t(null),o=0;o<h.length;o++)a[(s=h[o])[0]]=i[s[1]];return i});var Qo=qo;$e({target:"RegExp",proto:!0,forced:/./.exec!==Qo},{exec:Qo}),K("species");var Zo=RegExp.prototype,ea=Ur.charAt,ta=function(e,t,r){return t+(r?ea(e,t).length:1)},ra=Math.floor,na="".replace,ia=/\$([$&'`]|\d{1,2}|<[^>]*>)/g,oa=/\$([$&'`]|\d{1,2})/g,aa=function(e,t,r,n,i,o){var a=r+e.length,s=n.length,c=oa;return void 0!==i&&(i=N(i),c=ia),na.call(o,c,(function(o,c){var u;switch(c.charAt(0)){case"$":return"$";case"&":return e;case"`":return t.slice(0,r);case"'":return t.slice(a);case"<":u=i[c.slice(1,-1)];break;default:var d=+c;if(0===d)return o;if(d>s){var l=ra(d/10);return 0===l?o:l<=s?void 0===n[l-1]?c.charAt(1):n[l-1]+c.charAt(1):o}u=n[d-1]}return void 0===u?"":u}))},sa=function(e,t){var r=e.exec;if("function"==typeof r){var n=r.call(e,t);if("object"!=Oe(n))throw TypeError("RegExp exec method returned something other than an Object or null");return n}if("RegExp"!==y(e))throw TypeError("RegExp#exec called on incompatible receiver");return Qo.call(e,t)},ca=K("replace"),ua=Math.max,da=Math.min,la="$0"==="a".replace(/./,"$0"),ha=!!/./[ca]&&""===/./[ca]("a","$0");!function(e,t,r){var n=K(e),i=!l((function(){var t={};return t[n]=function(){return 7},7!=""[e](t)})),o=i&&!l((function(){var e=!1,t=/a/;return t.exec=function(){return e=!0,null},t[n](""),!e}));if(!i||!o||r){var a=/./[n],s=function(e,t,r){var n=ha?"$":"$0";return[function(e,r){var n=E(this),i=null==e?void 0:e[ca];return void 0!==i?i.call(e,n,r):t.call(Mr(n),e,r)},function(e,i){var o=te(this),a=Mr(e);if("string"==typeof i&&-1===i.indexOf(n)&&-1===i.indexOf("$<")){var s=r(t,o,a,i);if(s.done)return s.value}var c="function"==typeof i;c||(i=Mr(i));var u=o.global;if(u){var d=o.unicode;o.lastIndex=0}for(var l=[];;){var h=sa(o,a);if(null===h)break;if(l.push(h),!u)break;""===Mr(h[0])&&(o.lastIndex=ta(a,Re(o.lastIndex),d))}for(var p,f="",m=0,v=0;v<l.length;v++){for(var g=Mr((h=l[v])[0]),y=ua(da(_e(h.index),a.length),0),b=[],S=1;S<h.length;S++)b.push(void 0===(p=h[S])?p:String(p));var E=h.groups;if(c){var C=[g].concat(b,y,a);void 0!==E&&C.push(E);var T=Mr(i.apply(void 0,C))}else T=aa(g,a,y,b,E,i);y>=m&&(f+=a.slice(m,y)+T,m=y+g.length)}return f+a.slice(m)}]}(0,""[e],(function(e,t,r,n,o){var s=t.exec;return s===Qo||s===Zo.exec?i&&!o?{done:!0,value:a.call(t,r,n)}:{done:!0,value:e.call(r,t,n)}:{done:!1}}));Ce(String.prototype,e,s[0]),Ce(Zo,n,s[1])}}("replace",0,!!l((function(){var e=/./;return e.exec=function(){var e=[];return e.groups={a:"7"},e},"7"!=="".replace(e,"$<a>")}))||!la||ha);var pa=RegExp.prototype,fa=pa.toString,ma=l((function(){return"/a/b"!=fa.call({source:"a",flags:"b"})})),va="toString"!=fa.name;(ma||va)&&Ce(RegExp.prototype,"toString",(function(){var e=te(this),t=Mr(e.source),r=e.flags;return"/"+t+"/"+Mr(void 0===r&&e instanceof RegExp&&!("flags"in pa)?Fo.call(e):r)}),{unsafe:!0});var ga=K("match"),ya=ne.f,ba=je.f,Sa=Ee.enforce,Ea=K("match"),Ca=d.RegExp,Ta=Ca.prototype,wa=/^\?<[^\s\d!#%&*+<=>@^][^\s!#%&*+<=>@^]*>/,_a=/a/g,ka=/a/g,Ra=new Ca(_a)!==_a,Ia=Bo.UNSUPPORTED_Y,Oa=h&&(!Ra||Ia||Go||Ho||l((function(){return ka[Ea]=!1,Ca(_a)!=_a||Ca(ka)==ka||"/a/i"!=Ca(_a,"i")})));if(qe("RegExp",Oa)){for(var Pa=function e(t,r){var n,i,o,a,s,c,u,d,l=this instanceof e,h=T(n=t)&&(void 0!==(i=n[ga])?!!i:"RegExp"==y(n)),p=void 0===r,f=[],m=t;if(!l&&h&&p&&t.constructor===e)return t;if((h||t instanceof e)&&(t=t.source,p&&(r="flags"in m?m.flags:Fo.call(m))),t=void 0===t?"":Mr(t),r=void 0===r?"":Mr(r),m=t,Go&&"dotAll"in _a&&(a=!!r&&r.indexOf("s")>-1)&&(r=r.replace(/s/g,"")),o=r,Ia&&"sticky"in _a&&(s=!!r&&r.indexOf("y")>-1)&&(r=r.replace(/y/g,"")),Ho&&(t=(c=function(e){for(var t,r=e.length,n=0,i="",o=[],a={},s=!1,c=!1,u=0,d="";n<=r;n++){if("\\"===(t=e.charAt(n)))t+=e.charAt(++n);else if("]"===t)s=!1;else if(!s)switch(!0){case"["===t:s=!0;break;case"("===t:wa.test(e.slice(n+1))&&(n+=2,c=!0),i+=t,u++;continue;case">"===t&&c:if(""===d||V(a,d))throw new SyntaxError("Invalid capture group name");a[d]=!0,o.push([d,u]),c=!1,d="";continue}c?d+=t:i+=t}return[i,o]}(t))[0],f=c[1]),u=_r(Ca(t,r),l?this:Ta,e),(a||s||f.length)&&(d=Sa(u),a&&(d.dotAll=!0,d.raw=e(function(e){for(var t,r=e.length,n=0,i="",o=!1;n<=r;n++)"\\"!==(t=e.charAt(n))?o||"."!==t?("["===t?o=!0:"]"===t&&(o=!1),i+=t):i+="[\\s\\S]":i+=t+e.charAt(++n);return i}(t),o)),s&&(d.sticky=!0),f.length&&(d.groups=f)),t!==m)try{ie(u,"source",""===m?"(?:)":m)}catch(e){}return u},Aa=function(e){e in Pa||ya(Pa,e,{configurable:!0,get:function(){return Ca[e]},set:function(t){Ca[e]=t}})},xa=ba(Ca),La=0;xa.length>La;)Aa(xa[La++]);Ta.constructor=Pa,Pa.prototype=Ta,Ce(d,"RegExp",Pa)}Ir("RegExp");var Ma=[].join,Da=S!=Object,Ua=Hi("join",",");function Na(e,t,r){var n=function(e,t,r){var n=new RegExp("\\b".concat(t," \\w+ (\\w+)"),"ig");e.replace(n,(function(e,t){return r[t]=0,e}))},i=function(e,t,r){var n=e.createShader(r);return e.shaderSource(n,t),e.compileShader(n),e.getShaderParameter(n,e.COMPILE_STATUS)?n:null};this.uniform={},this.attribute={};var o=i(e,t,e.VERTEX_SHADER),a=i(e,r,e.FRAGMENT_SHADER);for(var s in this.id=e.createProgram(),e.attachShader(this.id,o),e.attachShader(this.id,a),e.linkProgram(this.id),e.getProgramParameter(this.id,e.LINK_STATUS),e.useProgram(this.id),n(t,"attribute",this.attribute),this.attribute)this.attribute[s]=e.getAttribLocation(this.id,s);for(var c in n(t,"uniform",this.uniform),n(r,"uniform",this.uniform),this.uniform)this.uniform[c]=e.getUniformLocation(this.id,c)}$e({target:"Array",proto:!0,forced:Da||!Ua},{join:function(e){return Ma.call(C(this),void 0===e?",":e)}});var ja=function(){function e(r){t(this,e),this.canvas=r.canvas,this.width=r.width||640,this.height=r.height||480,this.gl=this.createGL(r.canvas),this.sourceTexture=this.gl.createTexture(),this.vertexBuffer=null,this.currentProgram=null,this.applied=!1,this.beautyParams={beauty:.5,brightness:.5,ruddy:.5}}return i(e,[{key:"setRect",value:function(e,t){this.width=e,this.height=t}},{key:"apply",value:function(e){if(!this.vertexBuffer){var t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]);this.vertexBuffer=this.gl.createBuffer(),this.gl.bindBuffer(this.gl.ARRAY_BUFFER,this.vertexBuffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW),this.gl.pixelStorei(this.gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0)}this.gl.viewport(0,0,this.width,this.height),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.applied?this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,this.gl.RGB,this.gl.UNSIGNED_BYTE,e):(this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGB,this.gl.RGB,this.gl.UNSIGNED_BYTE,e),this.applied=!0),this.beauty()}},{key:"beauty",value:function(){var e=this.beautyParams,t=e.beauty,r=e.brightness,n=e.ruddy,i=2/this.width,o=2/this.height,a=this.compileBeautyShader();this.gl.uniform2f(a.uniform.singleStepOffset,i,o);var s=new Float32Array([1-.8*t,1-.6*t,.1+.45*n,.1+.45*n]);this.gl.uniform4fv(a.uniform.params,s),this.gl.uniform1f(a.uniform.brightness,.12*r),this.draw()}},{key:"draw",value:function(){this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.uniform1f(this.currentProgram.uniform.flipY,1),this.gl.drawArrays(this.gl.TRIANGLES,0,6)}},{key:"compileBeautyShader",value:function(){if(this.currentProgram)return this.currentProgram;this.currentProgram=new Na(this.gl,["precision highp float;","attribute vec2 pos;","attribute vec2 uv;","varying vec2 vUv;","uniform float flipY;","void main(void) {","vUv = uv;","gl_Position = vec4(pos.x, pos.y*flipY, 0.0, 1.);","}"].join("\n"),["precision highp float;","uniform vec2 singleStepOffset;","uniform sampler2D texture;","uniform vec4 params;","uniform float brightness;","varying vec2 vUv;","const highp vec3 W = vec3(0.299,0.587,0.114);","const mat3 saturateMatrix = mat3(1.1102,-0.0598,-0.061,-0.0774,1.0826,-0.1186,-0.0228,-0.0228,1.1772);","vec2 blurCoordinates[24];","float hardLight(float color){","if(color <= 0.5){","color = color * color * 2.0;","} else {","color = 1.0 - ((1.0 - color)*(1.0 - color) * 2.0);","}","return color;","}","void main(){","vec3 centralColor = texture2D(texture, vUv).rgb;","blurCoordinates[0] = vUv.xy + singleStepOffset * vec2(0.0, -10.0);","blurCoordinates[1] = vUv.xy + singleStepOffset * vec2(0.0, 10.0);","blurCoordinates[2] = vUv.xy + singleStepOffset * vec2(-10.0, 0.0);","blurCoordinates[3] = vUv.xy + singleStepOffset * vec2(10.0, 0.0);","blurCoordinates[4] = vUv.xy + singleStepOffset * vec2(5.0, -8.0);","blurCoordinates[5] = vUv.xy + singleStepOffset * vec2(5.0, 8.0);","blurCoordinates[6] = vUv.xy + singleStepOffset * vec2(-5.0, 8.0);","blurCoordinates[7] = vUv.xy + singleStepOffset * vec2(-5.0, -8.0);","blurCoordinates[8] = vUv.xy + singleStepOffset * vec2(8.0, -5.0);","blurCoordinates[9] = vUv.xy + singleStepOffset * vec2(8.0, 5.0);","blurCoordinates[10] = vUv.xy + singleStepOffset * vec2(-8.0, 5.0);","blurCoordinates[11] = vUv.xy + singleStepOffset * vec2(-8.0, -5.0);","blurCoordinates[12] = vUv.xy + singleStepOffset * vec2(0.0, -6.0);","blurCoordinates[13] = vUv.xy + singleStepOffset * vec2(0.0, 6.0);","blurCoordinates[14] = vUv.xy + singleStepOffset * vec2(6.0, 0.0);","blurCoordinates[15] = vUv.xy + singleStepOffset * vec2(-6.0, 0.0);","blurCoordinates[16] = vUv.xy + singleStepOffset * vec2(-4.0, -4.0);","blurCoordinates[17] = vUv.xy + singleStepOffset * vec2(-4.0, 4.0);","blurCoordinates[18] = vUv.xy + singleStepOffset * vec2(4.0, -4.0);","blurCoordinates[19] = vUv.xy + singleStepOffset * vec2(4.0, 4.0);","blurCoordinates[20] = vUv.xy + singleStepOffset * vec2(-2.0, -2.0);","blurCoordinates[21] = vUv.xy + singleStepOffset * vec2(-2.0, 2.0);","blurCoordinates[22] = vUv.xy + singleStepOffset * vec2(2.0, -2.0);","blurCoordinates[23] = vUv.xy + singleStepOffset * vec2(2.0, 2.0);","float sampleColor = centralColor.g * 22.0;","sampleColor += texture2D(texture, blurCoordinates[0]).g;","sampleColor += texture2D(texture, blurCoordinates[1]).g;","sampleColor += texture2D(texture, blurCoordinates[2]).g;","sampleColor += texture2D(texture, blurCoordinates[3]).g;","sampleColor += texture2D(texture, blurCoordinates[4]).g;","sampleColor += texture2D(texture, blurCoordinates[5]).g;","sampleColor += texture2D(texture, blurCoordinates[6]).g;","sampleColor += texture2D(texture, blurCoordinates[7]).g;","sampleColor += texture2D(texture, blurCoordinates[8]).g;","sampleColor += texture2D(texture, blurCoordinates[9]).g;","sampleColor += texture2D(texture, blurCoordinates[10]).g;","sampleColor += texture2D(texture, blurCoordinates[11]).g;","sampleColor += texture2D(texture, blurCoordinates[12]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[13]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[14]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[15]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[16]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[17]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[18]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[19]).g * 2.0;","sampleColor += texture2D(texture, blurCoordinates[20]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[21]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[22]).g * 3.0;","sampleColor += texture2D(texture, blurCoordinates[23]).g * 3.0;","sampleColor = sampleColor / 62.0;","float highPass = centralColor.g - sampleColor + 0.5;","for(int i = 0; i < 5;i++){","highPass = hardLight(highPass);","}","float luminance = dot(centralColor, W);","float alpha = pow(luminance, params.r);","vec3 smoothColor = centralColor + (centralColor-vec3(highPass))*alpha*0.1;","smoothColor.r = clamp(pow(smoothColor.r, params.g),0.0,1.0);","smoothColor.g = clamp(pow(smoothColor.g, params.g),0.0,1.0);","smoothColor.b = clamp(pow(smoothColor.b, params.g),0.0,1.0);","vec3 screen = vec3(1.0) - (vec3(1.0)-smoothColor) * (vec3(1.0)-centralColor);","vec3 lighten = max(smoothColor, centralColor);","vec3 softLight = 2.0 * centralColor*smoothColor + centralColor*centralColor - 2.0 * centralColor*centralColor * smoothColor;","gl_FragColor = vec4(mix(centralColor, screen, alpha), 1.0);","gl_FragColor.rgb = mix(gl_FragColor.rgb, lighten, alpha);","gl_FragColor.rgb = mix(gl_FragColor.rgb, softLight, params.b);","vec3 satColor = gl_FragColor.rgb * saturateMatrix;","gl_FragColor.rgb = mix(gl_FragColor.rgb, satColor, params.a);","gl_FragColor.rgb = vec3(gl_FragColor.rgb + vec3(brightness));","}"].join("\n"));var e=Float32Array.BYTES_PER_ELEMENT,t=4*e;return this.gl.enableVertexAttribArray(this.currentProgram.attribute.pos),this.gl.vertexAttribPointer(this.currentProgram.attribute.pos,2,this.gl.FLOAT,!1,t,0),this.gl.enableVertexAttribArray(this.currentProgram.attribute.uv),this.gl.vertexAttribPointer(this.currentProgram.attribute.uv,2,this.gl.FLOAT,!1,t,2*e),this.currentProgram}},{key:"createGL",value:function(e){var t=e.getContext("webgl");if(t||e.getContext("experimental-webgl",{preserveDrawingBuffer:!0}),!t)throw"Couldn't get WebGL context";return t}},{key:"setBeautyParams",value:function(e){this.beautyParams=e}},{key:"reset",value:function(){this.applied=!1}}]),e}(),Va=function(e){return"number"==typeof e},Fa=function(){function r(){t(this,r),this.video=document.createElement("video"),this.video.loop=!0,this.video.autoplay=!0,this.canvas=document.createElement("canvas"),this.filter=new ja({canvas:this.canvas}),this.beautyParams={beauty:.5,brightness:.5,ruddy:.5},this.timeoutId=null,this.rafId=null,this.startTime=null,this.originTrack=null,this.beautyTrack=null,this.localStream=null,this.frameRate=null,this.disableStatus=!1}return i(r,[{key:"generateBeautyStream",value:function(e){var t=e.getVideoTrack();if(!t)throw new Error("Your localStream does not contain video track.");var r=this.generateBeautyTrack(t);return e.replaceTrack(r),this.localStream=e,e.setBeautyStatus&&e.setBeautyStatus(!0),e}},{key:"generateBeautyTrack",value:function(e){var t=this;this.reset();var r=e.getSettings();this.frameRate=r.frameRate,this.filter.setRect(r.width,r.height),this.setRect(r.width,r.height);var n=new MediaStream;n.addTrack(e),this.video.srcObject=n,this.video.play();var i=this.generateVideoTrackFromCanvasCapture(r.frameRate||15);return this.rafId&&cancelAnimationFrame(this.rafId),this.rafId=requestAnimationFrame((function(){t.startTime=(new Date).getTime(),t.render()})),this.installEvents(),this.setBeautyTrack({originTrack:e,beautyTrack:i}),this.originTrack=e,this.beautyTrack=i,i}},{key:"draw",value:function(){this.video&&this.video.readyState===this.video.HAVE_ENOUGH_DATA&&this.filter.apply(this.video)}},{key:"render",value:function(){var e=this,t=(new Date).getTime();t-this.startTime>1e3/this.frameRate&&(this.draw(),this.startTime=t),document.hidden?(clearTimeout(this.timeoutId),this.timeoutId=setTimeout((function(){e.render()}),1e3/this.frameRate)):(this.timeoutId&&clearTimeout(this.timeoutId),this.rafId&&cancelAnimationFrame(this.rafId),requestAnimationFrame(this.render.bind(this)))}},{key:"setBeautyParam",value:function(e){var t=e.beauty,r=e.brightness,n=e.ruddy;Va(t)&&(this.beautyParams.beauty=t),Va(r)&&(this.beautyParams.brightness=r),Va(n)&&(this.beautyParams.ruddy=n),this.filter.setBeautyParams(this.beautyParams),this.getClose()&&!this.disableStatus&&this.disable(),!this.getClose()&&this.disableStatus&&this.enable()}},{key:"setRect",value:function(e,t){var r=e||640,n=t||480;this.video.height=n,this.video.width=r,this.canvas.height=n,this.canvas.width=r}},{key:"reset",value:function(){cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.video.pause(),this.filter.reset(),this.beautyTrack&&this.beautyTrack.stop(),this.originTrack&&this.originTrack.stop()}},{key:"destroy",value:function(){cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.canvas&&(this.canvas.width=0,this.canvas.height=0,this.canvas.remove(),delete this.canvas),this.video&&(this.video.pause(),this.video.removeAttribute("srcObject"),this.video.removeAttribute("src"),this.video.load(),this.video.width=0,this.video.height=0,this.video.remove(),delete this.video),this.beautyTrack&&this.beautyTrack.stop(),this.originTrack&&this.originTrack.stop(),this.uninstallEvents()}},{key:"generateVideoTrackFromCanvasCapture",value:function(e){return this.canvas.captureStream(e).getVideoTracks()[0]}},{key:"setBeautyTrack",value:function(t){var r=t.originTrack,n=t.beautyTrack;e&&(e.beautyTrackMap||(e.beautyTrackMap=new Map),e.beautyTrackMap.set(n.id,{originTrack:r,beautyTrack:n,param:this.beautyParams,pluginInstance:this}))}},{key:"disable",value:function(){this.localStream&&this.originTrack&&(this.localStream.replaceTrack(this.originTrack),cancelAnimationFrame(this.rafId),clearTimeout(this.timeoutId),this.disableStatus=!0)}},{key:"enable",value:function(){this.localStream&&this.beautyTrack&&(this.localStream.replaceTrack(this.beautyTrack),this.render(),this.disableStatus=!1)}},{key:"installEvents",value:function(){document.addEventListener("visibilitychange",this.render.bind(this))}},{key:"uninstallEvents",value:function(){document.removeEventListener("visibilitychange",this.render.bind(this))}},{key:"getClose",value:function(){return 0===this.beautyParams.beauty&&0===this.beautyParams.brightness&&0===this.beautyParams.ruddy}}]),r}();return e&&(e.getRTCBeautyPlugin=function(){return new Fa}),Fa}(Ci.XRTC);var Ti=RTCBeautyPlugin,wi=function(){function e(t){le(this,e),this.logger=t,this.beautyParams={beauty:.5,brightness:.5,ruddy:.5},this.isBeautyStreamSupported=Pt(),this.isBeautyStreamSupported&&(this.rtcBeautyPlugin=new Ti)}return pe(e,[{key:"generateBeautyStream",value:function(e){return this.logger.info("generate beauty stream ,streamId ".concat(e.streamId)),this.isBeautyStreamSupported?this.rtcBeautyPlugin.generateBeautyStream(e):e}},{key:"setBeautyParam",value:function(e){var t,r;if(!this.isBeautyStreamSupported)return this.logger.warn("The current browser does not support beauty");var n=null===(t=this.rtcBeautyPlugin)||void 0===t||null===(r=t.localStream)||void 0===r?void 0:r.getVideoTrack();if(null==n||!n.enabled)return this.logger.warn("cannot set beauty param when video track is muted");var i,o=e.beauty,a=e.brightness,s=e.ruddy;return o>=0&&o<=1&&a>=0&&a<=1&&s>=0&&s<=1?(this.beautyParams=e,this.logger.info("set beauty param beauty:".concat(o,",brightness:").concat(a,",ruddy:").concat(s)),o>.5&&(this.beautyParams.beauty=Number((.6*(o-.5)+.5).toFixed(2))),null===(i=this.rtcBeautyPlugin)||void 0===i?void 0:i.setBeautyParam(this.beautyParams)):void 0}},{key:"destroy",value:function(){var e=this,t=setTimeout((function(){clearTimeout(t),e.rtcBeautyPlugin=null,e.logger=null,e.beautyParams=null}),100);return this.logger.info("destroy beauty"),this.rtcBeautyPlugin&&this.rtcBeautyPlugin.destroy()}},{key:"updateBeautyStream",value:function(e){if(!this.isBeautyStreamSupported)return this.logger.warn("The current browser does not support beauty");this.logger.info("update beauty stream"),this.rtcBeautyPlugin.reset();var t=e.getVideoTrack();t.enabled=!0,t&&(this.rtcBeautyPlugin.generateBeautyTrack(t),this.rtcBeautyPlugin.enable())}}]),e}(),_i=new yn;_i.info("browserDetails.browser",Ei.browserDetails),window.Logger=_i;var ki,Ri,Ii,Oi,Pi,Ai,xi,Li,Mi,Di,Ui,Ni,ji,Vi,Fi,Wi,Bi,Gi,Hi,zi={VERSION:"5.2024.2.1_00_hotfix2",Logger:_i,checkSystemRequirements:wt,isScreenShareSupported:function(){return!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia)},isSmallStreamSupported:Ot,isBeautyStreamSupported:Pt,getDevices:_t,getCameras:kt,getMicrophones:Rt,getSpeakers:It,createClient:function(e){return _i.info("create client with config",JSON.stringify(e)),new mn(e,_i)},createStream:function(e){return _i.info("create stream with config",JSON.stringify(e)),new Gt(e,_i)},createBeauty:function(){return _i.info("create beauty"),new wi(_i)}},Ki=function(){function e(){var t;return D(this,e),t=P(this,e),ki.set(B(t),!1),Ri.set(B(t),!1),Ii.set(B(t),1),Oi.set(B(t),void 0),Pi.set(B(t),void 0),Ai.set(B(t),void 0),xi.set(B(t),void 0),Li.set(B(t),void 0),Mi.set(B(t),!1),Di.set(B(t),void 0),Ui.set(B(t),void 0),Ni.set(B(t),void 0),ji.set(B(t),!1),Vi.set(B(t),(function(e){var r;try{switch(e.state){case"PLAYING":"unmute"===e.reason&&"video"===e.type?t.emit(q.playing):"playing"===e.reason&&(z(B(t),ji,"f")||(K(B(t),ji,!0,"f"),t.emit(q.play)),"audio"===e.type&&t.emit(q.playing));break;case"PAUSED":"mute"===e.reason&&"video"===e.type?t.emit(q.waiting):"video"===e.type&&(null===(r=z(B(t),Ai,"f"))||void 0===r||r.resume())}}catch(e){console.error(e)}})),Fi.set(B(t),(function(){t.emit(q.stop)})),Wi.set(B(t),(function(){var e,r,n,i;null===(e=z(B(t),xi,"f"))||void 0===e||e.off("error",z(B(t),Di,"f")),null===(r=z(B(t),xi,"f"))||void 0===r||r.off("stream-added",z(B(t),Ui,"f")),null===(n=z(B(t),xi,"f"))||void 0===n||n.off("stream-subscribed",z(B(t),Ni,"f")),z(B(t),Mi,"f")&&(null===(i=z(B(t),xi,"f"))||void 0===i||i.leave().catch((function(){}))),z(B(t),Bi,"f").call(B(t)),zi.Logger.disableUploadLog()})),Bi.set(B(t),(function(){var e,r,n;null===(e=z(B(t),Ai,"f"))||void 0===e||e.stop(),z(B(t),xi,"f")&&z(B(t),Ai,"f")&&(null===(n=(r=z(B(t),xi,"f")).unsubscribe)||void 0===n||n.call(r,z(B(t),Ai,"f")))})),zi.Logger.setLogLevel(zi.Logger.LogLevel.WARN),t}return j(e,X),N(e,[{key:"muted",get:function(){var e=z(this,Ri,"f");if(z(this,Ai,"f"))try{e=z(this,Ai,"f").getAudioMuted()}catch(e){}return e},set:function(e){K(this,Ri,e,"f"),z(this,Ai,"f")&&(e?z(this,Ai,"f").muteAudio():(z(this,Ai,"f").resume(),z(this,Ai,"f").unmuteAudio()))}},{key:"volume",get:function(){return z(this,Ii,"f")},set:function(e){e>1&&(e=1),K(this,Ii,e,"f"),z(this,Ai,"f")&&z(this,Ai,"f").setAudioVolume(e)}},{key:"stream",set:function(e){K(this,Oi,e,"f")}},{key:"videoWrapper",set:function(e){K(this,Pi,e,"f")}},{key:"play",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f,m=this;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(z(this,Oi,"f")){e.next=2;break}return e.abrupt("return",Promise.reject(new Q(ee.message,ee.code,Y.MediaError)));case 2:return K(this,ji,!1,"f"),t=z(this,Oi,"f"),r=t.server,n=t.auth,i=t.appid,o=t.userId,a=t.roomId,s=K(this,xi,zi.createClient({wsUrl:r,mode:"live",sdkAppId:i,userId:o,userSig:n}),"f"),c=Z(),u=c.promise,d=c.controller,l=!1,h=Z(),p=h.promise,f=h.controller,K(this,Ni,(function(e){var t,r,n=e.stream,i=null;n.on("player-state-changed",(function(e){return H(m,void 0,void 0,x().mark((function t(){var r=this;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return l||"PLAYING"!==e.state||i||(i=setTimeout((function(){var e;l=!0,null===(e=d.resolve)||void 0===e||e.call(d,16451)}),500)),t.next=3,u;case 3:K(this,Li,setTimeout((function(){z(r,Vi,"f").call(r,e)})),"f");case 4:case"end":return t.stop()}}),t,this)})))})),null==n||n.on("error",(function(e){var t,r,n=null==e?void 0:e.getCode();16451===n?l?(m.emit(q.playNotAllowed,te.code),K(m,ki,!0,"f"),m.muted=!0):(l=!0,null===(t=d.resolve)||void 0===t||t.call(d,16451)):(l||(l=!0,null===(r=d.reject)||void 0===r||r.call(d,n)),m.emit(q.play,new Q(ne.message+" ".concat(null==e?void 0:e.getCode()),ne.code,Y.MediaError)))})),null===(r=null===(t=null==n?void 0:n.play(z(m,Pi,"f"),{isEleLisenter:!1,objectFit:"cover"}).then((function(){n.setAudioVolume(z(m,Ii,"f")),n.resize(),z(m,Ri,"f")?n.muteAudio():n.unmuteAudio()})).then((function(){var e;l=!0,null===(e=d.resolve)||void 0===e||e.call(d,!0)})))||void 0===t?void 0:t.catch)||void 0===r||r.call(t,(function(e){var t,r;l=!0,16451===e.getCode()?null===(t=d.resolve)||void 0===t||t.call(d,16451):(z(m,Wi,"f").call(m),null===(r=d.reject)||void 0===r||r.call(d,e))}))}),"f"),K(this,Di,(function(e){var t;console.error("client error observed: ",e.getCode()),257===e.getCode()&&(null===(t=f.reject)||void 0===t||t.call(f,new Q(re.message,re.code,Y.MediaError)),m.emit(q.error,new Q(re.message,re.code,Y.MediaError)),z(m,Wi,"f").call(m))}),"f"),s.on("stream-subscribed",z(this,Ni,"f")),s.on("error",z(this,Di,"f")),K(this,Ui,(function(e){var t=K(m,Ai,e.stream,"f");t.setPlayBackground("#00000000"),z(m,xi,"f").subscribe(t,{audio:!0,video:!0}).then((function(){var e;null===(e=f.resolve)||void 0===e||e.call(f,void 0)})).catch((function(e){var t;z(m,Wi,"f").call(m),null===(t=f.reject)||void 0===t||t.call(f,e)}))}),"f"),s.on("stream-added",z(this,Ui,"f")),zi.Logger.enableUploadLog(),e.prev=15,this.emit(q.waiting),e.next=19,s.join({roomId:a,role:"audience"}).then((function(){K(m,Mi,!0,"f")})).catch((function(e){return z(m,Wi,"f").call(m),Promise.reject(e)}));case 19:return e.next=21,p;case 21:return e.next=23,u;case 23:16451===e.sent&&(this.emit(q.playNotAllowed,te.code),K(this,ki,!0,"f"),this.muted=!0),e.next=32;break;case 27:throw e.prev=27,e.t0=e.catch(15),this.emit(q.stop),clearTimeout(z(this,Li,"f")),e.t0;case 32:case"end":return e.stop()}}),e,this,[[15,27]])})))}},{key:"resume",value:function(){z(this,Ai,"f")&&(z(this,ki,"f")&&(this.muted=!1,K(this,ki,!1,"f")),z(this,Ai,"f").resume())}},{key:"stop",value:function(){clearTimeout(z(this,Li,"f")),z(this,Fi,"f").call(this),z(this,Wi,"f").call(this),K(this,Mi,!1,"f"),K(this,Ri,!1,"f"),K(this,ji,!1,"f"),K(this,ki,!1,"f")}},{key:"setSinkId",value:function(e){return H(this,void 0,void 0,x().mark((function t(){var r;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(r=z(this,Ai,"f"))||void 0===r?void 0:r.setAudioOutput(e);case 2:case"end":return t.stop()}}),t,this)})))}},{key:"getSinkId",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t,r,n;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,null===(t=z(this,Ai,"f"))||void 0===t?void 0:t.getInuseSpeaker();case 2:return n=e.sent,e.abrupt("return",(null===(r=null==n?void 0:n.speaker)||void 0===r?void 0:r.deviceId)||"");case 4:case"end":return e.stop()}}),e,this)})))}},{key:"destroy",value:function(){this.stop(),G(V(e.prototype),"destroy",this).call(this)}},{key:"resize",value:function(){z(this,Ai,"f")&&z(this,Ai,"f").resize()}}]),e}();function Ji(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}ki=new WeakMap,Ri=new WeakMap,Ii=new WeakMap,Oi=new WeakMap,Pi=new WeakMap,Ai=new WeakMap,xi=new WeakMap,Li=new WeakMap,Mi=new WeakMap,Di=new WeakMap,Ui=new WeakMap,Ni=new WeakMap,ji=new WeakMap,Vi=new WeakMap,Fi=new WeakMap,Wi=new WeakMap,Bi=new WeakMap,function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){if(!s&&Ji)return Ji(a);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var u=r[a]={exports:{}};t[a][0].call(u.exports,(function(e){return i(t[a][1][e]||e)}),u,u.exports,e,t,r,n)}return r[a].exports}for(var o=Ji,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(e,t,r){var n=(0,e("./adapter_factory.js").adapterFactory)({window:window});t.exports=n},{"./adapter_factory.js":2}],2:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.adapterFactory=function(){var e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).window,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},r=n.log,u=n.detectBrowser(e),d={browserDetails:u,commonShim:c,extractVersion:n.extractVersion,disableLog:n.disableLog,disableWarnings:n.disableWarnings};switch(u.browser){case"chrome":if(!i||!i.shimPeerConnection||!t.shimChrome)return r("Chrome shim is not included in this adapter release."),d;r("adapter.js shimming chrome."),d.browserShim=i,i.shimGetUserMedia(e),i.shimMediaStream(e),i.shimPeerConnection(e),i.shimOnTrack(e),i.shimAddTrackRemoveTrack(e),i.shimGetSendersWithDtmf(e),i.shimGetStats(e),i.shimSenderReceiverGetStats(e),i.fixNegotiationNeeded(e),c.shimRTCIceCandidate(e),c.shimConnectionState(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e),c.removeAllowExtmapMixed(e);break;case"firefox":if(!a||!a.shimPeerConnection||!t.shimFirefox)return r("Firefox shim is not included in this adapter release."),d;r("adapter.js shimming firefox."),d.browserShim=a,a.shimGetUserMedia(e),a.shimPeerConnection(e),a.shimOnTrack(e),a.shimRemoveStream(e),a.shimSenderGetStats(e),a.shimReceiverGetStats(e),a.shimRTCDataChannel(e),a.shimAddTransceiver(e),a.shimCreateOffer(e),a.shimCreateAnswer(e),c.shimRTCIceCandidate(e),c.shimConnectionState(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e);break;case"edge":if(!o||!o.shimPeerConnection||!t.shimEdge)return r("MS edge shim is not included in this adapter release."),d;r("adapter.js shimming edge."),d.browserShim=o,o.shimGetUserMedia(e),o.shimGetDisplayMedia(e),o.shimPeerConnection(e),o.shimReplaceTrack(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e);break;case"safari":if(!s||!t.shimSafari)return r("Safari shim is not included in this adapter release."),d;r("adapter.js shimming safari."),d.browserShim=s,s.shimRTCIceServerUrls(e),s.shimCreateOfferLegacy(e),s.shimCallbacksAPI(e),s.shimLocalStreamsAPI(e),s.shimRemoteStreamsAPI(e),s.shimTrackEventTransceiver(e),s.shimGetUserMedia(e),c.shimRTCIceCandidate(e),c.shimMaxMessageSize(e),c.shimSendThrowTypeError(e),c.removeAllowExtmapMixed(e);break;default:r("Unsupported browser!")}return d};var n=u(e("./utils")),i=u(e("./chrome/chrome_shim")),o=u(e("./edge/edge_shim")),a=u(e("./firefox/firefox_shim")),s=u(e("./safari/safari_shim")),c=u(e("./common_shim"));function u(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,"./utils":15}],3:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimMediaStream=function(e){e.MediaStream=e.MediaStream||e.webkitMediaStream},r.shimOnTrack=function(e){if("object"!==(void 0===e?"undefined":n(e))||!e.RTCPeerConnection||"ontrack"in e.RTCPeerConnection.prototype)a.wrapPeerConnectionEvent(e,"track",(function(e){return e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e}));else{Object.defineProperty(e.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(e){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=e)},enumerable:!0,configurable:!0});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var r=this;return this._ontrackpoly||(this._ontrackpoly=function(t){t.stream.addEventListener("addtrack",(function(n){var i=void 0;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.track.id})):{track:n.track};var o=new Event("track");o.track=n.track,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],r.dispatchEvent(o)})),t.stream.getTracks().forEach((function(n){var i=void 0;i=e.RTCPeerConnection.prototype.getReceivers?r.getReceivers().find((function(e){return e.track&&e.track.id===n.id})):{track:n};var o=new Event("track");o.track=n,o.receiver=i,o.transceiver={receiver:i},o.streams=[t.stream],r.dispatchEvent(o)}))},this.addEventListener("addstream",this._ontrackpoly)),t.apply(this,arguments)}}},r.shimGetSendersWithDtmf=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&!("getSenders"in e.RTCPeerConnection.prototype)&&"createDTMFSender"in e.RTCPeerConnection.prototype){var t=function(e,t){return{track:t,get dtmf(){return void 0===this._dtmf&&("audio"===t.kind?this._dtmf=e.createDTMFSender(t):this._dtmf=null),this._dtmf},_pc:e}};if(!e.RTCPeerConnection.prototype.getSenders){e.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};var r=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,n){var i=r.apply(this,arguments);return i||(i=t(this,e),this._senders.push(i)),i};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){i.apply(this,arguments);var t=this._senders.indexOf(e);-1!==t&&this._senders.splice(t,1)}}var o=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._senders=this._senders||[],o.apply(this,[e]),e.getTracks().forEach((function(e){r._senders.push(t(r,e))}))};var a=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._senders=this._senders||[],a.apply(this,[e]),e.getTracks().forEach((function(e){var r=t._senders.find((function(t){return t.track===e}));r&&t._senders.splice(t._senders.indexOf(r),1)}))}}else if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&"getSenders"in e.RTCPeerConnection.prototype&&"createDTMFSender"in e.RTCPeerConnection.prototype&&e.RTCRtpSender&&!("dtmf"in e.RTCRtpSender.prototype)){var s=e.RTCPeerConnection.prototype.getSenders;e.RTCPeerConnection.prototype.getSenders=function(){var e=this,t=s.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t},Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}},r.shimGetStats=function(e){if(e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=this,r=Array.prototype.slice.call(arguments),n=r[0],i=r[1],o=r[2];if(arguments.length>0&&"function"==typeof n)return t.apply(this,arguments);if(0===t.length&&(0===arguments.length||"function"!=typeof n))return t.apply(this,[]);var a=function(e){var t={};return e.result().forEach((function(e){var r={id:e.id,timestamp:e.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[e.type]||e.type};e.names().forEach((function(t){r[t]=e.stat(t)})),t[r.id]=r})),t},s=function(e){return new Map(Object.keys(e).map((function(t){return[t,e[t]]})))};if(arguments.length>=2){var c=function(e){i(s(a(e)))};return t.apply(this,[c,n])}return new Promise((function(r,n){t.apply(e,[function(e){r(s(a(e)))},n])})).then(i,o)}}},r.shimSenderReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&e.RTCRtpReceiver){if(!("getStats"in e.RTCRtpSender.prototype)){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!0)}))}}if(!("getStats"in e.RTCRtpReceiver.prototype)){var i=e.RTCPeerConnection.prototype.getReceivers;i&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,t=i.apply(this,[]);return t.forEach((function(t){return t._pc=e})),t}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){var e=this;return this._pc.getStats().then((function(t){return a.filterStats(t,e.track,!1)}))}}if("getStats"in e.RTCRtpSender.prototype&&"getStats"in e.RTCRtpReceiver.prototype){var o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof e.MediaStreamTrack){var t=arguments[0],r=void 0,n=void 0,i=void 0;return this.getSenders().forEach((function(e){e.track===t&&(r?i=!0:r=e)})),this.getReceivers().forEach((function(e){return e.track===t&&(n?i=!0:n=e),e.track===t})),i||r&&n?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):r?r.getStats():n?n.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return o.apply(this,arguments)}}}},r.shimAddTrackRemoveTrackWithNative=c,r.shimAddTrackRemoveTrack=function(e){if(e.RTCPeerConnection){var t=a.detectBrowser(e);if(e.RTCPeerConnection.prototype.addTrack&&t.version>=65)return c(e);var r=e.RTCPeerConnection.prototype.getLocalStreams;e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this,t=r.apply(this);return this._reverseStreams=this._reverseStreams||{},t.map((function(t){return e._reverseStreams[t.id]}))};var n=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(t){var r=this;if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},t.getTracks().forEach((function(e){if(r.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")})),!this._reverseStreams[t.id]){var i=new e.MediaStream(t.getTracks());this._streams[t.id]=i,this._reverseStreams[i.id]=t,t=i}n.apply(this,[t])};var i=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},i.apply(this,[this._streams[e.id]||e]),delete this._reverseStreams[this._streams[e.id]?this._streams[e.id].id:e.id],delete this._streams[e.id]},e.RTCPeerConnection.prototype.addTrack=function(t,r){var n=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var i=[].slice.call(arguments,1);if(1!==i.length||!i[0].getTracks().find((function(e){return e===t})))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");var o=this.getSenders().find((function(e){return e.track===t}));if(o)throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};var a=this._streams[r.id];if(a)a.addTrack(t),Promise.resolve().then((function(){n.dispatchEvent(new Event("negotiationneeded"))}));else{var s=new e.MediaStream([t]);this._streams[r.id]=s,this._reverseStreams[s.id]=r,this.addStream(s)}return this.getSenders().find((function(e){return e.track===t}))},["createOffer","createAnswer"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=s({},t,(function(){var e=this,t=arguments;return arguments.length&&"function"==typeof arguments[0]?r.apply(this,[function(r){var n=d(e,r);t[0].apply(null,[n])},function(e){t[1]&&t[1].apply(null,e)},arguments[2]]):r.apply(this,arguments).then((function(t){return d(e,t)}))}));e.RTCPeerConnection.prototype[t]=n[t]}));var o=e.RTCPeerConnection.prototype.setLocalDescription;e.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=l(this,arguments[0]),o.apply(this,arguments)):o.apply(this,arguments)};var u=Object.getOwnPropertyDescriptor(e.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(e.RTCPeerConnection.prototype,"localDescription",{get:function(){var e=u.get.apply(this);return""===e.type?e:d(this,e)}}),e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!e._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(e._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var r=void 0;Object.keys(this._streams).forEach((function(n){t._streams[n].getTracks().find((function(t){return e.track===t}))&&(r=t._streams[n])})),r&&(1===r.getTracks().length?this.removeStream(this._reverseStreams[r.id]):r.removeTrack(e.track),this.dispatchEvent(new Event("negotiationneeded")))}}function d(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(i.id,"g"),n.id)})),new RTCSessionDescription({type:t.type,sdp:r})}function l(e,t){var r=t.sdp;return Object.keys(e._reverseStreams||[]).forEach((function(t){var n=e._reverseStreams[t],i=e._streams[n.id];r=r.replace(new RegExp(n.id,"g"),i.id)})),new RTCSessionDescription({type:t.type,sdp:r})}},r.shimPeerConnection=function(e){var t=a.detectBrowser(e);if(!e.RTCPeerConnection&&e.webkitRTCPeerConnection&&(e.RTCPeerConnection=e.webkitRTCPeerConnection),e.RTCPeerConnection){t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=s({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=n[t]}));var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?t.version<78&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}},r.fixNegotiationNeeded=function(e){a.wrapPeerConnectionEvent(e,"negotiationneeded",(function(e){if("stable"===e.target.signalingState)return e}))};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js"));function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function c(e){e.RTCPeerConnection.prototype.getLocalStreams=function(){var e=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map((function(t){return e._shimmedLocalStreams[t][0]}))};var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addTrack=function(e,r){if(!r)return t.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var n=t.apply(this,arguments);return this._shimmedLocalStreams[r.id]?-1===this._shimmedLocalStreams[r.id].indexOf(n)&&this._shimmedLocalStreams[r.id].push(n):this._shimmedLocalStreams[r.id]=[r,n],n};var r=e.RTCPeerConnection.prototype.addStream;e.RTCPeerConnection.prototype.addStream=function(e){var t=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{},e.getTracks().forEach((function(e){if(t.getSenders().find((function(t){return t.track===e})))throw new DOMException("Track already exists.","InvalidAccessError")}));var n=this.getSenders();r.apply(this,arguments);var i=this.getSenders().filter((function(e){return-1===n.indexOf(e)}));this._shimmedLocalStreams[e.id]=[e].concat(i)};var n=e.RTCPeerConnection.prototype.removeStream;e.RTCPeerConnection.prototype.removeStream=function(e){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[e.id],n.apply(this,arguments)};var i=e.RTCPeerConnection.prototype.removeTrack;e.RTCPeerConnection.prototype.removeTrack=function(e){var t=this;return this._shimmedLocalStreams=this._shimmedLocalStreams||{},e&&Object.keys(this._shimmedLocalStreams).forEach((function(r){var n=t._shimmedLocalStreams[r].indexOf(e);-1!==n&&t._shimmedLocalStreams[r].splice(n,1),1===t._shimmedLocalStreams[r].length&&delete t._shimmedLocalStreams[r]})),i.apply(this,arguments)}}},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&("function"==typeof t?e.navigator.mediaDevices.getDisplayMedia=function(r){return t(r).then((function(t){var n=r.video&&r.video.width,i=r.video&&r.video.height,o=r.video&&r.video.frameRate;return r.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxFrameRate:o||3}},n&&(r.video.mandatory.maxWidth=n),i&&(r.video.mandatory.maxHeight=i),e.navigator.mediaDevices.getUserMedia(r)}))}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))}},{}],5:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)};r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices){var r=i.detectBrowser(e),a=function(e){if("object"!==(void 0===e?"undefined":n(e))||e.mandatory||e.optional)return e;var t={};return Object.keys(e).forEach((function(r){if("require"!==r&&"advanced"!==r&&"mediaSource"!==r){var i="object"===n(e[r])?e[r]:{ideal:e[r]};void 0!==i.exact&&"number"==typeof i.exact&&(i.min=i.max=i.exact);var o=function(e,t){return e?e+t.charAt(0).toUpperCase()+t.slice(1):"deviceId"===t?"sourceId":t};if(void 0!==i.ideal){t.optional=t.optional||[];var a={};"number"==typeof i.ideal?(a[o("min",r)]=i.ideal,t.optional.push(a),(a={})[o("max",r)]=i.ideal,t.optional.push(a)):(a[o("",r)]=i.ideal,t.optional.push(a))}void 0!==i.exact&&"number"!=typeof i.exact?(t.mandatory=t.mandatory||{},t.mandatory[o("",r)]=i.exact):["min","max"].forEach((function(e){void 0!==i[e]&&(t.mandatory=t.mandatory||{},t.mandatory[o(e,r)]=i[e])}))}})),e.advanced&&(t.optional=(t.optional||[]).concat(e.advanced)),t},s=function(e,i){if(r.version>=61)return i(e);if((e=JSON.parse(JSON.stringify(e)))&&"object"===n(e.audio)){var s=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])};s((e=JSON.parse(JSON.stringify(e))).audio,"autoGainControl","googAutoGainControl"),s(e.audio,"noiseSuppression","googNoiseSuppression"),e.audio=a(e.audio)}if(e&&"object"===n(e.video)){var c=e.video.facingMode;c=c&&("object"===(void 0===c?"undefined":n(c))?c:{ideal:c});var u=r.version<66;if(c&&("user"===c.exact||"environment"===c.exact||"user"===c.ideal||"environment"===c.ideal)&&(!t.mediaDevices.getSupportedConstraints||!t.mediaDevices.getSupportedConstraints().facingMode||u)){delete e.video.facingMode;var d=void 0;if("environment"===c.exact||"environment"===c.ideal?d=["back","rear"]:"user"!==c.exact&&"user"!==c.ideal||(d=["front"]),d)return t.mediaDevices.enumerateDevices().then((function(t){var r=(t=t.filter((function(e){return"videoinput"===e.kind}))).find((function(e){return d.some((function(t){return e.label.toLowerCase().includes(t)}))}));return!r&&t.length&&d.includes("back")&&(r=t[t.length-1]),r&&(e.video.deviceId=c.exact?{exact:r.deviceId}:{ideal:r.deviceId}),e.video=a(e.video),o("chrome: "+JSON.stringify(e)),i(e)}))}e.video=a(e.video)}return o("chrome: "+JSON.stringify(e)),i(e)},c=function(e){return r.version>=64?e:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[e.name]||e.name,message:e.message,constraint:e.constraint||e.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};if(t.getUserMedia=function(e,r,n){s(e,(function(e){t.webkitGetUserMedia(e,r,(function(e){n&&n(c(e))}))}))}.bind(t),t.mediaDevices.getUserMedia){var u=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return s(e,(function(e){return u(e).then((function(t){if(e.audio&&!t.getAudioTracks().length||e.video&&!t.getVideoTracks().length)throw t.getTracks().forEach((function(e){e.stop()})),new DOMException("","NotFoundError");return t}),(function(e){return Promise.reject(c(e))}))}))}}}};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils.js")),o=i.log},{"../utils.js":15}],6:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)};r.shimRTCIceCandidate=function(e){if(!(!e.RTCIceCandidate||e.RTCIceCandidate&&"foundation"in e.RTCIceCandidate.prototype)){var t=e.RTCIceCandidate;e.RTCIceCandidate=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.candidate&&0===e.candidate.indexOf("a=")&&((e=JSON.parse(JSON.stringify(e))).candidate=e.candidate.substr(2)),e.candidate&&e.candidate.length){var r=new t(e),i=o.default.parseCandidate(e.candidate),a=Object.assign(r,i);return a.toJSON=function(){return{candidate:a.candidate,sdpMid:a.sdpMid,sdpMLineIndex:a.sdpMLineIndex,usernameFragment:a.usernameFragment}},a}return new t(e)},e.RTCIceCandidate.prototype=t.prototype,a.wrapPeerConnectionEvent(e,"icecandidate",(function(t){return t.candidate&&Object.defineProperty(t,"candidate",{value:new e.RTCIceCandidate(t.candidate),writable:"false"}),t}))}},r.shimMaxMessageSize=function(e){if(e.RTCPeerConnection){var t=a.detectBrowser(e);"sctp"in e.RTCPeerConnection.prototype||Object.defineProperty(e.RTCPeerConnection.prototype,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp}});var r=function(e){if(!e||!e.sdp)return!1;var t=o.default.splitSections(e.sdp);return t.shift(),t.some((function(e){var t=o.default.parseMLine(e);return t&&"application"===t.kind&&-1!==t.protocol.indexOf("SCTP")}))},n=function(e){var t=e.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===t||t.length<2)return-1;var r=parseInt(t[1],10);return r!=r?-1:r},i=function(e){var r=65536;return"firefox"===t.browser&&(r=t.version<57?-1===e?16384:2147483637:t.version<60?57===t.version?65535:65536:2147483637),r},s=function(e,r){var n=65536;"firefox"===t.browser&&57===t.version&&(n=65535);var i=o.default.matchPrefix(e.sdp,"a=max-message-size:");return i.length>0?n=parseInt(i[0].substr(19),10):"firefox"===t.browser&&-1!==r&&(n=2147483637),n},c=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,"chrome"===t.browser&&t.version>=76&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return void 0===this._sctp?null:this._sctp},enumerable:!0,configurable:!0}),r(arguments[0])){var e=n(arguments[0]),o=i(e),a=s(arguments[0],e),u=void 0;u=0===o&&0===a?Number.POSITIVE_INFINITY:0===o||0===a?Math.max(o,a):Math.min(o,a);var d={};Object.defineProperty(d,"maxMessageSize",{get:function(){return u}}),this._sctp=d}return c.apply(this,arguments)}}},r.shimSendThrowTypeError=function(e){if(e.RTCPeerConnection&&"createDataChannel"in e.RTCPeerConnection.prototype){var t=e.RTCPeerConnection.prototype.createDataChannel;e.RTCPeerConnection.prototype.createDataChannel=function(){var e=t.apply(this,arguments);return r(e,this),e},a.wrapPeerConnectionEvent(e,"datachannel",(function(e){return r(e.channel,e.target),e}))}function r(e,t){var r=e.send;e.send=function(){var n=arguments[0],i=n.length||n.size||n.byteLength;if("open"===e.readyState&&t.sctp&&i>t.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+t.sctp.maxMessageSize+" bytes)");return r.apply(e,arguments)}}},r.shimConnectionState=function(e){if(e.RTCPeerConnection&&!("connectionState"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype;Object.defineProperty(t,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(t,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(e){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),e&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=e)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach((function(e){var r=t[e];t[e]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=function(e){var t=e.target;if(t._lastConnectionState!==t.connectionState){t._lastConnectionState=t.connectionState;var r=new Event("connectionstatechange",e);t.dispatchEvent(r)}return e},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),r.apply(this,arguments)}}))}},r.removeAllowExtmapMixed=function(e){if(e.RTCPeerConnection){var t=a.detectBrowser(e);if(!("chrome"===t.browser&&t.version>=71)){var r=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(e){return e&&e.sdp&&-1!==e.sdp.indexOf("\na=extmap-allow-mixed")&&(e.sdp=e.sdp.split("\n").filter((function(e){return"a=extmap-allow-mixed"!==e.trim()})).join("\n")),r.apply(this,arguments)}}}};var i,o=(i=e("sdp"))&&i.__esModule?i:{default:i},a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("./utils"))},{"./utils":15,sdp:17}],7:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var n=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return n.shimGetUserMedia}});var i=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return i.shimGetDisplayMedia}}),r.shimPeerConnection=function(e){var t=a.detectBrowser(e);if(e.RTCIceGatherer&&(e.RTCIceCandidate||(e.RTCIceCandidate=function(e){return e}),e.RTCSessionDescription||(e.RTCSessionDescription=function(e){return e}),t.version<15025)){var r=Object.getOwnPropertyDescriptor(e.MediaStreamTrack.prototype,"enabled");Object.defineProperty(e.MediaStreamTrack.prototype,"enabled",{set:function(e){r.set.call(this,e);var t=new Event("enabled");t.enabled=e,this.dispatchEvent(t)}})}!e.RTCRtpSender||"dtmf"in e.RTCRtpSender.prototype||Object.defineProperty(e.RTCRtpSender.prototype,"dtmf",{get:function(){return void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new e.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null)),this._dtmf}}),e.RTCDtmfSender&&!e.RTCDTMFSender&&(e.RTCDTMFSender=e.RTCDtmfSender);var n=(0,c.default)(e,t.version);e.RTCPeerConnection=function(e){return e&&e.iceServers&&(e.iceServers=(0,s.filterIceServers)(e.iceServers,t.version),a.log("ICE servers after filtering:",e.iceServers)),new n(e)},e.RTCPeerConnection.prototype=n.prototype},r.shimReplaceTrack=function(e){!e.RTCRtpSender||"replaceTrack"in e.RTCRtpSender.prototype||(e.RTCRtpSender.prototype.replaceTrack=e.RTCRtpSender.prototype.setTrack)};var o,a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils")),s=e("./filtericeservers"),c=(o=e("rtcpeerconnection-shim"))&&o.__esModule?o:{default:o}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.filterIceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var t=e.urls||e.url;e.url&&!e.urls&&n.deprecated("RTCIceServer.url","RTCIceServer.urls");var i="string"==typeof t;return i&&(t=[t]),t=t.filter((function(e){if(0===e.indexOf("stun:"))return!1;var t=e.startsWith("turn")&&!e.startsWith("turn:[")&&e.includes("transport=udp");return t&&!r?(r=!0,!0):t&&!r})),delete e.url,e.urls=i?t[0]:t,!!t.length}}))};var n=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],9:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e){"getDisplayMedia"in e.navigator&&e.navigator.mediaDevices&&(e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||(e.navigator.mediaDevices.getDisplayMedia=e.navigator.getDisplayMedia.bind(e.navigator)))}},{}],10:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetUserMedia=function(e){var t=e&&e.navigator,r=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(e){return r(e).catch((function(e){return Promise.reject(function(e){return{name:{PermissionDeniedError:"NotAllowedError"}[e.name]||e.name,message:e.message,constraint:e.constraint,toString:function(){return this.name}}}(e))}))}}},{}],11:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=r.shimGetUserMedia=void 0;var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)},i=e("./getusermedia");Object.defineProperty(r,"shimGetUserMedia",{enumerable:!0,get:function(){return i.shimGetUserMedia}});var o=e("./getdisplaymedia");Object.defineProperty(r,"shimGetDisplayMedia",{enumerable:!0,get:function(){return o.shimGetDisplayMedia}}),r.shimOnTrack=function(e){"object"===(void 0===e?"undefined":n(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimPeerConnection=function(e){var t=a.detectBrowser(e);if("object"===(void 0===e?"undefined":n(e))&&(e.RTCPeerConnection||e.mozRTCPeerConnection)){if(!e.RTCPeerConnection&&e.mozRTCPeerConnection&&(e.RTCPeerConnection=e.mozRTCPeerConnection),t.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach((function(t){var r=e.RTCPeerConnection.prototype[t],n=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},t,(function(){return arguments[0]=new("addIceCandidate"===t?e.RTCIceCandidate:e.RTCSessionDescription)(arguments[0]),r.apply(this,arguments)}));e.RTCPeerConnection.prototype[t]=n[t]})),t.version<68){var r=e.RTCPeerConnection.prototype.addIceCandidate;e.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?arguments[0]&&""===arguments[0].candidate?Promise.resolve():r.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())}}var i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},o=e.RTCPeerConnection.prototype.getStats;e.RTCPeerConnection.prototype.getStats=function(){var e=Array.prototype.slice.call(arguments),r=e[0],n=e[1],a=e[2];return o.apply(this,[r||null]).then((function(e){if(t.version<53&&!n)try{e.forEach((function(e){e.type=i[e.type]||e.type}))}catch(t){if("TypeError"!==t.name)throw t;e.forEach((function(t,r){e.set(r,Object.assign({},t,{type:i[t.type]||t.type}))}))}return e})).then(n,a)}}},r.shimSenderGetStats=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpSender.prototype))){var t=e.RTCPeerConnection.prototype.getSenders;t&&(e.RTCPeerConnection.prototype.getSenders=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r});var r=e.RTCPeerConnection.prototype.addTrack;r&&(e.RTCPeerConnection.prototype.addTrack=function(){var e=r.apply(this,arguments);return e._pc=this,e}),e.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}},r.shimReceiverGetStats=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&e.RTCRtpSender&&(!e.RTCRtpSender||!("getStats"in e.RTCRtpReceiver.prototype))){var t=e.RTCPeerConnection.prototype.getReceivers;t&&(e.RTCPeerConnection.prototype.getReceivers=function(){var e=this,r=t.apply(this,[]);return r.forEach((function(t){return t._pc=e})),r}),a.wrapPeerConnectionEvent(e,"track",(function(e){return e.receiver._pc=e.srcElement,e})),e.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}},r.shimRemoveStream=function(e){e.RTCPeerConnection&&!("removeStream"in e.RTCPeerConnection.prototype)&&(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;a.deprecated("removeStream","removeTrack"),this.getSenders().forEach((function(r){r.track&&e.getTracks().includes(r.track)&&t.removeTrack(r)}))})},r.shimRTCDataChannel=function(e){e.DataChannel&&!e.RTCDataChannel&&(e.RTCDataChannel=e.DataChannel)},r.shimAddTransceiver=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.addTransceiver;t&&(e.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var e=arguments[1],r=e&&"sendEncodings"in e;r&&e.sendEncodings.forEach((function(e){if("rid"in e&&!/^[a-z0-9]{0,16}$/i.test(e.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in e&&!(parseFloat(e.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in e&&!(parseFloat(e.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")}));var n=t.apply(this,arguments);if(r){var i=n.sender,o=i.getParameters();"encodings"in o||(o.encodings=e.sendEncodings,this.setParametersPromises.push(i.setParameters(o).catch((function(){}))))}return n})}},r.shimCreateOffer=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}},r.shimCreateAnswer=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype.createAnswer;e.RTCPeerConnection.prototype.createAnswer=function(){var e=this,r=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then((function(){return t.apply(e,r)})).finally((function(){e.setParametersPromises=[]})):t.apply(this,arguments)}}};var a=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15,"./getdisplaymedia":12,"./getusermedia":13}],12:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.shimGetDisplayMedia=function(e,t){e.navigator.mediaDevices&&"getDisplayMedia"in e.navigator.mediaDevices||e.navigator.mediaDevices&&(e.navigator.mediaDevices.getDisplayMedia=function(r){if(!r||!r.video){var n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Promise.reject(n)}return!0===r.video?r.video={mediaSource:t}:r.video.mediaSource=t,e.navigator.mediaDevices.getUserMedia(r)})}},{}],13:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)};r.shimGetUserMedia=function(e){var t=i.detectBrowser(e),r=e&&e.navigator,o=e&&e.MediaStreamTrack;if(r.getUserMedia=function(e,t,n){i.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),r.mediaDevices.getUserMedia(e).then(t,n)},!(t.version>55&&"autoGainControl"in r.mediaDevices.getSupportedConstraints())){var a=function(e,t,r){t in e&&!(r in e)&&(e[r]=e[t],delete e[t])},s=r.mediaDevices.getUserMedia.bind(r.mediaDevices);if(r.mediaDevices.getUserMedia=function(e){return"object"===(void 0===e?"undefined":n(e))&&"object"===n(e.audio)&&(e=JSON.parse(JSON.stringify(e)),a(e.audio,"autoGainControl","mozAutoGainControl"),a(e.audio,"noiseSuppression","mozNoiseSuppression")),s(e)},o&&o.prototype.getSettings){var c=o.prototype.getSettings;o.prototype.getSettings=function(){var e=c.apply(this,arguments);return a(e,"mozAutoGainControl","autoGainControl"),a(e,"mozNoiseSuppression","noiseSuppression"),e}}if(o&&o.prototype.applyConstraints){var u=o.prototype.applyConstraints;o.prototype.applyConstraints=function(e){return"audio"===this.kind&&"object"===(void 0===e?"undefined":n(e))&&(e=JSON.parse(JSON.stringify(e)),a(e,"autoGainControl","mozAutoGainControl"),a(e,"noiseSuppression","mozNoiseSuppression")),u.apply(this,[e])}}}};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"))},{"../utils":15}],14:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)};r.shimLocalStreamsAPI=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){if("getLocalStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in e.RTCPeerConnection.prototype)){var t=e.RTCPeerConnection.prototype.addTrack;e.RTCPeerConnection.prototype.addStream=function(e){var r=this;this._localStreams||(this._localStreams=[]),this._localStreams.includes(e)||this._localStreams.push(e),e.getAudioTracks().forEach((function(n){return t.call(r,n,e)})),e.getVideoTracks().forEach((function(n){return t.call(r,n,e)}))},e.RTCPeerConnection.prototype.addTrack=function(e){var r=arguments[1];return r&&(this._localStreams?this._localStreams.includes(r)||this._localStreams.push(r):this._localStreams=[r]),t.apply(this,arguments)}}"removeStream"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.removeStream=function(e){var t=this;this._localStreams||(this._localStreams=[]);var r=this._localStreams.indexOf(e);if(-1!==r){this._localStreams.splice(r,1);var n=e.getTracks();this.getSenders().forEach((function(e){n.includes(e.track)&&t.removeTrack(e)}))}})}},r.shimRemoteStreamsAPI=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection&&("getRemoteStreams"in e.RTCPeerConnection.prototype||(e.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in e.RTCPeerConnection.prototype))){Object.defineProperty(e.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(e){var t=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=e),this.addEventListener("track",this._onaddstreampoly=function(e){e.streams.forEach((function(e){if(t._remoteStreams||(t._remoteStreams=[]),!t._remoteStreams.includes(e)){t._remoteStreams.push(e);var r=new Event("addstream");r.stream=e,t.dispatchEvent(r)}}))})}});var t=e.RTCPeerConnection.prototype.setRemoteDescription;e.RTCPeerConnection.prototype.setRemoteDescription=function(){var e=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(t){t.streams.forEach((function(t){if(e._remoteStreams||(e._remoteStreams=[]),!(e._remoteStreams.indexOf(t)>=0)){e._remoteStreams.push(t);var r=new Event("addstream");r.stream=t,e.dispatchEvent(r)}}))}),t.apply(e,arguments)}}},r.shimCallbacksAPI=function(e){if("object"===(void 0===e?"undefined":n(e))&&e.RTCPeerConnection){var t=e.RTCPeerConnection.prototype,r=t.createOffer,i=t.createAnswer,o=t.setLocalDescription,a=t.setRemoteDescription,s=t.addIceCandidate;t.createOffer=function(e,t){var n=arguments.length>=2?arguments[2]:arguments[0],i=r.apply(this,[n]);return t?(i.then(e,t),Promise.resolve()):i},t.createAnswer=function(e,t){var r=arguments.length>=2?arguments[2]:arguments[0],n=i.apply(this,[r]);return t?(n.then(e,t),Promise.resolve()):n};var c=function(e,t,r){var n=o.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n};t.setLocalDescription=c,c=function(e,t,r){var n=a.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.setRemoteDescription=c,c=function(e,t,r){var n=s.apply(this,[e]);return r?(n.then(t,r),Promise.resolve()):n},t.addIceCandidate=c}},r.shimGetUserMedia=function(e){var t=e&&e.navigator;if(t.mediaDevices&&t.mediaDevices.getUserMedia){var r=t.mediaDevices,n=r.getUserMedia.bind(r);t.mediaDevices.getUserMedia=function(e){return n(o(e))}}!t.getUserMedia&&t.mediaDevices&&t.mediaDevices.getUserMedia&&(t.getUserMedia=function(e,r,n){t.mediaDevices.getUserMedia(e).then(r,n)}.bind(t))},r.shimConstraints=o,r.shimRTCIceServerUrls=function(e){var t=e.RTCPeerConnection;e.RTCPeerConnection=function(e,r){if(e&&e.iceServers){for(var n=[],o=0;o<e.iceServers.length;o++){var a=e.iceServers[o];!a.hasOwnProperty("urls")&&a.hasOwnProperty("url")?(i.deprecated("RTCIceServer.url","RTCIceServer.urls"),(a=JSON.parse(JSON.stringify(a))).urls=a.url,delete a.url,n.push(a)):n.push(e.iceServers[o])}e.iceServers=n}return new t(e,r)},e.RTCPeerConnection.prototype=t.prototype,"generateCertificate"in e.RTCPeerConnection&&Object.defineProperty(e.RTCPeerConnection,"generateCertificate",{get:function(){return t.generateCertificate}})},r.shimTrackEventTransceiver=function(e){"object"===(void 0===e?"undefined":n(e))&&e.RTCTrackEvent&&"receiver"in e.RTCTrackEvent.prototype&&!("transceiver"in e.RTCTrackEvent.prototype)&&Object.defineProperty(e.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})},r.shimCreateOfferLegacy=function(e){var t=e.RTCPeerConnection.prototype.createOffer;e.RTCPeerConnection.prototype.createOffer=function(e){if(e){void 0!==e.offerToReceiveAudio&&(e.offerToReceiveAudio=!!e.offerToReceiveAudio);var r=this.getTransceivers().find((function(e){return"audio"===e.receiver.track.kind}));!1===e.offerToReceiveAudio&&r?"sendrecv"===r.direction?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":"recvonly"===r.direction&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):!0!==e.offerToReceiveAudio||r||this.addTransceiver("audio"),void 0!==e.offerToReceiveVideo&&(e.offerToReceiveVideo=!!e.offerToReceiveVideo);var n=this.getTransceivers().find((function(e){return"video"===e.receiver.track.kind}));!1===e.offerToReceiveVideo&&n?"sendrecv"===n.direction?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":"recvonly"===n.direction&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):!0!==e.offerToReceiveVideo||n||this.addTransceiver("video")}return t.apply(this,arguments)}};var i=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../utils"));function o(e){return e&&void 0!==e.video?Object.assign({},e,{video:i.compactObject(e.video)}):e}},{"../utils":15}],15:[function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0});var n="function"==typeof Symbol&&"symbol"==M(Symbol.iterator)?function(e){return M(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":M(e)};r.extractVersion=a,r.wrapPeerConnectionEvent=function(e,t,r){if(e.RTCPeerConnection){var n=e.RTCPeerConnection.prototype,i=n.addEventListener;n.addEventListener=function(e,n){if(e!==t)return i.apply(this,arguments);var o=function(e){var t=r(e);t&&n(t)};return this._eventMap=this._eventMap||{},this._eventMap[n]=o,i.apply(this,[e,o])};var o=n.removeEventListener;n.removeEventListener=function(e,r){if(e!==t||!this._eventMap||!this._eventMap[r])return o.apply(this,arguments);var n=this._eventMap[r];return delete this._eventMap[r],o.apply(this,[e,n])},Object.defineProperty(n,"on"+t,{get:function(){return this["_on"+t]},set:function(e){this["_on"+t]&&(this.removeEventListener(t,this["_on"+t]),delete this["_on"+t]),e&&this.addEventListener(t,this["_on"+t]=e)},enumerable:!0,configurable:!0})}},r.disableLog=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":n(e))+". Please use a boolean."):(i=e,e?"adapter.js logging disabled":"adapter.js logging enabled")},r.disableWarnings=function(e){return"boolean"!=typeof e?new Error("Argument type: "+(void 0===e?"undefined":n(e))+". Please use a boolean."):(o=!e,"adapter.js deprecation warnings "+(e?"disabled":"enabled"))},r.log=function(){if("object"===("undefined"==typeof window?"undefined":n(window))){if(i)return;"undefined"!=typeof console&&"function"==typeof console.log&&console.log.apply(console,arguments)}},r.deprecated=function(e,t){o&&console.warn(e+" is deprecated, please use "+t+" instead.")},r.detectBrowser=function(e){var t=e.navigator,r={browser:null,version:null};if(void 0===e||!e.navigator)return r.browser="Not a browser.",r;if(t.mozGetUserMedia)r.browser="firefox",r.version=a(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||!1===e.isSecureContext&&e.webkitRTCPeerConnection&&!e.RTCIceGatherer)r.browser="chrome",r.version=a(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(t.mediaDevices&&t.userAgent.match(/Edge\/(\d+).(\d+)$/))r.browser="edge",r.version=a(t.userAgent,/Edge\/(\d+).(\d+)$/,2);else{if(!e.RTCPeerConnection||!t.userAgent.match(/AppleWebKit\/(\d+)\./))return r.browser="Not a supported browser.",r;r.browser="safari",r.version=a(t.userAgent,/AppleWebKit\/(\d+)\./,1),r.supportsUnifiedPlan=e.RTCRtpTransceiver&&"currentDirection"in e.RTCRtpTransceiver.prototype}return r},r.compactObject=function e(t){return s(t)?Object.keys(t).reduce((function(r,n){var i=s(t[n]),o=i?e(t[n]):t[n],a=i&&!Object.keys(o).length;return void 0===o||a?r:Object.assign(r,function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}({},n,o))}),{}):t},r.walkStats=c,r.filterStats=function(e,t,r){var n=r?"outbound-rtp":"inbound-rtp",i=new Map;if(null===t)return i;var o=[];return e.forEach((function(e){"track"===e.type&&e.trackIdentifier===t.id&&o.push(e)})),o.forEach((function(t){e.forEach((function(r){r.type===n&&r.trackId===t.id&&c(e,r,i)}))})),i};var i=!0,o=!0;function a(e,t,r){var n=e.match(t);return n&&n.length>=r&&parseInt(n[r],10)}function s(e){return"[object Object]"===Object.prototype.toString.call(e)}function c(e,t,r){t&&!r.has(t.id)&&(r.set(t.id,t),Object.keys(t).forEach((function(n){n.endsWith("Id")?c(e,e.get(t[n]),r):n.endsWith("Ids")&&t[n].forEach((function(t){c(e,e.get(t),r)}))})))}},{}],16:[function(e,t,r){var n=e("sdp");function i(e,t,r,i,o){var a=n.writeRtpDescription(e.kind,t);if(a+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),a+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":o||"active"),a+="a=mid:"+e.mid+"\r\n",e.rtpSender&&e.rtpReceiver?a+="a=sendrecv\r\n":e.rtpSender?a+="a=sendonly\r\n":e.rtpReceiver?a+="a=recvonly\r\n":a+="a=inactive\r\n",e.rtpSender){var s=e.rtpSender._initialTrackId||e.rtpSender.track.id;e.rtpSender._initialTrackId=s;var c="msid:"+(i?i.id:"-")+" "+s+"\r\n";a+="a="+c,a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+c,e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+c,a+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return a+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(a+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),a}function o(e,t){var r={codecs:[],headerExtensions:[],fecMechanisms:[]},n=function(e,t){e=parseInt(e,10);for(var r=0;r<t.length;r++)if(t[r].payloadType===e||t[r].preferredPayloadType===e)return t[r]},i=function(e,t,r,i){var o=n(e.parameters.apt,r),a=n(t.parameters.apt,i);return o&&a&&o.name.toLowerCase()===a.name.toLowerCase()};return e.codecs.forEach((function(n){for(var o=0;o<t.codecs.length;o++){var a=t.codecs[o];if(n.name.toLowerCase()===a.name.toLowerCase()&&n.clockRate===a.clockRate){if("rtx"===n.name.toLowerCase()&&n.parameters&&a.parameters.apt&&!i(n,a,e.codecs,t.codecs))continue;(a=JSON.parse(JSON.stringify(a))).numChannels=Math.min(n.numChannels,a.numChannels),r.codecs.push(a),a.rtcpFeedback=a.rtcpFeedback.filter((function(e){for(var t=0;t<n.rtcpFeedback.length;t++)if(n.rtcpFeedback[t].type===e.type&&n.rtcpFeedback[t].parameter===e.parameter)return!0;return!1}));break}}})),e.headerExtensions.forEach((function(e){for(var n=0;n<t.headerExtensions.length;n++){var i=t.headerExtensions[n];if(e.uri===i.uri){r.headerExtensions.push(i);break}}})),r}function a(e,t,r){return-1!=={offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[t][e].indexOf(r)}function s(e,t){var r=e.getRemoteCandidates().find((function(e){return t.foundation===e.foundation&&t.ip===e.ip&&t.port===e.port&&t.priority===e.priority&&t.protocol===e.protocol&&t.type===e.type}));return r||e.addRemoteCandidate(t),!r}function c(e,t){var r=new Error(t);return r.name=e,r.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[e],r}t.exports=function(e,t){function r(t,r){r.addTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("addtrack",{track:t}))}function u(t,r,n,i){var o=new Event("track");o.track=r,o.receiver=n,o.transceiver={receiver:n},o.streams=i,e.setTimeout((function(){t._dispatchEvent("track",o)}))}var d=function(r){var i=this,o=document.createDocumentFragment();if(["addEventListener","removeEventListener","dispatchEvent"].forEach((function(e){i[e]=o[e].bind(o)})),this.canTrickleIceCandidates=null,this.needNegotiation=!1,this.localStreams=[],this.remoteStreams=[],this._localDescription=null,this._remoteDescription=null,this.signalingState="stable",this.iceConnectionState="new",this.connectionState="new",this.iceGatheringState="new",r=JSON.parse(JSON.stringify(r||{})),this.usingBundle="max-bundle"===r.bundlePolicy,"negotiate"===r.rtcpMuxPolicy)throw c("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");switch(r.rtcpMuxPolicy||(r.rtcpMuxPolicy="require"),r.iceTransportPolicy){case"all":case"relay":break;default:r.iceTransportPolicy="all"}switch(r.bundlePolicy){case"balanced":case"max-compat":case"max-bundle":break;default:r.bundlePolicy="balanced"}if(r.iceServers=function(e,t){var r=!1;return(e=JSON.parse(JSON.stringify(e))).filter((function(e){if(e&&(e.urls||e.url)){var n=e.urls||e.url;e.url&&!e.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var i="string"==typeof n;return i&&(n=[n]),n=n.filter((function(e){return 0!==e.indexOf("turn:")||-1===e.indexOf("transport=udp")||-1!==e.indexOf("turn:[")||r?0===e.indexOf("stun:")&&t>=14393&&-1===e.indexOf("?transport=udp"):(r=!0,!0)})),delete e.url,e.urls=i?n[0]:n,!!n.length}}))}(r.iceServers||[],t),this._iceGatherers=[],r.iceCandidatePoolSize)for(var a=r.iceCandidatePoolSize;a>0;a--)this._iceGatherers.push(new e.RTCIceGatherer({iceServers:r.iceServers,gatherPolicy:r.iceTransportPolicy}));else r.iceCandidatePoolSize=0;this._config=r,this.transceivers=[],this._sdpSessionId=n.generateSessionId(),this._sdpSessionVersion=0,this._dtlsRole=void 0,this._isClosed=!1};Object.defineProperty(d.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}}),Object.defineProperty(d.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}}),d.prototype.onicecandidate=null,d.prototype.onaddstream=null,d.prototype.ontrack=null,d.prototype.onremovestream=null,d.prototype.onsignalingstatechange=null,d.prototype.oniceconnectionstatechange=null,d.prototype.onconnectionstatechange=null,d.prototype.onicegatheringstatechange=null,d.prototype.onnegotiationneeded=null,d.prototype.ondatachannel=null,d.prototype._dispatchEvent=function(e,t){this._isClosed||(this.dispatchEvent(t),"function"==typeof this["on"+e]&&this["on"+e](t))},d.prototype._emitGatheringStateChange=function(){var e=new Event("icegatheringstatechange");this._dispatchEvent("icegatheringstatechange",e)},d.prototype.getConfiguration=function(){return this._config},d.prototype.getLocalStreams=function(){return this.localStreams},d.prototype.getRemoteStreams=function(){return this.remoteStreams},d.prototype._createTransceiver=function(e,t){var r=this.transceivers.length>0,n={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:e,mid:null,sendEncodingParameters:null,recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};if(this.usingBundle&&r)n.iceTransport=this.transceivers[0].iceTransport,n.dtlsTransport=this.transceivers[0].dtlsTransport;else{var i=this._createIceAndDtlsTransports();n.iceTransport=i.iceTransport,n.dtlsTransport=i.dtlsTransport}return t||this.transceivers.push(n),n},d.prototype.addTrack=function(t,r){if(this._isClosed)throw c("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");var n;if(this.transceivers.find((function(e){return e.track===t})))throw c("InvalidAccessError","Track already exists.");for(var i=0;i<this.transceivers.length;i++)this.transceivers[i].track||this.transceivers[i].kind!==t.kind||(n=this.transceivers[i]);return n||(n=this._createTransceiver(t.kind)),this._maybeFireNegotiationNeeded(),-1===this.localStreams.indexOf(r)&&this.localStreams.push(r),n.track=t,n.stream=r,n.rtpSender=new e.RTCRtpSender(t,n.dtlsTransport),n.rtpSender},d.prototype.addStream=function(e){var r=this;if(t>=15025)e.getTracks().forEach((function(t){r.addTrack(t,e)}));else{var n=e.clone();e.getTracks().forEach((function(e,t){var r=n.getTracks()[t];e.addEventListener("enabled",(function(e){r.enabled=e.enabled}))})),n.getTracks().forEach((function(e){r.addTrack(e,n)}))}},d.prototype.removeTrack=function(t){if(this._isClosed)throw c("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(t instanceof e.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var r=this.transceivers.find((function(e){return e.rtpSender===t}));if(!r)throw c("InvalidAccessError","Sender was not created by this connection.");var n=r.stream;r.rtpSender.stop(),r.rtpSender=null,r.track=null,r.stream=null,-1===this.transceivers.map((function(e){return e.stream})).indexOf(n)&&this.localStreams.indexOf(n)>-1&&this.localStreams.splice(this.localStreams.indexOf(n),1),this._maybeFireNegotiationNeeded()},d.prototype.removeStream=function(e){var t=this;e.getTracks().forEach((function(e){var r=t.getSenders().find((function(t){return t.track===e}));r&&t.removeTrack(r)}))},d.prototype.getSenders=function(){return this.transceivers.filter((function(e){return!!e.rtpSender})).map((function(e){return e.rtpSender}))},d.prototype.getReceivers=function(){return this.transceivers.filter((function(e){return!!e.rtpReceiver})).map((function(e){return e.rtpReceiver}))},d.prototype._createIceGatherer=function(t,r){var n=this;if(r&&t>0)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var i=new e.RTCIceGatherer({iceServers:this._config.iceServers,gatherPolicy:this._config.iceTransportPolicy});return Object.defineProperty(i,"state",{value:"new",writable:!0}),this.transceivers[t].bufferedCandidateEvents=[],this.transceivers[t].bufferCandidates=function(e){var r=!e.candidate||0===Object.keys(e.candidate).length;i.state=r?"completed":"gathering",null!==n.transceivers[t].bufferedCandidateEvents&&n.transceivers[t].bufferedCandidateEvents.push(e)},i.addEventListener("localcandidate",this.transceivers[t].bufferCandidates),i},d.prototype._gather=function(t,r){var i=this,o=this.transceivers[r].iceGatherer;if(!o.onlocalcandidate){var a=this.transceivers[r].bufferedCandidateEvents;this.transceivers[r].bufferedCandidateEvents=null,o.removeEventListener("localcandidate",this.transceivers[r].bufferCandidates),o.onlocalcandidate=function(e){if(!(i.usingBundle&&r>0)){var a=new Event("icecandidate");a.candidate={sdpMid:t,sdpMLineIndex:r};var s=e.candidate,c=!s||0===Object.keys(s).length;if(c)"new"!==o.state&&"gathering"!==o.state||(o.state="completed");else{"new"===o.state&&(o.state="gathering"),s.component=1,s.ufrag=o.getLocalParameters().usernameFragment;var u=n.writeCandidate(s);a.candidate=Object.assign(a.candidate,n.parseCandidate(u)),a.candidate.candidate=u,a.candidate.toJSON=function(){return{candidate:a.candidate.candidate,sdpMid:a.candidate.sdpMid,sdpMLineIndex:a.candidate.sdpMLineIndex,usernameFragment:a.candidate.usernameFragment}}}var d=n.getMediaSections(i._localDescription.sdp);d[a.candidate.sdpMLineIndex]+=c?"a=end-of-candidates\r\n":"a="+a.candidate.candidate+"\r\n",i._localDescription.sdp=n.getDescription(i._localDescription.sdp)+d.join("");var l=i.transceivers.every((function(e){return e.iceGatherer&&"completed"===e.iceGatherer.state}));"gathering"!==i.iceGatheringState&&(i.iceGatheringState="gathering",i._emitGatheringStateChange()),c||i._dispatchEvent("icecandidate",a),l&&(i._dispatchEvent("icecandidate",new Event("icecandidate")),i.iceGatheringState="complete",i._emitGatheringStateChange())}},e.setTimeout((function(){a.forEach((function(e){o.onlocalcandidate(e)}))}),0)}},d.prototype._createIceAndDtlsTransports=function(){var t=this,r=new e.RTCIceTransport(null);r.onicestatechange=function(){t._updateIceConnectionState(),t._updateConnectionState()};var n=new e.RTCDtlsTransport(r);return n.ondtlsstatechange=function(){t._updateConnectionState()},n.onerror=function(){Object.defineProperty(n,"state",{value:"failed",writable:!0}),t._updateConnectionState()},{iceTransport:r,dtlsTransport:n}},d.prototype._disposeIceAndDtlsTransports=function(e){var t=this.transceivers[e].iceGatherer;t&&(delete t.onlocalcandidate,delete this.transceivers[e].iceGatherer);var r=this.transceivers[e].iceTransport;r&&(delete r.onicestatechange,delete this.transceivers[e].iceTransport);var n=this.transceivers[e].dtlsTransport;n&&(delete n.ondtlsstatechange,delete n.onerror,delete this.transceivers[e].dtlsTransport)},d.prototype._transceive=function(e,r,i){var a=o(e.localCapabilities,e.remoteCapabilities);r&&e.rtpSender&&(a.encodings=e.sendEncodingParameters,a.rtcp={cname:n.localCName,compound:e.rtcpParameters.compound},e.recvEncodingParameters.length&&(a.rtcp.ssrc=e.recvEncodingParameters[0].ssrc),e.rtpSender.send(a)),i&&e.rtpReceiver&&a.codecs.length>0&&("video"===e.kind&&e.recvEncodingParameters&&t<15019&&e.recvEncodingParameters.forEach((function(e){delete e.rtx})),e.recvEncodingParameters.length?a.encodings=e.recvEncodingParameters:a.encodings=[{}],a.rtcp={compound:e.rtcpParameters.compound},e.rtcpParameters.cname&&(a.rtcp.cname=e.rtcpParameters.cname),e.sendEncodingParameters.length&&(a.rtcp.ssrc=e.sendEncodingParameters[0].ssrc),e.rtpReceiver.receive(a))},d.prototype.setLocalDescription=function(e){var t,r,i=this;if(-1===["offer","answer"].indexOf(e.type))return Promise.reject(c("TypeError",'Unsupported type "'+e.type+'"'));if(!a("setLocalDescription",e.type,i.signalingState)||i._isClosed)return Promise.reject(c("InvalidStateError","Can not set local "+e.type+" in state "+i.signalingState));if("offer"===e.type)t=n.splitSections(e.sdp),r=t.shift(),t.forEach((function(e,t){var r=n.parseRtpParameters(e);i.transceivers[t].localCapabilities=r})),i.transceivers.forEach((function(e,t){i._gather(e.mid,t)}));else if("answer"===e.type){t=n.splitSections(i._remoteDescription.sdp),r=t.shift();var s=n.matchPrefix(r,"a=ice-lite").length>0;t.forEach((function(e,t){var a=i.transceivers[t],c=a.iceGatherer,u=a.iceTransport,d=a.dtlsTransport,l=a.localCapabilities,h=a.remoteCapabilities;if(!(n.isRejected(e)&&0===n.matchPrefix(e,"a=bundle-only").length||a.rejected)){var p=n.getIceParameters(e,r),f=n.getDtlsParameters(e,r);s&&(f.role="server"),i.usingBundle&&0!==t||(i._gather(a.mid,t),"new"===u.state&&u.start(c,p,s?"controlling":"controlled"),"new"===d.state&&d.start(f));var m=o(l,h);i._transceive(a,m.codecs.length>0,!1)}}))}return i._localDescription={type:e.type,sdp:e.sdp},"offer"===e.type?i._updateSignalingState("have-local-offer"):i._updateSignalingState("stable"),Promise.resolve()},d.prototype.setRemoteDescription=function(i){var d=this;if(-1===["offer","answer"].indexOf(i.type))return Promise.reject(c("TypeError",'Unsupported type "'+i.type+'"'));if(!a("setRemoteDescription",i.type,d.signalingState)||d._isClosed)return Promise.reject(c("InvalidStateError","Can not set remote "+i.type+" in state "+d.signalingState));var l={};d.remoteStreams.forEach((function(e){l[e.id]=e}));var h=[],p=n.splitSections(i.sdp),f=p.shift(),m=n.matchPrefix(f,"a=ice-lite").length>0,v=n.matchPrefix(f,"a=group:BUNDLE ").length>0;d.usingBundle=v;var g=n.matchPrefix(f,"a=ice-options:")[0];return d.canTrickleIceCandidates=!!g&&g.substr(14).split(" ").indexOf("trickle")>=0,p.forEach((function(a,c){var u=n.splitLines(a),p=n.getKind(a),g=n.isRejected(a)&&0===n.matchPrefix(a,"a=bundle-only").length,y=u[0].substr(2).split(" ")[2],b=n.getDirection(a,f),S=n.parseMsid(a),E=n.getMid(a)||n.generateIdentifier();if(g||"application"===p&&("DTLS/SCTP"===y||"UDP/DTLS/SCTP"===y))d.transceivers[c]={mid:E,kind:p,protocol:y,rejected:!0};else{var C,T,w,_,k,R,I,O,P;!g&&d.transceivers[c]&&d.transceivers[c].rejected&&(d.transceivers[c]=d._createTransceiver(p,!0));var A,x,L=n.parseRtpParameters(a);g||(A=n.getIceParameters(a,f),(x=n.getDtlsParameters(a,f)).role="client"),I=n.parseRtpEncodingParameters(a);var M=n.parseRtcpParameters(a),D=n.matchPrefix(a,"a=end-of-candidates",f).length>0,U=n.matchPrefix(a,"a=candidate:").map((function(e){return n.parseCandidate(e)})).filter((function(e){return 1===e.component}));if(("offer"===i.type||"answer"===i.type)&&!g&&v&&c>0&&d.transceivers[c]&&(d._disposeIceAndDtlsTransports(c),d.transceivers[c].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[c].iceTransport=d.transceivers[0].iceTransport,d.transceivers[c].dtlsTransport=d.transceivers[0].dtlsTransport,d.transceivers[c].rtpSender&&d.transceivers[c].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[c].rtpReceiver&&d.transceivers[c].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport)),"offer"!==i.type||g)"answer"!==i.type||g||(T=(C=d.transceivers[c]).iceGatherer,w=C.iceTransport,_=C.dtlsTransport,k=C.rtpReceiver,R=C.sendEncodingParameters,O=C.localCapabilities,d.transceivers[c].recvEncodingParameters=I,d.transceivers[c].remoteCapabilities=L,d.transceivers[c].rtcpParameters=M,U.length&&"new"===w.state&&(!m&&!D||v&&0!==c?U.forEach((function(e){s(C.iceTransport,e)})):w.setRemoteCandidates(U)),v&&0!==c||("new"===w.state&&w.start(T,A,"controlling"),"new"===_.state&&_.start(x)),!o(C.localCapabilities,C.remoteCapabilities).codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&C.sendEncodingParameters[0].rtx&&delete C.sendEncodingParameters[0].rtx,d._transceive(C,"sendrecv"===b||"recvonly"===b,"sendrecv"===b||"sendonly"===b),!k||"sendrecv"!==b&&"sendonly"!==b?delete C.rtpReceiver:(P=k.track,S?(l[S.stream]||(l[S.stream]=new e.MediaStream),r(P,l[S.stream]),h.push([P,k,l[S.stream]])):(l.default||(l.default=new e.MediaStream),r(P,l.default),h.push([P,k,l.default]))));else{(C=d.transceivers[c]||d._createTransceiver(p)).mid=E,C.iceGatherer||(C.iceGatherer=d._createIceGatherer(c,v)),U.length&&"new"===C.iceTransport.state&&(!D||v&&0!==c?U.forEach((function(e){s(C.iceTransport,e)})):C.iceTransport.setRemoteCandidates(U)),O=e.RTCRtpReceiver.getCapabilities(p),t<15019&&(O.codecs=O.codecs.filter((function(e){return"rtx"!==e.name}))),R=C.sendEncodingParameters||[{ssrc:1001*(2*c+2)}];var N,j=!1;"sendrecv"===b||"sendonly"===b?(j=!C.rtpReceiver,k=C.rtpReceiver||new e.RTCRtpReceiver(C.dtlsTransport,p),j&&(P=k.track,S&&"-"===S.stream||(S?(l[S.stream]||(l[S.stream]=new e.MediaStream,Object.defineProperty(l[S.stream],"id",{get:function(){return S.stream}})),Object.defineProperty(P,"id",{get:function(){return S.track}}),N=l[S.stream]):(l.default||(l.default=new e.MediaStream),N=l.default)),N&&(r(P,N),C.associatedRemoteMediaStreams.push(N)),h.push([P,k,N]))):C.rtpReceiver&&C.rtpReceiver.track&&(C.associatedRemoteMediaStreams.forEach((function(t){var r=t.getTracks().find((function(e){return e.id===C.rtpReceiver.track.id}));r&&function(t,r){r.removeTrack(t),r.dispatchEvent(new e.MediaStreamTrackEvent("removetrack",{track:t}))}(r,t)})),C.associatedRemoteMediaStreams=[]),C.localCapabilities=O,C.remoteCapabilities=L,C.rtpReceiver=k,C.rtcpParameters=M,C.sendEncodingParameters=R,C.recvEncodingParameters=I,d._transceive(d.transceivers[c],!1,j)}}})),void 0===d._dtlsRole&&(d._dtlsRole="offer"===i.type?"active":"passive"),d._remoteDescription={type:i.type,sdp:i.sdp},"offer"===i.type?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable"),Object.keys(l).forEach((function(t){var r=l[t];if(r.getTracks().length){if(-1===d.remoteStreams.indexOf(r)){d.remoteStreams.push(r);var n=new Event("addstream");n.stream=r,e.setTimeout((function(){d._dispatchEvent("addstream",n)}))}h.forEach((function(e){var t=e[0],n=e[1];r.id===e[2].id&&u(d,t,n,[r])}))}})),h.forEach((function(e){e[2]||u(d,e[0],e[1],[])})),e.setTimeout((function(){d&&d.transceivers&&d.transceivers.forEach((function(e){e.iceTransport&&"new"===e.iceTransport.state&&e.iceTransport.getRemoteCandidates().length>0&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),e.iceTransport.addRemoteCandidate({}))}))}),4e3),Promise.resolve()},d.prototype.close=function(){this.transceivers.forEach((function(e){e.iceTransport&&e.iceTransport.stop(),e.dtlsTransport&&e.dtlsTransport.stop(),e.rtpSender&&e.rtpSender.stop(),e.rtpReceiver&&e.rtpReceiver.stop()})),this._isClosed=!0,this._updateSignalingState("closed")},d.prototype._updateSignalingState=function(e){this.signalingState=e;var t=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",t)},d.prototype._maybeFireNegotiationNeeded=function(){var t=this;"stable"===this.signalingState&&!0!==this.needNegotiation&&(this.needNegotiation=!0,e.setTimeout((function(){if(t.needNegotiation){t.needNegotiation=!1;var e=new Event("negotiationneeded");t._dispatchEvent("negotiationneeded",e)}}),0))},d.prototype._updateIceConnectionState=function(){var e,t={new:0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&!e.rejected&&t[e.iceTransport.state]++})),e="new",t.failed>0?e="failed":t.checking>0?e="checking":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0?e="connected":t.completed>0&&(e="completed"),e!==this.iceConnectionState){this.iceConnectionState=e;var r=new Event("iceconnectionstatechange");this._dispatchEvent("iceconnectionstatechange",r)}},d.prototype._updateConnectionState=function(){var e,t={new:0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};if(this.transceivers.forEach((function(e){e.iceTransport&&e.dtlsTransport&&!e.rejected&&(t[e.iceTransport.state]++,t[e.dtlsTransport.state]++)})),t.connected+=t.completed,e="new",t.failed>0?e="failed":t.connecting>0?e="connecting":t.disconnected>0?e="disconnected":t.new>0?e="new":t.connected>0&&(e="connected"),e!==this.connectionState){this.connectionState=e;var r=new Event("connectionstatechange");this._dispatchEvent("connectionstatechange",r)}},d.prototype.createOffer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createOffer after close"));var o=r.transceivers.filter((function(e){return"audio"===e.kind})).length,a=r.transceivers.filter((function(e){return"video"===e.kind})).length,s=arguments[0];if(s){if(s.mandatory||s.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");void 0!==s.offerToReceiveAudio&&(o=!0===s.offerToReceiveAudio?1:!1===s.offerToReceiveAudio?0:s.offerToReceiveAudio),void 0!==s.offerToReceiveVideo&&(a=!0===s.offerToReceiveVideo?1:!1===s.offerToReceiveVideo?0:s.offerToReceiveVideo)}for(r.transceivers.forEach((function(e){"audio"===e.kind?--o<0&&(e.wantReceive=!1):"video"===e.kind&&--a<0&&(e.wantReceive=!1)}));o>0||a>0;)o>0&&(r._createTransceiver("audio"),o--),a>0&&(r._createTransceiver("video"),a--);var u=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.transceivers.forEach((function(i,o){var a=i.track,s=i.kind,c=i.mid||n.generateIdentifier();i.mid=c,i.iceGatherer||(i.iceGatherer=r._createIceGatherer(o,r.usingBundle));var u=e.RTCRtpSender.getCapabilities(s);t<15019&&(u.codecs=u.codecs.filter((function(e){return"rtx"!==e.name}))),u.codecs.forEach((function(e){"H264"===e.name&&void 0===e.parameters["level-asymmetry-allowed"]&&(e.parameters["level-asymmetry-allowed"]="1"),i.remoteCapabilities&&i.remoteCapabilities.codecs&&i.remoteCapabilities.codecs.forEach((function(t){e.name.toLowerCase()===t.name.toLowerCase()&&e.clockRate===t.clockRate&&(e.preferredPayloadType=t.payloadType)}))})),u.headerExtensions.forEach((function(e){(i.remoteCapabilities&&i.remoteCapabilities.headerExtensions||[]).forEach((function(t){e.uri===t.uri&&(e.id=t.id)}))}));var d=i.sendEncodingParameters||[{ssrc:1001*(2*o+1)}];a&&t>=15019&&"video"===s&&!d[0].rtx&&(d[0].rtx={ssrc:d[0].ssrc+1}),i.wantReceive&&(i.rtpReceiver=new e.RTCRtpReceiver(i.dtlsTransport,s)),i.localCapabilities=u,i.sendEncodingParameters=d})),"max-compat"!==r._config.bundlePolicy&&(u+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),u+="a=ice-options:trickle\r\n",r.transceivers.forEach((function(e,t){u+=i(e,e.localCapabilities,"offer",e.stream,r._dtlsRole),u+="a=rtcp-rsize\r\n",!e.iceGatherer||"new"===r.iceGatheringState||0!==t&&r.usingBundle||(e.iceGatherer.getLocalCandidates().forEach((function(e){e.component=1,u+="a="+n.writeCandidate(e)+"\r\n"})),"completed"===e.iceGatherer.state&&(u+="a=end-of-candidates\r\n"))}));var d=new e.RTCSessionDescription({type:"offer",sdp:u});return Promise.resolve(d)},d.prototype.createAnswer=function(){var r=this;if(r._isClosed)return Promise.reject(c("InvalidStateError","Can not call createAnswer after close"));if("have-remote-offer"!==r.signalingState&&"have-local-pranswer"!==r.signalingState)return Promise.reject(c("InvalidStateError","Can not call createAnswer in signalingState "+r.signalingState));var a=n.writeSessionBoilerplate(r._sdpSessionId,r._sdpSessionVersion++);r.usingBundle&&(a+="a=group:BUNDLE "+r.transceivers.map((function(e){return e.mid})).join(" ")+"\r\n"),a+="a=ice-options:trickle\r\n";var s=n.getMediaSections(r._remoteDescription.sdp).length;r.transceivers.forEach((function(e,n){if(!(n+1>s)){if(e.rejected)return"application"===e.kind?"DTLS/SCTP"===e.protocol?a+="m=application 0 DTLS/SCTP 5000\r\n":a+="m=application 0 "+e.protocol+" webrtc-datachannel\r\n":"audio"===e.kind?a+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(a+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),void(a+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n");var c;e.stream&&("audio"===e.kind?c=e.stream.getAudioTracks()[0]:"video"===e.kind&&(c=e.stream.getVideoTracks()[0]),c&&t>=15019&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1}));var u=o(e.localCapabilities,e.remoteCapabilities);!u.codecs.filter((function(e){return"rtx"===e.name.toLowerCase()})).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx,a+=i(e,u,"answer",e.stream,r._dtlsRole),e.rtcpParameters&&e.rtcpParameters.reducedSize&&(a+="a=rtcp-rsize\r\n")}}));var u=new e.RTCSessionDescription({type:"answer",sdp:a});return Promise.resolve(u)},d.prototype.addIceCandidate=function(e){var t,r=this;return e&&void 0===e.sdpMLineIndex&&!e.sdpMid?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise((function(i,o){if(!r._remoteDescription)return o(c("InvalidStateError","Can not add ICE candidate without a remote description"));if(e&&""!==e.candidate){var a=e.sdpMLineIndex;if(e.sdpMid)for(var u=0;u<r.transceivers.length;u++)if(r.transceivers[u].mid===e.sdpMid){a=u;break}var d=r.transceivers[a];if(!d)return o(c("OperationError","Can not add ICE candidate"));if(d.rejected)return i();var l=Object.keys(e.candidate).length>0?n.parseCandidate(e.candidate):{};if("tcp"===l.protocol&&(0===l.port||9===l.port))return i();if(l.component&&1!==l.component)return i();if((0===a||a>0&&d.iceTransport!==r.transceivers[0].iceTransport)&&!s(d.iceTransport,l))return o(c("OperationError","Can not add ICE candidate"));var h=e.candidate.trim();0===h.indexOf("a=")&&(h=h.substr(2)),(t=n.getMediaSections(r._remoteDescription.sdp))[a]+="a="+(l.type?h:"end-of-candidates")+"\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join("")}else for(var p=0;p<r.transceivers.length&&(r.transceivers[p].rejected||(r.transceivers[p].iceTransport.addRemoteCandidate({}),(t=n.getMediaSections(r._remoteDescription.sdp))[p]+="a=end-of-candidates\r\n",r._remoteDescription.sdp=n.getDescription(r._remoteDescription.sdp)+t.join(""),!r.usingBundle));p++);i()}))},d.prototype.getStats=function(t){if(t&&t instanceof e.MediaStreamTrack){var r=null;if(this.transceivers.forEach((function(e){e.rtpSender&&e.rtpSender.track===t?r=e.rtpSender:e.rtpReceiver&&e.rtpReceiver.track===t&&(r=e.rtpReceiver)})),!r)throw c("InvalidAccessError","Invalid selector.");return r.getStats()}var n=[];return this.transceivers.forEach((function(e){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach((function(t){e[t]&&n.push(e[t].getStats())}))})),Promise.all(n).then((function(e){var t=new Map;return e.forEach((function(e){e.forEach((function(e){t.set(e.id,e)}))})),t}))},["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach((function(t){var r=e[t];if(r&&r.prototype&&r.prototype.getStats){var n=r.prototype.getStats;r.prototype.getStats=function(){return n.apply(this).then((function(e){var t=new Map;return Object.keys(e).forEach((function(r){var n;e[r].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[(n=e[r]).type]||n.type,t.set(r,e[r])})),t}))}}}));var l=["createOffer","createAnswer"];return l.forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[0]||"function"==typeof e[1]?t.apply(this,[arguments[2]]).then((function(t){"function"==typeof e[0]&&e[0].apply(null,[t])}),(function(t){"function"==typeof e[1]&&e[1].apply(null,[t])})):t.apply(this,arguments)}})),(l=["setLocalDescription","setRemoteDescription","addIceCandidate"]).forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]||"function"==typeof e[2]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)}),(function(t){"function"==typeof e[2]&&e[2].apply(null,[t])})):t.apply(this,arguments)}})),["getStats"].forEach((function(e){var t=d.prototype[e];d.prototype[e]=function(){var e=arguments;return"function"==typeof e[1]?t.apply(this,arguments).then((function(){"function"==typeof e[1]&&e[1].apply(null)})):t.apply(this,arguments)}})),d}},{sdp:17}],17:[function(e,t,r){var n={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};n.localCName=n.generateIdentifier(),n.splitLines=function(e){return e.trim().split("\n").map((function(e){return e.trim()}))},n.splitSections=function(e){return e.split("\nm=").map((function(e,t){return(t>0?"m="+e:e).trim()+"\r\n"}))},n.getDescription=function(e){var t=n.splitSections(e);return t&&t[0]},n.getMediaSections=function(e){var t=n.splitSections(e);return t.shift(),t},n.matchPrefix=function(e,t){return n.splitLines(e).filter((function(e){return 0===e.indexOf(t)}))},n.parseCandidate=function(e){for(var t,r={foundation:(t=0===e.indexOf("a=candidate:")?e.substring(12).split(" "):e.substring(10).split(" "))[0],component:parseInt(t[1],10),protocol:t[2].toLowerCase(),priority:parseInt(t[3],10),ip:t[4],address:t[4],port:parseInt(t[5],10),type:t[7]},n=8;n<t.length;n+=2)switch(t[n]){case"raddr":r.relatedAddress=t[n+1];break;case"rport":r.relatedPort=parseInt(t[n+1],10);break;case"tcptype":r.tcpType=t[n+1];break;case"ufrag":r.ufrag=t[n+1],r.usernameFragment=t[n+1];break;default:r[t[n]]=t[n+1]}return r},n.writeCandidate=function(e){var t=[];t.push(e.foundation),t.push(e.component),t.push(e.protocol.toUpperCase()),t.push(e.priority),t.push(e.address||e.ip),t.push(e.port);var r=e.type;return t.push("typ"),t.push(r),"host"!==r&&e.relatedAddress&&e.relatedPort&&(t.push("raddr"),t.push(e.relatedAddress),t.push("rport"),t.push(e.relatedPort)),e.tcpType&&"tcp"===e.protocol.toLowerCase()&&(t.push("tcptype"),t.push(e.tcpType)),(e.usernameFragment||e.ufrag)&&(t.push("ufrag"),t.push(e.usernameFragment||e.ufrag)),"candidate:"+t.join(" ")},n.parseIceOptions=function(e){return e.substr(14).split(" ")},n.parseRtpMap=function(e){var t=e.substr(9).split(" "),r={payloadType:parseInt(t.shift(),10)};return t=t[0].split("/"),r.name=t[0],r.clockRate=parseInt(t[1],10),r.channels=3===t.length?parseInt(t[2],10):1,r.numChannels=r.channels,r},n.writeRtpMap=function(e){var t=e.payloadType;void 0!==e.preferredPayloadType&&(t=e.preferredPayloadType);var r=e.channels||e.numChannels||1;return"a=rtpmap:"+t+" "+e.name+"/"+e.clockRate+(1!==r?"/"+r:"")+"\r\n"},n.parseExtmap=function(e){var t=e.substr(9).split(" ");return{id:parseInt(t[0],10),direction:t[0].indexOf("/")>0?t[0].split("/")[1]:"sendrecv",uri:t[1]}},n.writeExtmap=function(e){return"a=extmap:"+(e.id||e.preferredId)+(e.direction&&"sendrecv"!==e.direction?"/"+e.direction:"")+" "+e.uri+"\r\n"},n.parseFmtp=function(e){for(var t,r={},n=e.substr(e.indexOf(" ")+1).split(";"),i=0;i<n.length;i++)r[(t=n[i].trim().split("="))[0].trim()]=t[1];return r},n.writeFmtp=function(e){var t="",r=e.payloadType;if(void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.parameters&&Object.keys(e.parameters).length){var n=[];Object.keys(e.parameters).forEach((function(t){e.parameters[t]?n.push(t+"="+e.parameters[t]):n.push(t)})),t+="a=fmtp:"+r+" "+n.join(";")+"\r\n"}return t},n.parseRtcpFb=function(e){var t=e.substr(e.indexOf(" ")+1).split(" ");return{type:t.shift(),parameter:t.join(" ")}},n.writeRtcpFb=function(e){var t="",r=e.payloadType;return void 0!==e.preferredPayloadType&&(r=e.preferredPayloadType),e.rtcpFeedback&&e.rtcpFeedback.length&&e.rtcpFeedback.forEach((function(e){t+="a=rtcp-fb:"+r+" "+e.type+(e.parameter&&e.parameter.length?" "+e.parameter:"")+"\r\n"})),t},n.parseSsrcMedia=function(e){var t=e.indexOf(" "),r={ssrc:parseInt(e.substr(7,t-7),10)},n=e.indexOf(":",t);return n>-1?(r.attribute=e.substr(t+1,n-t-1),r.value=e.substr(n+1)):r.attribute=e.substr(t+1),r},n.parseSsrcGroup=function(e){var t=e.substr(13).split(" ");return{semantics:t.shift(),ssrcs:t.map((function(e){return parseInt(e,10)}))}},n.getMid=function(e){var t=n.matchPrefix(e,"a=mid:")[0];if(t)return t.substr(6)},n.parseFingerprint=function(e){var t=e.substr(14).split(" ");return{algorithm:t[0].toLowerCase(),value:t[1]}},n.getDtlsParameters=function(e,t){return{role:"auto",fingerprints:n.matchPrefix(e+t,"a=fingerprint:").map(n.parseFingerprint)}},n.writeDtlsParameters=function(e,t){var r="a=setup:"+t+"\r\n";return e.fingerprints.forEach((function(e){r+="a=fingerprint:"+e.algorithm+" "+e.value+"\r\n"})),r},n.parseCryptoLine=function(e){var t=e.substr(9).split(" ");return{tag:parseInt(t[0],10),cryptoSuite:t[1],keyParams:t[2],sessionParams:t.slice(3)}},n.writeCryptoLine=function(e){return"a=crypto:"+e.tag+" "+e.cryptoSuite+" "+("object"==M(e.keyParams)?n.writeCryptoKeyParams(e.keyParams):e.keyParams)+(e.sessionParams?" "+e.sessionParams.join(" "):"")+"\r\n"},n.parseCryptoKeyParams=function(e){if(0!==e.indexOf("inline:"))return null;var t=e.substr(7).split("|");return{keyMethod:"inline",keySalt:t[0],lifeTime:t[1],mkiValue:t[2]?t[2].split(":")[0]:void 0,mkiLength:t[2]?t[2].split(":")[1]:void 0}},n.writeCryptoKeyParams=function(e){return e.keyMethod+":"+e.keySalt+(e.lifeTime?"|"+e.lifeTime:"")+(e.mkiValue&&e.mkiLength?"|"+e.mkiValue+":"+e.mkiLength:"")},n.getCryptoParameters=function(e,t){return n.matchPrefix(e+t,"a=crypto:").map(n.parseCryptoLine)},n.getIceParameters=function(e,t){var r=n.matchPrefix(e+t,"a=ice-ufrag:")[0],i=n.matchPrefix(e+t,"a=ice-pwd:")[0];return r&&i?{usernameFragment:r.substr(12),password:i.substr(10)}:null},n.writeIceParameters=function(e){return"a=ice-ufrag:"+e.usernameFragment+"\r\na=ice-pwd:"+e.password+"\r\n"},n.parseRtpParameters=function(e){for(var t={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=n.splitLines(e)[0].split(" "),i=3;i<r.length;i++){var o=r[i],a=n.matchPrefix(e,"a=rtpmap:"+o+" ")[0];if(a){var s=n.parseRtpMap(a),c=n.matchPrefix(e,"a=fmtp:"+o+" ");switch(s.parameters=c.length?n.parseFmtp(c[0]):{},s.rtcpFeedback=n.matchPrefix(e,"a=rtcp-fb:"+o+" ").map(n.parseRtcpFb),t.codecs.push(s),s.name.toUpperCase()){case"RED":case"ULPFEC":t.fecMechanisms.push(s.name.toUpperCase())}}}return n.matchPrefix(e,"a=extmap:").forEach((function(e){t.headerExtensions.push(n.parseExtmap(e))})),t},n.writeRtpDescription=function(e,t){var r="";r+="m="+e+" ",r+=t.codecs.length>0?"9":"0",r+=" UDP/TLS/RTP/SAVPF ",r+=t.codecs.map((function(e){return void 0!==e.preferredPayloadType?e.preferredPayloadType:e.payloadType})).join(" ")+"\r\n",r+="c=IN IP4 0.0.0.0\r\n",r+="a=rtcp:9 IN IP4 0.0.0.0\r\n",t.codecs.forEach((function(e){r+=n.writeRtpMap(e),r+=n.writeFmtp(e),r+=n.writeRtcpFb(e)}));var i=0;return t.codecs.forEach((function(e){e.maxptime>i&&(i=e.maxptime)})),i>0&&(r+="a=maxptime:"+i+"\r\n"),r+="a=rtcp-mux\r\n",t.headerExtensions&&t.headerExtensions.forEach((function(e){r+=n.writeExtmap(e)})),r},n.parseRtpEncodingParameters=function(e){var t,r=[],i=n.parseRtpParameters(e),o=-1!==i.fecMechanisms.indexOf("RED"),a=-1!==i.fecMechanisms.indexOf("ULPFEC"),s=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute})),c=s.length>0&&s[0].ssrc,u=n.matchPrefix(e,"a=ssrc-group:FID").map((function(e){return e.substr(17).split(" ").map((function(e){return parseInt(e,10)}))}));u.length>0&&u[0].length>1&&u[0][0]===c&&(t=u[0][1]),i.codecs.forEach((function(e){if("RTX"===e.name.toUpperCase()&&e.parameters.apt){var n={ssrc:c,codecPayloadType:parseInt(e.parameters.apt,10)};c&&t&&(n.rtx={ssrc:t}),r.push(n),o&&((n=JSON.parse(JSON.stringify(n))).fec={ssrc:c,mechanism:a?"red+ulpfec":"red"},r.push(n))}})),0===r.length&&c&&r.push({ssrc:c});var d=n.matchPrefix(e,"b=");return d.length&&(d=0===d[0].indexOf("b=TIAS:")?parseInt(d[0].substr(7),10):0===d[0].indexOf("b=AS:")?1e3*parseInt(d[0].substr(5),10)*.95-16e3:void 0,r.forEach((function(e){e.maxBitrate=d}))),r},n.parseRtcpParameters=function(e){var t={},r=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"cname"===e.attribute}))[0];r&&(t.cname=r.value,t.ssrc=r.ssrc);var i=n.matchPrefix(e,"a=rtcp-rsize");t.reducedSize=i.length>0,t.compound=0===i.length;var o=n.matchPrefix(e,"a=rtcp-mux");return t.mux=o.length>0,t},n.parseMsid=function(e){var t,r=n.matchPrefix(e,"a=msid:");if(1===r.length)return{stream:(t=r[0].substr(7).split(" "))[0],track:t[1]};var i=n.matchPrefix(e,"a=ssrc:").map((function(e){return n.parseSsrcMedia(e)})).filter((function(e){return"msid"===e.attribute}));return i.length>0?{stream:(t=i[0].value.split(" "))[0],track:t[1]}:void 0},n.parseSctpDescription=function(e){var t,r=n.parseMLine(e),i=n.matchPrefix(e,"a=max-message-size:");i.length>0&&(t=parseInt(i[0].substr(19),10)),isNaN(t)&&(t=65536);var o=n.matchPrefix(e,"a=sctp-port:");if(o.length>0)return{port:parseInt(o[0].substr(12),10),protocol:r.fmt,maxMessageSize:t};if(n.matchPrefix(e,"a=sctpmap:").length>0){var a=n.matchPrefix(e,"a=sctpmap:")[0].substr(10).split(" ");return{port:parseInt(a[0],10),protocol:a[1],maxMessageSize:t}}},n.writeSctpDescription=function(e,t){var r=[];return r="DTLS/SCTP"!==e.protocol?["m="+e.kind+" 9 "+e.protocol+" "+t.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+t.port+"\r\n"]:["m="+e.kind+" 9 "+e.protocol+" "+t.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+t.port+" "+t.protocol+" 65535\r\n"],void 0!==t.maxMessageSize&&r.push("a=max-message-size:"+t.maxMessageSize+"\r\n"),r.join("")},n.generateSessionId=function(){return Math.random().toString().substr(2,21)},n.writeSessionBoilerplate=function(e,t,r){var i=void 0!==t?t:2;return"v=0\r\no="+(r||"thisisadapterortc")+" "+(e||n.generateSessionId())+" "+i+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"},n.writeMediaSection=function(e,t,r,i){var o=n.writeRtpDescription(e.kind,t);if(o+=n.writeIceParameters(e.iceGatherer.getLocalParameters()),o+=n.writeDtlsParameters(e.dtlsTransport.getLocalParameters(),"offer"===r?"actpass":"active"),o+="a=mid:"+e.mid+"\r\n",e.direction?o+="a="+e.direction+"\r\n":e.rtpSender&&e.rtpReceiver?o+="a=sendrecv\r\n":e.rtpSender?o+="a=sendonly\r\n":e.rtpReceiver?o+="a=recvonly\r\n":o+="a=inactive\r\n",e.rtpSender){var a="msid:"+i.id+" "+e.rtpSender.track.id+"\r\n";o+="a="+a,o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" "+a,e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" "+a,o+="a=ssrc-group:FID "+e.sendEncodingParameters[0].ssrc+" "+e.sendEncodingParameters[0].rtx.ssrc+"\r\n")}return o+="a=ssrc:"+e.sendEncodingParameters[0].ssrc+" cname:"+n.localCName+"\r\n",e.rtpSender&&e.sendEncodingParameters[0].rtx&&(o+="a=ssrc:"+e.sendEncodingParameters[0].rtx.ssrc+" cname:"+n.localCName+"\r\n"),o},n.getDirection=function(e,t){for(var r=n.splitLines(e),i=0;i<r.length;i++)switch(r[i]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[i].substr(2)}return t?n.getDirection(t):"sendrecv"},n.getKind=function(e){return n.splitLines(e)[0].split(" ")[0].substr(2)},n.isRejected=function(e){return"0"===e.split(" ",2)[1]},n.parseMLine=function(e){var t=n.splitLines(e)[0].substr(2).split(" ");return{kind:t[0],port:parseInt(t[1],10),protocol:t[2],fmt:t.slice(3).join(" ")}},n.parseOLine=function(e){var t=n.matchPrefix(e,"o=")[0].substr(2).split(" ");return{username:t[0],sessionId:t[1],sessionVersion:parseInt(t[2],10),netType:t[3],addressType:t[4],address:t[5]}},n.isValidSDP=function(e){if("string"!=typeof e||0===e.length)return!1;for(var t=n.splitLines(e),r=0;r<t.length;r++)if(t[r].length<2||"="!==t[r].charAt(1))return!1;return!0},"object"==M(t)&&(t.exports=n)},{}]},{},[1])(1);var qi,Yi,$i,Xi,Qi,Zi,eo,to,ro,no,io,oo,ao,so,co,uo,lo,ho,po=function(){function e(t){var r=this;D(this,e),Gi.set(this,void 0),Hi.set(this,void 0),K(this,Gi,new RTCPeerConnection,"f"),K(this,Hi,t,"f"),z(this,Gi,"f").onaddstream=function(e){z(r,Hi,"f")&&Promise.resolve().then((function(){var t;null===(t=z(r,Hi,"f"))||void 0===t||t.call(r,e)}))},z(this,Gi,"f").ontrack=function(e){z(r,Hi,"f")&&Promise.resolve().then((function(){var t;null===(t=z(r,Hi,"f"))||void 0===t||t.call(r,e)}))}}return N(e,[{key:"play",value:function(e,t){return H(this,void 0,void 0,x().mark((function r(){var n,i,o,a,s,c,u;return x().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,null===(n=z(this,Gi,"f"))||void 0===n?void 0:n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});case 2:return a=r.sent,r.next=5,null===(i=z(this,Gi,"f"))||void 0===i?void 0:i.setLocalDescription(a);case 5:return s={api:e,streamurl:t,clientip:null,sdp:null==a?void 0:a.sdp},r.next=8,fetch(e,{method:"post",body:JSON.stringify(s),headers:{"Content-Type":"application/json"}}).then((function(e){return e.json()}));case 8:return c=r.sent,u=c.sdp,c.sdp=u.replace("a=rtpmap:102 H264/90000","a=rtpmap:102 H264/90000\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f"),r.next=13,null===(o=z(this,Gi,"f"))||void 0===o?void 0:o.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:c.sdp}));case 13:return r.abrupt("return",c);case 14:case"end":return r.stop()}}),r,this)})))}},{key:"close",value:function(){var e;null===(e=z(this,Gi,"f"))||void 0===e||e.close()}}],[{key:"parseRtcUrl",value:function(e){var t=function(e){var t=document.createElement("a");t.href=e.replace("rtmp://","http://").replace("webrtc://","http://").replace("rtc://","http://");var r=t.hostname,n=t.pathname.substr(1,t.pathname.lastIndexOf("/")-1),i=t.pathname.substr(t.pathname.lastIndexOf("/")+1);if((n=n.replace("...vhost...","?vhost=")).indexOf("?")>=0){var o=n.substr(n.indexOf("?"));n=n.substr(0,n.indexOf("?")),o.indexOf("vhost=")>0&&(r=o.substr(o.indexOf("vhost=")+6)).indexOf("&")>0&&(r=r.substr(0,r.indexOf("&")))}t.hostname===r&&/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/.test(t.hostname)&&(r="__defaultVhost__");var a="rtmp";e.indexOf("://")>0&&(a=e.substr(0,e.indexOf("://")));var s=t.port;s||("http"===a?s=80:"https"===a?s=443:"rtmp"===a&&(s=1935));var c={url:e,schema:a,server:t.hostname,port:s,vhost:r,app:n,stream:i};return function(e,t){if(t.user_query={},0!==e.length){e.indexOf("?")>=0&&(e=e.split("?")[1]);for(var r=e.split("&"),n=0;n<r.length;n++){var i=r[n].split("=");t[i[0]]=i[1],t.user_query[i[0]]=i[1]}t.domain&&(t.vhost=t.domain)}}(t.search,c),c.port||"webrtc"!==a&&"rtc"!==a||("https"===c.user_query.schema||0===window.location.href.indexOf("https://")?c.port=443:c.port=1985),c}(e),r=t.user_query.schema,n=r?r+":":window.location.protocol,i=t.port||("https:"===n?443:1985),o=t.user_query.play||"/rtc/v1/play/",a="".concat(o).concat(o.lastIndexOf("/")!==o.length-1?"/":""),s="".concat(n,"//").concat(t.server,":").concat(i).concat(a);for(var c in t.user_query)"api"!==c&&"play"!==c&&(s+="&"+c+"="+t.user_query[c]);return{apiUrl:s=s.replace(a+"&",a+"?"),streamUrl:t.url,schema:n,urlObject:t,port:i}}}]),e}();Gi=new WeakMap,Hi=new WeakMap;var fo,mo,vo,go,yo,bo,So,Eo,Co,To,wo,_o,ko,Ro,Io,Oo,Po,Ao,xo=function(){function e(){var t;return D(this,e),t=P(this,e),qi.set(B(t),1),Yi.set(B(t),!1),$i.set(B(t),!1),Xi.set(B(t),void 0),Qi.set(B(t),void 0),Zi.set(B(t),void 0),eo.set(B(t),void 0),to.set(B(t),!1),ro.set(B(t),window.navigator.userAgent.match(/CPU.+Mac OS X/)&&window.navigator.userAgent.match(/(iPhone)|(iPad)/)),no.set(B(t),!0),io.set(B(t),(function(){z(B(t),to,"f")||t.emit(q.play),K(B(t),to,!0,"f"),z(B(t),ro,"f")&&z(B(t),ao,"f").call(B(t),!1),t.emit(q.playing)})),oo.set(B(t),(function(){z(B(t),ao,"f").call(B(t),!1),t.emit(q.error)})),ao.set(B(t),(function(e){e?(K(B(t),no,!0,"f"),t.emit(q.waiting)):(K(B(t),no,!1,"f"),clearTimeout(z(B(t),eo,"f")))})),so.set(B(t),(function(){K(B(t),eo,setTimeout((function(){z(B(t),ao,"f").call(B(t),!0)}),300),"f")})),co.set(B(t),(function(){z(B(t),ao,"f").call(B(t),!1),z(B(t),ro,"f")||z(B(t),Zi,"f")&&z(B(t),no,"f")&&(z(B(t),ao,"f").call(B(t),!1),z(B(t),io,"f").call(B(t)))})),uo.set(B(t),(function(){return H(B(t),void 0,void 0,x().mark((function e(){var t,r,n,i,o,a,s,c,u,d,l,h,p,f;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=z(this,Xi,"f"),r=t.sid,n=t.streamUrl,i=po.parseRtcUrl(n||""),o=Z(),a=o.promise,s=o.controller,c=Z(),u=c.promise,d=c.controller,l=new po((function(e){u.then((function(t){var r,n;e.stream||e.streams[0]?null===(n=s.resolve)||void 0===n||n.call(s,{stream:e.stream||e.streams[0],sessionid:t}):null===(r=s.reject)||void 0===r||r.call(s,new Error("no stream available"))}))})),l.play(i.apiUrl,i.streamUrl).then((function(e){var t;null===(t=d.resolve)||void 0===t||t.call(d,e.sessionid)})).catch((function(e){var t;console.error("rtc error",null==e?void 0:e.message),l.close(),null===(t=d.reject)||void 0===t||t.call(d,e)})),e.next=8,a;case 8:return h=e.sent,p=h.stream,f=h.sessionid,e.abrupt("return",{stream:p,sessionid:f,sid:r||""});case 12:case"end":return e.stop()}}),e,this)})))})),lo.set(B(t),(function(e){return H(B(t),void 0,void 0,x().mark((function t(){var r,n,i=this;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(z(this,Zi,"f")||((n=K(this,Zi,document.createElement("video"),"f")).setAttribute("x5-video-player-type","h5"),n.setAttribute("x5-video-player-fullscreen","true"),n.setAttribute("x-webkit-airplay","allow"),n.setAttribute("webkit-playsinline","webkit-playsinline"),n.setAttribute("playsinline","playsinline"),n.addEventListener("waiting",z(this,so,"f")),n.addEventListener("play",z(this,io,"f")),n.addEventListener("playing",z(this,io,"f")),n.addEventListener("error",z(this,oo,"f")),n.addEventListener("timeupdate",z(this,co,"f")),n.style.objectFit="contain",null===(r=z(this,Qi,"f"))||void 0===r||r.appendChild(n)),z(this,Zi,"f")&&z(this,Qi,"f")){t.next=3;break}return t.abrupt("return");case 3:try{z(this,Zi,"f").srcObject=e}catch(t){z(this,Zi,"f").src=window.URL.createObjectURL(e),window.URL.revokeObjectURL(z(this,Zi,"f").src)}return t.next=6,z(this,Zi,"f").play().catch((function(e){if("NotAllowedError"===(null==e?void 0:e.name)&&z(i,Zi,"f"))return i.emit(q.playNotAllowed,te.code),i.muted=!0,K(i,Yi,!0,"f"),z(i,Zi,"f").play()}));case 6:case"end":return t.stop()}}),t,this)})))})),ho.set(B(t),(function(){var e;z(B(t),ao,"f").call(B(t),!1);var r=z(B(t),Zi,"f");r&&(r.removeEventListener("waiting",z(B(t),so,"f")),r.removeEventListener("play",z(B(t),io,"f")),r.removeEventListener("playing",z(B(t),io,"f")),r.removeEventListener("error",z(B(t),oo,"f")),r.removeEventListener("timeupdate",z(B(t),co,"f"))),null===(e=z(B(t),Zi,"f"))||void 0===e||e.pause(),K(B(t),Zi,void 0,"f")})),t}return j(e,X),N(e,[{key:"muted",get:function(){var e=z(this,$i,"f");if(z(this,Zi,"f"))try{e=z(this,Zi,"f").muted}catch(e){}return e},set:function(e){K(this,$i,e,"f"),z(this,Zi,"f")&&(e?z(this,Zi,"f").muted=!0:(z(this,Zi,"f").play().catch((function(e){})),z(this,Zi,"f").muted=!1))}},{key:"volume",get:function(){return z(this,qi,"f")},set:function(e){e>1&&(e=1),K(this,qi,e,"f"),z(this,Zi,"f")&&(z(this,Zi,"f").volume=e)}},{key:"stream",set:function(e){K(this,Xi,e,"f")}},{key:"videoWrapper",set:function(e){K(this,Qi,e,"f")}},{key:"play",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,z(this,uo,"f").call(this);case 2:return t=e.sent,e.next=5,z(this,lo,"f").call(this,t.stream);case 5:case 6:case"end":return e.stop()}}),e,this)})))}},{key:"resume",value:function(){z(this,Zi,"f")&&(z(this,Yi,"f")&&(this.muted=!1,K(this,Yi,!1,"f")),z(this,Zi,"f").play().catch((function(e){})))}},{key:"stop",value:function(){K(this,Yi,!1,"f"),this.emit(q.stop),z(this,ho,"f").call(this)}},{key:"setSinkId",value:function(e){return H(this,void 0,void 0,x().mark((function t(){var r;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(r=z(this,Zi,"f"))||void 0===r?void 0:r.setSinkId(e);case 2:case"end":return t.stop()}}),t,this)})))}},{key:"getSinkId",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null===(t=z(this,Zi,"f"))||void 0===t?void 0:t.sinkId)||"");case 1:case"end":return e.stop()}}),e,this)})))}},{key:"destroy",value:function(){this.stop(),G(V(e.prototype),"destroy",this).call(this)}},{key:"resize",value:function(){}}]),e}();qi=new WeakMap,Yi=new WeakMap,$i=new WeakMap,Xi=new WeakMap,Qi=new WeakMap,Zi=new WeakMap,eo=new WeakMap,to=new WeakMap,ro=new WeakMap,no=new WeakMap,io=new WeakMap,oo=new WeakMap,ao=new WeakMap,so=new WeakMap,co=new WeakMap,uo=new WeakMap,lo=new WeakMap,ho=new WeakMap,function(e){e[e.webrtc=6]="webrtc",e[e.xrtc=12]="xrtc",e[e.text=99]="text"}(fo||(fo={})),function(e){e[e.start=0]="start",e[e.intermediate=1]="intermediate",e[e.end=2]="end"}(mo||(mo={})),function(e){e.init="0",e.bs="2",e.audio="3",e.asr="4",e.nlp="5",e.frameBegin="10",e.duration="9",e.frameEnd="11",e.commonError="-9",e.seriousError="-99"}(vo||(vo={})),function(e){e.ping="-99",e.break="-1",e.init="0",e.nlpByVoice="1",e.nlpByText="2",e.repeatText="3",e.repeatVoice="4",e.repeatBigVoice="5",e.actionPlay="6"}(go||(go={}));var Lo=function(){function e(){var t;return D(this,e),t=P(this,e),yo.set(B(t),void 0),bo.set(B(t),fo.xrtc),So.set(B(t),!1),Eo.set(B(t),1),Co.set(B(t),void 0),To.set(B(t),void 0),wo.set(B(t),void 0),_o.set(B(t),void 0),ko.set(B(t),{width:1080,height:1920}),Ro.set(B(t),1),Io.set(B(t),(function(){var e;z(B(t),yo,"f")&&z(B(t),yo,"f").destroy(),z(B(t),bo,"f")===fo.xrtc?K(B(t),yo,new Ki,"f"):z(B(t),bo,"f")===fo.webrtc&&K(B(t),yo,new xo,"f"),null===(e=z(B(t),yo,"f"))||void 0===e||e.on(q.play,(function(){t.emit(q.play)})).on(q.waiting,(function(){t.emit(q.waiting)})).on(q.playing,(function(){t.emit(q.playing)})).on(q.playNotAllowed,(function(){t.emit(q.playNotAllowed)})).on(q.stop,(function(){t.emit(q.stop)})).on(q.error,(function(e){t.emit(q.error,e)}))})),Oo.set(B(t),(function(){var e;if(!z(B(t),wo,"f")){var r=K(B(t),wo,document.createElement("div"),"f");r.setAttribute("id","xvideo"),r.style.position="relative",r.style.width="100%",r.style.height="100%",r.style.minWidth="100%",r.style.minHeight="100%",r.style.pointerEvents="none",null===(e=z(B(t),To,"f"))||void 0===e||e.appendChild(r)}if(!z(B(t),_o,"f")){var n=K(B(t),_o,document.createElement("div"),"f");n.style.position="absolute",t.resize(),z(B(t),wo,"f").appendChild(n),window.addEventListener("resize",z(B(t),Po,"f"))}})),Po.set(B(t),(function(){var e,r,n=z(B(t),ko,"f"),i=n.width,o=n.height,a=(null===(e=z(B(t),wo,"f"))||void 0===e?void 0:e.offsetWidth)||0,s=(null===(r=z(B(t),wo,"f"))||void 0===r?void 0:r.offsetHeight)||0;if(z(B(t),_o,"f")){var c=1;c=a/s>i/o?s/o:a/i,z(B(t),_o,"f").style.left="50%",z(B(t),_o,"f").style.top="50%";var u=z(B(t),Ro,"f")*c;z(B(t),_o,"f").style.transform="translate(-50%,-50%) scale(".concat(u,", ").concat(c,")")}})),Ao.set(B(t),(function(){window.removeEventListener("resize",z(B(t),Po,"f")),z(B(t),_o,"f")&&(z(B(t),_o,"f").remove(),K(B(t),_o,void 0,"f")),z(B(t),wo,"f")&&(z(B(t),wo,"f").remove(),K(B(t),wo,void 0,"f"))})),t}return j(e,X),N(e,[{key:"playerType",set:function(e){K(this,bo,e,"f")}},{key:"muted",get:function(){var e,t=z(this,So,"f");if(z(this,yo,"f"))try{t=null===(e=z(this,yo,"f"))||void 0===e?void 0:e.muted}catch(e){}return t},set:function(e){K(this,So,e,"f"),z(this,yo,"f")&&(e?z(this,yo,"f").muted=!0:(z(this,yo,"f").resume(),z(this,yo,"f").muted=!1))}},{key:"volume",get:function(){var e;return(null===(e=z(this,yo,"f"))||void 0===e?void 0:e.volume)||z(this,Eo,"f")},set:function(e){e>1&&(e=1),K(this,Eo,e,"f"),z(this,yo,"f")&&(z(this,yo,"f").volume=e)}},{key:"stream",set:function(e){K(this,Co,e,"f"),z(this,yo,"f")&&(z(this,yo,"f").stream=e)}},{key:"container",set:function(e){K(this,To,e,"f")}},{key:"videoSize",set:function(e){K(this,ko,e,"f")}},{key:"play",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return z(this,Oo,"f").call(this),z(this,Io,"f").call(this),z(this,yo,"f")&&(z(this,Co,"f")&&(z(this,yo,"f").stream=z(this,Co,"f")),z(this,yo,"f").videoWrapper=z(this,_o,"f")),e.prev=3,e.next=6,null===(t=z(this,yo,"f"))||void 0===t?void 0:t.play();case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),this.stop();case 11:case"end":return e.stop()}}),e,this,[[3,8]])})))}},{key:"resume",value:function(){z(this,yo,"f")&&z(this,yo,"f").resume()}},{key:"stop",value:function(){var e;z(this,Ao,"f").call(this),null===(e=z(this,yo,"f"))||void 0===e||e.stop()}},{key:"scaleX",get:function(){return z(this,Ro,"f")||1},set:function(e){K(this,Ro,e,"f"),z(this,Po,"f").call(this)}},{key:"setSinkId",value:function(e){return H(this,void 0,void 0,x().mark((function t(){var r;return x().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(r=z(this,yo,"f"))||void 0===r?void 0:r.setSinkId(e);case 2:case"end":return t.stop()}}),t,this)})))}},{key:"getSinkId",value:function(){return H(this,void 0,void 0,x().mark((function e(){var t;return x().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null===(t=z(this,yo,"f"))||void 0===t?void 0:t.getSinkId())||"");case 1:case"end":return e.stop()}}),e,this)})))}},{key:"destroy",value:function(){this.stop(),G(V(e.prototype),"destroy",this).call(this)}},{key:"resize",value:function(){var e;z(this,_o,"f")&&(z(this,_o,"f").style.width="".concat(z(this,ko,"f").width,"px"),z(this,_o,"f").style.height="".concat(z(this,ko,"f").height,"px")),null===(e=z(this,yo,"f"))||void 0===e||e.resize(),z(this,Po,"f").call(this)}}]),e}();yo=new WeakMap,bo=new WeakMap,So=new WeakMap,Eo=new WeakMap,Co=new WeakMap,To=new WeakMap,wo=new WeakMap,_o=new WeakMap,ko=new WeakMap,Ro=new WeakMap,Io=new WeakMap,Oo=new WeakMap,Po=new WeakMap,Ao=new WeakMap;const Mo=new Lo;var Do={data(){return{}},methods:{play(){Mo.resume(),Mo?.on("play",(function(){console.log("play事件")})).on("playing",(function(){console.log("playing事件")})).on("waiting",(function(){console.log("waiting事件")})).on("error",(function(e){console.log("error:",e)})).on("not-allowed",(function(){console.log("触发游览器限制播放策略，播放前必须要先与游览器产生交互（例如点击页面或者dom组件),触发该事件后去调用resume（）方法解除限制"),Mo.resume()})),Mo.playerType=6,Mo.stream={sid:"e754f25f-509d-ee77-29f9-4e4b567597e1",streamUrl:"webrtc://srs-stream.cn-huadong-1.xf-yun.com:19850/live/a78ca3f0?stream=a78ca3f0"},Mo.videoSize={width:720,height:1280},Mo.container=document.querySelector(".wrapperPlayer"),Mo.play()}}},Uo=Do,No=(0,S.A)(Uo,I,O,!1,null,"dfd4db88",null),jo=No.exports;i["default"].use(R.A);const Vo=[{path:"/bishileidatu",name:"bishileidatu",component:()=>n.e(848).then(n.bind(n,848))},{path:"/",name:"login",component:()=>n.e(793).then(n.bind(n,2793))},{path:"/jianlifenxi",name:"进行简历分析",component:()=>n.e(783).then(n.bind(n,4164))},{path:"/mianshi",name:"avatar",component:C},{path:"/player",name:"xrtcplayer",component:jo},{path:"/three",name:"question",component:()=>n.e(998).then(n.bind(n,6998))}],Fo=new R.A({routes:Vo});var Wo=Fo,Bo=n(9143),Go=n.n(Bo);i["default"].config.productionTip=!1,i["default"].use(Go()),new i["default"]({router:Wo,el:"#app",render:e=>e(k)}).$mount("#app")},2002:function(e,t,r){r.d(t,{A:function(){return hc},C:function(){return L},E:function(){return K},L:function(){return Ce},P:function(){return ke},S:function(){return _e},_:function(){return b},a:function(){return v},b:function(){return l},c:function(){return T},d:function(){return J},e:function(){return A},f:function(){return x},g:function(){return y},h:function(){return P},i:function(){return p},j:function(){return Z},k:function(){return D},l:function(){return w},m:function(){return S},n:function(){return He},o:function(){return m},p:function(){return Dt}});var n,i,o,a,s,c,u,d;r(4114),r(6573),r(8100),r(7936),r(8111),r(2489),r(7588),r(1701),r(8237),r(7467),r(4732),r(9577),r(4979),r(4603),r(7566),r(8721);function l(e,t,r){return t=S(t),function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return T(e)}(e,h()?Reflect.construct(t,r||[],S(e).constructor):t.apply(e,r))}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(h=function(){return!!e})()}function p(){p=function(){return t};var e,t={},r=Object.prototype,n=r.hasOwnProperty,i=Object.defineProperty||function(e,t,r){e[t]=r.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",c=o.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function d(e,t,r,n){var o=t&&t.prototype instanceof y?t:y,a=Object.create(o.prototype),s=new A(n||[]);return i(a,"_invoke",{value:R(e,r,s)}),a}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var h="suspendedStart",f="suspendedYield",m="executing",v="completed",g={};function y(){}function b(){}function S(){}var E={};u(E,a,(function(){return this}));var C=Object.getPrototypeOf,T=C&&C(C(x([])));T&&T!==r&&n.call(T,a)&&(E=T);var w=S.prototype=y.prototype=Object.create(E);function _(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function k(e,t){function r(i,o,a,s){var c=l(e[i],e,o);if("throw"!==c.type){var u=c.arg,d=u.value;return d&&"object"==typeof d&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,a,s)}),(function(e){r("throw",e,a,s)})):t.resolve(d).then((function(e){u.value=e,a(u)}),(function(e){return r("throw",e,a,s)}))}s(c.arg)}var o;i(this,"_invoke",{value:function(e,n){function i(){return new t((function(t,i){r(e,n,t,i)}))}return o=o?o.then(i,i):i()}})}function R(t,r,n){var i=h;return function(o,a){if(i===m)throw new Error("Generator is already running");if(i===v){if("throw"===o)throw a;return{value:e,done:!0}}for(n.method=o,n.arg=a;;){var s=n.delegate;if(s){var c=I(s,n);if(c){if(c===g)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(i===h)throw i=v,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);i=m;var u=l(t,r,n);if("normal"===u.type){if(i=n.done?v:f,u.arg===g)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(i=v,n.method="throw",n.arg=u.arg)}}}function I(t,r){var n=r.method,i=t.iterator[n];if(i===e)return r.delegate=null,"throw"===n&&t.iterator.return&&(r.method="return",r.arg=e,I(t,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),g;var o=l(i,t.iterator,r.arg);if("throw"===o.type)return r.method="throw",r.arg=o.arg,r.delegate=null,g;var a=o.arg;return a?a.done?(r[t.resultName]=a.value,r.next=t.nextLoc,"return"!==r.method&&(r.method="next",r.arg=e),r.delegate=null,g):a:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function P(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function x(t){if(t||""===t){var r=t[a];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,o=function r(){for(;++i<t.length;)if(n.call(t,i))return r.value=t[i],r.done=!1,r;return r.value=e,r.done=!0,r};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return b.prototype=S,i(w,"constructor",{value:S,configurable:!0}),i(S,"constructor",{value:b,configurable:!0}),b.displayName=u(S,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===b||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,u(e,c,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},_(k.prototype),u(k.prototype,s,(function(){return this})),t.AsyncIterator=k,t.async=function(e,r,n,i,o){void 0===o&&(o=Promise);var a=new k(d(e,r,n,i),o);return t.isGeneratorFunction(r)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},_(w),u(w,c,"Generator"),u(w,a,(function(){return this})),u(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),r=[];for(var n in t)r.push(n);return r.reverse(),function e(){for(;r.length;){var n=r.pop();if(n in t)return e.value=n,e.done=!1,e}return e.done=!0,e}},t.values=x,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(P),!t)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var r=this;function i(n,i){return s.type="throw",s.arg=t,r.next=n,i&&(r.method="next",r.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var c=n.call(a,"catchLoc"),u=n.call(a,"finallyLoc");if(c&&u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),P(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;P(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,r,n){return this.delegate={iterator:x(t),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=e),g}},t}function f(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var r=e[Symbol.toPrimitive];if(void 0!==r){var n=r.call(e,t||"default");if("object"!=typeof n)return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}function m(e){return m="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},m(e)}function v(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function g(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,f(n.key),n)}}function y(e,t,r){return t&&g(e.prototype,t),r&&g(e,r),Object.defineProperty(e,"prototype",{writable:!1}),e}function b(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&E(e,t)}function S(e){return S=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},S(e)}function E(e,t){return E=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},E(e,t)}function C(e){var t="function"==typeof Map?new Map:void 0;return C=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(h){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,r)}function r(){return function(e,t,r){if(h())return Reflect.construct.apply(null,arguments);var n=[null];n.push.apply(n,t);var i=new(e.bind.apply(e,n));return r&&E(i,r.prototype),i}(e,arguments,S(this).constructor)}return r.prototype=Object.create(e.prototype,{constructor:{value:r,enumerable:!1,writable:!0,configurable:!0}}),E(r,e)},C(e)}function T(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function w(){return w="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,r){var n=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=S(e)););return e}(e,t);if(n){var i=Object.getOwnPropertyDescriptor(n,t);return i.get?i.get.call(arguments.length<3?e:r):i.value}},w.apply(this,arguments)}function _(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var r=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=r){var n,i,o,a,s=[],c=!0,u=!1;try{if(o=(r=r.call(e)).next,0===t){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=o.call(r)).done)&&(s.push(n.value),s.length!==t);c=!0);}catch(e){u=!0,i=e}finally{try{if(!c&&null!=r.return&&(a=r.return(),Object(a)!==a))return}finally{if(u)throw i}}return s}}(e,t)||R(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(e){return function(e){if(Array.isArray(e))return I(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||R(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function R(e,t){if(e){if("string"==typeof e)return I(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?I(e,t):void 0}}function I(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function O(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function P(e,t,r,n){return new(r||(r=Promise))((function(i,o){function a(e){try{c(n.next(e))}catch(e){o(e)}}function s(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,s)}c((n=n.apply(e,t||[])).next())}))}function A(e,t,r,n){if("a"===r&&!n)throw new TypeError("Private accessor was defined without a getter");if("function"==typeof t?e!==t||!n:!t.has(e))throw new TypeError("Cannot read private member from an object whose class did not declare it");return"m"===r?n:"a"===r?n.call(e):n?n.value:t.get(e)}function x(e,t,r,n,i){if("m"===n)throw new TypeError("Private method is not writable");if("a"===n&&!i)throw new TypeError("Private accessor was defined without a setter");if("function"==typeof t?e!==t||!i:!t.has(e))throw new TypeError("Cannot write private member to an object whose class did not declare it");return"a"===n?i.call(e,r):i?i.value=r:t.set(e,r),r}"function"==typeof SuppressedError&&SuppressedError,function(e){e[e.start=0]="start",e[e.intermediate=1]="intermediate",e[e.end=2]="end"}(n||(n={})),function(e){e[e.disconnected=0]="disconnected",e[e.connecting=2]="connecting",e[e.connected=1]="connected"}(i||(i={})),function(e){e[e.start=0]="start",e[e.processing=1]="processing",e[e.stop=2]="stop"}(o||(o={})),function(e){e[e.start=0]="start",e[e.stop=2]="stop"}(a||(a={})),function(e){e[e.append=0]="append",e[e.break=1]="break"}(s||(s={})),function(e){e[e.offline=0]="offline",e[e.realtime=1]="realtime"}(c||(c={})),function(e){e.live="live",e.genneral="genneral"}(u||(u={})),function(e){e.action="action"}(d||(d={}));var L=function(){function e(t,r,n,i,o){var a;return v(this,e),(a=l(this,e,[t])).name=n,a.code=r,a.request_id=o||"",a.sid=i||"",a}return b(e,C(Error)),y(e)}();function M(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})).replace(/-/g,"")}var D=function(){var e={resolve:function(){},reject:function(){}};return{promise:new Promise((function(t,r){e.resolve=t,e.reject=r})),controller:e}};function U(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return t.reduce((function(e,t){for(var r in t)if(t.hasOwnProperty(r)){var n=t[r],i=e[r];"object"===m(n)&&null!=n&&"object"===m(i)&&null!=i?Array.isArray(n)?e[r]=k(n):e[r]=U(i,n):e[r]=n}return e}),{})}const N="function"==typeof Buffer,j=("function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder&&new TextEncoder,Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=")),V=((()=>{let e={};j.forEach(((t,r)=>e[t]=r))})(),String.fromCharCode.bind(String)),F=("function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array),e=>e.replace(/=/g,"").replace(/[+\/]/g,(e=>"+"==e?"-":"_"))),W=e=>{let t,r,n,i,o="";const a=e.length%3;for(let s=0;s<e.length;){if((r=e.charCodeAt(s++))>255||(n=e.charCodeAt(s++))>255||(i=e.charCodeAt(s++))>255)throw new TypeError("invalid character found");t=r<<16|n<<8|i,o+=j[t>>18&63]+j[t>>12&63]+j[t>>6&63]+j[63&t]}return a?o.slice(0,a-3)+"===".substring(a):o},B="function"==typeof btoa?e=>btoa(e):N?e=>Buffer.from(e,"binary").toString("base64"):W,G=N?e=>Buffer.from(e).toString("base64"):e=>{let t=[];for(let r=0,n=e.length;r<n;r+=4096)t.push(V.apply(null,e.subarray(r,r+4096)));return B(t.join(""))},H=(e,t=!1)=>t?F(G(e)):G(e),z=H;var K,J,q,Y={code:"600000",message:"必要参数缺失"},$={code:"600003",message:"连接异常"},X={code:"600004",message:"无效的响应"},Q={code:"999999",message:"未知错误"},Z={EmptyStreamError:{code:"700000",message:"无效的流数据"},PlayNotAllowed:{code:"700006",message:"播放不允许"},MissingPlayerLibsError:{code:"700001",message:"缺失播放插件"},H264NotSupported:{code:"700002",message:"当前设备不支持 H.264"},Unknown:{code:"700005",message:"播放失败"}},ee={code:"800000",message:"不支持的环境"},te={code:"800001",message:"未找到指定约束的设备"},re={code:"800002",message:"设备访问权限异常/无法请求使用源设备"},ne={code:"800003",message:"暂时无法访问摄像头/麦克风，请确保当前没有其他应用请求访问设备，并重试"},ie={code:"800004",message:"无效的设备请求参数"},oe={code:"800005",message:"未知原因操作已终止"},ae={code:"800006",message:"当前页面未处于激活状态"},se={code:"800007",message:"页面未发生用户交互，请求被终止"};!function(e){e.InvalidParam="InvalidParam",e.InvalidResponse="InvalidResponse",e.ContextError="ContextError",e.NetworkError="NetworkError",e.ConnectError="ConnectError",e.InvalidConnect="InvalidConnect",e.MediaError="MediaError",e.UserMediaError="UserMediaError"}(K||(K={})),function(e){e[e.verbose=0]="verbose",e[e.debug=1]="debug",e[e.info=2]="info",e[e.warn=3]="warn",e[e.error=4]="error",e[e.none=5]="none"}(J||(J={}));var ce=function(){function e(){v(this,e),q.set(this,J.warn)}return y(e,[{key:"setLogLevel",value:function(e){x(this,q,e,"f")}},{key:"record",value:function(e){var t,r,n,i,o;if(e>=A(this,q,"f")){for(var a=arguments.length,s=new Array(a>1?a-1:0),c=1;c<a;c++)s[c-1]=arguments[c];switch(e){case J.verbose:(t=console).log.apply(t,["[SDK] [VERBOSE] "].concat(s));break;case J.debug:(r=console).log.apply(r,["[SDK] [DEBUG] "].concat(s));break;case J.info:(n=console).log.apply(n,["[SDK] [INFO] "].concat(s));break;case J.warn:(i=console).warn.apply(i,["[SDK] [WARN] "].concat(s));break;case J.error:(o=console).error.apply(o,["[SDK] [ERROR] "].concat(s))}}}}]),e}();q=new WeakMap;var ue,de,le,he,pe,fe,me,ve,ge,ye,be,Se,Ee,Ce=new ce,Te=function(){function e(t,r){var n=this;v(this,e),de.set(this,void 0),le.set(this,ue.CLOSED),he.set(this,"web"),pe.set(this,void 0),fe.set(this,void 0),me.set(this,void 0),ve.set(this,void 0),"undefined"!=typeof wx&&wx.env&&x(this,he,"miniprogram","f"),Ce.record(J.debug,"[ws]",A(this,he,"f"),t),x(this,de,void 0,"f"),x(this,le,ue.CONNECTING,"f"),"miniprogram"===A(this,he,"f")?(x(this,de,wx.connectSocket({url:encodeURI(t)}),"f"),A(this,de,"f").onOpen((function(){var e,t;Ce.record(J.debug,"[ws]","channel open"),x(n,le,ue.OPEN,"f");for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,pe,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))})),A(this,de,"f").onMessage((function(){for(var e,t,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,fe,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))})),A(this,de,"f").onClose((function(){var e,t;Ce.record(J.debug,"[ws]","channel closed"),x(n,le,ue.CLOSED,"f");for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,ve,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))})),A(this,de,"f").onError((function(e){var t;Ce.record(J.error,"[ws]","channel error",e),null===(t=A(n,me,"f"))||void 0===t||t.call(n,e)}))):(x(this,de,new WebSocket(t),"f"),(null==r?void 0:r.binaryData)&&(Ce.record(J.debug,"[ws]","binaryType:ab"),A(this,de,"f").binaryType="arraybuffer"),A(this,de,"f").onopen=function(){var e,t;Ce.record(J.debug,"[ws]","channel open");for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,pe,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))},A(this,de,"f").onmessage=function(){for(var e,t,r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,fe,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))},A(this,de,"f").onclose=function(){var e,t;Ce.record(J.debug,"[ws]","channel closed");for(var r=arguments.length,i=new Array(r),o=0;o<r;o++)i[o]=arguments[o];null===(t=A(n,ve,"f"))||void 0===t||(e=t).call.apply(e,[n].concat(i))},A(this,de,"f").onerror=function(e){var t;Ce.record(J.error,"[ws]","channel error",e),null===(t=A(n,me,"f"))||void 0===t||t.call(n,e)})}return y(e,[{key:"readyState",get:function(){return"miniprogram"===A(this,he,"f")?A(this,le,"f"):A(this,de,"f").readyState}},{key:"onopen",set:function(e){x(this,pe,e,"f")}},{key:"onmessage",set:function(e){x(this,fe,e,"f")}},{key:"onclose",set:function(e){x(this,ve,e,"f")}},{key:"onerror",set:function(e){x(this,me,e,"f")}},{key:"send",value:function(e){"miniprogram"===A(this,he,"f")?A(this,de,"f").send({data:e}):A(this,de,"f").send(e)}},{key:"close",value:function(e){var t,r,n,i;x(this,le,ue.CLOSING,"f"),Ce.record(J.debug,"[ws]","close channel",null!==(t=null==e?void 0:e.code)&&void 0!==t?t:"",null!==(r=null==e?void 0:e.reason)&&void 0!==r?r:""),"miniprogram"===A(this,he,"f")?null===(n=A(this,de,"f"))||void 0===n||n.close(e):null===(i=A(this,de,"f"))||void 0===i||i.close(null==e?void 0:e.code,null==e?void 0:e.reason)}}]),e}();function we(e,t){var r,n=!1;return{abort:function(){var e;n=!0,clearTimeout(void 0),r&&(r.onerror=null,r.onopen=null,r.onmessage=null,null===(e=r.close)||void 0===e||e.call(r))},instablishPromise:new Promise((function(i,o){try{var a=0;(r=new Te(e,t)).onopen=function(){r.onerror=null,r.onopen=null,a=setTimeout((function(){n?r.close():i(r)}),50)},r.onclose=function(e){clearTimeout(a),r.onerror=null,r.onopen=null,r.onclose=null,n||o(e)},r.onerror=function(e){clearTimeout(a),r.onerror=null,r.onopen=null,r.onclose=null,n||o(e)}}catch(e){o(e)}}))}}ue=Te,de=new WeakMap,le=new WeakMap,he=new WeakMap,pe=new WeakMap,fe=new WeakMap,me=new WeakMap,ve=new WeakMap,Te.CONNECTING=0,Te.OPEN=1,Te.CLOSING=2,Te.CLOSED=3;var _e,ke,Re,Ie,Oe,Pe,Ae,xe,Le,Me,De,Ue,Ne,je,Ve,Fe,We,Be,Ge=0,He=function(){function e(t){var r,n=this;v(this,e),ge.set(this,Ge),ye.set(this,{}),be.set(this,[]),Se.set(this,(function(e,t,r){if("function"!=typeof t)throw TypeError("listener must be a function");-1===A(n,be,"f").indexOf(e)&&A(n,be,"f").push(e),A(n,ye,"f")[e]=A(n,ye,"f")[e]||[],A(n,ye,"f")[e].push({once:r||!1,fn:t})})),Ee.set(this,(function(e,t){var r=A(n,ye,"f")[e],i=[];null==r||r.forEach((function(e,r){e.fn.apply(null,t),e.once&&i.unshift(r)})),null==i||i.forEach((function(e){r.splice(e,1)}))})),x(this,ge,null!==(r=null==t?void 0:t.emitDelay)&&void 0!==r?r:Ge,"f")}return y(e,[{key:"on",value:function(e,t){return A(this,Se,"f").call(this,e,t,!1),this}},{key:"once",value:function(e,t){return A(this,Se,"f").call(this,e,t,!0),this}},{key:"off",value:function(e,t){var r=A(this,be,"f").indexOf(e);if(e&&-1!==r)if(t){var n=[],i=A(this,ye,"f")[e];null==i||i.forEach((function(e,r){e.fn===t&&n.unshift(r)})),null==n||n.forEach((function(e){i.splice(e,1)})),i.length||(A(this,be,"f").splice(r,1),delete A(this,ye,"f")[e])}else delete A(this,ye,"f")[e],A(this,be,"f").splice(r,1);return this}},{key:"removeAllListeners",value:function(){return x(this,ye,{},"f"),x(this,be,[],"f"),this}},{key:"emit",value:function(e){for(var t=this,r=arguments.length,n=new Array(r>1?r-1:0),i=1;i<r;i++)n[i-1]=arguments[i];A(this,ge,"f")?setTimeout((function(){A(t,Ee,"f").call(t,e,n)}),A(this,ge,"f")):A(this,Ee,"f").call(this,e,n)}},{key:"emitSync",value:function(e){for(var t=arguments.length,r=new Array(t>1?t-1:0),n=1;n<t;n++)r[n-1]=arguments[n];A(this,Ee,"f").call(this,e,r)}},{key:"destroy",value:function(){x(this,ye,{},"f"),x(this,be,[],"f")}}]),e}();ge=new WeakMap,ye=new WeakMap,be=new WeakMap,Se=new WeakMap,Ee=new WeakMap,function(e){e.connected="connected",e.disconnected="disconnected",e.nlp="nlp",e.asr="asr",e.stream_start="stream_start",e.frame_start="frame_start",e.frame_stop="frame_stop",e.action_start="action_start",e.action_stop="action_stop",e.tts_duration="tts_duration",e.subtitle_info="subtitle_info",e.error="error"}(_e||(_e={})),function(e){e.play="play",e.waiting="waiting",e.playing="playing",e.stop="stop",e.playNotAllowed="not-allowed",e.error="error"}(ke||(ke={}));var ze,Ke=function(){function e(){var t;return v(this,e),t=l(this,e),Re.set(T(t),void 0),Ie.set(T(t),"xrtc"),Oe.set(T(t),void 0),Pe.set(T(t),!1),Ae.set(T(t),1),xe.set(T(t),"center"),Le.set(T(t),void 0),Me.set(T(t),void 0),De.set(T(t),void 0),Ue.set(T(t),void 0),Ne.set(T(t),{width:1080,height:1920}),je.set(T(t),1),Ve.set(T(t),(function(){return P(T(t),void 0,void 0,p().mark((function e(){var t,n,i,o,a,s,c=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(A(this,Re,"f")&&A(this,Re,"f").destroy(),n=void 0,e.prev=2,"xrtc"!==A(this,Ie,"f")){e.next=11;break}return e.next=6,r.e(122).then(r.bind(r,4122));case 6:i=e.sent,o=i.XRTCPlayer,x(this,Re,new o,"f"),e.next=17;break;case 11:if("webrtc"!==A(this,Ie,"f")){e.next=17;break}return e.next=14,r.e(6).then(r.bind(r,7006));case 14:a=e.sent,s=a.WebRTCPlayer,x(this,Re,new s,"f");case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(2),n=new L(Z.MissingPlayerLibsError.message,Z.MissingPlayerLibsError.code,K.MediaError);case 22:if(!n){e.next=24;break}return e.abrupt("return",Promise.reject(n));case 24:null===(t=A(this,Re,"f"))||void 0===t||t.on(ke.play,(function(){c.emit(ke.play)})).on(ke.waiting,(function(){c.emit(ke.waiting)})).on(ke.playing,(function(){c.emit(ke.playing)})).on(ke.playNotAllowed,(function(){c.emit(ke.playNotAllowed)})).on(ke.stop,(function(){c.emit(ke.stop)})).on(ke.error,(function(e){c.emit(ke.error,e)}));case 25:case"end":return e.stop()}}),e,this,[[2,19]])})))})),Fe.set(T(t),(function(){var e,r;if(!A(T(t),De,"f")){var n=x(T(t),De,document.createElement("div"),"f");n.setAttribute("id","xvideo"),n.style.position="relative",n.style.width="100%",n.style.height="100%",n.style.minWidth="100%",n.style.minHeight="100%",n.style.pointerEvents="none",null===(e=A(T(t),Me,"f"))||void 0===e||e.appendChild(n)}if(!A(T(t),Ue,"f")){var i=x(T(t),Ue,document.createElement("div"),"f");i.style.position="absolute",t.resize(),A(T(t),De,"f").appendChild(i),window.addEventListener("resize",A(T(t),We,"f"))}if(A(T(t),Me,"f"))try{null===(r=A(T(t),Oe,"f"))||void 0===r||r.observe(A(T(t),Me,"f"))}catch(e){}})),We.set(T(t),(function(){var e,r,n=A(T(t),Ne,"f"),i=n.width,o=n.height,a=(null===(e=A(T(t),De,"f"))||void 0===e?void 0:e.offsetWidth)||0,s=(null===(r=A(T(t),De,"f"))||void 0===r?void 0:r.offsetHeight)||0;if(A(T(t),Ue,"f")){var c=1;c=a/s>i/o?s/o:a/i,A(T(t),Ue,"f").style.left="50%";var u="-50%";"bottom"===A(T(t),xe,"f")?(u="0",A(T(t),Ue,"f").style.bottom="0px",A(T(t),Ue,"f").style.transformOrigin="center bottom"):(A(T(t),Ue,"f").style.top="50%",A(T(t),Ue,"f").style.transformOrigin="center center");var d=A(T(t),je,"f")*c;A(T(t),Ue,"f").style.transform="translate3d(-50%,".concat(u,",0) scale(").concat(d,", ").concat(c,")")}})),Be.set(T(t),(function(){var e;if(A(T(t),Me,"f"))try{null===(e=A(T(t),Oe,"f"))||void 0===e||e.unobserve(A(T(t),Me,"f"))}catch(e){}window.removeEventListener("resize",A(T(t),We,"f")),A(T(t),Ue,"f")&&(A(T(t),Ue,"f").remove(),x(T(t),Ue,void 0,"f")),A(T(t),De,"f")&&(A(T(t),De,"f").remove(),x(T(t),De,void 0,"f"))})),void 0!==window.ResizeObserver&&x(T(t),Oe,new ResizeObserver((function(e){e.forEach((function(){var e;null===(e=A(T(t),We,"f"))||void 0===e||e.call(T(t))}))})),"f"),t}return b(e,He),y(e,[{key:"renderAlign",set:function(e){x(this,xe,e,"f")}},{key:"playerType",set:function(e){x(this,Ie,e,"f")}},{key:"muted",get:function(){var e,t=A(this,Pe,"f");return A(this,Re,"f")&&(t=null===(e=A(this,Re,"f"))||void 0===e?void 0:e.muted),t},set:function(e){x(this,Pe,e,"f"),A(this,Re,"f")&&(e?A(this,Re,"f").muted=!0:(A(this,Re,"f").muted=!1,A(this,Re,"f").resume()))}},{key:"volume",get:function(){var e;return(null===(e=A(this,Re,"f"))||void 0===e?void 0:e.volume)||A(this,Ae,"f")},set:function(e){e>1&&(e=1),x(this,Ae,e,"f"),A(this,Re,"f")&&(A(this,Re,"f").volume=e)}},{key:"stream",set:function(e){x(this,Le,e,"f"),A(this,Re,"f")&&(A(this,Re,"f").stream=e)}},{key:"container",set:function(e){var t;if(A(this,Me,"f"))try{null===(t=A(this,Oe,"f"))||void 0===t||t.unobserve(A(this,Me,"f"))}catch(e){}x(this,Me,e,"f")}},{key:"videoSize",set:function(e){x(this,Ne,e,"f")}},{key:"playStream",value:function(e){return P(this,void 0,void 0,p().mark((function t(){var r;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return x(this,Le,e,"f"),A(this,Fe,"f").call(this),t.next=5,A(this,Ve,"f").call(this);case 5:return A(this,Re,"f")&&(A(this,Re,"f")&&(A(this,Re,"f").stream=e),A(this,Re,"f").videoWrapper=A(this,Ue,"f")),t.prev=6,t.next=9,null===(r=A(this,Re,"f"))||void 0===r?void 0:r.play();case 9:t.next=15;break;case 11:t.prev=11,t.t0=t.catch(6),this.stop();case 15:case"end":return t.stop()}}),t,this,[[6,11]])})))}},{key:"resume",value:function(){return P(this,void 0,void 0,p().mark((function e(){var t=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!A(this,Re,"f")){e.next=2;break}return e.abrupt("return",A(this,Re,"f").resume().then((function(){A(t,Re,"f")&&(A(t,Re,"f").muted=!1)})));case 2:return e.abrupt("return",Promise.reject("player not found"));case 3:case"end":return e.stop()}}),e,this)})))}},{key:"stop",value:function(){var e;A(this,Be,"f").call(this),null===(e=A(this,Re,"f"))||void 0===e||e.stop()}},{key:"scaleX",get:function(){return A(this,je,"f")||1},set:function(e){x(this,je,e,"f"),A(this,We,"f").call(this)}},{key:"setSinkId",value:function(e){return P(this,void 0,void 0,p().mark((function t(){var r;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,null===(r=A(this,Re,"f"))||void 0===r?void 0:r.setSinkId(e);case 2:case"end":return t.stop()}}),t,this)})))}},{key:"getSinkId",value:function(){return P(this,void 0,void 0,p().mark((function e(){var t;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",(null===(t=A(this,Re,"f"))||void 0===t?void 0:t.getSinkId())||"");case 1:case"end":return e.stop()}}),e,this)})))}},{key:"destroy",value:function(){var t;try{null===(t=A(this,Oe,"f"))||void 0===t||t.disconnect()}catch(t){}x(this,Oe,void 0,"f"),this.stop(),w(S(e.prototype),"destroy",this).call(this)}},{key:"resize",value:function(){var e;A(this,Ue,"f")&&(A(this,Ue,"f").style.width="".concat(A(this,Ne,"f").width,"px"),A(this,Ue,"f").style.height="".concat(A(this,Ne,"f").height,"px")),null===(e=A(this,Re,"f"))||void 0===e||e.resize(),A(this,We,"f").call(this)}}],[{key:"getVersion",value:function(){return"3.1.1-1011"}},{key:"setLogLevel",value:function(e){Ce.setLogLevel(e)}}]),e}();function Je(){var e={transF32ToRawData:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:16e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16e3,i=e.transSamplingRate(t,r,n);return e.transF32ToS16(i).buffer},transSamplingRate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:44100,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:16e3;if(t===r)return e;var n=Math.round(e.length*(r/t)),i=new Float32Array(n),o=(e.length-1)/(n-1);i[0]=e[0];for(var a=1;a<n-1;a++){var s=a*o,c=Number(Math.floor(s).toFixed()),u=Number(Math.ceil(s).toFixed()),d=s-c;i[a]=e[c]+(e[u]-e[c])*d}return i[n-1]=e[e.length-1],i},transF32ToS16:function(e){for(var t=[],r=0;r<e.length;r++){var n=e[r]<0?32768*e[r]:32767*e[r];t.push(n)}return new Int16Array(t)}};self.onmessage=function(t){var r=t.data,n=r.audio,i=r.sampleRate,o=void 0===i?16e3:i,a=r.destSampleRate,s=void 0===a?16e3:a;try{var c=e.transF32ToRawData(n,o,s);self.postMessage({data:c})}catch(t){self.postMessage({error:{code:t.type,message:t.message}})}}}Re=new WeakMap,Ie=new WeakMap,Oe=new WeakMap,Pe=new WeakMap,Ae=new WeakMap,xe=new WeakMap,Le=new WeakMap,Me=new WeakMap,De=new WeakMap,Ue=new WeakMap,Ne=new WeakMap,je=new WeakMap,Ve=new WeakMap,Fe=new WeakMap,We=new WeakMap,Be=new WeakMap,function(e){e.recoder_audio="recoder_audio",e.ended="ended",e.mute="mute",e.unmute="unmute",e.error="error",e.deviceAutoSwitched="device-auto-switched"}(ze||(ze={}));var qe,Ye,$e,Xe,Qe,Ze,et,tt,rt,nt,it,ot,at,st,ct,ut,dt,lt,ht,pt,ft,mt,vt,gt,yt,bt,St,Et,Ct,Tt,wt,_t,kt,Rt=function(){function e(){v(this,e)}return y(e,null,[{key:"requestPermissions",value:function(t){return P(this,void 0,void 0,p().mark((function r(){var n,i,o;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:n="",r.t0=t,r.next="audioinput"===r.t0||"audiooutput"===r.t0?4:"videoinput"===r.t0?6:8;break;case 4:return n="microphone",r.abrupt("break",8);case 6:return n="camera",r.abrupt("break",8);case 8:if(!n){r.next=22;break}if(i="prompt",!navigator.permissions){r.next=17;break}return r.next=13,navigator.permissions.query({name:n});case 13:if(o=r.sent,"denied"!==(i=o.state)){r.next=17;break}return r.abrupt("return",Promise.reject(new L(re.message,re.code,K.UserMediaError)));case 17:if("prompt"!==i){r.next=22;break}return r.next=20,e.getUserMedia({video:"camera"===n,audio:"microphone"===n});case 20:r.sent.getTracks().forEach((function(e){e.stop()}));case 22:case"end":return r.stop()}}),r)})))}},{key:"getEnumerateDevices",value:function(t){return P(this,void 0,void 0,p().mark((function r(){var n;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){r.next=2;break}return r.abrupt("return",Promise.reject(new L(ee.message,ee.code,K.UserMediaError)));case 2:return r.next=4,e.requestPermissions(t);case 4:return r.next=6,navigator.mediaDevices.enumerateDevices().then((function(e){return e.filter((function(e){return e.kind===t&&e.deviceId}))})).catch((function(e){return Promise.reject(new L(e.message||e.name||ae.message,ae.code,K.UserMediaError))}));case 6:return n=r.sent,r.abrupt("return",n);case 8:case"end":return r.stop()}}),r)})))}},{key:"getUserMedia",value:function(e){return P(this,void 0,void 0,p().mark((function t(){return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,navigator.mediaDevices.getUserMedia(e).catch((function(e){var t=new L(oe.message,oe.code,K.UserMediaError);switch(null==e?void 0:e.name){case"NotAllowedError":t=new L(re.message,re.code,K.UserMediaError);break;case"SecurityError":t=new L(ee.message,ee.code,K.UserMediaError);break;case"NotReadableError":t=new L(ne.message,ne.code,K.UserMediaError);break;case"NotFoundError":t=new L(te.message,te.code,K.UserMediaError);break;case"OverconstrainedError":t=new L(ie.message,ie.code,K.UserMediaError)}return Promise.reject(t)}));case 2:return t.abrupt("return",t.sent);case 3:case"end":return t.stop()}}),t)})))}}]),e}(),It=function(){function e(t){var r,i;return v(this,e),i=l(this,e),qe.add(T(i)),Ye.set(T(i),!1),$e.set(T(i),new window.AudioContext),Xe.set(T(i),void 0),Qe.set(T(i),void 0),Ze.set(T(i),[]),et.set(T(i),{sampleRate:16e3,analyser:!1}),tt.set(T(i),void 0),rt.set(T(i),void 0),nt.set(T(i),void 0),it.set(T(i),void 0),ot.set(T(i),void 0),at.set(T(i),void 0),st.set(T(i),void 0),ct.set(T(i),0),ut.set(T(i),!1),dt.set(T(i),!1),lt.set(T(i),12e4),ht.set(T(i),void 0),pt.set(T(i),!1),ft.set(T(i),!1),mt.set(T(i),void 0),vt.set(T(i),void 0),gt.set(T(i),(function(){var t;if(!A(T(i),st,"f"))try{var o=URL.createObjectURL(new Blob([(null===(t=Je.toLocaleString().match(/(?:\/\*[\s\S]*?\*\/|\/\/.*?\r?\n|[^{])+\{([\s\S]*)\}$/))||void 0===t?void 0:t[1])||""]));x(T(i),st,new Worker(o),"f"),URL.revokeObjectURL(o),A(T(i),st,"f").onmessage=function(t){var o,a;A(T(i),ct,"f")>0&&x(T(i),ct,(a=A(T(i),ct,"f"),--a),"f");var s=t.data.data;w((r=T(i),S(e.prototype)),"emitSync",r).call(r,ze.recoder_audio,{s16buffer:s,frameStatus:A(T(i),ut,"f")?A(T(i),pt,"f")&&0===A(T(i),ct,"f")?n.end:n.intermediate:n.start,fullDuplex:null!==(o=A(T(i),ft,"f"))&&void 0!==o&&o,extend:Object.assign({sampleRate:i.sampleRate},U(A(T(i),mt,"f")||{},{}))}),A(T(i),ut,"f")||A(T(i),pt,"f")||x(T(i),ut,!0,"f")},A(T(i),st,"f").onerror=function(e){A(T(i),yt,"f").call(T(i)),Ce.record(J.error,"[audioWorker]",e)}}catch(t){Ce.record(J.error,"[prepareAudioWorker]",t)}if(!A(T(i),st,"f"))return Promise.reject(new L(oe.message,oe.code,K.UserMediaError))})),yt.set(T(i),(function(){var e,t;x(T(i),ct,0,"f"),null===(t=null===(e=A(T(i),st,"f"))||void 0===e?void 0:e.terminate)||void 0===t||t.call(e),x(T(i),st,void 0,"f")})),bt.set(T(i),(function(){A(T(i),at,"f")||(x(T(i),at,A(T(i),$e,"f").createScriptProcessor(4096,1,1),"f"),A(T(i),at,"f").onaudioprocess=function(e){var t,r=e.inputBuffer.getChannelData(0).slice(0);null===(t=A(T(i),st,"f"))||void 0===t||t.postMessage({audio:r,sampleRate:A(T(i),$e,"f").sampleRate,destSampleRate:A(T(i),et,"f").sampleRate||16e3}),x(T(i),ct,A(T(i),ct,"f")+1,"f")}),A(T(i),Xe,"f")||(x(T(i),Xe,A(T(i),$e,"f").createAnalyser(),"f"),A(T(i),Xe,"f").fftSize=2048,x(T(i),Qe,new Uint8Array(A(T(i),Xe,"f").frequencyBinCount),"f"))})),St.set(T(i),(function(){i.emitSync(ze.mute)})),Et.set(T(i),(function(){i.emitSync(ze.unmute)})),Ct.set(T(i),(function(){A(T(i),Tt,"f").call(T(i)),i.emitSync(ze.ended),A(T(i),ft,"f")?(i.stopRecord(),i.startRecord(0,A(T(i),vt,"f"),A(T(i),mt,"f")).then((function(){i.emit(ze.deviceAutoSwitched)})).catch((function(e){i.emitSync(ze.error,e)}))):(i.stopRecord(),i.emitSync(ze.error,new L(re.message,re.code,K.UserMediaError)))})),Tt.set(T(i),(function(){var e,t,r;null===(e=A(T(i),nt,"f"))||void 0===e||e.removeEventListener("mute",A(T(i),St,"f")),null===(t=A(T(i),nt,"f"))||void 0===t||t.removeEventListener("unmute",A(T(i),St,"f")),null===(r=A(T(i),nt,"f"))||void 0===r||r.removeEventListener("ended",A(T(i),St,"f"))})),wt.set(T(i),(function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return P(T(i),[].concat(t),void 0,(function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;return p().mark((function i(){var o,a,s,c,u;return p().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(a=t<=0,A(e,bt,"f").call(e),A(e,at,"f")){i.next=5;break}return Ce.record(J.warn,"none scriptProcessor"),i.abrupt("return");case 5:return x(e,it,new Promise((function(t){x(e,ot,{resolve:t},"f")})),"f"),i.next=8,Rt.getUserMedia({audio:{noiseSuppression:!0,echoCancellation:!0,autoGainControl:!0},video:!1});case 8:s=i.sent,x(e,rt,s,"f"),(c=x(e,nt,s.getAudioTracks()[0],"f")).addEventListener("mute",A(e,St,"f")),c.addEventListener("unmute",A(e,Et,"f")),c.addEventListener("ended",A(e,Ct,"f")),s.addEventListener("addtrack",(function(){Ce.record(J.verbose,"addtrack")})),s.addEventListener("removetrack",(function(){Ce.record(J.verbose,"removetrack")})),x(e,ut,!1,"f"),x(e,pt,!1,"f"),x(e,tt,A(e,$e,"f").createMediaStreamSource(s),"f"),u=[],(null===(o=A(e,et,"f"))||void 0===o?void 0:o.analyser)&&A(e,Xe,"f")&&u.push(A(e,Xe,"f")),A(e,at,"f")&&u.push(A(e,at,"f")),A(e,qe,"m",_t).call(e,u),x(e,Ze,u,"f"),x(e,dt,!0,"f"),x(e,ft,a,"f"),x(e,mt,U({nlp:!0},n||{}),"f"),x(e,vt,r,"f"),a||x(e,ht,setTimeout((function(){e.stopRecord()}),t||A(e,lt,"f")),"f");case 29:case"end":return i.stop()}}),i)}))()}))})),x(T(i),et,Object.assign(Object.assign({},A(T(i),et,"f")),t),"f"),i}return b(e,He),y(e,[{key:"recording",get:function(){return A(this,dt,"f")||!1}},{key:"byteTimeDomainData",get:function(){var e,t;if(A(this,dt,"f")){if(A(this,Xe,"f"))return A(this,Qe,"f")||x(this,Qe,new Uint8Array((null===(e=A(this,Xe,"f"))||void 0===e?void 0:e.frequencyBinCount)||0),"f"),null===(t=A(this,Xe,"f"))||void 0===t||t.getByteTimeDomainData(A(this,Qe,"f")),A(this,Qe,"f");Ce.record(J.error,"none analyser inited")}}},{key:"startRecord",value:function(e,t,r){return P(this,void 0,void 0,p().mark((function n(){var i,o,a=this;return p().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!A(this,dt,"f")){n.next=3;break}return Ce.record(J.warn,"[recorder]","conflicted recorder start"),n.abrupt("return");case 3:if(window.isSecureContext){n.next=5;break}return n.abrupt("return",Promise.reject(new L(ee.message,ee.code,K.UserMediaError)));case 5:return n.next=7,new Promise((function(e,t){A(a,$e,"f").resume().then(e).catch((function(e){Ce.record(J.error,"[resume]",e),t(new L(oe.message,oe.code,K.UserMediaError))})),setTimeout((function(){t(new L(se.message,se.code,K.UserMediaError))}),1500)}));case 7:return A(this,gt,"f").call(this),n.prev=8,n.next=11,A(this,wt,"f").call(this,e,t,r);case 11:n.next=17;break;case 13:throw n.prev=13,n.t0=n.catch(8),x(this,dt,!1,"f"),n.t0;case 17:return n.prev=17,null===(o=null===(i=A(this,ot,"f"))||void 0===i?void 0:i.resolve)||void 0===o||o.call(i),n.finish(17);case 20:case"end":return n.stop()}}),n,this,[[8,13,17,20]])})))}},{key:"stopRecord",value:function(){var t=this,r=Object.create(null,{emitSync:{get:function(){return w(S(e.prototype),"emitSync",t)}}});return P(this,arguments,void 0,(function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return p().mark((function i(){var o,a,s,c,u,d,l;return p().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,A(e,it,"f");case 2:if(A(e,dt,"f")){i.next=4;break}return i.abrupt("return");case 4:for(clearTimeout(A(e,ht,"f")),x(e,dt,!1,"f"),A(e,Tt,"f").call(e),u=null===(o=A(e,rt,"f"))||void 0===o?void 0:o.getAudioTracks(),d=0,l=(null==u?void 0:u.length)||0;d<l;d++)null===(a=null==u?void 0:u[d])||void 0===a||a.stop();x(e,pt,!0,"f"),!0!==t&&0!==A(e,ct,"f")||(r.emitSync.call(e,ze.recoder_audio,{s16buffer:new ArrayBuffer(2),frameStatus:n.end,fullDuplex:null!==(s=A(e,ft,"f"))&&void 0!==s&&s,extend:Object.assign({sampleRate:e.sampleRate},U(A(e,mt,"f")||{},{}))}),!0===t&&A(e,yt,"f").call(e));try{A(e,qe,"m",kt).call(e,A(e,Ze,"f"))}catch(e){Ce.record(J.warn,"[disconnect media]",e)}finally{x(e,Ze,[],"f")}null===(c=A(e,vt,"f"))||void 0===c||c.call(e),x(e,vt,void 0,"f");case 14:case"end":return i.stop()}}),i)}))()}))}},{key:"switchDevice",value:function(e){return P(this,void 0,void 0,p().mark((function t(){var r,n;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(A(this,at,"f")){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,Rt.getUserMedia({audio:{deviceId:{exact:e},noiseSuppression:!0,echoCancellation:!0},video:!1});case 4:n=t.sent,A(this,qe,"m",kt).call(this,A(this,Ze,"f")),A(this,Tt,"f").call(this),null===(r=A(this,rt,"f"))||void 0===r||r.getAudioTracks().forEach((function(e){return e.stop()})),x(this,rt,n,"f"),x(this,tt,A(this,$e,"f").createMediaStreamSource(n),"f"),A(this,qe,"m",_t).call(this,A(this,Ze,"f"));case 11:case"end":return t.stop()}}),t,this)})))}},{key:"destroy",value:function(){x(this,Ye,!0,"f"),this.stopRecord(),w(S(e.prototype),"destroy",this).call(this)}},{key:"isDestroyed",value:function(){return A(this,Ye,"f")}},{key:"sampleRate",get:function(){return A(this,et,"f").sampleRate||16e3}}],[{key:"getVersion",value:function(){return"3.1.1-1011"}},{key:"setLogLevel",value:function(e){Ce.setLogLevel(e)}}]),e}();Ye=new WeakMap,$e=new WeakMap,Xe=new WeakMap,Qe=new WeakMap,Ze=new WeakMap,et=new WeakMap,tt=new WeakMap,rt=new WeakMap,nt=new WeakMap,it=new WeakMap,ot=new WeakMap,at=new WeakMap,st=new WeakMap,ct=new WeakMap,ut=new WeakMap,dt=new WeakMap,lt=new WeakMap,ht=new WeakMap,pt=new WeakMap,ft=new WeakMap,mt=new WeakMap,vt=new WeakMap,gt=new WeakMap,yt=new WeakMap,bt=new WeakMap,St=new WeakMap,Et=new WeakMap,Ct=new WeakMap,Tt=new WeakMap,wt=new WeakMap,qe=new WeakSet,_t=function(e){var t,r;if(!e.length)return x(this,Ze,[],"f"),null===(t=A(this,tt,"f"))||void 0===t?void 0:t.connect(A(this,$e,"f").destination);null===(r=A(this,tt,"f"))||void 0===r||r.connect(e[0]);for(var n=1;n<e.length;n++)e[n-1].connect(e[n]);e[e.length-1].connect(A(this,$e,"f").destination)},kt=function(e){var t,r;if(!(null==e?void 0:e.length))return null===(t=A(this,tt,"f"))||void 0===t?void 0:t.disconnect(A(this,$e,"f").destination);null===(r=A(this,tt,"f"))||void 0===r||r.disconnect(e[0]);for(var n=1;n<e.length;n++)e[n-1].disconnect(e[n]);e[e.length-1].disconnect(A(this,$e,"f").destination)};var Ot=["src","img","video","link","txt","action","cmd","options","h5_url"];function Pt(e){var t=!1;return function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return e&&"[object String]"===Object.prototype.toString.call(e)?e.replace(/\[={0,1}([a-zA-Z_-])+\d*:?-?\d*\]/g,""):e||""}(e).replace(/(\[打招呼\])|(\[鞠躬\])|(\[左手点赞\])|(\[右手点赞\])|(\[双手比心\])|(\[拜拜\])|(\[看上边摄像头\])|(\[放交通卡\])|(\[左边出口\])|(\[右边出口\])|(\[左上内容-单手\])|(\[左中内容-单手\])|(\[左下内容-单手\])|(\[右上内容-单手\])|(\[右中内容-单手\])|(\[右下内容-单手\])|(\[左上内容-双手\])|(\[左中内容-双手\])|(\[左下内容-双手\])|(\[右上内容-双手\])|(\[右中内容-双手\])|(\[右下内容-双手\])|(\[展开双手\])|(\[聆听点头\])|(\[轻微摇头\])|(\[双手放下\])/g,"").replace(/\[\[(\w+)=(((?!\]\]).)+)\]\]/g,(function(e,t){return-1===Ot.indexOf(t)?"":e})).replace(/(\[\[txt=[^\[\]]+\]\])|(\[\[cmd=[^\[\]]+\]\])|(\[\[action=[^\[\]]+\]\])|(\[\[txt=(((?!\]\]).)+)\]\])/g,"").replace(/\[\[link=([^\[\]]+)\]\]/g,(function(e,t){return'<a class="llm-content-link" target="_blank"  href="'.concat(encodeURI(t),'">').concat(t,"</a>")})).replace(/\[\[h5_url=([^\[\]]+)\]\]/g,(function(e,t){return'<div class="llm-content-iframe"><iframe class="content-iframe" src="'.concat(encodeURI(t),'" frameborder="no" border="0" marginwidth="0" marginheight="0" allowtransparency="yes"></iframe></div>')})).replace(/\[\[(src|img)=(((?!\]\]).)+)\]\]/g,(function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"",n=r.split(";");r=n[0].replace("ceph.xfyousheng.com","ossbj.xfinfr.com");for(var i={},o=1;o<n.length;o++){var a=_(n[o].split("="),2),s=a[0],c=a[1];i[s]=c}return'<div class="llm-content-img"  style="width:'.concat(i.width||100,"%;\" ><img src='").concat(r,'\' onload="globalImgLoad(this)" onerror="globalImgError(this)"></div>')})).replace(/\[\[video=(((?!\]\]).)+)\]\]/g,(function(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",n=r.split(";");if(1===n.length)return t?"":(t=!0,"<div class=\"llm-content-video\">\n                        <video \n                          onloadstart='imVideoWaiting(this)'\n                          ontimeupdate='imVideoPlaying(this)'\n                          onwaiting='imVideoWaiting(this)'\n                          onended='imVideoEnded(this)' \n                          onerror='imVideoError(this)' \n                          onplay='imVideoPlay(this)' \n                          onplaying='imVideoPlaying(this)' \n                          webkit-playsinline \n                          playsinline \n                          x5-playsinline \n                          autoplay=\"autoplay\"  \n                          preload=\"auto\" \n                          src='".concat(r,'\' \n                          loop=\'loop\'\n                          controls\n                          class="content-video">\n                        </video>\n                        <div class="loading-icon">\n                          <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="60px" height="60px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">\n                            <path opacity="0.2" fill="#FF6700" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946\n                                s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634\n                                c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"></path>\n                            <path fill="#FF6700" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0\n                                C22.32,8.481,24.301,9.057,26.013,10.047z" transform="rotate(42.1171 20 20)">\n                                <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="0.5s" repeatCount="indefinite"></animateTransform>\n                            </path>\n                          </svg>\n                        </div>\n                      </div>'));if(2===n.length){if(t)return"";t=!0;var i=n[1]||"";return i=Number(i.split("=")[1]),r=n[0],1===i?"<div class=\"llm-content-video\">\n                          <video  \n                            onloadstart='imVideoWaiting(this)'\n                            ontimeupdate='imVideoPlaying(this)'\n                            onwaiting='imVideoWaiting(this)'\n                            onended='imVideoEnded(this)' \n                            onerror='imVideoError(this)' \n                            onplay='imVideoPlay(this)' \n                            onplaying='imVideoPlaying(this)' \n                            webkit-playsinline \n                            playsinline \n                            x5-playsinline \n                            autoplay=\"autoplay\"  \n                            preload=\"auto\" \n                            src='".concat(r,'\' \n                            muted \n                            loop=\'loop\'\n                            style="width:100%;" \n                            controls\n                            class="content-video">\n                          </video>\n                          <div class="loading-icon">\n                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="60px" height="60px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">\n                              <path opacity="0.2" fill="#FF6700" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946\n                                  s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634\n                                  c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"></path>\n                              <path fill="#FF6700" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0\n                                  C22.32,8.481,24.301,9.057,26.013,10.047z" transform="rotate(42.1171 20 20)">\n                                  <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="0.5s" repeatCount="indefinite"></animateTransform>\n                              </path>\n                            </svg>\n                          </div>\n                        </div>'):"<div class=\"llm-content-video\">\n                          <video \n                            onloadstart='imVideoWaiting(this)'\n                            ontimeupdate='imVideoPlaying(this)'\n                            onwaiting='imVideoWaiting(this)'\n                            onended='imVideoEnded(this)' \n                            onerror='imVideoError(this)' \n                            onplay='imVideoPlay(this)' \n                            onplaying='imVideoPlaying(this)' \n                            webkit-playsinline \n                            playsinline \n                            x5-playsinline \n                            autoplay=\"autoplay\"  \n                            preload=\"auto\" \n                            src='".concat(r,'\' \n                            loop=\'loop\'\n                            controls\n                            class="content-video">\n                          </video>\n                          <div class="loading-icon">\n                            <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="60px" height="60px" viewBox="0 0 40 40" enable-background="new 0 0 40 40" xml:space="preserve">\n                              <path opacity="0.2" fill="#FF6700" d="M20.201,5.169c-8.254,0-14.946,6.692-14.946,14.946c0,8.255,6.692,14.946,14.946,14.946\n                                  s14.946-6.691,14.946-14.946C35.146,11.861,28.455,5.169,20.201,5.169z M20.201,31.749c-6.425,0-11.634-5.208-11.634-11.634\n                                  c0-6.425,5.209-11.634,11.634-11.634c6.425,0,11.633,5.209,11.633,11.634C31.834,26.541,26.626,31.749,20.201,31.749z"></path>\n                              <path fill="#FF6700" d="M26.013,10.047l1.654-2.866c-2.198-1.272-4.743-2.012-7.466-2.012h0v3.312h0\n                                  C22.32,8.481,24.301,9.057,26.013,10.047z" transform="rotate(42.1171 20 20)">\n                                  <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 20 20" to="360 20 20" dur="0.5s" repeatCount="indefinite"></animateTransform>\n                              </path>\n                            </svg>\n                          </div>\n                        </div>')}return e}))}var At="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof r.g?r.g:"undefined"!=typeof self?self:{};function xt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Lt(e){if(e.__esModule)return e;var t=e.default;if("function"==typeof t){var r=function e(){return this instanceof e?Reflect.construct(t,arguments,this.constructor):t.apply(this,arguments)};r.prototype=t.prototype}else r={};return Object.defineProperty(r,"__esModule",{value:!0}),Object.keys(e).forEach((function(t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})})),r}var Mt={exports:{}};function Dt(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Ut,Nt={exports:{}},jt=Lt(Object.freeze({__proto__:null,default:{}}));function Vt(){return Ut||(Ut=1,Nt.exports=(e=e||function(e,t){var r;if("undefined"!=typeof window&&window.crypto&&(r=window.crypto),"undefined"!=typeof self&&self.crypto&&(r=self.crypto),"undefined"!=typeof globalThis&&globalThis.crypto&&(r=globalThis.crypto),!r&&"undefined"!=typeof window&&window.msCrypto&&(r=window.msCrypto),!r&&void 0!==At&&At.crypto&&(r=At.crypto),!r)try{r=jt}catch(e){}var n=function(){if(r){if("function"==typeof r.getRandomValues)try{return r.getRandomValues(new Uint32Array(1))[0]}catch(e){}if("function"==typeof r.randomBytes)try{return r.randomBytes(4).readInt32LE()}catch(e){}}throw new Error("Native crypto module could not be used to get secure random number.")},i=Object.create||function(){function e(){}return function(t){var r;return e.prototype=t,r=new e,e.prototype=null,r}}(),o={},a=o.lib={},s=a.Base={extend:function(e){var t=i(this);return e&&t.mixIn(e),t.hasOwnProperty("init")&&this.init!==t.init||(t.init=function(){t.$super.init.apply(this,arguments)}),t.init.prototype=t,t.$super=this,t},create:function(){var e=this.extend();return e.init.apply(e,arguments),e},init:function(){},mixIn:function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);e.hasOwnProperty("toString")&&(this.toString=e.toString)},clone:function(){return this.init.prototype.extend(this)}},c=a.WordArray=s.extend({init:function(e,r){e=this.words=e||[],this.sigBytes=r!=t?r:4*e.length},toString:function(e){return(e||d).stringify(this)},concat:function(e){var t=this.words,r=e.words,n=this.sigBytes,i=e.sigBytes;if(this.clamp(),n%4)for(var o=0;o<i;o++){var a=r[o>>>2]>>>24-o%4*8&255;t[n+o>>>2]|=a<<24-(n+o)%4*8}else for(var s=0;s<i;s+=4)t[n+s>>>2]=r[s>>>2];return this.sigBytes+=i,this},clamp:function(){var t=this.words,r=this.sigBytes;t[r>>>2]&=4294967295<<32-r%4*8,t.length=e.ceil(r/4)},clone:function(){var e=s.clone.call(this);return e.words=this.words.slice(0),e},random:function(e){for(var t=[],r=0;r<e;r+=4)t.push(n());return new c.init(t,e)}}),u=o.enc={},d=u.Hex={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push((o>>>4).toString(16)),n.push((15&o).toString(16))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n+=2)r[n>>>3]|=parseInt(e.substr(n,2),16)<<24-n%8*4;return new c.init(r,t/2)}},l=u.Latin1={stringify:function(e){for(var t=e.words,r=e.sigBytes,n=[],i=0;i<r;i++){var o=t[i>>>2]>>>24-i%4*8&255;n.push(String.fromCharCode(o))}return n.join("")},parse:function(e){for(var t=e.length,r=[],n=0;n<t;n++)r[n>>>2]|=(255&e.charCodeAt(n))<<24-n%4*8;return new c.init(r,t)}},h=u.Utf8={stringify:function(e){try{return decodeURIComponent(escape(l.stringify(e)))}catch(e){throw new Error("Malformed UTF-8 data")}},parse:function(e){return l.parse(unescape(encodeURIComponent(e)))}},p=a.BufferedBlockAlgorithm=s.extend({reset:function(){this._data=new c.init,this._nDataBytes=0},_append:function(e){"string"==typeof e&&(e=h.parse(e)),this._data.concat(e),this._nDataBytes+=e.sigBytes},_process:function(t){var r,n=this._data,i=n.words,o=n.sigBytes,a=this.blockSize,s=o/(4*a),u=(s=t?e.ceil(s):e.max((0|s)-this._minBufferSize,0))*a,d=e.min(4*u,o);if(u){for(var l=0;l<u;l+=a)this._doProcessBlock(i,l);r=i.splice(0,u),n.sigBytes-=d}return new c.init(r,d)},clone:function(){var e=s.clone.call(this);return e._data=this._data.clone(),e},_minBufferSize:0});a.Hasher=p.extend({cfg:s.extend(),init:function(e){this.cfg=this.cfg.extend(e),this.reset()},reset:function(){p.reset.call(this),this._doReset()},update:function(e){return this._append(e),this._process(),this},finalize:function(e){return e&&this._append(e),this._doFinalize()},blockSize:16,_createHelper:function(e){return function(t,r){return new e.init(r).finalize(t)}},_createHmacHelper:function(e){return function(t,r){return new f.HMAC.init(e,r).finalize(t)}}});var f=o.algo={};return o}(Math),e)),Nt.exports;var e}var Ft,Wt={exports:{}};function Bt(){return Ft?Wt.exports:(Ft=1,Wt.exports=(e=Vt(),function(t){var r=e,n=r.lib,i=n.WordArray,o=n.Hasher,a=r.algo,s=[],c=[];!function(){function e(e){for(var r=t.sqrt(e),n=2;n<=r;n++)if(!(e%n))return!1;return!0}function r(e){return 4294967296*(e-(0|e))|0}for(var n=2,i=0;i<64;)e(n)&&(i<8&&(s[i]=r(t.pow(n,.5))),c[i]=r(t.pow(n,1/3)),i++),n++}();var u=[],d=a.SHA256=o.extend({_doReset:function(){this._hash=new i.init(s.slice(0))},_doProcessBlock:function(e,t){for(var r=this._hash.words,n=r[0],i=r[1],o=r[2],a=r[3],s=r[4],d=r[5],l=r[6],h=r[7],p=0;p<64;p++){if(p<16)u[p]=0|e[t+p];else{var f=u[p-15],m=(f<<25|f>>>7)^(f<<14|f>>>18)^f>>>3,v=u[p-2],g=(v<<15|v>>>17)^(v<<13|v>>>19)^v>>>10;u[p]=m+u[p-7]+g+u[p-16]}var y=n&i^n&o^i&o,b=(n<<30|n>>>2)^(n<<19|n>>>13)^(n<<10|n>>>22),S=h+((s<<26|s>>>6)^(s<<21|s>>>11)^(s<<7|s>>>25))+(s&d^~s&l)+c[p]+u[p];h=l,l=d,d=s,s=a+S|0,a=o,o=i,i=n,n=S+(b+y)|0}r[0]=r[0]+n|0,r[1]=r[1]+i|0,r[2]=r[2]+o|0,r[3]=r[3]+a|0,r[4]=r[4]+s|0,r[5]=r[5]+d|0,r[6]=r[6]+l|0,r[7]=r[7]+h|0},_doFinalize:function(){var e=this._data,r=e.words,n=8*this._nDataBytes,i=8*e.sigBytes;return r[i>>>5]|=128<<24-i%32,r[14+(i+64>>>9<<4)]=t.floor(n/4294967296),r[15+(i+64>>>9<<4)]=n,e.sigBytes=4*r.length,this._process(),this._hash},clone:function(){var e=o.clone.call(this);return e._hash=this._hash.clone(),e}});r.SHA256=o._createHelper(d),r.HmacSHA256=o._createHmacHelper(d)}(Math),e.SHA256));var e}var Gt,Ht,zt={exports:{}};Mt.exports=function(e){return e.HmacSHA256}(Vt(),Bt(),Gt||(Gt=1,zt.exports=(Ht=Vt(),void function(){var e=Ht,t=e.lib.Base,r=e.enc.Utf8;e.algo.HMAC=t.extend({init:function(e,t){e=this._hasher=new e.init,"string"==typeof t&&(t=r.parse(t));var n=e.blockSize,i=4*n;t.sigBytes>i&&(t=e.finalize(t)),t.clamp();for(var o=this._oKey=t.clone(),a=this._iKey=t.clone(),s=o.words,c=a.words,u=0;u<n;u++)s[u]^=1549556828,c[u]^=909522486;o.sigBytes=a.sigBytes=i,this.reset()},reset:function(){var e=this._hasher;e.reset(),e.update(this._iKey)},update:function(e){return this._hasher.update(e),this},finalize:function(e){var t=this._hasher,r=t.finalize(e);return t.reset(),t.finalize(this._oKey.clone().concat(r))}})}())));var Kt=xt(Mt.exports),Jt={exports:{}};Jt.exports=function(e){return function(){var t=e,r=t.lib.WordArray;function n(e,t,n){for(var i=[],o=0,a=0;a<t;a++)if(a%4){var s=n[e.charCodeAt(a-1)]<<a%4*2|n[e.charCodeAt(a)]>>>6-a%4*2;i[o>>>2]|=s<<24-o%4*8,o++}return r.create(i,o)}t.enc.Base64={stringify:function(e){var t=e.words,r=e.sigBytes,n=this._map;e.clamp();for(var i=[],o=0;o<r;o+=3)for(var a=(t[o>>>2]>>>24-o%4*8&255)<<16|(t[o+1>>>2]>>>24-(o+1)%4*8&255)<<8|t[o+2>>>2]>>>24-(o+2)%4*8&255,s=0;s<4&&o+.75*s<r;s++)i.push(n.charAt(a>>>6*(3-s)&63));var c=n.charAt(64);if(c)for(;i.length%4;)i.push(c);return i.join("")},parse:function(e){var t=e.length,r=this._map,i=this._reverseMap;if(!i){i=this._reverseMap=[];for(var o=0;o<r.length;o++)i[r.charCodeAt(o)]=o}var a=r.charAt(64);if(a){var s=e.indexOf(a);-1!==s&&(t=s)}return n(e,t,i)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}}(),e.enc.Base64}(Vt());var qt=xt(Jt.exports),Yt={exports:{}};Yt.exports=function(e){return e.enc.Utf8}(Vt());var $t=xt(Yt.exports);function Xt(e,t,r){var n=_(e.match(/^wss?:\/\/([^\/]+)(\/.*)/)||[],3);n[0];var i=n[1],o=n[2],a=(new Date).toUTCString(),s="host: ".concat(i,"\ndate: ").concat(a,"\n").concat("GET"," ").concat(o," HTTP/1.1"),c=Kt(s,r),u=qt.stringify(c),d='api_key="'.concat(t,'", algorithm="').concat("hmac-sha256",'", headers="').concat("host date request-line",'", signature="').concat(u,'"'),l=qt.stringify($t.parse(d));return"".concat(e,"?authorization=").concat(l,"&date=").concat(a,"&host=").concat(i)}var Qt=function(){this.__data__=[],this.size=0},Zt=function(e,t){return e===t||e!=e&&t!=t},er=Zt,tr=function(e,t){for(var r=e.length;r--;)if(er(e[r][0],t))return r;return-1},rr=tr,nr=Array.prototype.splice,ir=tr,or=tr,ar=tr,sr=Qt,cr=function(e){var t=this.__data__,r=rr(t,e);return!(r<0)&&(r==t.length-1?t.pop():nr.call(t,r,1),--this.size,!0)},ur=function(e){var t=this.__data__,r=ir(t,e);return r<0?void 0:t[r][1]},dr=function(e){return or(this.__data__,e)>-1},lr=function(e,t){var r=this.__data__,n=ar(r,e);return n<0?(++this.size,r.push([e,t])):r[n][1]=t,this};function hr(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}hr.prototype.clear=sr,hr.prototype.delete=cr,hr.prototype.get=ur,hr.prototype.has=dr,hr.prototype.set=lr;var pr,fr=hr,mr=fr,vr=function(){this.__data__=new mr,this.size=0},gr=function(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r},yr=function(e){return this.__data__.get(e)},br=function(e){return this.__data__.has(e)},Sr="object"==typeof At&&At&&At.Object===Object&&At,Er=Sr,Cr="object"==typeof self&&self&&self.Object===Object&&self,Tr=Er||Cr||Function("return this")(),wr=Tr.Symbol,_r=wr,kr=Object.prototype,Rr=kr.hasOwnProperty,Ir=kr.toString,Or=_r?_r.toStringTag:void 0,Pr=function(e){var t=Rr.call(e,Or),r=e[Or];try{e[Or]=void 0;var n=!0}catch(e){}var i=Ir.call(e);return n&&(t?e[Or]=r:delete e[Or]),i},Ar=Object.prototype.toString,xr=Pr,Lr=function(e){return Ar.call(e)},Mr=wr?wr.toStringTag:void 0,Dr=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Mr&&Mr in Object(e)?xr(e):Lr(e)},Ur=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)},Nr=Dr,jr=Ur,Vr=function(e){if(!jr(e))return!1;var t=Nr(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t},Fr=Tr["__core-js_shared__"],Wr=(pr=/[^.]+$/.exec(Fr&&Fr.keys&&Fr.keys.IE_PROTO||""))?"Symbol(src)_1."+pr:"",Br=function(e){return!!Wr&&Wr in e},Gr=Function.prototype.toString,Hr=function(e){if(null!=e){try{return Gr.call(e)}catch(e){}try{return e+""}catch(e){}}return""},zr=Vr,Kr=Br,Jr=Ur,qr=Hr,Yr=/^\[object .+?Constructor\]$/,$r=Function.prototype,Xr=Object.prototype,Qr=$r.toString,Zr=Xr.hasOwnProperty,en=RegExp("^"+Qr.call(Zr).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),tn=function(e){return!(!Jr(e)||Kr(e))&&(zr(e)?en:Yr).test(qr(e))},rn=function(e,t){return null==e?void 0:e[t]},nn=function(e,t){var r=rn(e,t);return tn(r)?r:void 0},on=nn(Tr,"Map"),an=nn(Object,"create"),sn=an,cn=function(){this.__data__=sn?sn(null):{},this.size=0},un=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t},dn=an,ln=Object.prototype.hasOwnProperty,hn=function(e){var t=this.__data__;if(dn){var r=t[e];return"__lodash_hash_undefined__"===r?void 0:r}return ln.call(t,e)?t[e]:void 0},pn=an,fn=Object.prototype.hasOwnProperty,mn=an,vn=cn,gn=un,yn=hn,bn=function(e){var t=this.__data__;return pn?void 0!==t[e]:fn.call(t,e)},Sn=function(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=mn&&void 0===t?"__lodash_hash_undefined__":t,this};function En(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}En.prototype.clear=vn,En.prototype.delete=gn,En.prototype.get=yn,En.prototype.has=bn,En.prototype.set=Sn;var Cn=En,Tn=fr,wn=on,_n=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e},kn=function(e,t){var r=e.__data__;return _n(t)?r["string"==typeof t?"string":"hash"]:r.map},Rn=kn,In=kn,On=kn,Pn=kn,An=function(){this.size=0,this.__data__={hash:new Cn,map:new(wn||Tn),string:new Cn}},xn=function(e){var t=Rn(this,e).delete(e);return this.size-=t?1:0,t},Ln=function(e){return In(this,e).get(e)},Mn=function(e){return On(this,e).has(e)},Dn=function(e,t){var r=Pn(this,e),n=r.size;return r.set(e,t),this.size+=r.size==n?0:1,this};function Un(e){var t=-1,r=null==e?0:e.length;for(this.clear();++t<r;){var n=e[t];this.set(n[0],n[1])}}Un.prototype.clear=An,Un.prototype.delete=xn,Un.prototype.get=Ln,Un.prototype.has=Mn,Un.prototype.set=Dn;var Nn=fr,jn=on,Vn=Un,Fn=fr,Wn=vr,Bn=gr,Gn=yr,Hn=br,zn=function(e,t){var r=this.__data__;if(r instanceof Nn){var n=r.__data__;if(!jn||n.length<199)return n.push([e,t]),this.size=++r.size,this;r=this.__data__=new Vn(n)}return r.set(e,t),this.size=r.size,this};function Kn(e){var t=this.__data__=new Fn(e);this.size=t.size}Kn.prototype.clear=Wn,Kn.prototype.delete=Bn,Kn.prototype.get=Gn,Kn.prototype.has=Hn,Kn.prototype.set=zn;var Jn=Kn,qn=function(e,t){for(var r=-1,n=null==e?0:e.length;++r<n&&!1!==t(e[r],r,e););return e},Yn=nn,$n=function(){try{var e=Yn(Object,"defineProperty");return e({},"",{}),e}catch(e){}}(),Xn=function(e,t,r){"__proto__"==t&&$n?$n(e,t,{configurable:!0,enumerable:!0,value:r,writable:!0}):e[t]=r},Qn=Xn,Zn=Zt,ei=Object.prototype.hasOwnProperty,ti=function(e,t,r){var n=e[t];ei.call(e,t)&&Zn(n,r)&&(void 0!==r||t in e)||Qn(e,t,r)},ri=ti,ni=Xn,ii=function(e,t,r,n){var i=!r;r||(r={});for(var o=-1,a=t.length;++o<a;){var s=t[o],c=n?n(r[s],e[s],s,r,e):void 0;void 0===c&&(c=e[s]),i?ni(r,s,c):ri(r,s,c)}return r},oi=function(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n},ai=function(e){return null!=e&&"object"==typeof e},si=Dr,ci=ai,ui=function(e){return ci(e)&&"[object Arguments]"==si(e)},di=ai,li=Object.prototype,hi=li.hasOwnProperty,pi=li.propertyIsEnumerable,fi=ui(function(){return arguments}())?ui:function(e){return di(e)&&hi.call(e,"callee")&&!pi.call(e,"callee")},mi=Array.isArray,vi={exports:{}},gi=function(){return!1};!function(e,t){var r=Tr,n=gi,i=t&&!t.nodeType&&t,o=i&&e&&!e.nodeType&&e,a=o&&o.exports===i?r.Buffer:void 0,s=(a?a.isBuffer:void 0)||n;e.exports=s}(vi,vi.exports);var yi=vi.exports,bi=/^(?:0|[1-9]\d*)$/,Si=function(e,t){var r=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==r||"symbol"!=r&&bi.test(e))&&e>-1&&e%1==0&&e<t},Ei=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991},Ci=Dr,Ti=Ei,wi=ai,_i={};_i["[object Float32Array]"]=_i["[object Float64Array]"]=_i["[object Int8Array]"]=_i["[object Int16Array]"]=_i["[object Int32Array]"]=_i["[object Uint8Array]"]=_i["[object Uint8ClampedArray]"]=_i["[object Uint16Array]"]=_i["[object Uint32Array]"]=!0,_i["[object Arguments]"]=_i["[object Array]"]=_i["[object ArrayBuffer]"]=_i["[object Boolean]"]=_i["[object DataView]"]=_i["[object Date]"]=_i["[object Error]"]=_i["[object Function]"]=_i["[object Map]"]=_i["[object Number]"]=_i["[object Object]"]=_i["[object RegExp]"]=_i["[object Set]"]=_i["[object String]"]=_i["[object WeakMap]"]=!1;var ki=function(e){return wi(e)&&Ti(e.length)&&!!_i[Ci(e)]},Ri=function(e){return function(t){return e(t)}},Ii={exports:{}};!function(e,t){var r=Sr,n=t&&!t.nodeType&&t,i=n&&e&&!e.nodeType&&e,o=i&&i.exports===n&&r.process,a=function(){try{var e=i&&i.require&&i.require("util").types;return e||o&&o.binding&&o.binding("util")}catch(e){}}();e.exports=a}(Ii,Ii.exports);var Oi=Ii.exports,Pi=ki,Ai=Ri,xi=Oi&&Oi.isTypedArray,Li=xi?Ai(xi):Pi,Mi=oi,Di=fi,Ui=mi,Ni=yi,ji=Si,Vi=Li,Fi=Object.prototype.hasOwnProperty,Wi=function(e,t){var r=Ui(e),n=!r&&Di(e),i=!r&&!n&&Ni(e),o=!r&&!n&&!i&&Vi(e),a=r||n||i||o,s=a?Mi(e.length,String):[],c=s.length;for(var u in e)!t&&!Fi.call(e,u)||a&&("length"==u||i&&("offset"==u||"parent"==u)||o&&("buffer"==u||"byteLength"==u||"byteOffset"==u)||ji(u,c))||s.push(u);return s},Bi=Object.prototype,Gi=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||Bi)},Hi=function(e,t){return function(r){return e(t(r))}},zi=Hi(Object.keys,Object),Ki=Gi,Ji=zi,qi=Object.prototype.hasOwnProperty,Yi=Vr,$i=Ei,Xi=function(e){return null!=e&&$i(e.length)&&!Yi(e)},Qi=Wi,Zi=function(e){if(!Ki(e))return Ji(e);var t=[];for(var r in Object(e))qi.call(e,r)&&"constructor"!=r&&t.push(r);return t},eo=Xi,to=function(e){return eo(e)?Qi(e):Zi(e)},ro=ii,no=to,io=function(e,t){return e&&ro(t,no(t),e)},oo=Ur,ao=Gi,so=function(e){var t=[];if(null!=e)for(var r in Object(e))t.push(r);return t},co=Object.prototype.hasOwnProperty,uo=Wi,lo=function(e){if(!oo(e))return so(e);var t=ao(e),r=[];for(var n in e)("constructor"!=n||!t&&co.call(e,n))&&r.push(n);return r},ho=Xi,po=function(e){return ho(e)?uo(e,!0):lo(e)},fo=ii,mo=po,vo=function(e,t){return e&&fo(t,mo(t),e)},go={exports:{}};!function(e,t){var r=Tr,n=t&&!t.nodeType&&t,i=n&&e&&!e.nodeType&&e,o=i&&i.exports===n?r.Buffer:void 0,a=o?o.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var r=e.length,n=a?a(r):new e.constructor(r);return e.copy(n),n}}(go,go.exports);var yo=go.exports,bo=function(e,t){var r=-1,n=e.length;for(t||(t=Array(n));++r<n;)t[r]=e[r];return t},So=function(){return[]},Eo=function(e,t){for(var r=-1,n=null==e?0:e.length,i=0,o=[];++r<n;){var a=e[r];t(a,r,e)&&(o[i++]=a)}return o},Co=So,To=Object.prototype.propertyIsEnumerable,wo=Object.getOwnPropertySymbols,_o=wo?function(e){return null==e?[]:(e=Object(e),Eo(wo(e),(function(t){return To.call(e,t)})))}:Co,ko=ii,Ro=_o,Io=function(e,t){return ko(e,Ro(e),t)},Oo=function(e,t){for(var r=-1,n=t.length,i=e.length;++r<n;)e[i+r]=t[r];return e},Po=Hi(Object.getPrototypeOf,Object),Ao=Oo,xo=Po,Lo=_o,Mo=So,Do=Object.getOwnPropertySymbols?function(e){for(var t=[];e;)Ao(t,Lo(e)),e=xo(e);return t}:Mo,Uo=ii,No=Do,jo=function(e,t){return Uo(e,No(e),t)},Vo=Oo,Fo=mi,Wo=function(e,t,r){var n=t(e);return Fo(e)?n:Vo(n,r(e))},Bo=Wo,Go=_o,Ho=to,zo=function(e){return Bo(e,Ho,Go)},Ko=Wo,Jo=Do,qo=po,Yo=function(e){return Ko(e,qo,Jo)},$o=nn(Tr,"DataView"),Xo=on,Qo=nn(Tr,"Promise"),Zo=nn(Tr,"Set"),ea=nn(Tr,"WeakMap"),ta=Dr,ra=Hr,na="[object Map]",ia="[object Promise]",oa="[object Set]",aa="[object WeakMap]",sa="[object DataView]",ca=ra($o),ua=ra(Xo),da=ra(Qo),la=ra(Zo),ha=ra(ea),pa=ta;($o&&pa(new $o(new ArrayBuffer(1)))!=sa||Xo&&pa(new Xo)!=na||Qo&&pa(Qo.resolve())!=ia||Zo&&pa(new Zo)!=oa||ea&&pa(new ea)!=aa)&&(pa=function(e){var t=ta(e),r="[object Object]"==t?e.constructor:void 0,n=r?ra(r):"";if(n)switch(n){case ca:return sa;case ua:return na;case da:return ia;case la:return oa;case ha:return aa}return t});var fa=pa,ma=Object.prototype.hasOwnProperty,va=function(e){var t=e.length,r=new e.constructor(t);return t&&"string"==typeof e[0]&&ma.call(e,"index")&&(r.index=e.index,r.input=e.input),r},ga=Tr.Uint8Array,ya=function(e){var t=new e.constructor(e.byteLength);return new ga(t).set(new ga(e)),t},ba=ya,Sa=function(e,t){var r=t?ba(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.byteLength)},Ea=/\w*$/,Ca=function(e){var t=new e.constructor(e.source,Ea.exec(e));return t.lastIndex=e.lastIndex,t},Ta=wr?wr.prototype:void 0,wa=Ta?Ta.valueOf:void 0,_a=ya,ka=ya,Ra=Sa,Ia=Ca,Oa=function(e){return wa?Object(wa.call(e)):{}},Pa=function(e,t){var r=t?_a(e.buffer):e.buffer;return new e.constructor(r,e.byteOffset,e.length)},Aa=function(e,t,r){var n=e.constructor;switch(t){case"[object ArrayBuffer]":return ka(e);case"[object Boolean]":case"[object Date]":return new n(+e);case"[object DataView]":return Ra(e,r);case"[object Float32Array]":case"[object Float64Array]":case"[object Int8Array]":case"[object Int16Array]":case"[object Int32Array]":case"[object Uint8Array]":case"[object Uint8ClampedArray]":case"[object Uint16Array]":case"[object Uint32Array]":return Pa(e,r);case"[object Map]":case"[object Set]":return new n;case"[object Number]":case"[object String]":return new n(e);case"[object RegExp]":return Ia(e);case"[object Symbol]":return Oa(e)}},xa=Ur,La=Object.create,Ma=function(){function e(){}return function(t){if(!xa(t))return{};if(La)return La(t);e.prototype=t;var r=new e;return e.prototype=void 0,r}}(),Da=Po,Ua=Gi,Na=function(e){return"function"!=typeof e.constructor||Ua(e)?{}:Ma(Da(e))},ja=fa,Va=ai,Fa=function(e){return Va(e)&&"[object Map]"==ja(e)},Wa=Ri,Ba=Oi&&Oi.isMap,Ga=Ba?Wa(Ba):Fa,Ha=fa,za=ai,Ka=function(e){return za(e)&&"[object Set]"==Ha(e)},Ja=Ri,qa=Oi&&Oi.isSet,Ya=qa?Ja(qa):Ka,$a=Jn,Xa=qn,Qa=ti,Za=io,es=vo,ts=yo,rs=bo,ns=Io,is=jo,os=zo,as=Yo,ss=fa,cs=va,us=Aa,ds=Na,ls=mi,hs=yi,ps=Ga,fs=Ur,ms=Ya,vs=to,gs=po,ys="[object Arguments]",bs="[object Function]",Ss="[object Object]",Es={};Es[ys]=Es["[object Array]"]=Es["[object ArrayBuffer]"]=Es["[object DataView]"]=Es["[object Boolean]"]=Es["[object Date]"]=Es["[object Float32Array]"]=Es["[object Float64Array]"]=Es["[object Int8Array]"]=Es["[object Int16Array]"]=Es["[object Int32Array]"]=Es["[object Map]"]=Es["[object Number]"]=Es[Ss]=Es["[object RegExp]"]=Es["[object Set]"]=Es["[object String]"]=Es["[object Symbol]"]=Es["[object Uint8Array]"]=Es["[object Uint8ClampedArray]"]=Es["[object Uint16Array]"]=Es["[object Uint32Array]"]=!0,Es["[object Error]"]=Es[bs]=Es["[object WeakMap]"]=!1;var Cs,Ts,ws,_s,ks,Rs,Is,Os,Ps,As,xs,Ls,Ms,Ds,Us,Ns,js,Vs,Fs,Ws,Bs,Gs,Hs,zs,Ks,Js,qs,Ys,$s,Xs,Qs,Zs,ec,tc,rc,nc,ic,oc,ac,sc,cc,uc=function e(t,r,n,i,o,a){var s,c=1&r,u=2&r,d=4&r;if(n&&(s=o?n(t,i,o,a):n(t)),void 0!==s)return s;if(!fs(t))return t;var l=ls(t);if(l){if(s=cs(t),!c)return rs(t,s)}else{var h=ss(t),p=h==bs||"[object GeneratorFunction]"==h;if(hs(t))return ts(t,c);if(h==Ss||h==ys||p&&!o){if(s=u||p?{}:ds(t),!c)return u?is(t,es(s,t)):ns(t,Za(s,t))}else{if(!Es[h])return o?t:{};s=us(t,h,c)}}a||(a=new $a);var f=a.get(t);if(f)return f;a.set(t,s),ms(t)?t.forEach((function(i){s.add(e(i,r,n,i,t,a))})):ps(t)&&t.forEach((function(i,o){s.set(o,e(i,r,n,o,t,a))}));var m=l?void 0:(d?u?as:os:u?gs:vs)(t);return Xa(m||t,(function(i,o){m&&(i=t[o=i]),Qa(s,o,e(i,r,n,o,t,a))})),s},dc=uc,lc=xt((function(e){return dc(e,5)})),hc=function(){function e(t){var r;return v(this,e),r=l(this,e),Cs.add(T(r)),Ts.set(T(r),{useInlinePlayer:!0}),ws.set(T(r),i.disconnected),_s.set(T(r),void 0),ks.set(T(r),void 0),Rs.set(T(r),!1),Is.set(T(r),{appId:"",apiKey:"",apiSecret:"",serverUrl:"wss://avatar.cn-huadong-1.xf-yun.com/v1/interact",sceneId:"",sceneVersion:""}),Os.set(T(r),"avatar"),Ps.set(T(r),!1),As.set(T(r),{avatar_dispatch:{interactive_mode:s.break,enable_action_status:1,content_analysis:0},avatar:{avatar_id:"",width:720,height:1280,audio_format:1},stream:{protocol:"xrtc",bitrate:1e6,fps:25,alpha:0},tts:{vcn:"",speed:50,pitch:50,volume:100},air:{air:0,add_nonsemantic:0}}),xs.set(T(r),void 0),Ls.set(T(r),void 0),Ms.set(T(r),void 0),Ds.set(T(r),void 0),Us.set(T(r),void 0),Ns.set(T(r),(function(){return P(T(r),void 0,void 0,p().mark((function e(){var t,r;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!A(this,Ds,"f")){e.next=2;break}return e.abrupt("return",A(this,Ds,"f"));case 2:return e.next=4,null===(t=A(this,Ms,"f"))||void 0===t?void 0:t.websocketPromise;case 4:if(r=e.sent){e.next=7;break}return e.abrupt("return",Promise.reject(new Error(K.InvalidConnect)));case 7:return e.abrupt("return",r);case 8:case"end":return e.stop()}}),e,this)})))})),js.set(T(r),(function(e,t){var n,i,o=e;if("[object String]"!==Object.prototype.toString.call(e)){var a=e;(null==a?void 0:a.header)&&!a.header.request_id&&(a.header.request_id=M()),o=JSON.stringify(a)}t?Ce.record(J.debug,"[ws]","[msg send]:ignore record audio data, req_id:",(null===(n=null==e?void 0:e.header)||void 0===n?void 0:n.request_id)||""):Ce.record(J.debug,"[ws]","[msg send]",o),null===(i=A(T(r),Ds,"f"))||void 0===i||i.send(o)})),Vs.set(T(r),void 0),Fs.set(T(r),void 0),Ws.set(T(r),(function(e){x(T(r),Vs,e,"f")})),Bs.set(T(r),0),Gs.set(T(r),void 0),Hs.set(T(r),(function(){clearTimeout(A(T(r),Gs,"f"))})),zs.set(T(r),(function(){return P(T(r),void 0,void 0,p().mark((function e(){var t,r,n,o,a,s,c,u,d,l;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return x(this,Vs,void 0,"f"),s=(null===(t=A(this,Is,"f"))||void 0===t?void 0:t.signedUrl)||Xt((null===(r=A(this,Is,"f"))||void 0===r?void 0:r.serverUrl)||"",(null===(n=A(this,Is,"f"))||void 0===n?void 0:n.apiKey)||"",(null===(o=A(this,Is,"f"))||void 0===o?void 0:o.apiSecret)||""),x(this,ws,i.connecting,"f"),c=we(s,{binaryData:null!==(a=A(this,Ts,"f").binaryData)&&void 0!==a&&a}),u=c.instablishPromise,d=c.abort,x(this,Ms,{websocketPromise:u,abort:d},"f"),e.next=7,u;case 7:return l=e.sent,x(this,Ds,l,"f"),e.abrupt("return",l);case 10:case"end":return e.stop()}}),e,this)})))})),qs.set(T(r),(function(e){var t,r,n,i,o,a,s,c,u,d,l,h,p=null,f=null;try{p=JSON.parse(e)}catch(e){null==e||e.message}var m=!1;if(0!==(null===(t=null==p?void 0:p.header)||void 0===t?void 0:t.code))f={code:null===(r=null==p?void 0:p.header)||void 0===r?void 0:r.code,message:null===(n=null==p?void 0:p.header)||void 0===n?void 0:n.message,sid:(null===(i=null==p?void 0:p.header)||void 0===i?void 0:i.sid)||""},m=!0;else if(null===(o=null==p?void 0:p.payload)||void 0===o?void 0:o.nlp){var v=p.payload.nlp;0!==v.error_code&&(f={code:v.error_code,message:v.error_message,sid:(null===(a=null==p?void 0:p.header)||void 0===a?void 0:a.sid)||"",request_id:(null==v?void 0:v.request_id)||""})}else if(null===(s=null==p?void 0:p.payload)||void 0===s?void 0:s.asr){var g=p.payload.asr;0!==g.error_code&&(f={code:g.error_code,message:g.error_message,sid:(null===(c=null==p?void 0:p.header)||void 0===c?void 0:c.sid)||"",request_id:(null==g?void 0:g.request_id)||""})}else if(null===(u=null==p?void 0:p.payload)||void 0===u?void 0:u.tts){var y=p.payload.tts;0!==y.error_code&&(f={code:y.error_code,message:y.error_message,sid:(null===(d=null==p?void 0:p.header)||void 0===d?void 0:d.sid)||"",request_id:(null==y?void 0:y.request_id)||""})}else if(null===(l=null==p?void 0:p.payload)||void 0===l?void 0:l.avatar){var b=p.payload.avatar;0!==b.error_code&&(f={code:b.error_code||Q.code,message:b.error_message||Q.message,sid:(null===(h=null==p?void 0:p.header)||void 0===h?void 0:h.sid)||"",request_id:(null==b?void 0:b.request_id)||""})}return{data:p,error:f,is_socket_error:m}})),Ys.set(T(r),(function(){return P(T(r),void 0,void 0,p().mark((function e(){var t,r,n=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=A(this,Cs,"m",Js).call(this),A(this,js,"f").call(this,t),!(r=A(this,Ds,"f"))){e.next=5;break}return e.abrupt("return",new Promise((function(e,t){r.onmessage=function(i){var o,a,s,c,u,d,l,h,p,f,m,v,g,y,b=A(n,qs,"f").call(n,i.data),S=b.data,E=b.error;r.onmessage=null;var C=void 0,T=void 0;if(E)T=new L(null!==(o=E.message)&&void 0!==o?o:Q.message,null!==(a=E.code)&&void 0!==a?a:Q.code,K.ConnectError);else{Ce.record(J.debug,"[stream_url]",null===(c=null===(s=null==S?void 0:S.payload)||void 0===s?void 0:s.avatar)||void 0===c?void 0:c.stream_url);var w=(null===(d=null===(u=null==S?void 0:S.payload)||void 0===u?void 0:u.avatar)||void 0===d?void 0:d.stream_url)||"",_=(null===(l=null==S?void 0:S.header)||void 0===l?void 0:l.sid)||"";w?C={stream_url:w,sid:_,session:(null===(h=null==S?void 0:S.header)||void 0===h?void 0:h.session)||"",appid:(null===(m=null===(f=null===(p=null==S?void 0:S.payload)||void 0===p?void 0:p.avatar)||void 0===f?void 0:f.stream_extend)||void 0===m?void 0:m.appid)||"",user_sign:(null===(y=null===(g=null===(v=null==S?void 0:S.payload)||void 0===v?void 0:v.avatar)||void 0===g?void 0:g.stream_extend)||void 0===y?void 0:y.user_sign)||""}:T=new L(X.message,X.code,K.InvalidResponse)}!T&&C?e(C):(r.onerror=null,t(T),A(n,Cs,"m",cc).call(n,!0))}})));case 5:return e.abrupt("return",Promise.reject(new L(X.message,X.code,K.InvalidResponse)));case 6:case"end":return e.stop()}}),e,this)})))})),$s.set(T(r),(function(){if(A(T(r),Ds,"f")){A(T(r),Ds,"f").onclose=function(){A(T(r),Cs,"m",cc).call(T(r))};var e=null;A(T(r),Ds,"f").onmessage=function(t){var n,i,s,c,u,d,l,h,p,f,m,v,g=A(T(r),qs,"f").call(T(r),t.data),y=g.data,b=g.error,S=g.is_socket_error;if(Ce.record(J.verbose,"[msg handler]",null===(n=null==y?void 0:y.header)||void 0===n?void 0:n.sid),b)Ce.record(J.error,"[error]",b),S||"nlp"===A(T(r),Os,"f")&&(null===(i=null==y?void 0:y.payload)||void 0===i?void 0:i.nlp)?(x(T(r),Ps,!1,"f"),A(T(r),Ws,"f").call(T(r),b)):r.emit(_e.error,new L(null!==(s=b.message)&&void 0!==s?s:Q.message,null!==(c=b.code)&&void 0!==c?c:Q.code,K.ConnectError),y);else if(null===(u=null==y?void 0:y.payload)||void 0===u?void 0:u.nlp){var E=null===(d=null==y?void 0:y.payload)||void 0===d?void 0:d.nlp;(null==E?void 0:E.request_id)===(null==e?void 0:e.request_id)&&(E.streamNlp||E.stream_nlp)?E.content="".concat((null==e?void 0:e.content)||"").concat((null===(l=null==E?void 0:E.answer)||void 0===l?void 0:l.text)||""):E.content=(null===(h=null==E?void 0:E.answer)||void 0===h?void 0:h.text)||"";var C=Object.assign(Object.assign({},E),{displayContent:Pt(E.content)});"nlp"!==A(T(r),Os,"f")||void 0!==(null==C?void 0:C.status)&&2!==(null==C?void 0:C.status)||x(T(r),Ps,!0,"f"),e=C,r.emit(_e.nlp,lc(C),lc(y))}else if(null===(p=null==y?void 0:y.payload)||void 0===p?void 0:p.asr)r.emit(_e.asr,null===(f=null==y?void 0:y.payload)||void 0===f?void 0:f.asr);else if(null===(m=null==y?void 0:y.payload)||void 0===m?void 0:m.avatar){var w=null===(v=null==y?void 0:y.payload)||void 0===v?void 0:v.avatar;switch(w.event_type){case"stream_start":r.emit(_e.stream_start);break;case"driver_status":w.vmr_status===o.start?(r.emit(_e.frame_start,w),clearTimeout(A(T(r),Gs,"f"))):w.vmr_status===o.stop&&(r.emit(_e.frame_stop,w),A(T(r),Hs,"f").call(T(r)));break;case"action_status":w.action_status===a.start?r.emit(_e.action_start,w):w.action_status===a.stop&&r.emit(_e.action_stop,w);break;case"tts_duration":r.emit(_e.tts_duration,w);break;case"subtitle_info":var _=!1;clearTimeout(A(T(r),tc,"f")),A(T(r),Qs,"f")!==w.request_id&&(_=!0,x(T(r),Zs,0,"f"),x(T(r),Qs,w.request_id,"f"),x(T(r),Xs,[],"f")),A(T(r),Xs,"f").push(w),_&&(cancelAnimationFrame(A(T(r),ec,"f")),x(T(r),ec,0,"f")),A(T(r),ec,"f")||A(T(r),Cs,"m",ic).call(T(r))}}}}})),Xs.set(T(r),[]),Qs.set(T(r),""),Zs.set(T(r),0),ec.set(T(r),0),tc.set(T(r),0),rc.set(T(r),100),oc.set(T(r),(function(){x(T(r),Bs,setInterval((function(){A(T(r),Ns,"f").call(T(r)).then((function(){var e;A(T(r),js,"f").call(T(r),{header:{request_id:M(),app_id:(null===(e=A(T(r),Is,"f"))||void 0===e?void 0:e.appId)||"",ctrl:"ping"}})})).catch((function(e){Ce.record(J.error,"[heartbeat error]",e)}))}),4e3),"f")})),ac.set(T(r),(function(e){var t,n,i,o=A(T(r),Vs,"f");(t=r).emit.apply(t,[_e.disconnected].concat(k(e||"nlp"===A(T(r),Os,"f")&&("nlp"!==A(T(r),Os,"f")||A(T(r),Ps,"f"))?[]:[o?new L(null==o?void 0:o.message,null==o?void 0:o.code,null==o?void 0:o.name,(null==o?void 0:o.sid)||""):new L($.message,$.code,K.NetworkError,(null===(n=A(T(r),Ls,"f"))||void 0===n?void 0:n.sid)||"")]))),A(T(r),Ts,"f").useInlinePlayer&&(null===(i=A(T(r),_s,"f"))||void 0===i||i.stop())})),sc.set(T(r),(function(e,t){return P(T(r),void 0,void 0,p().mark((function r(){var n,i,o,a,s,c,u;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!A(this,Ts,"f").useInlinePlayer||!["xrtc","webrtc"].includes(null===(n=A(this,As,"f").stream)||void 0===n?void 0:n.protocol)){r.next=14;break}if(Ce.record(J.debug,"[player]:useInlinePlayer","inited"),A(this,Ts,"f").useInlinePlayer&&this.createPlayer(),A(this,_s,"f")){r.next=5;break}return r.abrupt("return",Promise.reject(new L(Z.MissingPlayerLibsError.message,Z.MissingPlayerLibsError.code,K.MediaError)));case 5:return e.stream_url.startsWith("xrtc")?(u=null===(i=e.stream_url)||void 0===i?void 0:i.match(/^xrtc(s?):\/\/([^/]*)\/([^/]+)/),c={sid:e.sid,server:"http".concat(u[1],"://").concat(u[2]),auth:null!==(a=null===(o=e.user_sign)||void 0===o?void 0:o.replace(/^Bearer /,""))&&void 0!==a?a:"",appid:e.appid,timeStr:"".concat(Date.now()),userId:"c"+u[3],roomId:u[3]},A(this,_s,"f").playerType="xrtc"):(A(this,_s,"f").playerType="webrtc",c={sid:e.sid,streamUrl:e.stream_url}),Ce.record(J.debug,"[player]: playerType",A(this,_s,"f").playerType),A(this,_s,"f").videoSize={width:A(this,As,"f").avatar.width,height:A(this,As,"f").avatar.height},A(this,_s,"f").container=t,Ce.record(J.debug,"[player]","preset streamSize:",A(this,_s,"f").videoSize),r.next=12,A(this,_s,"f").playStream(c);case 12:r.next=15;break;case 14:Ce.record(J.debug,"[player]: ingore; [inline]/[protocol]",A(this,Ts,"f").useInlinePlayer,["xrtc","webrtc"].includes(null===(s=A(this,As,"f").stream)||void 0===s?void 0:s.protocol));case 15:case"end":return r.stop()}}),r,this)})))})),x(T(r),Ts,Object.assign(Object.assign({},A(T(r),Ts,"f")),t),"f"),A(T(r),Ts,"f").useInlinePlayer&&r.createPlayer(),r}return b(e,He),y(e,[{key:"player",get:function(){return A(this,_s,"f")}},{key:"setApiInfo",value:function(e){return x(this,Is,U(A(this,Is,"f"),e),"f"),this}},{key:"setGlobalParams",value:function(e){return x(this,As,U(A(this,As,"f"),e),"f"),this}},{key:"start",value:function(e){return P(this,void 0,void 0,p().mark((function t(){var r,n,o,a,s,c,u;return p().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(x(this,Vs,void 0,"f"),x(this,Os,"avatar","f"),s=(a=e||{}).wrapper,c=a.preRes,A(this,Is,"f")&&(null===(r=A(this,As,"f").avatar)||void 0===r?void 0:r.avatar_id)&&(null===(n=A(this,As,"f").tts)||void 0===n?void 0:n.vcn)&&A(this,As,"f").avatar.width&&A(this,As,"f").avatar.height){t.next=5;break}return t.abrupt("return",Promise.reject(new L(Y.message,Y.code,K.InvalidParam)));case 5:if(void 0!==s||!A(this,Ts,"f").useInlinePlayer||!["xrtc","webrtc"].includes(null===(o=A(this,As,"f").stream)||void 0===o?void 0:o.protocol)){t.next=7;break}return t.abrupt("return",Promise.reject(new L("播放节点未指定",Y.code,K.InvalidParam)));case 7:return A(this,Cs,"m",cc).call(this,!0),t.prev=8,x(this,xs,c||void 0,"f"),t.next=12,A(this,zs,"f").call(this);case 12:t.next=19;break;case 14:return t.prev=14,t.t0=t.catch(8),Ce.record(J.error,"[ws]:connect failed",(null===t.t0||void 0===t.t0?void 0:t.t0.message)||""),x(this,ws,i.disconnected,"f"),t.abrupt("return",Promise.reject(new L((null===t.t0||void 0===t.t0?void 0:t.t0.message)||$.message,(null===t.t0||void 0===t.t0?void 0:t.t0.code)||$.code,K.ConnectError)));case 19:return t.prev=19,t.next=22,A(this,Ys,"f").call(this);case 22:return u=t.sent,A(this,$s,"f").call(this),x(this,Ls,lc(u),"f"),x(this,ws,i.connected,"f"),this.emit(_e.connected,u),Ce.record(J.debug,"[interact]:success",u),A(this,oc,"f").call(this),A(this,Hs,"f").call(this),t.next=32,A(this,sc,"f").call(this,u,s);case 32:t.next=39;break;case 34:throw t.prev=34,t.t1=t.catch(19),A(this,Cs,"m",cc).call(this,!0),x(this,ws,i.disconnected,"f"),t.t1;case 39:case"end":return t.stop()}}),t,this,[[8,14],[19,34]])})))}},{key:"connectNlp",value:function(){return P(this,void 0,void 0,p().mark((function e(){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(x(this,Os,"nlp","f"),x(this,Ps,!1,"f"),A(this,Is,"f")){e.next=4;break}return e.abrupt("return",Promise.reject(new L(Y.message,Y.code,K.InvalidParam)));case 4:return A(this,Cs,"m",cc).call(this,!0),e.prev=5,e.next=8,A(this,zs,"f").call(this);case 8:e.next=15;break;case 10:return e.prev=10,e.t0=e.catch(5),Ce.record(J.error,"[ws]:connect failed",(null===e.t0||void 0===e.t0?void 0:e.t0.message)||""),x(this,ws,i.disconnected,"f"),e.abrupt("return",Promise.reject(new L((null===e.t0||void 0===e.t0?void 0:e.t0.message)||$.message,(null===e.t0||void 0===e.t0?void 0:e.t0.code)||$.code,K.ConnectError)));case 15:A(this,$s,"f").call(this),x(this,ws,i.connected,"f"),this.emit(_e.connected),Ce.record(J.debug,"[interact]:success");case 19:case"end":return e.stop()}}),e,this,[[5,10]])})))}},{key:"interrupt",value:function(){return P(this,void 0,void 0,p().mark((function e(){var t=this;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,A(this,Ns,"f").call(this).then((function(){var e;A(t,js,"f").call(t,{header:{app_id:(null===(e=A(t,Is,"f"))||void 0===e?void 0:e.appId)||"",ctrl:"reset"}})}));case 2:case"end":return e.stop()}}),e,this)})))}},{key:"writeText",value:function(e,t){return P(this,void 0,void 0,p().mark((function r(){var n,i,o,a,s,c,u,d,l,h,f,m,v,g,y,b;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return u=(c=t||{}).request_id,d=c.session,l=c.uid,h=c.nlp,f=c.avatar_dispatch,m=c.air,v=c.parameter,g=c.tts,u=u||M(),y=null!=m?m:A(this,As,"f").air,b={},y&&(b={air:U(A(this,As,"f").air,m)}),r.prev=5,r.next=8,A(this,Ns,"f").call(this);case 8:r.next=14;break;case 10:return r.prev=10,r.t0=r.catch(5),Ce.record(J.error,"[writeText]",r.t0),r.abrupt("return",Promise.reject(new L($.message,$.code,K.InvalidConnect)));case 14:return A(this,js,"f").call(this,{header:{app_id:(null===(n=A(this,Is,"f"))||void 0===n?void 0:n.appId)||"",request_id:u,ctrl:h?"text_interact":"text_driver",session:d||"",uid:l||"",scene_id:(null===(i=A(this,Is,"f"))||void 0===i?void 0:i.sceneId)||"",scene_version:(null===(o=A(this,Is,"f"))||void 0===o?void 0:o.sceneVersion)||""},parameter:Object.assign(Object.assign({avatar_dispatch:Object.assign(Object.assign({},U(A(this,As,"f").avatar_dispatch,f)),{interactive_mode:null!==(a=null==f?void 0:f.interactive_mode)&&void 0!==a?a:null===(s=A(this,As,"f").avatar_dispatch)||void 0===s?void 0:s.interactive_mode}),tts:Object.assign({},U(A(this,As,"f").tts,g,{audio:{sample_rate:2===A(this,Cs,"m",Ks).call(this)?24e3:16e3}}))},b),v),payload:{text:{content:e}}}),r.abrupt("return",u);case 16:case"end":return r.stop()}}),r,this,[[5,10]])})))}},{key:"writeJsonText",value:function(e,t,r){return P(this,void 0,void 0,p().mark((function n(){var i,o,a,s,c,u,d,l,h,f,m;return p().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return s=t.request_id,c=t.nlp,u=t.avatar_dispatch,d=t.air,l=t.tts,h=t.parameter,s=s||M(),f=null!=d?d:A(this,As,"f").air,m={},f&&(m={air:U(A(this,As,"f").air,d)}),n.prev=5,n.next=8,A(this,Ns,"f").call(this);case 8:n.next=14;break;case 10:return n.prev=10,n.t0=n.catch(5),Ce.record(J.error,"[writeJsonText]",n.t0),n.abrupt("return",Promise.reject(new L($.message,$.code,K.InvalidConnect)));case 14:return A(this,js,"f").call(this,{header:{app_id:(null===(i=A(this,Is,"f"))||void 0===i?void 0:i.appId)||"",request_id:s,ctrl:c?"text_interact":"text_driver"},parameter:Object.assign(Object.assign({avatar_dispatch:Object.assign(Object.assign({},U(A(this,As,"f").avatar_dispatch,u)),{interactive_mode:null!==(o=null==u?void 0:u.interactive_mode)&&void 0!==o?o:null===(a=A(this,As,"f").avatar_dispatch)||void 0===a?void 0:a.interactive_mode}),tts:Object.assign({},U(A(this,As,"f").tts,l,{audio:{sample_rate:2===A(this,Cs,"m",Ks).call(this)?24e3:16e3}}))},m),h),payload:{json_text:{text:e,cmd:r}}}),n.abrupt("return",s);case 16:case"end":return n.stop()}}),n,this,[[5,10]])})))}},{key:"writeAudio",value:function(e,t,r){return P(this,void 0,void 0,p().mark((function i(){var o,a,s,c,u,d,l,h,f,m,v,g,y,b,S,E,C,T,w,_,k,R,I;return p().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.prev=0,i.next=3,A(this,Ns,"f").call(this);case 3:i.next=9;break;case 5:return i.prev=5,i.t0=i.catch(0),Ce.record(J.error,"[writeAudio]",i.t0),i.abrupt("return",Promise.reject(new L($.message,$.code,K.InvalidConnect)));case 9:return m=!1,(t===n.start||!A(this,Rs,"f")&&t===n.end)&&(m=!0,x(this,Us,M(),"f"),Ce.record(J.info,"[writeAudio]","audio is first Frame, reset")),x(this,Us,f=A(this,Us,"f")||M(),"f"),t===n.end?x(this,Rs,!1,"f"):x(this,Rs,!0,"f"),g=(v=r||{}).nlp,y=v.full_duplex,b=v.avatar,S=v.vc,E=v.avatar_dispatch,C=v.air,T=v.audio,w=v.session,_=v.uid,k=O(v,["nlp","full_duplex","avatar","vc","avatar_dispatch","air","audio","session","uid"]),R=null!=C?C:A(this,As,"f").air,I={},R&&(I={air:U(A(this,As,"f").air,C)}),A(this,js,"f").call(this,{header:{app_id:(null===(o=A(this,Is,"f"))||void 0===o?void 0:o.appId)||"",request_id:f,ctrl:g?"audio_interact":"audio_driver",session:w||"",uid:_||""},parameter:Object.assign(Object.assign(Object.assign({avatar_dispatch:Object.assign(Object.assign(Object.assign({},E),!g&&m?{interactive_mode:null!==(a=null==E?void 0:E.interactive_mode)&&void 0!==a?a:null===(s=A(this,As,"f").avatar_dispatch)||void 0===s?void 0:s.interactive_mode}:{}),{audio_mode:null!==(c=null==E?void 0:E.audio_mode)&&void 0!==c?c:0,content_analysis:(g?null!==(u=null==E?void 0:E.content_analysis)&&void 0!==u?u:null===(d=A(this,As,"f").avatar_dispatch)||void 0===d?void 0:d.content_analysis:0)||0})},g?{asr:{full_duplex:y?1:0}}:{}),(null==S?void 0:S.vc)?{vc:{vc:null!==(l=null==S?void 0:S.vc)&&void 0!==l?l:0,voice_name:(null==S?void 0:S.voice_name)||""}}:{}),I),payload:{audio:Object.assign(Object.assign(Object.assign({},T),{sample_rate:null!==(h=null==T?void 0:T.sample_rate)&&void 0!==h?h:g||2!==A(this,Cs,"m",Ks).call(this)?16e3:24e3,status:t,audio:z(new Uint8Array(e)),frame_size:e.byteLength}),k),avatar:b||[]}},!0),i.abrupt("return",f);case 20:case"end":return i.stop()}}),i,this,[[0,5]])})))}},{key:"writeCmd",value:function(e,t){return P(this,void 0,void 0,p().mark((function r(){var n,i,o;return p().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return i=M(),r.prev=1,r.next=4,A(this,Ns,"f").call(this);case 4:r.next=10;break;case 6:return r.prev=6,r.t0=r.catch(1),Ce.record(J.error,"[writeCmd]",r.t0),r.abrupt("return",Promise.reject(new L($.message,$.code,K.InvalidConnect)));case 10:o=null,r.prev=11,r.t1=e,r.next="action"===r.t1?15:17;break;case 15:return o={cmd_text:{avatar:[{type:e,value:t}]}},r.abrupt("break",17);case 17:r.next=21;break;case 19:r.prev=19,r.t2=r.catch(11);case 21:return o&&A(this,js,"f").call(this,{header:{app_id:(null===(n=A(this,Is,"f"))||void 0===n?void 0:n.appId)||"",request_id:i,ctrl:"cmd"},payload:o}),r.abrupt("return",i);case 23:case"end":return r.stop()}}),r,this,[[1,6],[11,19]])})))}},{key:"recorder",get:function(){return A(this,ks,"f")}},{key:"destroyRecorder",value:function(){var e,t;null===(e=A(this,ks,"f"))||void 0===e||e.stopRecord(),null===(t=A(this,ks,"f"))||void 0===t||t.destroy(),x(this,ks,void 0,"f")}},{key:"createRecorder",value:function(e){var t,r=this;if(A(this,ks,"f")&&!(null===(t=A(this,ks,"f"))||void 0===t?void 0:t.isDestroyed()))return A(this,ks,"f");var o=-1;return x(this,ks,new It(Object.assign({sampleRate:16e3},e)),"f").on(ze.recoder_audio,(function(e){var t,a;if(A(r,ws,"f")===i.connected){var s=e.frameStatus;-1===o&&e.frameStatus!==n.end&&(s=0,o=0),r.writeAudio(e.s16buffer,s,{nlp:null!==(a=null===(t=null==e?void 0:e.extend)||void 0===t?void 0:t.nlp)&&void 0!==a&&a,full_duplex:e.fullDuplex?1:0}).catch((function(e){Ce.record(J.error,"[writeAudio]",e)}))}else Ce.record(J.info,"[writeAudio]","channel disconnected, ignore audio data")})),A(this,ks,"f")}},{key:"createPlayer",value:function(){return A(this,_s,"f")?A(this,_s,"f"):x(this,_s,new Ke,"f")}},{key:"stop",value:function(){A(this,Cs,"m",cc).call(this,!0)}},{key:"destroy",value:function(){var t,r;null===(t=A(this,_s,"f"))||void 0===t||t.destroy(),x(this,_s,void 0,"f"),A(this,Cs,"m",cc).call(this,!0),null===(r=A(this,ks,"f"))||void 0===r||r.destroy(),x(this,ks,void 0,"f"),w(S(e.prototype),"destroy",this).call(this)}}],[{key:"getVersion",value:function(){return"3.1.1-1011"}},{key:"setLogLevel",value:function(e){Ce.setLogLevel(e)}}]),e}();Ts=new WeakMap,ws=new WeakMap,_s=new WeakMap,ks=new WeakMap,Rs=new WeakMap,Is=new WeakMap,Os=new WeakMap,Ps=new WeakMap,As=new WeakMap,xs=new WeakMap,Ls=new WeakMap,Ms=new WeakMap,Ds=new WeakMap,Us=new WeakMap,Ns=new WeakMap,js=new WeakMap,Vs=new WeakMap,Fs=new WeakMap,Ws=new WeakMap,Bs=new WeakMap,Gs=new WeakMap,Hs=new WeakMap,zs=new WeakMap,qs=new WeakMap,Ys=new WeakMap,$s=new WeakMap,Xs=new WeakMap,Qs=new WeakMap,Zs=new WeakMap,ec=new WeakMap,tc=new WeakMap,rc=new WeakMap,oc=new WeakMap,ac=new WeakMap,sc=new WeakMap,Cs=new WeakSet,Ks=function(){var e,t,r;return null!==(r=null===(t=null===(e=A(this,As,"f"))||void 0===e?void 0:e.avatar)||void 0===t?void 0:t.audio_format)&&void 0!==r?r:1},Js=function(){var e,t,r,n,i,o,a=null!==(e=A(this,As,"f").stream)&&void 0!==e?e:{},s=a.protocol,c=void 0===s?"xrtc":s,u=a.bitrate,d=void 0===u?1e6:u,l=O(a,["protocol","bitrate"]),h=A(this,As,"f").avatar,p=h.avatar_id,f=h.width,m=h.height,v=O(h,["avatar_id","width","height"]),g=A(this,As,"f").tts,y=g.vcn,b=g.speed,S=g.pitch,E=g.volume,C=O(g,["vcn","speed","pitch","volume"]),T=A(this,As,"f").subtitle||{},w=T.subtitle,_=T.font_color,k=O(T,["subtitle","font_color"]),R=A(this,As,"f").background,I=A(this,As,"f").air,P={};return I&&(P={air:I}),Object.assign({header:{app_id:(null===(t=A(this,Is,"f"))||void 0===t?void 0:t.appId)||"",ctrl:"start",scene_id:(null===(r=A(this,Is,"f"))||void 0===r?void 0:r.sceneId)||"",scene_version:(null===(n=A(this,Is,"f"))||void 0===n?void 0:n.sceneVersion)||""},parameter:Object.assign(Object.assign({avatar_dispatch:{enable_action_status:null!==(o=null===(i=A(this,As,"f").avatar_dispatch)||void 0===i?void 0:i.enable_action_status)&&void 0!==o?o:0},avatar:Object.assign(Object.assign({stream:Object.assign(Object.assign({},l),{protocol:c,bitrate:Math.floor((d||1e6)/1024)}),avatar_id:p,width:f,height:m},v),{audio_format:A(this,Cs,"m",Ks).call(this)}),tts:Object.assign({vcn:y,speed:null!=b?b:50,pitch:null!=S?S:50,volume:null!=E?E:100,audio:{sample_rate:2===A(this,Cs,"m",Ks).call(this)?24e3:16e3}},C)},w?{subtitle:Object.assign({subtitle:w,font_color:null!=_?_:"#FFFFFF"},k)}:{}),P)},(null==R?void 0:R.data)||A(this,xs,"f")?{payload:Object.assign({background:R},A(this,xs,"f")?{preload_resources:A(this,xs,"f")}:{})}:void 0)},nc=function(e,t){if(0===e.length||t<e[0].bg)return{target:null,index:-1};if(t>e[e.length-1].ed)return{target:null,index:-2};for(var r=0,n=e.length-1;r<=n;){var i=Math.floor((r+n)/2),o=e[i],a=o.bg,s=o.ed;if(t>=a&&t<=s)return{target:e[i],index:i};t<a?n=i-1:r=i+1}return{target:null,index:-1}},ic=function e(){var t=this;x(this,ec,requestAnimationFrame((function(r){A(t,Zs,"f")||x(t,Zs,r,"f");var n=null;if(A(t,Xs,"f").length&&A(t,Zs,"f")){var i=A(t,Cs,"m",nc).call(t,A(t,Xs,"f"),r-A(t,Zs,"f")-A(t,rc,"f")),o=i.target,a=i.index;o?(n=o,t.emit(_e.subtitle_info,o),A(t,Xs,"f").splice(0,a+1)):-2===a&&(A(t,Xs,"f").length=0,cancelAnimationFrame(A(t,ec,"f")),x(t,ec,0,"f"))}A(t,Xs,"f").length?A(t,Cs,"m",e).call(t):(cancelAnimationFrame(A(t,ec,"f")),x(t,ec,0,"f"),x(t,tc,setTimeout((function(){t.emit(_e.subtitle_info)}),((null==n?void 0:n.ed)||0)-((null==n?void 0:n.bg)||0)+1e3),"f"))})),"f")},cc=function(){var e,t,r,n,o,a=arguments.length>0&&void 0!==arguments[0]&&arguments[0];x(this,Rs,!1,"f"),clearInterval(A(this,Bs,"f")),clearTimeout(A(this,Gs,"f")),a&&x(this,Vs,void 0,"f"),clearTimeout(A(this,Fs,"f")),x(this,xs,void 0,"f"),x(this,ws,i.disconnected,"f");var s=A(this,Ds,"f");null===(e=A(this,ks,"f"))||void 0===e||e.stopRecord(),null===(t=A(this,_s,"f"))||void 0===t||t.stop(),(null==s?void 0:s.readyState)===Te.OPEN?(s.onclose=null,s.onmessage=null,A(this,js,"f").call(this,{header:{request_id:M(),app_id:(null===(r=A(this,Is,"f"))||void 0===r?void 0:r.appId)||"",ctrl:"stop"}}),s.close()):(null===(n=A(this,Ms,"f"))||void 0===n||n.abort(),null===(o=null==s?void 0:s.close)||void 0===o||o.call(s)),A(this,Ds,"f")&&(A(this,ac,"f").call(this,a),x(this,Ms,void 0,"f"),x(this,Ds,void 0,"f"),x(this,Ls,void 0,"f"))}}},r={};function n(e){var i=r[e];if(void 0!==i)return i.exports;var o=r[e]={id:e,loaded:!1,exports:{}};return t[e].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=t,function(){n.amdO={}}(),function(){var e=[];n.O=function(t,r,i,o){if(!r){var a=1/0;for(d=0;d<e.length;d++){r=e[d][0],i=e[d][1],o=e[d][2];for(var s=!0,c=0;c<r.length;c++)(!1&o||a>=o)&&Object.keys(n.O).every((function(e){return n.O[e](r[c])}))?r.splice(c--,1):(s=!1,o<a&&(a=o));if(s){e.splice(d--,1);var u=i();void 0!==u&&(t=u)}}return t}o=o||0;for(var d=e.length;d>0&&e[d-1][2]>o;d--)e[d]=e[d-1];e[d]=[r,i,o]}}(),function(){n.n=function(e){var t=e&&e.__esModule?function(){return e["default"]}:function(){return e};return n.d(t,{a:t}),t}}(),function(){n.d=function(e,t){for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})}}(),function(){n.f={},n.e=function(e){return Promise.all(Object.keys(n.f).reduce((function(t,r){return n.f[r](e,t),t}),[]))}}(),function(){n.u=function(e){return"js/"+e+"."+{6:"a65cee17",122:"e5db04bb",783:"dd100216",793:"6eb01835",848:"8328abf6",998:"119116e0"}[e]+".js"}}(),function(){n.miniCssF=function(e){return"css/"+e+"."+{783:"3036d9b1",793:"6931b4e7",848:"cdacd7b7",998:"ca5a11cd"}[e]+".css"}}(),function(){n.g=function(){if("object"===typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"===typeof window)return window}}()}(),function(){n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)}}(),function(){var e={},t="avatarvue2:";n.l=function(r,i,o,a){if(e[r])e[r].push(i);else{var s,c;if(void 0!==o)for(var u=document.getElementsByTagName("script"),d=0;d<u.length;d++){var l=u[d];if(l.getAttribute("src")==r||l.getAttribute("data-webpack")==t+o){s=l;break}}s||(c=!0,s=document.createElement("script"),s.charset="utf-8",s.timeout=120,n.nc&&s.setAttribute("nonce",n.nc),s.setAttribute("data-webpack",t+o),s.src=r),e[r]=[i];var h=function(t,n){s.onerror=s.onload=null,clearTimeout(p);var i=e[r];if(delete e[r],s.parentNode&&s.parentNode.removeChild(s),i&&i.forEach((function(e){return e(n)})),t)return t(n)},p=setTimeout(h.bind(null,void 0,{type:"timeout",target:s}),12e4);s.onerror=h.bind(null,s.onerror),s.onload=h.bind(null,s.onload),c&&document.head.appendChild(s)}}}(),function(){n.r=function(e){"undefined"!==typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}}(),function(){n.nmd=function(e){return e.paths=[],e.children||(e.children=[]),e}}(),function(){n.p="/"}(),function(){if("undefined"!==typeof document){var e=function(e,t,r,i,o){var a=document.createElement("link");a.rel="stylesheet",a.type="text/css",n.nc&&(a.nonce=n.nc);var s=function(r){if(a.onerror=a.onload=null,"load"===r.type)i();else{var n=r&&r.type,s=r&&r.target&&r.target.href||t,c=new Error("Loading CSS chunk "+e+" failed.\n("+n+": "+s+")");c.name="ChunkLoadError",c.code="CSS_CHUNK_LOAD_FAILED",c.type=n,c.request=s,a.parentNode&&a.parentNode.removeChild(a),o(c)}};return a.onerror=a.onload=s,a.href=t,r?r.parentNode.insertBefore(a,r.nextSibling):document.head.appendChild(a),a},t=function(e,t){for(var r=document.getElementsByTagName("link"),n=0;n<r.length;n++){var i=r[n],o=i.getAttribute("data-href")||i.getAttribute("href");if("stylesheet"===i.rel&&(o===e||o===t))return i}var a=document.getElementsByTagName("style");for(n=0;n<a.length;n++){i=a[n],o=i.getAttribute("data-href");if(o===e||o===t)return i}},r=function(r){return new Promise((function(i,o){var a=n.miniCssF(r),s=n.p+a;if(t(a,s))return i();e(r,s,null,i,o)}))},i={524:0};n.f.miniCss=function(e,t){var n={783:1,793:1,848:1,998:1};i[e]?t.push(i[e]):0!==i[e]&&n[e]&&t.push(i[e]=r(e).then((function(){i[e]=0}),(function(t){throw delete i[e],t})))}}}(),function(){var e={524:0};n.f.j=function(t,r){var i=n.o(e,t)?e[t]:void 0;if(0!==i)if(i)r.push(i[2]);else{var o=new Promise((function(r,n){i=e[t]=[r,n]}));r.push(i[2]=o);var a=n.p+n.u(t),s=new Error,c=function(r){if(n.o(e,t)&&(i=e[t],0!==i&&(e[t]=void 0),i)){var o=r&&("load"===r.type?"missing":r.type),a=r&&r.target&&r.target.src;s.message="Loading chunk "+t+" failed.\n("+o+": "+a+")",s.name="ChunkLoadError",s.type=o,s.request=a,i[1](s)}};n.l(a,c,"chunk-"+t,t)}},n.O.j=function(t){return 0===e[t]};var t=function(t,r){var i,o,a=r[0],s=r[1],c=r[2],u=0;if(a.some((function(t){return 0!==e[t]}))){for(i in s)n.o(s,i)&&(n.m[i]=s[i]);if(c)var d=c(n)}for(t&&t(r);u<a.length;u++)o=a[u],n.o(e,o)&&e[o]&&e[o][0](),e[o]=0;return n.O(d)},r=self["webpackChunkavatarvue2"]=self["webpackChunkavatarvue2"]||[];r.forEach(t.bind(null,0)),r.push=t.bind(null,r.push.bind(r))}();var i=n.O(void 0,[504],(function(){return n(1522)}));i=n.O(i)})();
//# sourceMappingURL=app.03948abb.js.map